{% extends 'base.html' %}
{% block content %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
    .terminal-mode { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
    #reader { width: 100%; max-width: 500px; border-radius: 20px; overflow: hidden; border: 4px solid #3b82f6; background: black; }
    .status-box { margin-top: 20px; padding: 20px; border-radius: 15px; width: 90%; max-width: 500px; text-align: center; background: #1e293b; border: 1px solid #334155; transition: all 0.3s ease; }
    .status-success { background: #064e3b; border-color: #10b981; }
    .status-error { background: #7f1d1d; border-color: #ef4444; }
    .last-scans { margin-top: 20px; width: 90%; max-width: 500px; height: 150px; overflow-y: auto; background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px; }
    .scan-item { font-size: 0.8rem; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; }
</style>
<div class="terminal-mode">
    <div class="mb-4 text-center"><h1 class="text-2xl font-bold tracking-widest text-blue-400">SHAHIN GESTÃO</h1><p class="text-xs text-slate-400">TERMINAL DE PONTO</p></div>
    <div id="reader"></div>
    <div id="statusBox" class="status-box"><h2 id="statusTitle" class="text-xl font-bold">Aguardando...</h2><p id="statusMsg" class="text-sm text-slate-400">Aproxime o QR Code do celular</p></div>
    <div class="last-scans" id="historyLog"></div>
    <div class="mt-4"><a href="/logout" class="text-xs text-slate-600 hover:text-slate-400">Sair do Modo Terminal</a></div>
</div>
<script>
    const html5QrCode = new Html5Qrcode("reader");
    let isScanning = true;
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
    html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure);
    function onScanSuccess(decodedText, decodedResult) {
        if (!isScanning) return;
        isScanning = false;
        processarPonto(decodedText);
        setTimeout(() => { isScanning = true; }, 3000);
    }
    function onScanFailure(error) {}
    function processarPonto(token) {
        const box = document.getElementById('statusBox');
        const title = document.getElementById('statusTitle');
        const msg = document.getElementById('statusMsg');
        box.className = "status-box"; title.innerText = "Processando...";
        fetch('/ponto/api/registrar-leitura', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ token: token }) })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                box.classList.add('status-success'); title.innerText = "REGISTRADO!"; msg.innerText = `${data.funcionario} às ${data.hora}`; addToHistory(data.funcionario, data.hora, "ok");
            } else {
                box.classList.add('status-error'); title.innerText = "NÃO REGISTRADO"; msg.innerText = data.error;
            }
        })
        .catch(err => { box.classList.add('status-error'); title.innerText = "ERRO DE REDE"; msg.innerText = "Verifique a conexão."; })
        .finally(() => { setTimeout(() => { box.className = "status-box"; title.innerText = "Aguardando..."; msg.innerText = "Aproxime o QR Code"; }, 2500); });
    }
    function addToHistory(nome, hora, status) {
        const log = document.getElementById('historyLog');
        const item = document.createElement('div');
        item.className = "scan-item";
        item.innerHTML = `<span class="text-emerald-400">${nome}</span> <span>${hora}</span>`;
        log.prepend(item);
    }
</script>
{% endblock %}