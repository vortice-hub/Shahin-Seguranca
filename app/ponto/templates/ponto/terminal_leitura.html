{% extends 'base.html' %}
{% block content %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
    .terminal-mode { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
    #reader { width: 100%; max-width: 600px; border-radius: 20px; overflow: hidden; border: 4px solid #3b82f6; background: black; }
    
    /* MODAL OVERLAY */
    #successModal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9);
        display: flex; align-items: center; justify-content: center;
        z-index: 10000;
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    #successModal.active { opacity: 1; pointer-events: all; }
    
    .modal-content {
        background: #064e3b; /* Emerald 900 */
        padding: 40px; border-radius: 20px; text-align: center;
        border: 2px solid #10b981;
        box-shadow: 0 0 50px rgba(16, 185, 129, 0.5);
        max-width: 90%;
    }
    .modal-content h2 { font-size: 2rem; font-weight: bold; color: white; margin-bottom: 10px; }
    .modal-content p { font-size: 1.5rem; color: #a7f3d0; margin-bottom: 30px; }
    .btn-next {
        background: white; color: #064e3b; font-size: 1.2rem; font-weight: bold;
        padding: 15px 40px; border-radius: 50px; border: none; cursor: pointer;
        display: inline-flex; align-items: center; gap: 10px;
    }
</style>

<div class="terminal-mode">
    <div class="mb-4 text-center"><h1 class="text-3xl font-bold tracking-widest text-blue-400">SHAHIN GESTÃO</h1><p class="text-sm text-slate-400">TERMINAL DE PONTO</p></div>
    <div id="reader"></div>
    <div class="mt-4"><a href="/logout" class="text-xs text-slate-600 hover:text-slate-400">Sair do Modo Terminal</a></div>
</div>

<!-- Modal de Sucesso -->
<div id="successModal">
    <div class="modal-content">
        <i class="fas fa-check-circle text-6xl text-emerald-400 mb-4"></i>
        <h2 id="modalTitle">REGISTRADO!</h2>
        <p id="modalMsg">Fulano de Tal<br>14:30</p>
        <button class="btn-next" onclick="resetScanner()">
            <i class="fas fa-redo"></i> PRÓXIMO
        </button>
    </div>
</div>

<script>
    const html5QrCode = new Html5Qrcode("reader");
    let isScanning = true;
    
    // Configuração para QR Code denso
    const config = { fps: 10, qrbox: { width: 300, height: 300 } };
    
    html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure);

    function onScanSuccess(decodedText, decodedResult) {
        if (!isScanning) return;
        isScanning = false;
        
        // Som de Beep
        try { new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play(); } catch(e){}

        fetch('/ponto/api/registrar-leitura', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({ token: decodedText }) 
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showModal(data.funcionario, data.hora, data.tipo);
            } else {
                alert("ERRO: " + data.error);
                setTimeout(() => { isScanning = true; }, 2000);
            }
        })
        .catch(err => {
            alert("Erro de conexão.");
            setTimeout(() => { isScanning = true; }, 2000);
        });
    }

    function onScanFailure(error) {}

    function showModal(nome, hora, tipo) {
        document.getElementById('modalTitle').innerText = tipo.toUpperCase() + " REGISTRADA";
        document.getElementById('modalMsg').innerHTML = `<strong>${nome}</strong><br>${hora}`;
        document.getElementById('successModal').classList.add('active');
        
        // Auto-fechar em 4s se ninguem clicar
        setTimeout(() => {
            if(document.getElementById('successModal').classList.contains('active')) resetScanner();
        }, 4000);
    }

    function resetScanner() {
        document.getElementById('successModal').classList.remove('active');
        isScanning = true;
    }
</script>
{% endblock %}