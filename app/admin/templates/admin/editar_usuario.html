{% extends 'base.html' %}
{% block content %}
<div class="max-w-lg mx-auto pb-20">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-bold text-slate-800">Editar Perfil</h2>
        <a href="/admin/usuarios" class="text-xs font-medium text-slate-500 hover:text-slate-800 transition">Voltar</a>
    </div>

    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <form id="form-edicao-usuario" action="/admin/usuarios/editar/{{ user.id }}" method="POST" class="p-8 space-y-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" id="acao_input" name="acao" value="salvar">
            
            <div class="space-y-4">
                <div>
                    <label class="label-pro">Nome Completo</label>
                    <input type="text" name="real_name" value="{{ user.real_name }}" class="input-pro">
                </div>
                
                <div class="bg-purple-50 p-4 rounded-lg border border-purple-100">
                    <p class="text-xs font-bold text-purple-800 uppercase mb-3 flex items-center gap-2"><i class="fas fa-sitemap"></i> Estrutura Organizacional</p>
                    <div class="space-y-3">
                        <div>
                            <label class="label-pro text-purple-700">Departamento / Equipe</label>
                            <input type="text" name="departamento" class="input-pro border-purple-200 focus:border-purple-500" value="{{ user.departamento or '' }}" placeholder="Ex: Operacional">
                        </div>
                        <div>
                            <label class="label-pro text-purple-700">Reporta-se a (Gestor)</label>
                            <select name="gestor_id" class="input-pro border-purple-200 focus:border-purple-500 cursor-pointer">
                                <option value="">-- Sem Gestor Direto --</option>
                                {% for gestor in gestores %}
                                    <option value="{{ gestor.id }}" {% if user.gestor_id == gestor.id %}selected{% endif %}>{{ gestor.real_name }} ({{ gestor.role }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                {% if user.username != '50097952800' %}
                <div class="bg-blue-50 p-5 rounded-xl border border-blue-100">
                    <div class="flex items-center gap-2 mb-4 text-blue-700">
                        <i class="fas fa-shield-halved"></i>
                        <span class="text-xs font-bold uppercase tracking-wider">Atribuições Administrativas</span>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-3">
                        {% set user_perms = user.permissions.split(',') if user.permissions else [] %}
                        
                        <label class="flex items-center justify-between p-3 bg-white rounded-lg border border-blue-100 cursor-pointer hover:bg-blue-50 transition">
                            <div class="flex items-center gap-3"><i class="fas fa-users-cog text-blue-500 w-5"></i><span class="text-sm font-semibold text-slate-700">Utilizadores</span></div>
                            <input type="checkbox" name="perm_keys" value="USUARIOS" class="w-5 h-5 rounded text-blue-600" {% if 'USUARIOS' in user_perms %}checked{% endif %}>
                        </label>
                        <label class="flex items-center justify-between p-3 bg-white rounded-lg border border-blue-100 cursor-pointer hover:bg-blue-50 transition">
                            <div class="flex items-center gap-3"><i class="fas fa-fingerprint text-emerald-500 w-5"></i><span class="text-sm font-semibold text-slate-700">Ponto (Aprovação)</span></div>
                            <input type="checkbox" name="perm_keys" value="PONTO" class="w-5 h-5 rounded text-blue-600" {% if 'PONTO' in user_perms %}checked{% endif %}>
                        </label>
                        <label class="flex items-center justify-between p-3 bg-white rounded-lg border border-blue-100 cursor-pointer hover:bg-blue-50 transition">
                            <div class="flex items-center gap-3"><i class="fas fa-file-invoice-dollar text-orange-500 w-5"></i><span class="text-sm font-semibold text-slate-700">Documentos (RH)</span></div>
                            <input type="checkbox" name="perm_keys" value="DOCUMENTOS" class="w-5 h-5 rounded text-blue-600" {% if 'DOCUMENTOS' in user_perms %}checked{% endif %}>
                        </label>
                        <label class="flex items-center justify-between p-3 bg-white rounded-lg border border-blue-100 cursor-pointer hover:bg-blue-50 transition">
                            <div class="flex items-center gap-3"><i class="fas fa-box-open text-purple-500 w-5"></i><span class="text-sm font-semibold text-slate-700">Estoque (Uniforme)</span></div>
                            <input type="checkbox" name="perm_keys" value="ESTOQUE" class="w-5 h-5 rounded text-blue-600" {% if 'ESTOQUE' in user_perms %}checked{% endif %}>
                        </label>
                        <label class="flex items-center justify-between p-3 bg-white rounded-lg border border-blue-100 cursor-pointer hover:bg-blue-50 transition">
                            <div class="flex items-center gap-3"><i class="fas fa-shield-alt text-slate-600 w-5"></i><span class="text-sm font-semibold text-slate-700">Auditoria Forense</span></div>
                            <input type="checkbox" name="perm_keys" value="AUDITORIA" class="w-5 h-5 rounded text-blue-600" {% if 'AUDITORIA' in user_perms %}checked{% endif %}>
                        </label>
                    </div>
                </div>
                {% else %}
                <div class="bg-slate-100 p-4 rounded-lg text-center">
                    <p class="text-[10px] font-bold text-slate-500 uppercase"><i class="fas fa-lock mr-1"></i> Acesso Master Absoluto</p>
                </div>
                {% endif %}

                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-3">Contratação e Vínculo</p>
                    <div class="space-y-3">
                        <div>
                            <label class="label-pro text-emerald-700"><i class="fas fa-calendar-check mr-1"></i> Data de Admissão</label>
                            <input type="date" name="data_admissao" class="input-pro border-emerald-200 focus:border-emerald-500" value="{{ user.data_admissao.strftime('%Y-%m-%d') if user.data_admissao else '' }}">
                        </div>
                        <div>
                            <label class="label-pro">Razão Social</label>
                            <input type="text" name="razao_social" class="input-pro" value="{{ user.razao_social_empregadora }}">
                        </div>
                        <div>
                            <label class="label-pro">CNPJ</label>
                            <input type="text" name="cnpj" class="input-pro font-mono" value="{{ user.cnpj_empregador }}">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label-pro">Login</label>
                        <input type="text" name="username" value="{{ user.username }}" class="input-pro" {% if user.username == '50097952800' %}readonly{% endif %}>
                    </div>
                    <div>
                        <label class="label-pro">Cargo</label>
                        <input type="text" name="role" value="{{ user.role }}" class="input-pro" {% if user.username == '50097952800' %}disabled{% endif %}>
                    </div>
                </div>
            </div>

            <div class="pt-4 border-t border-slate-100">
                <p class="text-xs font-bold text-slate-400 uppercase mb-3">Regra de Ponto</p>
                <div class="mb-4">
                    <label class="label-pro">Escala</label>
                    <select name="escala" class="input-pro">
                        <option value="Livre" {% if user.escala == 'Livre' %}selected{% endif %}>Livre</option>
                        <option value="5x2" {% if user.escala == '5x2' %}selected{% endif %}>Normal 5x2</option>
                        <option value="12x36" {% if user.escala == '12x36' %}selected{% endif %}>Plantão 12x36</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4 bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                    <div>
                        <label class="label-pro text-yellow-800">Carga Diária</label>
                        <input type="time" name="carga_horaria" value="{{ carga_hm }}" class="input-pro border-yellow-200 font-bold">
                    </div>
                    <div>
                        <label class="label-pro text-yellow-800">Intervalo (Min)</label>
                        <input type="number" name="tempo_intervalo" value="{{ user.tempo_intervalo or 60 }}" class="input-pro border-yellow-200 font-bold">
                    </div>
                </div>
                <div class="mt-4">
                    <label class="label-pro">Horário Ideal</label>
                    <input type="time" name="h_ent" value="{{ user.inicio_jornada_ideal }}" class="input-pro">
                </div>
            </div>

            <div class="pt-6 border-t border-slate-100 flex flex-col gap-3">
                <button type="submit" onclick="document.getElementById('acao_input').value='salvar'" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95">SALVAR ALTERAÇÕES</button>
                <div class="grid grid-cols-2 gap-3">
                    <button type="submit" onclick="document.getElementById('acao_input').value='resetar_senha'" class="bg-yellow-50 hover:bg-yellow-100 text-yellow-700 font-bold py-3 rounded-lg text-xs border border-yellow-200 transition">RESETAR SENHA</button>
                    
                    {% if user.username != '50097952800' %}
                    <button type="button" onclick="acionarModalExclusao()" class="bg-red-50 hover:bg-red-100 text-red-600 font-bold py-3 rounded-lg text-xs border border-red-200 transition">
                        EXCLUIR
                    </button>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    // Função específica para interceptar o Modal e fazer o submit deste formulário com a ação "excluir"
    function acionarModalExclusao() {
        confirmarAcao("ATENÇÃO: Isto apagará todos os dados, pontos e espelhos deste funcionário permanentemente. Confirmar?", "#");
        
        // Substitui o comportamento padrão do botão "Excluir" do Modal temporariamente
        document.getElementById('form-confirmacao').onsubmit = function(e) {
            e.preventDefault();
            document.getElementById('acao_input').value = 'excluir';
            document.getElementById('form-edicao-usuario').submit();
        };
    }
</script>
{% endblock %}

