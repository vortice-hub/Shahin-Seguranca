{% extends 'base.html' %}
{% block content %}

<div class="bg-gradient-to-r from-blue-900 to-slate-900 rounded-2xl p-6 text-white shadow-xl mb-8 flex justify-between items-center relative overflow-hidden transition transform hover:scale-[1.01]">
    <div class="absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
    <div>
        <p class="text-xs font-bold text-blue-300 uppercase tracking-widest mb-1">Status Hoje</p>
        <h2 class="text-2xl font-bold mb-1">{{ dados.hoje }}</h2>
        <p class="text-xs opacity-70">{{ current_user.real_name }}</p>
    </div>
    <a href="/ponto/registrar" class="bg-white text-blue-900 hover:bg-blue-50 font-bold py-3 px-6 rounded-full shadow-lg transition transform hover:scale-105 flex items-center gap-2 z-10">
        <i class="fas fa-fingerprint"></i> <span>REGISTAR</span>
    </a>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
        <h3 class="font-bold text-slate-700 mb-2"><i class="fas fa-bolt text-yellow-500 mr-2"></i>Acesso Rápido</h3>
        <div class="flex flex-col gap-2 mt-4">
             <a href="/ponto/espelho" class="text-sm text-slate-600 hover:text-blue-600 flex items-center gap-2"><i class="fas fa-calendar-alt w-5"></i> Ver meu Espelho</a>
             <a href="/documentos/meus-documentos" class="text-sm text-slate-600 hover:text-blue-600 flex items-center gap-2"><i class="fas fa-file-invoice w-5"></i> Meus Documentos</a>
             <a href="/ponto/solicitar-ajuste" class="text-sm text-slate-600 hover:text-blue-600 flex items-center gap-2"><i class="fas fa-exclamation-circle w-5"></i> Ajustar Ponto</a>
        </div>
    </div>
    
    {% if current_user.role != 'Master' %}
    <div class="bg-blue-50 p-6 rounded-xl border border-blue-100 shadow-sm flex items-center justify-center text-center">
        <div>
            <div class="text-blue-200 text-4xl mb-2"><i class="fas fa-quote-left"></i></div>
            <p class="text-blue-800 font-medium italic text-sm">"O sucesso é a soma de pequenos esforços repetidos dia após dia."</p>
        </div>
    </div>
    {% else %}
    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-purple-500 hover:shadow-md transition flex flex-col justify-center">
        <h3 class="font-bold text-slate-700 mb-2"><i class="fas fa-crown text-purple-500 mr-2"></i>Atalhos Executivos</h3>
        <div class="grid grid-cols-2 gap-3 mt-2">
            <a href="/admin/usuarios" class="bg-slate-50 hover:bg-slate-100 p-3 rounded-lg text-center text-xs font-bold text-slate-600 border border-slate-200 transition"><i class="fas fa-users block text-lg mb-1 text-blue-500"></i> Efetivo</a>
            <a href="/admin/solicitacoes" class="bg-slate-50 hover:bg-slate-100 p-3 rounded-lg text-center text-xs font-bold text-slate-600 border border-slate-200 transition relative">
                <i class="fas fa-inbox block text-lg mb-1 text-yellow-500"></i> Pedidos
                {% if admin.ajustes_pendentes > 0 %}
                <span class="absolute top-1 right-1 bg-red-500 text-white text-[9px] rounded-full w-4 h-4 flex items-center justify-center">{{ admin.ajustes_pendentes }}</span>
                {% endif %}
            </a>
        </div>
    </div>
    {% endif %}
</div>

{% if current_user.role == 'Master' %}
<div class="mt-10 mb-6 flex items-center gap-3">
    <div class="h-8 w-1 bg-blue-600 rounded-full"></div>
    <h3 class="text-xl font-black text-slate-800 tracking-tight">Business Intelligence</h3>
</div>

<div id="loading-analytics" class="flex flex-col items-center justify-center py-12 text-slate-400">
    <i class="fas fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
    <p class="text-sm font-bold animate-pulse">A carregar dados em tempo real da operação...</p>
</div>

<div id="painel-analytics" class="hidden">
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative">
            <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4"><i class="fas fa-chart-pie mr-1"></i> Raio-X da Operação (Hoje)</h4>
            <div class="h-64 relative">
                <canvas id="chartRaioX"></canvas>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4"><i class="fas fa-chart-line mr-1"></i> Termómetro de Risco (7 Dias)</h4>
            <div class="h-64">
                <canvas id="chartRisco"></canvas>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm text-center">
            <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2"><i class="fas fa-shield-alt mr-1"></i> Escudo Legal</h4>
            <p class="text-[10px] text-slate-400 mb-4">Leitura de Holerites no Mês</p>
            <div class="h-32 relative flex justify-center">
                <canvas id="chartEscudo"></canvas>
                <div class="absolute bottom-0 w-full text-center pb-2">
                    <span id="escudo-valor" class="text-2xl font-black text-slate-800">0%</span>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4"><i class="fas fa-clock mr-1"></i> Radar de Pontualidade</h4>
            <div class="h-40">
                <canvas id="chartPontualidade"></canvas>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4"><i class="fas fa-tshirt mr-1"></i> Consumo de EPI / Uniforme</h4>
            <div class="h-40">
                <canvas id="chartCustos"></canvas>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            // 1. Busca os dados na API
            const response = await fetch('/api/analytics');
            if (!response.ok) throw new Error('Falha na API');
            const data = await response.json();

            // 2. Esconde o Loading e mostra o painel
            document.getElementById('loading-analytics').classList.add('hidden');
            document.getElementById('painel-analytics').classList.remove('hidden');

            // ---------------------------------------------------------
            // GRÁFICO 1: RAIO-X DA OPERAÇÃO (Donut)
            // ---------------------------------------------------------
            const labelsRaioX = Object.keys(data.raio_x).length > 0 ? Object.keys(data.raio_x) : ['Sem dados hoje'];
            const valoresRaioX = Object.keys(data.raio_x).length > 0 ? Object.values(data.raio_x) : [1];
            
            // Mapeia cores padronizadas baseadas no status
            const colorMap = {
                'OK': '#10b981', 'Trabalhando': '#10b981', 
                'Falta': '#ef4444', 
                'Atestado': '#f59e0b', 
                'Folga': '#3b82f6',
                'Sem dados hoje': '#e2e8f0'
            };
            const bgColorsRaioX = labelsRaioX.map(l => colorMap[l] || '#8b5cf6');

            new Chart(document.getElementById('chartRaioX'), {
                type: 'doughnut',
                data: {
                    labels: labelsRaioX,
                    datasets: [{
                        data: valoresRaioX,
                        backgroundColor: bgColorsRaioX,
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } },
                    cutout: '70%'
                }
            });

            // ---------------------------------------------------------
            // GRÁFICO 2: TERMÓMETRO DE RISCO (Linhas Faltas vs Extras)
            // ---------------------------------------------------------
            new Chart(document.getElementById('chartRisco'), {
                type: 'line',
                data: {
                    labels: data.risco.labels,
                    datasets: [
                        {
                            label: 'Faltas (Dias)',
                            data: data.risco.faltas,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Horas Extras (h)',
                            data: data.risco.extras,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true, grid: { borderDash: [4, 4] } }, x: { grid: { display: false } } }
                }
            });

            // ---------------------------------------------------------
            // GRÁFICO 3: CUSTOS EPI (Barras)
            // ---------------------------------------------------------
            new Chart(document.getElementById('chartCustos'), {
                type: 'bar',
                data: {
                    labels: data.custos.labels.length > 0 ? data.custos.labels : ['Nenhuma saída'],
                    datasets: [{
                        label: 'Peças Entregues',
                        data: data.custos.data.length > 0 ? data.custos.data : [0],
                        backgroundColor: '#8b5cf6',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } }, x: { grid: { display: false } } }
                }
            });

            // ---------------------------------------------------------
            // GRÁFICO 4: ESCUDO LEGAL (Velocímetro / Meio Donut)
            // ---------------------------------------------------------
            document.getElementById('escudo-valor').innerText = data.escudo + '%';
            let corEscudo = '#10b981'; // Verde se > 80%
            if (data.escudo < 50) corEscudo = '#ef4444'; // Vermelho se < 50%
            else if (data.escudo < 80) corEscudo = '#f59e0b'; // Amarelo
            
            new Chart(document.getElementById('chartEscudo'), {
                type: 'doughnut',
                data: {
                    labels: ['Lidos', 'Pendentes'],
                    datasets: [{
                        data: [data.escudo, 100 - data.escudo],
                        backgroundColor: [corEscudo, '#f1f5f9'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    circumference: 180, rotation: 270, // Faz o formato de arco (velocímetro)
                    cutout: '80%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });

            // ---------------------------------------------------------
            // GRÁFICO 5: RADAR DE PONTUALIDADE (Barras)
            // ---------------------------------------------------------
            new Chart(document.getElementById('chartPontualidade'), {
                type: 'bar',
                data: {
                    labels: ['No Horário', 'Atraso Leve', 'Atraso Crítico'],
                    datasets: [{
                        data: data.pontualidade,
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } }, x: { grid: { display: false } } }
                }
            });

        } catch (error) {
            console.error("Erro ao carregar Analytics:", error);
            document.getElementById('loading-analytics').innerHTML = '<div class="text-red-500"><i class="fas fa-exclamation-triangle mb-2 text-2xl"></i><p class="text-xs">Erro ao carregar gráficos.</p></div>';
        }
    });
</script>
{% endif %}

{% endblock %}

