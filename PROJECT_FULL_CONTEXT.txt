==================================================
SNAPSHOT DO PROJETO: Shahin Gest√£o
Gerado em: 2026-02-21 16:10:06
==================================================

--- ESTRUTURA DE ARQUIVOS ---
.
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ admin/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ admin_importar_csv.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ admin_limpeza.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ admin_relatorio_folha.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ admin_usuarios.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ configuracoes.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ editar_usuario.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ liberar_acesso.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ novo_usuario.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ solicitacoes.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ sucesso_usuario.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes.py
‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ auto_cadastro.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ auto_cadastro_sucesso.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ esqueci_senha.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ login.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ primeiro_acesso.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes.py
‚îÇ   ‚îú‚îÄ‚îÄ documentos/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ documentos/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ admin_upload_holerite.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ auditoria.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ dashboard.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ enviar_atestado.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ gestao_atestados.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ meus_atestados.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ meus_documentos.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ novo_recibo.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ relatorio_folha.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ revisao.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai_parser.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ atestado_parser.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ storage.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.py
‚îÇ   ‚îú‚îÄ‚îÄ estoque/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ estoque/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ controle_uniforme.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ editar_item.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ editar_log_entrada.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ editar_log_saida.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ entrada.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ gestao_pedidos_uniforme.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ historico_entrada.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ historico_saida.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ saida.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ selecionar_edicao.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ solicitar_uniforme.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes.py
‚îÇ   ‚îú‚îÄ‚îÄ main/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ dashboard.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes.py
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ ponto/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ponto/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ controle_escala.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ gestao_ausencias.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ meu_calendario.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ minha_escala.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ponto_espelho.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ registro.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ solicitar_ajuste.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ solicitar_ferias.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ terminal_leitura.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes.py
‚îÇ   ‚îú‚îÄ‚îÄ static/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ style.css
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icons/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icon-192x192.png
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ icon-512x512.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ manifest.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ service-worker.js
‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ errors/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 403.html
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 404.html
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 500.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.html
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ponto_espelho_master.html
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ extensions.py
‚îÇ   ‚îî‚îÄ‚îÄ utils.py
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ PROJETOTXT.py
‚îú‚îÄ‚îÄ Procfile
‚îú‚îÄ‚îÄ backup.py
‚îú‚îÄ‚îÄ config.py
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ restore_backup.py
‚îú‚îÄ‚îÄ run.py
‚îî‚îÄ‚îÄ runtime.txt

==================================================

--- CONTE√öDO DOS ARQUIVOS ---

FILE: Dockerfile
----------------
# Usa a vers√£o do Python que voc√™ j√° definiu no runtime.txt
FROM python:3.11-slim

# Define vari√°veis para o Python n√£o gerar arquivos .pyc e logs aparecerem na hora
ENV PYTHONUNBUFFERED True
ENV APP_HOME /app

# --- AQUI EST√Å O TRUQUE DO FUSO HOR√ÅRIO (BLINDAGEM N√çVEL SO) ---
# For√ßa o servidor a operar no hor√°rio de Bras√≠lia cravado no Linux
ENV TZ=America/Sao_Paulo
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

WORKDIR $APP_HOME

# Instala depend√™ncias do sistema (Linux) necess√°rias para o PostgreSQL e PDF
RUN apt-get update && apt-get install -y \
    gcc \
    libpq-dev \
    tzdata \
    && rm -rf /var/lib/apt/lists/*

# Copia e instala as bibliotecas do projeto
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia todo o c√≥digo do Shahin para dentro do container
COPY . .

# Comando de inicializa√ß√£o (Igual ao seu Procfile)
# O Cloud Run vai injetar a vari√°vel $PORT automaticamente
CMD exec gunicorn --bind :$PORT --workers 1 --threads 8 --timeout 0 run:app



##################################################

FILE: PROJETOTXT.py
-------------------
import os
from datetime import datetime

# --- CONFIGURA√á√ïES ---
OUTPUT_FILE = "PROJECT_FULL_CONTEXT.txt"

# Pastas para ignorar (Adicionei as solicitadas e padroes de sistema)
IGNORE_DIRS = {
    '.git', '__pycache__', '.venv', 'venv', 'env', 'node_modules', 
    'backup', 'backups', 'backups_auto', 'app_backup_20260214_220800',
    '.idea', '.vscode'
}

IGNORE_FILES = {
    '.DS_Store', 'Thumbs.db', OUTPUT_FILE, 
    'generate_project_snapshot.py', 'generate_snapshot_v2.py',
    'db.sqlite3' # Ignora banco local se houver
}

# Extens√µes que queremos ler o conte√∫do
READ_EXTENSIONS = {'.py', '.html', '.txt', '.md', '.css', '.js', '.json', '.xml'}
# Arquivos espec√≠ficos sem extens√£o que queremos ler
READ_FILES = {'Procfile', 'requirements.txt', 'runtime.txt', 'Dockerfile', '.env.example'}

def should_ignore_dir(dirname):
    """Verifica se o diretorio deve ser ignorado."""
    if dirname in IGNORE_DIRS:
        return True
    # Ignora qualquer pasta que comece com app_backup_ (para backups futuros)
    if dirname.startswith('app_backup_'):
        return True
    return False

def generate_tree(startpath, prefix=""):
    """Gera a estrutura de √°rvore visual."""
    tree_str = ""
    files = []
    dirs = []

    try:
        for item in os.listdir(startpath):
            path = os.path.join(startpath, item)
            if os.path.isdir(path):
                if not should_ignore_dir(item):
                    dirs.append(item)
            else:
                if item not in IGNORE_FILES:
                    files.append(item)
    except PermissionError:
        return ""

    dirs.sort()
    files.sort()

    entries = dirs + files
    
    for i, entry in enumerate(entries):
        is_last = (i == len(entries) - 1)
        connector = "‚îî‚îÄ‚îÄ " if is_last else "‚îú‚îÄ‚îÄ "
        
        if entry in dirs:
            tree_str += f"{prefix}{connector}{entry}/\n"
            extension = "    " if is_last else "‚îÇ   "
            tree_str += generate_tree(os.path.join(startpath, entry), prefix + extension)
        else:
            tree_str += f"{prefix}{connector}{entry}\n"

    return tree_str

def get_file_content(filepath):
    """L√™ o conte√∫do do arquivo com seguran√ßa."""
    ext = os.path.splitext(filepath)[1]
    filename = os.path.basename(filepath)
    
    if ext in READ_EXTENSIONS or filename in READ_FILES:
        try:
            with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                content = f.read()
                return content
        except Exception as e:
            return f"[Erro ao ler arquivo: {e}]"
    return "[Conte√∫do bin√°rio ou n√£o listado para leitura]"

def main():
    root_dir = os.getcwd()
    
    print(f"--- GERANDO SNAPSHOT DO PROJETO ---")
    print(f"Raiz: {root_dir}")
    print(f"Ignorando pastas de backup...")
    
    with open(OUTPUT_FILE, 'w', encoding='utf-8') as out:
        # 1. Cabe√ßalho
        out.write("="*50 + "\n")
        out.write(f"SNAPSHOT DO PROJETO: Shahin Gest√£o\n")
        out.write(f"Gerado em: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
        out.write("="*50 + "\n\n")
        
        # 2. Estrutura de Pastas (Tree)
        out.write("--- ESTRUTURA DE ARQUIVOS ---\n")
        out.write(".\n")
        out.write(generate_tree(root_dir))
        out.write("\n" + "="*50 + "\n\n")
        
        # 3. Conte√∫do dos Arquivos
        out.write("--- CONTE√öDO DOS ARQUIVOS ---\n\n")
        
        for root, dirs, files in os.walk(root_dir):
            # Modifica a lista dirs "in-place" para impedir o os.walk de entrar nas pastas ignoradas
            dirs[:] = [d for d in dirs if not should_ignore_dir(d)]
            
            # Ordena para ficar bonito
            dirs.sort()
            files.sort()
            
            for file in files:
                if file in IGNORE_FILES: continue
                
                filepath = os.path.join(root, file)
                relative_path = os.path.relpath(filepath, root_dir)
                
                # Verifica se deve ler
                ext = os.path.splitext(file)[1]
                if ext in READ_EXTENSIONS or file in READ_FILES:
                    print(f"Lendo: {relative_path}")
                    content = get_file_content(filepath)
                    
                    out.write(f"FILE: {relative_path}\n")
                    out.write("-" * len(f"FILE: {relative_path}") + "\n")
                    out.write(content + "\n")
                    out.write("\n" + "#"*50 + "\n\n")

    print(f"\nCONCLU√çDO! Arquivo gerado: {OUTPUT_FILE}")

if __name__ == "__main__":
    main()




##################################################

FILE: Procfile
--------------
web: gunicorn run:app

##################################################

FILE: backup.py
---------------
import os
import zipfile
from datetime import datetime

def create_backup():
    # 1. Configura√ß√µes
    project_root = os.getcwd()
    backup_folder = os.path.join(project_root, 'backups')
    
    # Pastas e arquivos que N√ÉO queremos no backup
    ignore_dirs = {'.git', '__pycache__', 'venv', '.venv', 'env', 'backups', 'node_modules', '.idea', '.vscode', 'uploads', 'instance'}
    ignore_files = {'.DS_Store', 'backup.py', '.env'} # Ignorando senhas (.env)
    ignore_extensions = {'.log', '.pyc', '.sqlite3', '.db'} # Ignora logs e bancos locais para evitar corrup√ß√£o

    # 2. Garante que a pasta de backups existe
    if not os.path.exists(backup_folder):
        os.makedirs(backup_folder)
        print(f"üìÅ Pasta '{backup_folder}' criada com sucesso.")

    # 3. Define o nome do arquivo com Timestamp
    timestamp = datetime.now().strftime('%Y-%m-%d_%H-%M-%S')
    zip_filename = f"backup_shahin_codigo_{timestamp}.zip"
    zip_path = os.path.join(backup_folder, zip_filename)

    print(f"‚è≥ Iniciando backup do c√≥digo: {zip_filename}...")

    # 4. Processo de Zipagem
    try:
        with zipfile.ZipFile(zip_path, 'w', zipfile.ZIP_DEFLATED) as zipf:
            for root, dirs, files in os.walk(project_root):
                # Remove pastas ignoradas da lista para n√£o entrar nelas
                dirs[:] = [d for d in dirs if d not in ignore_dirs]
                
                for file in files:
                    # Ignora arquivos espec√≠ficos
                    if file in ignore_files:
                        continue
                    
                    # Ignora extens√µes espec√≠ficas
                    if any(file.endswith(ext) for ext in ignore_extensions):
                        continue
                    
                    # Caminho completo do arquivo
                    file_path = os.path.join(root, file)
                    arcname = os.path.relpath(file_path, project_root)
                    
                    zipf.write(file_path, arcname)
        
        print(f"‚úÖ Backup de c√≥digo conclu√≠do com sucesso!")
        print(f"üìç Local: {zip_path}")
        
    except Exception as e:
        print(f"‚ùå Erro ao criar backup: {e}")

if __name__ == "__main__":
    create_backup()



##################################################

FILE: config.py
---------------
import os
from dotenv import load_dotenv

load_dotenv()

class Config:
    # Seguran√ßa: Usa vari√°vel de ambiente ou um fallback (nunca fixo em prod)
    SECRET_KEY = os.environ.get('SECRET_KEY', 'chave_mestra_v67_fix_final')
    
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    SQLALCHEMY_ENGINE_OPTIONS = {
        "pool_pre_ping": True,
        "pool_recycle": 300,
        "pool_size": 10
    }
    
    # --- CORRE√á√ÉO DE SEGURAN√áA (FASE 1) ---
    # Ativa prote√ß√£o contra CSRF (Cross-Site Request Forgery)
    # Importante: Certifique-se que seus formul√°rios HTML tenham {{ csrf_token() }}
    WTF_CSRF_ENABLED = True 
    
    # Configura√ß√µes de Cookie
    # Mude SESSION_COOKIE_SECURE para True apenas se estiver usando HTTPS (Produ√ß√£o)
    SESSION_COOKIE_SECURE = False 
    SESSION_COOKIE_HTTPONLY = True
    SESSION_COOKIE_SAMESITE = 'Lax'

class DevelopmentConfig(Config):
    DEBUG = True
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL', 'sqlite:///dev.db')

class ProductionConfig(Config):
    DEBUG = False
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL')

config_map = {
    'development': DevelopmentConfig,
    'production': ProductionConfig,
    'default': DevelopmentConfig
}





##################################################

FILE: requirements.txt
----------------------
flask
flask-sqlalchemy
psycopg2-binary
gunicorn
flask-login
werkzeug
pypdf
requests
python-dotenv
Flask-WTF
email_validator
Flask-Migrate
reportlab
google-cloud-aiplatform
thefuzz
google-cloud-storage
pytz
itsdangerous
google-cloud-vision==3.4.4
pandas
openpyxl
pywebpush


##################################################

FILE: restore_backup.py
-----------------------
import os
import zipfile
import glob
import shutil

def restaurar_backup_recente():
    pasta_backups = 'backups'
    diretorio_projeto = '.' # Raiz do projeto

    # 1. Localiza todos os arquivos .zip na pasta de backups
    arquivos_zip = glob.glob(os.path.join(pasta_backups, '*.zip'))

    if not arquivos_zip:
        print(f"‚ùå Erro: Nenhum arquivo .zip encontrado na pasta '{pasta_backups}'.")
        return

    # 2. Encontra o arquivo mais recente baseado na data de modifica√ß√£o
    backup_recente = max(arquivos_zip, key=os.path.getmtime)
    print(f"üì¶ Backup identificado: {backup_recente}")

    try:
        # 3. Descompacta o backup
        print(f"‚è≥ Restaurando arquivos... isso pode substituir arquivos existentes.")
        with zipfile.ZipFile(backup_recente, 'r') as zip_ref:
            # Extrai tudo para a raiz do projeto
            zip_ref.extractall(diretorio_projeto)
        
        print(f"‚úÖ Sucesso! O projeto foi restaurado para a vers√£o de: {backup_recente}")
        print("üöÄ Agora voc√™ pode rodar o comando de deploy novamente.")

    except Exception as e:
        print(f"‚ùå Ocorreu um erro durante a restaura√ß√£o: {e}")

if __name__ == "__main__":
    restaurar_backup_recente()



##################################################

FILE: run.py
------------
from app import app

if __name__ == "__main__":
    app.run(debug=True)

##################################################

FILE: runtime.txt
-----------------
python-3.11.9

##################################################

FILE: app/__init__.py
---------------------
import os
import logging
from flask import Flask, render_template
from app.extensions import db, login_manager, csrf, migrate
from config import config_map
from werkzeug.middleware.proxy_fix import ProxyFix

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def create_app():
    app = Flask(__name__)
    
    env_name = os.environ.get('FLASK_ENV', 'default')
    app.config.from_object(config_map[env_name])
    
    db_url = app.config.get('SQLALCHEMY_DATABASE_URI')
    if db_url and db_url.startswith("postgres://"):
        app.config['SQLALCHEMY_DATABASE_URI'] = db_url.replace("postgres://", "postgresql://", 1)
    
    app.wsgi_app = ProxyFix(app.wsgi_app, x_for=1, x_proto=1, x_host=1, x_prefix=1)
    
    db.init_app(app)
    login_manager.init_app(app)
    csrf.init_app(app)
    migrate.init_app(app, db)
    
    login_manager.login_view = 'auth.login'

    # --- CORRE√á√ÉO: USER LOADER ---
    @login_manager.user_loader
    def load_user(user_id):
        from app.models import User
        return User.query.get(int(user_id))

    @app.context_processor
    def inject_permissions():
        from app.utils import has_permission
        return dict(has_permission=has_permission)

    # --- INTERCETORES DE ERRO GLOBAIS ---
    @app.errorhandler(404)
    def page_not_found(e):
        return render_template('errors/404.html'), 404

    @app.errorhandler(403)
    def forbidden(e):
        return render_template('errors/403.html'), 403

    @app.errorhandler(500)
    def internal_server_error(e):
        return render_template('errors/500.html'), 500

    with app.app_context():
        from app.auth.routes import auth_bp
        from app.admin.routes import admin_bp
        from app.ponto.routes import ponto_bp
        from app.estoque.routes import estoque_bp
        from app.documentos.routes import documentos_bp
        from app.main.routes import main_bp

        app.register_blueprint(auth_bp)
        app.register_blueprint(admin_bp)
        app.register_blueprint(ponto_bp)
        app.register_blueprint(estoque_bp)
        app.register_blueprint(documentos_bp)
        app.register_blueprint(main_bp)

    # --- COMANDO DE SEEDING ISOLADO E LIMPO (FASE 3) ---
    @app.cli.command("setup-db")
    def setup_db():
        """Comando manual para criar tabelas e utilizadores padr√£o."""
        with app.app_context():
            try:
                db.create_all()
                
                from app.models import User
                
                # GEST√ÉO MASTER
                cpf_master = '50097952800'
                master = User.query.filter_by(username=cpf_master).first()
                if not master:
                    m = User(username=cpf_master, cpf=cpf_master, real_name='Thaynara Master', role='Master', is_first_access=False, permissions="ALL", salario=0.0)
                    senha_master = os.environ.get('MASTER_PASSWORD', '1855')
                    m.set_password(senha_master)
                    db.session.add(m)
                else:
                    master.role = 'Master'
                    master.permissions = "ALL"

                # GEST√ÉO TERMINAL
                term = User.query.filter_by(username='12345678900').first()
                if not term:
                    t = User(username='12345678900', real_name='Terminal de Ponto', role='Terminal', is_first_access=False, cpf='12345678900', salario=0.0)
                    senha_terminal = os.environ.get('TERMINAL_PASSWORD', 'terminal1234')
                    t.set_password(senha_terminal)
                    db.session.add(t)
                
                db.session.commit()
                print(">>> BANCO DE DADOS E UTILIZADORES CONFIGURADOS COM SUCESSO <<<")
                logger.info(">>> BOOT DO BANCO DE DADOS OK <<<")
            except Exception as e:
                print(f"Erro ao configurar DB: {e}")
                logger.error(f"Erro no boot do DB: {e}")

    return app

app = create_app()



##################################################

FILE: app/extensions.py
-----------------------
from flask_sqlalchemy import SQLAlchemy
from flask_login import LoginManager
from flask_wtf.csrf import CSRFProtect
from flask_migrate import Migrate

db = SQLAlchemy()
login_manager = LoginManager()
csrf = CSRFProtect()
migrate = Migrate()


##################################################

FILE: app/utils.py
------------------
from datetime import datetime, timedelta, time
import pytz
import unicodedata
import re
import hashlib
import os
import json
from functools import wraps
from flask import abort, redirect, url_for, flash, request
from flask_login import current_user

# Tenta importar o motor Push (se n√£o estiver instalado, o sistema n√£o quebra, apenas guarda no sininho)
try:
    from pywebpush import webpush, WebPushException
except ImportError:
    webpush = None

# --- FUN√á√ÉO CENTRALIZADA DE TEMPO (BLINDADA) ---
def get_brasil_time():
    """Retorna o hor√°rio atual no fuso de Bras√≠lia de forma exata e blindada."""
    fuso_br = pytz.timezone('America/Sao_Paulo')
    return datetime.now(fuso_br).replace(tzinfo=None)

# --- UTILIT√ÅRIOS DE TEXTO E DATA ---

def remove_accents(txt):
    if not txt: return ""
    return "".join(c for c in unicodedata.normalize('NFD', txt) if unicodedata.category(c) != 'Mn')

def limpar_nome(txt):
    """
    Normaliza√ß√£o Agressiva para IA.
    Remove acentos, preposi√ß√µes e espa√ßos extras.
    """
    if not txt: return ""
    txt = remove_accents(txt).upper().strip()
    stopwords = [" DE ", " DA ", " DO ", " DOS ", " DAS ", " E "]
    for word in stopwords:
        txt = txt.replace(word, " ")
    return " ".join(txt.split())

def gerar_login_automatico(nome_completo):
    """Gera login base (primeiro nome) para novos usu√°rios."""
    if not nome_completo: return "user"
    partes = nome_completo.split()
    primeiro_nome = remove_accents(partes[0]).lower()
    return re.sub(r'[^a-z]', '', primeiro_nome)

def data_por_extenso(data_obj):
    meses = {1:'Janeiro', 2:'Fevereiro', 3:'Mar√ßo', 4:'Abril', 5:'Maio', 6:'Junho', 
             7:'Julho', 8:'Agosto', 9:'Setembro', 10:'Outubro', 11:'Novembro', 12:'Dezembro'}
    return f"{data_obj.day} de {meses[data_obj.month]} de {data_obj.year}"

# --- C√ÅLCULOS DE PONTO (ESSENCIAIS) ---

def time_to_minutes(t):
    if not t: return 0
    if isinstance(t, str):
        try: h, m = map(int, t.split(':')); return h * 60 + m
        except: return 0
    return t.hour * 60 + t.minute

def format_minutes_to_hm(total_minutes):
    sinal = "" if total_minutes >= 0 else "-"
    total_minutes = abs(total_minutes)
    h = total_minutes // 60
    m = total_minutes % 60
    return f"{sinal}{h:02d}:{m:02d}"

def calcular_dia(user_id, data_ref):
    """Calcula o saldo de horas e status do dia para o m√≥dulo de Ponto."""
    from app.extensions import db
    from app.models import User, PontoRegistro, PontoResumo
    
    user = User.query.get(user_id)
    if not user: return

    registros = PontoRegistro.query.filter_by(user_id=user_id, data_registro=data_ref).order_by(PontoRegistro.hora_registro).all()
    
    meta = user.carga_horaria if user.carga_horaria else 528
    
    if user.escala == '5x2' and data_ref.weekday() >= 5: meta = 0
    elif user.escala == '12x36' and user.data_inicio_escala:
        dias_diff = (data_ref - user.data_inicio_escala).days
        if dias_diff % 2 != 0: meta = 0
        else: meta = 720
            
    trab = 0
    for i in range(0, len(registros), 2):
        if i + 1 < len(registros):
            entrada = time_to_minutes(registros[i].hora_registro)
            saida = time_to_minutes(registros[i+1].hora_registro)
            trab += (saida - entrada)
            
    saldo = trab - meta
    
    status = "OK"
    if not registros:
        status = "Falta" if meta > 0 else "Folga"
    elif len(registros) % 2 != 0:
        status = "Incompleto"
    elif saldo > 10:
        status = "Hora Extra"
    elif saldo < -10:
        status = "D√©bito" if meta > 0 else "Extra" 
        
    resumo = PontoResumo.query.filter_by(user_id=user_id, data_referencia=data_ref).first()
    if not resumo:
        resumo = PontoResumo(user_id=user_id, data_referencia=data_ref)
        db.session.add(resumo)
    
    resumo.minutos_trabalhados = trab
    resumo.minutos_esperados = meta
    resumo.minutos_saldo = saldo
    resumo.status_dia = status
    
    try: db.session.commit()
    except: db.session.rollback()

# --- SISTEMA DE AUDITORIA E PERMISS√ïES ---

def calcular_hash_arquivo(conteudo_bytes):
    if not conteudo_bytes: return None
    return hashlib.sha256(conteudo_bytes).hexdigest()

def get_client_ip():
    if request.headers.getlist("X-Forwarded-For"):
        return request.headers.getlist("X-Forwarded-For")[0]
    return request.remote_addr

def has_permission(permission_name):
    if not current_user.is_authenticated: return False
    if current_user.username == '50097952800': return True
    if not current_user.permissions: return False
    user_perms = [p.strip().upper() for p in current_user.permissions.split(',')]
    return permission_name.upper() in user_perms

def permission_required(permission_name):
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            if not has_permission(permission_name):
                flash(f'Acesso Negado: Necessita da permiss√£o {permission_name}.', 'error')
                return redirect(url_for('main.dashboard'))
            return f(*args, **kwargs)
        return decorated_function
    return decorator

def master_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not current_user.is_authenticated or (current_user.role != 'Master' and current_user.username != '50097952800'):
            flash('Acesso n√£o autorizado.', 'error')
            return redirect(url_for('main.dashboard'))
        return f(*args, **kwargs)
    return decorated_function

# ============================================================================
# FASE 4: O MOTOR DE NOTIFICA√á√ïES (SININHO + PUSH NATIVO NO ECR√É)
# ============================================================================
def enviar_notificacao(user_id, mensagem, link=None):
    """Envia um alerta interno para o Sininho do utilizador e um Push para o telem√≥vel."""
    from app.extensions import db
    from app.models import Notificacao, PushSubscription
    
    # 1. Guarda a notifica√ß√£o na Caixa de Entrada (Sininho) do sistema
    try:
        nova_notif = Notificacao(
            user_id=user_id,
            mensagem=mensagem,
            link=link,
            lida=False,
            data_criacao=get_brasil_time()
        )
        db.session.add(nova_notif)
        db.session.commit()
    except Exception as e:
        db.session.rollback()
        print(f"[Shahin Push] Erro ao salvar notifica√ß√£o no banco: {e}")
        return False

    # 2. Dispara o Push Nativo para acordar o telem√≥vel do funcion√°rio
    if not webpush:
        print("[Shahin Push] Aviso: Biblioteca 'pywebpush' n√£o instalada. Apenas notifica√ß√£o web gerada.")
        return True # Retorna True porque salvou no sininho com sucesso

    # Puxa a chave privada de seguran√ßa que vamos configurar no Cloud Run
    VAPID_PRIVATE_KEY = os.environ.get('VAPID_PRIVATE_KEY')
    VAPID_CLAIM_EMAIL = 'mailto:contato@shahin.com.br' # Um email padr√£o obrigat√≥rio pelas regras da Web

    if not VAPID_PRIVATE_KEY:
        print("[Shahin Push] Aviso: VAPID_PRIVATE_KEY n√£o configurada no ambiente. Push n√£o disparado.")
        return True

    # Procura todos os telem√≥veis autorizados deste funcion√°rio
    subs = PushSubscription.query.filter_by(user_id=user_id).all()
    if not subs:
        return True # O utilizador ainda n√£o clicou em "Ativar Alertas"

    payload = json.dumps({
        "title": "Shahin Gest√£o",
        "body": mensagem,
        "url": link or "/"
    })

    for sub in subs:
        try:
            sub_info = {
                "endpoint": sub.endpoint,
                "keys": {
                    "p256dh": sub.p256dh,
                    "auth": sub.auth
                }
            }
            # A Magia Acontece Aqui: Disparo encriptado!
            webpush(
                subscription_info=sub_info,
                data=payload,
                vapid_private_key=VAPID_PRIVATE_KEY,
                vapid_claims={"sub": VAPID_CLAIM_EMAIL}
            )
        except WebPushException as e:
            print(f"[Shahin Push] Falha ao enviar para telem√≥vel: {e}")
            # Se a Google/Apple disserem que o telem√≥vel desinstalou o app (Erro 410), n√≥s limpamos a morada
            if e.response is not None and e.response.status_code == 410:
                db.session.delete(sub)
                db.session.commit()
        except Exception as e:
            print(f"[Shahin Push] Erro inesperado no disparo: {e}")

    return True



##################################################

FILE: app/admin/__init__.py
---------------------------
# M√≥dulo admin

##################################################

FILE: app/admin/routes.py
-------------------------
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from sqlalchemy import func, text
import io
import logging
import random
import string
from datetime import time, datetime, date
import pandas as pd 

# Importa√ß√µes do Projeto - Adicionadas TODAS as tabelas dependentes para limpeza
from app.extensions import db
from app.models import User, PreCadastro, PontoResumo, PontoAjuste, PontoRegistro, Holerite, Recibo, AssinaturaDigital, Atestado, PeriodoAquisitivo, SolicitacaoAusencia, SolicitacaoUniforme, Notificacao, PushSubscription
from app.utils import (
    calcular_dia, 
    get_brasil_time, 
    format_minutes_to_hm, 
    time_to_minutes,
    gerar_login_automatico,
    master_required,
    permission_required
)

admin_bp = Blueprint('admin', __name__, template_folder='templates', url_prefix='/admin')
logger = logging.getLogger(__name__)

# --- GEST√ÉO DE UTILIZADORES ---

@admin_bp.route('/usuarios/novo', methods=['GET', 'POST'])
@login_required
@permission_required('USUARIOS')
def novo_usuario():
    # Busca todos os utilizadores para listar como poss√≠veis gestores no formul√°rio
    gestores = User.query.filter(User.username != '12345678900', User.username != 'terminal').order_by(User.real_name).all()
    
    if request.method == 'POST':
        try:
            real_name = request.form.get('real_name')
            cpf = request.form.get('cpf', '').replace('.', '').replace('-', '').strip()
            
            if not real_name or not cpf:
                flash('Nome e CPF s√£o obrigat√≥rios.', 'error')
                return redirect(url_for('admin.novo_usuario'))

            if User.query.filter_by(cpf=cpf).first() or PreCadastro.query.filter_by(cpf=cpf).first():
                flash('CPF j√° cadastrado!', 'error')
                return redirect(url_for('admin.novo_usuario'))

            dt_adm_str = request.form.get('data_admissao')
            dt_admissao = datetime.strptime(dt_adm_str, '%Y-%m-%d').date() if dt_adm_str else None

            carga_hm = request.form.get('carga_horaria') or '08:48'
            carga_minutos = time_to_minutes(carga_hm)
            intervalo_min = int(request.form.get('tempo_intervalo') or 60)
            
            # Captura a Estrutura Organizacional
            cpf_gestor = request.form.get('cpf_gestor', '').replace('.', '').replace('-', '').strip()

            novo_pre = PreCadastro(
                cpf=cpf,
                nome_previsto=real_name,
                cargo=request.form.get('role'),
                departamento=request.form.get('departamento'),
                cpf_gestor=cpf_gestor if cpf_gestor else None,
                salario=float(request.form.get('salario') or 0),
                razao_social=request.form.get('razao_social'),
                cnpj=request.form.get('cnpj'),
                data_admissao=dt_admissao,
                carga_horaria=carga_minutos,
                tempo_intervalo=intervalo_min,
                inicio_jornada_ideal=request.form.get('h_ent') or '08:00',
                escala=request.form.get('escala'),
                data_inicio_escala=request.form.get('dt_escala') if request.form.get('dt_escala') else None
            )
            
            db.session.add(novo_pre)
            db.session.commit()
            return render_template('admin/sucesso_usuario.html', nome_real=real_name, cpf=cpf)
            
        except Exception as e:
            db.session.rollback()
            flash(f'Erro interno: {str(e)}', 'error')
            
    return render_template('admin/novo_usuario.html', gestores=gestores)

@admin_bp.route('/usuarios')
@login_required
def gerenciar_usuarios():
    from app.utils import has_permission
    if not has_permission('USUARIOS'):
        flash('Sem acesso √† gest√£o de utilizadores.', 'error')
        return redirect(url_for('main.dashboard'))

    page = request.args.get('page', 1, type=int)
    users_pagination = User.query.filter(
        User.username != '12345678900', 
        User.username != 'terminal'
    ).order_by(User.real_name).paginate(page=page, per_page=15, error_out=False)
    
    pendentes = PreCadastro.query.order_by(PreCadastro.nome_previsto).all()
    
    return render_template('admin/admin_usuarios.html', users_pagination=users_pagination, pendentes=pendentes)

@admin_bp.route('/liberar-acesso/excluir/<int:id>', methods=['GET'])
@login_required
@permission_required('USUARIOS')
def excluir_pre_cadastro(id):
    pre_cadastro = PreCadastro.query.get_or_404(id)
    try:
        nome = pre_cadastro.nome_previsto
        db.session.delete(pre_cadastro)
        db.session.commit()
        flash(f'O pr√©-cadastro de {nome} foi removido com sucesso da fila.', 'success')
    except Exception as e:
        db.session.rollback()
        flash(f'Erro ao tentar remover: {str(e)}', 'error')
    
    return redirect(url_for('admin.gerenciar_usuarios'))

@admin_bp.route('/usuarios/editar/<int:id>', methods=['GET', 'POST'])
@login_required
def editar_usuario(id):
    from app.utils import has_permission
    if not has_permission('USUARIOS'):
        flash('Sem acesso.', 'error')
        return redirect(url_for('main.dashboard'))

    user = User.query.get_or_404(id)
    user_carga_hm = format_minutes_to_hm(user.carga_horaria or 528)
    gestores = User.query.filter(User.username != '12345678900', User.username != 'terminal', User.id != user.id).order_by(User.real_name).all()
    
    if request.method == 'POST':
        acao = request.form.get('acao')
        try:
            if acao == 'excluir':
                if user.username == '50097952800' or user.username == 'Thaynara':
                    flash('Imposs√≠vel excluir Master.', 'error')
                else: 
                    # 1. Liberta os funcion√°rios que eram subordinados dele
                    subordinados = User.query.filter_by(gestor_id=user.id).all()
                    for sub in subordinados: sub.gestor_id = None
                    
                    # 2. Limpeza Profunda: Apaga TODAS as depend√™ncias do funcion√°rio no banco
                    AssinaturaDigital.query.filter_by(user_id=user.id).delete()
                    Atestado.query.filter_by(user_id=user.id).delete()
                    Notificacao.query.filter_by(user_id=user.id).delete()
                    PushSubscription.query.filter_by(user_id=user.id).delete()
                    PontoAjuste.query.filter_by(user_id=user.id).delete()
                    PeriodoAquisitivo.query.filter_by(user_id=user.id).delete()
                    SolicitacaoAusencia.query.filter_by(user_id=user.id).delete()
                    SolicitacaoUniforme.query.filter_by(user_id=user.id).delete()
                    PontoRegistro.query.filter_by(user_id=user.id).delete()
                    PontoResumo.query.filter_by(user_id=user.id).delete()
                    Holerite.query.filter_by(user_id=user.id).delete()
                    Recibo.query.filter_by(user_id=user.id).delete()
                    
                    # 3. Finalmente, apaga o funcion√°rio
                    db.session.delete(user)
                    db.session.commit()
                    flash('Utilizador e todos os seus dados foram exclu√≠dos com sucesso.', 'success')
                    return redirect(url_for('admin.gerenciar_usuarios'))

            elif acao == 'salvar':
                user.real_name = request.form.get('real_name')
                user.role = request.form.get('role')
                user.departamento = request.form.get('departamento')
                gestor_req = request.form.get('gestor_id')
                user.gestor_id = int(gestor_req) if gestor_req else None
                user.salario = float(request.form.get('salario') or 0)
                user.razao_social_empregadora = request.form.get('razao_social')
                user.cnpj_empregador = request.form.get('cnpj')
                
                dt_adm_str = request.form.get('data_admissao')
                if dt_adm_str: user.data_admissao = datetime.strptime(dt_adm_str, '%Y-%m-%d').date()
                
                user.carga_horaria = time_to_minutes(request.form.get('carga_horaria'))
                user.tempo_intervalo = int(request.form.get('tempo_intervalo') or 60)
                user.inicio_jornada_ideal = request.form.get('h_ent')
                user.escala = request.form.get('escala')
                if request.form.get('dt_escala'): user.data_inicio_escala = request.form.get('dt_escala')

                if user.username != '50097952800' and user.username != 'Thaynara':
                    lista_perms = request.form.getlist('perm_keys')
                    user.permissions = ",".join(lista_perms)
                
                db.session.commit()
                flash('Dados atualizados com sucesso.', 'success')
                return redirect(url_for('admin.gerenciar_usuarios'))
                
            elif acao == 'resetar_senha':
                # RESET DE SENHA SEGURO
                senha_temporaria = ''.join(random.choices(string.ascii_uppercase + string.digits, k=6))
                user.set_password(senha_temporaria)
                user.is_first_access = True
                db.session.commit()
                flash(f'Senha resetada com sucesso! A nova senha de acesso √©: {senha_temporaria}', 'success')
                
        except Exception as e:
            db.session.rollback()
            flash(f'Erro: {e}', 'error')

    return render_template('admin/editar_usuario.html', user=user, carga_hm=user_carga_hm, gestores=gestores)

@admin_bp.route('/solicitacoes', methods=['GET', 'POST'])
@login_required
@permission_required('PONTO') 
def admin_solicitacoes():
    if request.method == 'POST':
        solic = PontoAjuste.query.get(request.form.get('solic_id'))
        if solic:
            if request.form.get('decisao') == 'aprovar':
                solic.status = 'Aprovado'
                try:
                    if solic.tipo_solicitacao == 'Edicao' and solic.ponto_original_id:
                        reg = PontoRegistro.query.get(solic.ponto_original_id)
                        if reg:
                            h, m = map(int, solic.novo_horario.split(':'))
                            reg.hora_registro = time(h, m)
                            reg.tipo = solic.tipo_batida
                    elif solic.tipo_solicitacao == 'Inclusao':
                        h, m = map(int, solic.novo_horario.split(':'))
                        novo_ponto = PontoRegistro(user_id=solic.user_id, data_registro=solic.data_referencia, hora_registro=time(h, m), tipo=solic.tipo_batida, latitude='Ajuste Manual', longitude='Aprovado pelo Master')
                        db.session.add(novo_ponto)
                    elif solic.tipo_solicitacao == 'Exclusao' and solic.ponto_original_id:
                        reg = PontoRegistro.query.get(solic.ponto_original_id)
                        if reg: db.session.delete(reg)

                    db.session.flush()
                    calcular_dia(solic.user_id, solic.data_referencia)
                    flash('Aprovado e refletido no espelho.', 'success')
                except Exception as e:
                    db.session.rollback()
                    flash(f'Erro ao aplicar ajuste: {e}', 'error')
                    return redirect(url_for('admin.admin_solicitacoes'))
            else:
                solic.status = 'Reprovado'
                solic.motivo_reprovacao = request.form.get('motivo_repro')
                flash('Reprovado.', 'warning')
            db.session.commit()
            
    extras = {}
    solicitacoes_pendentes = PontoAjuste.query.filter_by(status='Pendente').order_by(PontoAjuste.created_at.desc()).all()
    for s in solicitacoes_pendentes:
        if s.ponto_original_id:
            p_original = PontoRegistro.query.get(s.ponto_original_id)
            if p_original: extras[s.id] = p_original.hora_registro.strftime('%H:%M')
    return render_template('admin/solicitacoes.html', solicitacoes=solicitacoes_pendentes, extras=extras)

@admin_bp.route('/ferramentas/limpeza', methods=['GET', 'POST'])
@login_required
@master_required 
def admin_limpeza():
    if request.method == 'POST':
        acao = request.form.get('acao')
        try:
            if acao == 'limpar_testes_ponto': 
                PontoRegistro.query.delete()
                PontoResumo.query.delete()
            elif acao == 'limpar_holerites': 
                Holerite.query.delete()
                Recibo.query.delete()
            elif acao == 'limpar_usuarios_nao_master': 
                User.query.filter(User.username != '50097952800', User.username != 'Thaynara').delete()
                PreCadastro.query.delete()
            db.session.commit()
            return redirect(url_for('admin.admin_limpeza'))
        except: db.session.rollback()
    return render_template('admin/admin_limpeza.html')

@admin_bp.route('/usuarios/importar-excel', methods=['POST'])
@login_required
@permission_required('USUARIOS')
def importar_excel_usuarios():
    if 'arquivo_excel' not in request.files:
        flash('Nenhum arquivo enviado.', 'error')
        return redirect(url_for('admin.gerenciar_usuarios'))
    
    file = request.files['arquivo_excel']
    if file.filename == '':
        flash('Nenhum arquivo selecionado.', 'error')
        return redirect(url_for('admin.gerenciar_usuarios'))
        
    if not file.filename.endswith(('.xlsx', '.xls')):
        flash('Formato inv√°lido. Por favor, envie uma planilha real do Excel (.xlsx ou .xls)', 'error')
        return redirect(url_for('admin.gerenciar_usuarios'))

    try:
        df = pd.read_excel(file)
        df = df.fillna('') 
        df.columns = [str(c).strip().lower() for c in df.columns] 
        
        records = df.to_dict('records') 
        sucesso, falhas = 0, 0
        
        for row in records:
            nome = str(row.get('nome', '')).strip()
            
            cpf_raw = str(row.get('cpf', '')).replace('.', '').replace('-', '').strip()
            if cpf_raw.endswith('.0'): cpf_raw = cpf_raw[:-2]
            cpf = cpf_raw
            
            cargo = str(row.get('cargo', '')).strip()
            
            departamento = str(row.get('departamento', '')).strip()
            cpf_gestor_raw = str(row.get('cpf_gestor', '')).replace('.', '').replace('-', '').strip()
            if cpf_gestor_raw.endswith('.0'): cpf_gestor_raw = cpf_gestor_raw[:-2]
            
            if not nome or not cpf:
                falhas += 1
                continue
                
            if User.query.filter_by(cpf=cpf).first() or PreCadastro.query.filter_by(cpf=cpf).first():
                falhas += 1
                continue

            dt_admissao = None
            dt_adm_raw = row.get('data_admissao', '')
            if dt_adm_raw:
                if isinstance(dt_adm_raw, (datetime, date)):
                    dt_admissao = dt_adm_raw if isinstance(dt_adm_raw, date) else dt_adm_raw.date()
                elif isinstance(dt_adm_raw, pd.Timestamp):
                    dt_admissao = dt_adm_raw.date()
                else:
                    dt_adm_str = str(dt_adm_raw).strip()
                    if ' ' in dt_adm_str: dt_adm_str = dt_adm_str.split(' ')[0]
                    try:
                        if '/' in dt_adm_str: dt_admissao = datetime.strptime(dt_adm_str, '%d/%m/%Y').date()
                        else: dt_admissao = datetime.strptime(dt_adm_str, '%Y-%m-%d').date()
                    except ValueError: pass

            try: salario = float(row.get('salario', 0))
            except: salario = 0.0

            escala = str(row.get('escala', 'Livre')).strip()
            dt_escala = None
            if escala == '12x36':
                dt_esc_raw = row.get('data_escala', '')
                if dt_esc_raw:
                    if isinstance(dt_esc_raw, (datetime, date)):
                        dt_escala = dt_esc_raw if isinstance(dt_esc_raw, date) else dt_esc_raw.date()
                    elif isinstance(dt_esc_raw, pd.Timestamp):
                        dt_escala = dt_esc_raw.date()
                    else:
                        dt_esc_str = str(dt_esc_raw).strip()
                        if ' ' in dt_esc_str: dt_esc_str = dt_esc_str.split(' ')[0]
                        try:
                            if '/' in dt_esc_str: dt_escala = datetime.strptime(dt_esc_str, '%d/%m/%Y').date()
                            else: dt_escala = datetime.strptime(dt_esc_str, '%Y-%m-%d').date()
                        except ValueError: pass

            carga_raw = row.get('carga_horaria', '08:48')
            if isinstance(carga_raw, time): carga_hm = carga_raw.strftime('%H:%M')
            else: carga_hm = str(carga_raw).strip() or '08:48'
            carga_min = time_to_minutes(carga_hm)
            
            try: intervalo = int(float(row.get('intervalo', 60)))
            except: intervalo = 60
            
            entrada_raw = row.get('entrada_ideal', '08:00')
            if isinstance(entrada_raw, time): entrada = entrada_raw.strftime('%H:%M')
            else: entrada = str(entrada_raw).strip() or '08:00'
            
            # PROBLEMA 3: Lendo Raz√£o Social e CNPJ diretamente da planilha
            razao_social_excel = str(row.get('razao_social', '')).strip()
            cnpj_excel = str(row.get('cnpj', '')).strip()

            novo_pre = PreCadastro(
                cpf=cpf,
                nome_previsto=nome,
                cargo=cargo,
                departamento=departamento if departamento else None,
                cpf_gestor=cpf_gestor_raw if cpf_gestor_raw else None,
                salario=salario,
                data_admissao=dt_admissao,
                escala=escala,
                data_inicio_escala=dt_escala,
                carga_horaria=carga_min,
                tempo_intervalo=intervalo,
                inicio_jornada_ideal=entrada,
                # Se n√£o vier na planilha, usa o padr√£o da LA SHAHIN
                razao_social=razao_social_excel if razao_social_excel else "LA SHAHIN SERVI√áOS DE SEGURAN√áA LTDA",
                cnpj=cnpj_excel if cnpj_excel else "50.537.235/0001-95"
            )
            db.session.add(novo_pre)
            sucesso += 1

        db.session.commit()
        if sucesso > 0:
            flash(f'Importa√ß√£o conclu√≠da com sucesso: {sucesso} registos lidos do Excel. {falhas} ignorados.', 'success')
        else:
            flash('Nenhum registro v√°lido encontrado. Verifique se a planilha tem os t√≠tulos das colunas corretos.', 'error')
            
    except Exception as e:
        db.session.rollback()
        flash(f'Erro ao ler arquivo do Excel: {str(e)}', 'error')

    return redirect(url_for('admin.gerenciar_usuarios'))



##################################################

FILE: app/admin/templates/admin/admin_importar_csv.html
-------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="mb-6"><h2 class="text-2xl font-bold text-slate-800">Importar em Massa (CSV)</h2><p class="text-sm text-slate-500">Cadastre m√∫ltiplos funcion√°rios de uma vez.</p></div>

    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-8 mb-6">
        <form action="/admin/usuarios/importar-csv" method="POST" enctype="multipart/form-data" class="space-y-6">
            <div>
                <label class="label-pro">Arquivo CSV ou Excel (.csv)</label>
                <input type="file" name="arquivo_csv" accept=".csv" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" required>
            </div>
            
            <div class="bg-slate-50 p-4 rounded-lg text-xs text-slate-500 border border-slate-200">
                <p class="font-bold mb-2">Formato Obrigat√≥rio do CSV (Separado por ponto e v√≠rgula ';')</p>
                <code class="block bg-white p-2 rounded border border-slate-200">Nome;CPF;Cargo;Salario;Entrada;Saida</code>
                <p class="mt-2">Exemplo:</p>
                <code class="block bg-white p-2 rounded border border-slate-200">Jo√£o Silva;12345678900;Assistente;2500,00;08:00;17:00</code>
            </div>

            <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-lg shadow-md transition">PROCESSAR ARQUIVO</button>
        </form>
    </div>
</div>
{% endblock %}



##################################################

FILE: app/admin/templates/admin/admin_limpeza.html
--------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-slate-800">Limpeza de Pr√©-Lan√ßamento</h2>
        <p class="text-slate-500 text-sm">Use estas ferramentas para apagar os dados de teste antes de importar os funcion√°rios reais.</p>
    </div>

    <div class="space-y-4">
        <div class="bg-white p-6 rounded-xl border border-red-100 shadow-sm">
            <h3 class="font-bold text-red-600 mb-2">1. Resetar Funcion√°rios</h3>
            <p class="text-xs text-slate-500 mb-4">Apaga todos os funcion√°rios cadastrados e pr√©-cadastros (Exceto Thaynara Master).</p>
            <form action="" method="POST">
                <input type="hidden" name="acao" value="limpar_usuarios_nao_master">
                <button type="submit" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg text-sm font-bold border border-red-200 hover:bg-red-100 transition w-full" onclick="return confirm('ATEN√á√ÉO: Isso apagar√° todos os funcion√°rios. Confirma?')">APAGAR USU√ÅRIOS DE TESTE</button>
            </form>
        </div>

        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
            <h3 class="font-bold text-slate-800 mb-2">2. Limpar Holerites</h3>
            <p class="text-xs text-slate-500 mb-4">Apaga todos os PDFs salvos no banco de dados para liberar espa√ßo.</p>
            <form action="" method="POST">
                <input type="hidden" name="acao" value="limpar_holerites">
                <button type="submit" class="bg-slate-50 text-slate-600 px-4 py-2 rounded-lg text-sm font-bold border border-slate-200 hover:bg-slate-100 transition w-full">LIMPAR PDFs</button>
            </form>
        </div>
        
        <a href="/admin/usuarios" class="block text-center text-sm text-blue-600 font-bold mt-6 underline">Voltar para Gerenciar Usu√°rios</a>
    </div>
</div>
{% endblock %}

##################################################

FILE: app/admin/templates/admin/admin_relatorio_folha.html
----------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6 flex justify-between items-center">
    <h2 class="text-2xl font-bold text-slate-800">Relat√≥rio de Folha</h2>
    <form action="/admin/relatorio-folha" method="POST" class="flex gap-2">
        <input type="month" name="mes_ref" value="{{ mes_ref }}" class="p-2 rounded-lg border border-slate-200 text-sm">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm">Filtrar</button>
    </form>
</div>

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <table class="w-full text-left text-sm">
        <thead class="bg-slate-50 text-slate-400 font-bold text-xs uppercase border-b border-slate-100">
            <tr>
                <th class="px-6 py-4">Funcion√°rio</th>
                <th class="px-6 py-4">Cargo</th>
                <th class="px-6 py-4 text-center">Saldo do M√™s</th>
                <th class="px-6 py-4 text-right">A√ß√£o</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
            {% for item in relatorio %}
            <tr class="hover:bg-slate-50 transition">
                <td class="px-6 py-4">
                    <!-- Drill-down: Link para o espelho do funcionario -->
                    <a href="/ponto/espelho?user_id={{ item.id }}&mes_ref={{ mes_ref }}" class="font-bold text-blue-600 hover:underline">
                        {{ item.nome }}
                    </a>
                </td>
                <td class="px-6 py-4 text-slate-500">{{ item.cargo }}</td>
                <td class="px-6 py-4 text-center font-mono font-bold {{ item.sinal }}">{{ item.saldo_formatado }}</td>
                <td class="px-6 py-4 text-right">
                    <a href="/ponto/espelho?user_id={{ item.id }}&mes_ref={{ mes_ref }}" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1 rounded-full transition">
                        Auditar Ponto
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

##################################################

FILE: app/admin/templates/admin/admin_usuarios.html
---------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold text-slate-800">Funcion√°rios</h2>
</div>

<div class="grid grid-cols-2 gap-4 mb-8">
    <a href="/admin/usuarios/novo" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-md text-center transition transform hover:-translate-y-1">
        <i class="fas fa-user-plus mr-2"></i> NOVO CADASTRO
    </a>
    <button onclick="document.getElementById('modalExcel').classList.remove('hidden')" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-md text-center transition transform hover:-translate-y-1">
        <i class="fas fa-file-excel mr-2"></i> IMPORTAR EXCEL
    </button>
</div>

<div class="mb-6">
    <input type="text" id="buscaFunc" onkeyup="filtrarTabela('buscaFunc', 'listaFunc')" placeholder="Pesquisar funcion√°rio nesta p√°gina..." class="w-full p-4 rounded-xl border border-slate-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
</div>

{% if pendentes %}
<div class="bg-yellow-50 border border-yellow-200 rounded-xl overflow-hidden mb-8 shadow-sm">
    <div class="px-6 py-4 border-b border-yellow-200 bg-yellow-100/50 flex justify-between items-center">
        <h3 class="font-bold text-yellow-800"><i class="fas fa-clock mr-2"></i> Aguardando Cadastro ({{ pendentes|length }})</h3>
    </div>
    <div class="divide-y divide-yellow-200/50">
        {% for p in pendentes %}
        <div class="px-6 py-4 flex items-center justify-between hover:bg-yellow-100/30 transition">
            <div>
                <div class="font-bold text-slate-800">{{ p.nome_previsto }}</div>
                <div class="text-xs font-mono text-slate-500">CPF: {{ p.cpf }}</div>
                <div class="text-[10px] text-slate-400 mt-1">{{ p.cargo }}</div>
            </div>
            <button type="button" onclick="confirmarAcao('Tem certeza que deseja remover {{ p.nome_previsto }} da lista de espera? Esta a√ß√£o n√£o pode ser desfeita.', '/admin/liberar-acesso/excluir/{{ p.id }}')" class="text-red-400 hover:text-red-600 p-2 cursor-pointer transition">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
        <h3 class="font-bold text-slate-700">Equipe Ativa</h3>
        <span class="text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded-full font-bold">{{ users_pagination.total }}</span>
    </div>
    
    <div class="divide-y divide-slate-100" id="listaFunc">
        {% for u in users_pagination.items %}
        <div class="px-6 py-4 flex items-center justify-between hover:bg-slate-50 transition group item-lista">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm bg-slate-100 text-slate-600">
                    {{ u.real_name[:2].upper() }}
                </div>
                <div>
                    <div class="font-bold text-slate-800 nome-item">{{ u.real_name }}</div>
                    <div class="text-xs text-slate-500">{{ u.role }}</div>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <span class="px-2 py-1 bg-emerald-100 text-emerald-700 text-[10px] font-bold uppercase rounded">Ativo</span>
                
                <a href="/admin/usuarios/editar/{{ u.id }}" class="w-8 h-8 flex items-center justify-center rounded-full text-slate-300 hover:bg-white hover:text-blue-600 hover:shadow border border-transparent hover:border-slate-200 transition">
                    <i class="fas fa-pencil-alt text-xs"></i>
                </a>
            </div>
        </div>
        {% else %}
        <div class="px-6 py-10 text-center text-slate-400 text-sm font-medium">
            Nenhum funcion√°rio encontrado nesta p√°gina.
        </div>
        {% endfor %}
    </div>
    
    {% if users_pagination.pages > 1 %}
    <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-between items-center">
        <span class="text-[11px] font-bold text-slate-500 uppercase tracking-wide">
            P√°gina {{ users_pagination.page }} de {{ users_pagination.pages }}
        </span>
        <div class="flex gap-2">
            {% if users_pagination.has_prev %}
            <a href="{{ url_for('admin.gerenciar_usuarios', page=users_pagination.prev_num) }}" class="px-4 py-2 rounded-lg border border-slate-200 bg-white text-slate-600 hover:bg-blue-50 hover:text-blue-600 font-bold text-xs transition shadow-sm">
                <i class="fas fa-chevron-left mr-1"></i> Anterior
            </a>
            {% else %}
            <button disabled class="px-4 py-2 rounded-lg border border-slate-200 bg-slate-50 text-slate-400 font-bold text-xs shadow-sm opacity-50 cursor-not-allowed">
                <i class="fas fa-chevron-left mr-1"></i> Anterior
            </button>
            {% endif %}

            {% if users_pagination.has_next %}
            <a href="{{ url_for('admin.gerenciar_usuarios', page=users_pagination.next_num) }}" class="px-4 py-2 rounded-lg border border-slate-200 bg-white text-slate-600 hover:bg-blue-50 hover:text-blue-600 font-bold text-xs transition shadow-sm">
                Pr√≥ximo <i class="fas fa-chevron-right ml-1"></i>
            </a>
            {% else %}
            <button disabled class="px-4 py-2 rounded-lg border border-slate-200 bg-slate-50 text-slate-400 font-bold text-xs shadow-sm opacity-50 cursor-not-allowed">
                Pr√≥ximo <i class="fas fa-chevron-right ml-1"></i>
            </button>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<div id="modalExcel" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden">
        <div class="bg-emerald-600 p-5 flex justify-between items-center text-white">
            <h3 class="font-bold text-lg"><i class="fas fa-file-excel mr-2"></i> Importar Planilha Excel</h3>
            <button onclick="document.getElementById('modalExcel').classList.add('hidden')" class="hover:text-emerald-200"><i class="fas fa-times text-xl"></i></button>
        </div>
        
        <form action="/admin/usuarios/importar-excel" method="POST" enctype="multipart/form-data" class="p-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <div class="mb-6 bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                <p class="text-xs text-emerald-800 mb-2 font-bold uppercase">Formato Exigido (.xlsx ou .xls)</p>
                <p class="text-[10px] text-emerald-700 font-mono bg-white p-2 rounded border border-emerald-200 mb-3 overflow-x-auto whitespace-nowrap">
                    Colunas: nome | cpf | cargo | departamento | cpf_gestor | data_admissao | salario | escala | data_escala | carga_horaria | intervalo | entrada_ideal
                </p>
                <ul class="text-[10px] text-emerald-600 space-y-1 list-disc list-inside">
                    <li>Pode importar a planilha original diretamente do Excel.</li>
                    <li><strong>nome e cpf</strong> s√£o as √∫nicas colunas estritamente obrigat√≥rias.</li>
                    <li>Os campos em branco ser√£o preenchidos com os padr√µes do sistema.</li>
                </ul>
            </div>

            <div class="mb-6">
                <label class="block w-full border-2 border-dashed border-slate-300 rounded-xl p-6 text-center cursor-pointer hover:border-emerald-500 hover:bg-emerald-50 transition group">
                    <i class="fas fa-cloud-upload-alt text-3xl text-slate-400 group-hover:text-emerald-500 mb-2"></i>
                    <p class="text-sm font-bold text-slate-600 group-hover:text-emerald-700">Clique para selecionar o arquivo Excel</p>
                    <input type="file" name="arquivo_excel" accept=".xlsx, .xls" required class="hidden" id="fileInput" onchange="document.getElementById('fileName').innerText = this.files[0].name">
                </label>
                <p id="fileName" class="text-center text-xs font-bold text-emerald-600 mt-2 h-4"></p>
            </div>

            <button type="submit" class="w-full bg-slate-900 hover:bg-emerald-600 text-white font-bold py-3.5 rounded-xl shadow-lg transition flex items-center justify-center gap-2">
                <i class="fas fa-file-import"></i> INICIAR IMPORTA√á√ÉO
            </button>
        </form>
    </div>
</div>

<script>
function filtrarTabela(inputId, listaId) {
    let input = document.getElementById(inputId);
    let filter = input.value.toUpperCase();
    let lista = document.getElementById(listaId);
    let itens = lista.getElementsByClassName('item-lista');
    for (let i = 0; i < itens.length; i++) {
        let nome = itens[i].getElementsByClassName('nome-item')[0];
        if (nome.innerHTML.toUpperCase().indexOf(filter) > -1) { itens[i].style.display = ""; } else { itens[i].style.display = "none"; }
    }
}
</script>
{% endblock %}



##################################################

FILE: app/admin/templates/admin/configuracoes.html
--------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-8">
    <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Configura√ß√µes do Sistema</h1>
    <p class="text-slate-500 text-sm">Gerencie a automa√ß√£o de cobran√ßas e seguran√ßa do Shahin Gest√£o.</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-2">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 border-b border-slate-100 bg-slate-50/50">
                <h3 class="font-bold text-slate-700 flex items-center gap-2">
                    <i class="fas fa-robot text-blue-500"></i> Agendamento de Cobran√ßas (Push)
                </h3>
            </div>
            <form method="POST" class="p-6 space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Dia de Cobran√ßa (Ponto)</label>
                        <input type="number" name="dia_ponto" value="{{ config.dia_cobranca_ponto }}" min="1" max="31" required
                               class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
                        <p class="text-[10px] text-slate-400 mt-1">Dia para alertar assinaturas de espelhos pendentes.</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Dia de Cobran√ßa (Folha)</label>
                        <input type="number" name="dia_holerite" value="{{ config.dia_cobranca_holerite }}" min="1" max="31" required
                               class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition">
                        <p class="text-[10px] text-slate-400 mt-1">Dia para alertar holerites e recibos do m√™s.</p>
                    </div>
                </div>

                <div class="pt-6 border-t border-slate-100">
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Token de Seguran√ßa (Cloud Scheduler)</label>
                    <div class="flex gap-2">
                        <input type="text" value="{{ config.token_seguranca_task }}" readonly
                               class="flex-1 px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 text-slate-400 font-mono text-xs">
                    </div>
                    <p class="text-[10px] text-amber-600 mt-2 italic font-medium">
                        <i class="fas fa-shield-alt mr-1"></i> Este token protege a rota de automa√ß√£o contra acessos externos.
                    </p>
                </div>

                <div class="flex justify-end pt-4">
                    <button type="submit" class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-200 transition-all active:scale-95">
                        Salvar Configura√ß√µes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="lg:col-span-1 space-y-6">
        <div class="bg-indigo-600 rounded-2xl p-6 text-white shadow-lg shadow-indigo-200">
            <i class="fas fa-info-circle text-2xl mb-4 opacity-50"></i>
            <h4 class="font-bold mb-2">Como funciona?</h4>
            <p class="text-xs leading-relaxed opacity-90">
                O Google Cloud Scheduler "acorda" o Shahin Gest√£o todos os dias √†s 09:00. <br><br>
                O sistema verifica as datas acima e dispara notifica√ß√µes autom√°ticas apenas para quem esqueceu de assinar os documentos.
            </p>
        </div>
    </div>
</div>
{% endblock %}



##################################################

FILE: app/admin/templates/admin/editar_usuario.html
---------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-lg mx-auto pb-20">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-bold text-slate-800">Editar Perfil</h2>
        <a href="/admin/usuarios" class="text-xs font-medium text-slate-500 hover:text-slate-800 transition">Voltar</a>
    </div>

    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <form id="form-edicao-usuario" action="/admin/usuarios/editar/{{ user.id }}" method="POST" class="p-8 space-y-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" id="acao_input" name="acao" value="salvar">
            
            <div class="space-y-4">
                <div>
                    <label class="label-pro">Nome Completo</label>
                    <input type="text" name="real_name" value="{{ user.real_name }}" class="input-pro">
                </div>
                
                <div class="bg-purple-50 p-4 rounded-lg border border-purple-100">
                    <p class="text-xs font-bold text-purple-800 uppercase mb-3 flex items-center gap-2"><i class="fas fa-sitemap"></i> Estrutura Organizacional</p>
                    <div class="space-y-3">
                        <div>
                            <label class="label-pro text-purple-700">Departamento / Equipe</label>
                            <input type="text" name="departamento" class="input-pro border-purple-200 focus:border-purple-500" value="{{ user.departamento or '' }}" placeholder="Ex: Operacional">
                        </div>
                        <div>
                            <label class="label-pro text-purple-700">Reporta-se a (Gestor)</label>
                            <select name="gestor_id" class="input-pro border-purple-200 focus:border-purple-500 cursor-pointer">
                                <option value="">-- Sem Gestor Direto --</option>
                                {% for gestor in gestores %}
                                    <option value="{{ gestor.id }}" {% if user.gestor_id == gestor.id %}selected{% endif %}>{{ gestor.real_name }} ({{ gestor.role }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                {% if user.username != '50097952800' %}
                <div class="bg-blue-50 p-5 rounded-xl border border-blue-100">
                    <div class="flex items-center gap-2 mb-4 text-blue-700">
                        <i class="fas fa-shield-halved"></i>
                        <span class="text-xs font-bold uppercase tracking-wider">Atribui√ß√µes Administrativas</span>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-3">
                        {% set user_perms = user.permissions.split(',') if user.permissions else [] %}
                        
                        <label class="flex items-center justify-between p-3 bg-white rounded-lg border border-blue-100 cursor-pointer hover:bg-blue-50 transition">
                            <div class="flex items-center gap-3"><i class="fas fa-users-cog text-blue-500 w-5"></i><span class="text-sm font-semibold text-slate-700">Utilizadores</span></div>
                            <input type="checkbox" name="perm_keys" value="USUARIOS" class="w-5 h-5 rounded text-blue-600" {% if 'USUARIOS' in user_perms %}checked{% endif %}>
                        </label>
                        <label class="flex items-center justify-between p-3 bg-white rounded-lg border border-blue-100 cursor-pointer hover:bg-blue-50 transition">
                            <div class="flex items-center gap-3"><i class="fas fa-fingerprint text-emerald-500 w-5"></i><span class="text-sm font-semibold text-slate-700">Ponto (Aprova√ß√£o)</span></div>
                            <input type="checkbox" name="perm_keys" value="PONTO" class="w-5 h-5 rounded text-blue-600" {% if 'PONTO' in user_perms %}checked{% endif %}>
                        </label>
                        <label class="flex items-center justify-between p-3 bg-white rounded-lg border border-blue-100 cursor-pointer hover:bg-blue-50 transition">
                            <div class="flex items-center gap-3"><i class="fas fa-file-invoice-dollar text-orange-500 w-5"></i><span class="text-sm font-semibold text-slate-700">Documentos (RH)</span></div>
                            <input type="checkbox" name="perm_keys" value="DOCUMENTOS" class="w-5 h-5 rounded text-blue-600" {% if 'DOCUMENTOS' in user_perms %}checked{% endif %}>
                        </label>
                        <label class="flex items-center justify-between p-3 bg-white rounded-lg border border-blue-100 cursor-pointer hover:bg-blue-50 transition">
                            <div class="flex items-center gap-3"><i class="fas fa-box-open text-purple-500 w-5"></i><span class="text-sm font-semibold text-slate-700">Estoque (Uniforme)</span></div>
                            <input type="checkbox" name="perm_keys" value="ESTOQUE" class="w-5 h-5 rounded text-blue-600" {% if 'ESTOQUE' in user_perms %}checked{% endif %}>
                        </label>
                        <label class="flex items-center justify-between p-3 bg-white rounded-lg border border-blue-100 cursor-pointer hover:bg-blue-50 transition">
                            <div class="flex items-center gap-3"><i class="fas fa-shield-alt text-slate-600 w-5"></i><span class="text-sm font-semibold text-slate-700">Auditoria Forense</span></div>
                            <input type="checkbox" name="perm_keys" value="AUDITORIA" class="w-5 h-5 rounded text-blue-600" {% if 'AUDITORIA' in user_perms %}checked{% endif %}>
                        </label>
                    </div>
                </div>
                {% else %}
                <div class="bg-slate-100 p-4 rounded-lg text-center">
                    <p class="text-[10px] font-bold text-slate-500 uppercase"><i class="fas fa-lock mr-1"></i> Acesso Master Absoluto</p>
                </div>
                {% endif %}

                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-3">Contrata√ß√£o e V√≠nculo</p>
                    <div class="space-y-3">
                        <div>
                            <label class="label-pro text-emerald-700"><i class="fas fa-calendar-check mr-1"></i> Data de Admiss√£o</label>
                            <input type="date" name="data_admissao" class="input-pro border-emerald-200 focus:border-emerald-500" value="{{ user.data_admissao.strftime('%Y-%m-%d') if user.data_admissao else '' }}">
                        </div>
                        <div>
                            <label class="label-pro">Raz√£o Social</label>
                            <input type="text" name="razao_social" class="input-pro" value="{{ user.razao_social_empregadora }}">
                        </div>
                        <div>
                            <label class="label-pro">CNPJ</label>
                            <input type="text" name="cnpj" class="input-pro font-mono" value="{{ user.cnpj_empregador }}">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label-pro">Login</label>
                        <input type="text" name="username" value="{{ user.username }}" class="input-pro" {% if user.username == '50097952800' %}readonly{% endif %}>
                    </div>
                    <div>
                        <label class="label-pro">Cargo</label>
                        <input type="text" name="role" value="{{ user.role }}" class="input-pro" {% if user.username == '50097952800' %}disabled{% endif %}>
                    </div>
                </div>
            </div>

            <div class="pt-4 border-t border-slate-100">
                <p class="text-xs font-bold text-slate-400 uppercase mb-3">Regra de Ponto</p>
                <div class="mb-4">
                    <label class="label-pro">Escala</label>
                    <select name="escala" class="input-pro">
                        <option value="Livre" {% if user.escala == 'Livre' %}selected{% endif %}>Livre</option>
                        <option value="5x2" {% if user.escala == '5x2' %}selected{% endif %}>Normal 5x2</option>
                        <option value="12x36" {% if user.escala == '12x36' %}selected{% endif %}>Plant√£o 12x36</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4 bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                    <div>
                        <label class="label-pro text-yellow-800">Carga Di√°ria</label>
                        <input type="time" name="carga_horaria" value="{{ carga_hm }}" class="input-pro border-yellow-200 font-bold">
                    </div>
                    <div>
                        <label class="label-pro text-yellow-800">Intervalo (Min)</label>
                        <input type="number" name="tempo_intervalo" value="{{ user.tempo_intervalo or 60 }}" class="input-pro border-yellow-200 font-bold">
                    </div>
                </div>
                <div class="mt-4">
                    <label class="label-pro">Hor√°rio Ideal</label>
                    <input type="time" name="h_ent" value="{{ user.inicio_jornada_ideal }}" class="input-pro">
                </div>
            </div>

            <div class="pt-6 border-t border-slate-100 flex flex-col gap-3">
                <button type="submit" onclick="document.getElementById('acao_input').value='salvar'" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95">SALVAR ALTERA√á√ïES</button>
                <div class="grid grid-cols-2 gap-3">
                    <button type="submit" onclick="document.getElementById('acao_input').value='resetar_senha'" class="bg-yellow-50 hover:bg-yellow-100 text-yellow-700 font-bold py-3 rounded-lg text-xs border border-yellow-200 transition">RESETAR SENHA</button>
                    
                    {% if user.username != '50097952800' %}
                    <button type="button" onclick="acionarModalExclusao()" class="bg-red-50 hover:bg-red-100 text-red-600 font-bold py-3 rounded-lg text-xs border border-red-200 transition">
                        EXCLUIR
                    </button>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    // Fun√ß√£o espec√≠fica para interceptar o Modal e fazer o submit deste formul√°rio com a a√ß√£o "excluir"
    function acionarModalExclusao() {
        confirmarAcao("ATEN√á√ÉO: Isto apagar√° todos os dados, pontos e espelhos deste funcion√°rio permanentemente. Confirmar?", "#");
        
        // Substitui o comportamento padr√£o do bot√£o "Excluir" do Modal temporariamente
        document.getElementById('form-confirmacao').onsubmit = function(e) {
            e.preventDefault();
            document.getElementById('acao_input').value = 'excluir';
            document.getElementById('form-edicao-usuario').submit();
        };
    }
</script>
{% endblock %}



##################################################

FILE: app/admin/templates/admin/liberar_acesso.html
---------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-bold text-slate-800">Liberar Acessos (Lista Branca)</h2>
        <a href="/admin/usuarios" class="text-xs font-bold text-slate-400 hover:text-slate-600">VER USU√ÅRIOS ATIVOS</a>
    </div>

    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-8">
        <div class="bg-blue-50 px-6 py-4 border-b border-blue-100">
            <h3 class="font-bold text-blue-800">Adicionar Funcion√°rio na Fila</h3>
            <p class="text-xs text-blue-600">O funcion√°rio s√≥ poder√° criar conta se o CPF estiver aqui.</p>
        </div>
        <form action="/admin/liberar-acesso" method="POST" class="p-6 space-y-4">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label-pro">CPF (Somente N√∫meros)</label>
                    <input type="text" name="cpf" class="input-pro font-mono" placeholder="00000000000" required>
                </div>
                <div>
                    <label class="label-pro">Nome Completo</label>
                    <input type="text" name="nome" class="input-pro" placeholder="Para identifica√ß√£o" required>
                </div>
            </div>
            
            <div class="bg-slate-50 p-4 rounded-lg border border-slate-100">
                <div class="grid grid-cols-1 gap-3">
                    <div>
                        <label class="label-pro">Raz√£o Social (Empregador)</label>
                        <input type="text" name="razao_social" class="input-pro text-xs" value="LA SHAHIN SERVI√áOS DE SEGURAN√áA E PRONTA RESPOSTA LTDA">
                    </div>
                    <div>
                        <label class="label-pro">CNPJ</label>
                        <input type="text" name="cnpj" class="input-pro text-xs font-mono" value="50.537.235/0001-95">
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label-pro">Cargo</label>
                    <input type="text" name="cargo" class="input-pro" placeholder="Ex: Auxiliar">
                </div>
                <div>
                    <label class="label-pro text-emerald-600">Sal√°rio</label>
                    <input type="number" step="0.01" name="salario" class="input-pro border-emerald-200" placeholder="2000.00">
                </div>
            </div>

            <div class="bg-slate-50 p-4 rounded-lg border border-slate-100">
                <label class="label-pro mb-3 text-slate-500">Definir Regras de Ponto</label>
                
                <div class="mb-4">
                    <label class="label-pro">Tipo de Escala</label>
                    <select name="escala" class="input-pro" onchange="toggleDtRef(this)">
                        <option value="Livre">Livre (Sem Bloqueio)</option>
                        <option value="5x2">Normal 5x2 (Seg-Sex)</option>
                        <option value="12x36">Plant√£o 12x36</option>
                    </select>
                </div>
                
                <div id="divDtRef" class="hidden mb-4">
                    <label class="label-pro text-blue-700">Data Ref (Dia de Trabalho)</label>
                    <input type="date" name="dt_escala" class="input-pro border-blue-200">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="label-pro">Entrada</label><input type="time" name="h_ent" value="07:12" class="input-pro"></div>
                    <div><label class="label-pro">Sa√≠da Almo√ßo</label><input type="time" name="h_alm_ini" value="12:00" class="input-pro"></div>
                    <div><label class="label-pro">Volta Almo√ßo</label><input type="time" name="h_alm_fim" value="13:00" class="input-pro"></div>
                    <div><label class="label-pro">Sa√≠da</label><input type="time" name="h_sai" value="17:00" class="input-pro"></div>
                </div>
            </div>

            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md transition">
                LIBERAR CPF
            </button>
        </form>
    </div>

    <h3 class="font-bold text-slate-700 mb-4 text-sm uppercase">Fila de Espera (Aguardando Cadastro)</h3>
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="divide-y divide-slate-100">
            {% for p in pendentes %}
            <div class="px-6 py-4 flex items-center justify-between hover:bg-slate-50">
                <div>
                    <div class="font-bold text-slate-800">{{ p.nome_previsto }}</div>
                    <div class="text-xs font-mono text-slate-500">CPF: {{ p.cpf }}</div>
                    <div class="text-[10px] text-slate-400 mt-1">{{ p.cargo }} | Escala: {{ p.escala }}</div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-[10px] bg-yellow-100 text-yellow-700 px-2 py-1 rounded font-bold uppercase">Aguardando</span>
                    <a href="/admin/liberar-acesso/excluir/{{ p.id }}" class="text-red-400 hover:text-red-600" onclick="return confirm('Remover da lista?')"><i class="fas fa-trash"></i></a>
                </div>
            </div>
            {% else %}
            <div class="p-8 text-center text-slate-400 text-sm">Nenhum CPF na fila de espera.</div>
            {% endfor %}
        </div>
    </div>
</div>
<script>
    function toggleDtRef(sel) { if (sel.value === '12x36') document.getElementById('divDtRef').classList.remove('hidden'); else document.getElementById('divDtRef').classList.add('hidden'); }
</script>
{% endblock %}



##################################################

FILE: app/admin/templates/admin/novo_usuario.html
-------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-4xl mx-auto pb-20">
    
    <div class="flex items-center justify-between mb-10 px-2">
        <div>
            <h2 class="text-3xl font-black text-slate-800 tracking-tight">Admitir Novo Funcion√°rio</h2>
            <p class="text-sm text-slate-500 font-medium">Os dados inseridos criar√£o uma conta de pr√©-cadastro para o colaborador.</p>
        </div>
        <a href="/admin/usuarios" class="bg-white border border-slate-200 text-slate-500 hover:text-red-600 px-5 py-2.5 rounded-xl font-bold text-xs shadow-sm transition-all flex items-center gap-2">
            <i class="fas fa-times"></i> DESISTIR
        </a>
    </div>

    <form action="/admin/usuarios/novo" method="POST" class="space-y-8">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-slate-900 px-8 py-4">
                <h3 class="text-white text-xs font-bold uppercase tracking-widest flex items-center gap-2">
                    <i class="fas fa-id-card text-blue-400"></i> Identifica√ß√£o Profissional
                </h3>
            </div>
            <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-6">
                <div class="md:col-span-2">
                    <label class="label-pro ml-1">Nome Completo do Colaborador</label>
                    <input type="text" name="real_name" class="input-pro" placeholder="Ex: Marcos Oliveira dos Santos" required>
                </div>

                <div>
                    <label class="label-pro ml-1">CPF (Apenas n√∫meros)</label>
                    <input type="text" name="cpf" class="input-pro font-mono text-lg" placeholder="00000000000" required>
                </div>

                <div>
                    <label class="label-pro ml-1">Fun√ß√£o / Cargo</label>
                    <input type="text" name="role" class="input-pro" placeholder="Ex: Controlador de Acesso" required>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-purple-600 px-8 py-4">
                <h3 class="text-white text-xs font-bold uppercase tracking-widest flex items-center gap-2">
                    <i class="fas fa-sitemap"></i> Estrutura Organizacional
                </h3>
            </div>
            <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-6">
                <div>
                    <label class="label-pro text-purple-700 ml-1">Departamento / Equipe</label>
                    <input type="text" name="departamento" class="input-pro bg-purple-50 border-purple-200 focus:border-purple-500" placeholder="Ex: Operacional Sul">
                </div>

                <div>
                    <label class="label-pro text-purple-700 ml-1">Lideran√ßa (CPF do Gestor)</label>
                    <select name="cpf_gestor" class="input-pro bg-purple-50 border-purple-200 focus:border-purple-500 cursor-pointer">
                        <option value="">-- Sem Gestor Direto --</option>
                        {% for gestor in gestores %}
                            <option value="{{ gestor.cpf }}">{{ gestor.real_name }} ({{ gestor.role }})</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-emerald-600 px-8 py-4">
                <h3 class="text-white text-xs font-bold uppercase tracking-widest flex items-center gap-2">
                    <i class="fas fa-hand-holding-usd"></i> Dados Contratuais & Empresa
                </h3>
            </div>
            <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-6">
                <div>
                    <label class="label-pro text-emerald-700 ml-1">Data de Admiss√£o</label>
                    <input type="date" name="data_admissao" class="input-pro border-emerald-200 focus:border-emerald-500" required>
                </div>

                <div>
                    <label class="label-pro text-emerald-700 ml-1">Sal√°rio Base (R$)</label>
                    <div class="relative">
                        <span class="absolute left-4 top-3 font-bold text-emerald-600">R$</span>
                        <input type="number" step="0.01" name="salario" class="input-pro pl-10 border-emerald-200 focus:border-emerald-500" placeholder="0.00">
                    </div>
                </div>

                <div>
                    <label class="label-pro ml-1 text-slate-700">Empresa Pagadora (Raz√£o Social)</label>
                    <input type="text" name="razao_social" class="input-pro border-slate-300 focus:border-blue-500" value="LA SHAHIN SERVI√áOS DE SEGURAN√áA LTDA" placeholder="Nome da Empresa" required>
                </div>
                
                <div>
                    <label class="label-pro ml-1 text-slate-700">CNPJ da Empresa</label>
                    <input type="text" name="cnpj" class="input-pro border-slate-300 focus:border-blue-500 font-mono" value="50.537.235/0001-95" placeholder="00.000.000/0000-00" required>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-blue-600 px-8 py-4">
                <h3 class="text-white text-xs font-bold uppercase tracking-widest flex items-center gap-2">
                    <i class="fas fa-clock"></i> Configura√ß√µes de Jornada de Trabalho
                </h3>
            </div>
            <div class="p-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="md:col-span-1">
                        <label class="label-pro ml-1">Escala de Trabalho</label>
                        <select name="escala" onchange="toggleDtRef(this)" class="input-pro cursor-pointer">
                            <option value="Livre">Livre (Sem Bloqueios)</option>
                            <option value="5x2">5x2 (Segunda a Sexta)</option>
                            <option value="12x36">12x36 (Plant√£o)</option>
                        </select>
                    </div>

                    <div id="divDtRef" class="hidden md:col-span-2 animate-fade-in">
                        <div class="bg-amber-50 border-2 border-amber-100 rounded-2xl p-5">
                            <label class="label-pro text-amber-700">Data de Refer√™ncia (Dia de Trabalho)</label>
                            <input type="date" name="dt_escala" class="input-pro border-amber-200 focus:border-amber-500">
                            <p class="text-[10px] text-amber-600 mt-2 font-medium">* O sistema usar√° esta data para alternar folgas e plant√µes no c√°lculo de 12x36.</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 p-6 bg-slate-50 rounded-xl border border-slate-200">
                    <div class="text-center">
                        <label class="label-pro">Carga Di√°ria</label>
                        <input type="time" name="carga_horaria" value="08:48" class="input-pro text-center font-mono">
                    </div>
                    <div class="text-center">
                        <label class="label-pro">Intervalo (Min)</label>
                        <input type="number" name="tempo_intervalo" value="60" class="input-pro text-center font-mono">
                    </div>
                    <div class="text-center">
                        <label class="label-pro">Entrada Ideal</label>
                        <input type="time" name="h_ent" value="07:12" class="input-pro text-center font-mono">
                    </div>
                </div>
            </div>
        </div>

        <div class="pt-6">
            <button type="submit" class="w-full bg-slate-900 hover:bg-blue-600 text-white font-black py-4 rounded-xl shadow-xl hover:shadow-blue-500/20 transition-all transform active:scale-[0.98] flex items-center justify-center gap-4 group">
                <span class="text-lg">FINALIZAR ADMISS√ÉO E CRIAR ACESSO</span>
                <i class="fas fa-chevron-right group-hover:translate-x-2 transition-transform"></i>
            </button>
        </div>
    </form>
</div>

<script>
    function toggleDtRef(sel) {
        const divRef = document.getElementById('divDtRef');
        if (sel.value === '12x36') {
            divRef.classList.remove('hidden');
        } else {
            divRef.classList.add('hidden');
        }
    }
</script>
{% endblock %}



##################################################

FILE: app/admin/templates/admin/solicitacoes.html
-------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6"><h2 class="text-2xl font-bold text-slate-800">Solicita√ß√µes</h2></div>

<div class="mb-6"><input type="text" id="buscaSolic" onkeyup="filtrarSolic('buscaSolic', 'gridSolic')" placeholder="Pesquisar por nome..." class="w-full p-4 rounded-xl border border-slate-200 shadow-sm"></div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="gridSolic">
    {% for s in solicitacoes %}
    <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm relative border-l-4 {% if s.tipo_solicitacao == 'Exclusao' %} border-l-red-500 {% elif s.tipo_solicitacao == 'Inclusao' %} border-l-emerald-500 {% else %} border-l-blue-500 {% endif %} item-solic">
        <span class="absolute top-4 right-4 bg-yellow-100 text-yellow-700 text-[10px] font-bold px-2 py-1 rounded uppercase">{{ s.tipo_solicitacao }}</span>
        <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-600">{{ s.user.real_name[:2].upper() }}</div>
            <div><h3 class="font-bold text-slate-800 text-sm nome-solic">{{ s.user.real_name }}</h3><p class="text-xs text-slate-500">Ref: {{ s.data_referencia.strftime('%d/%m/%Y') }}</p></div>
        </div>
        <div class="bg-slate-50 p-3 rounded-lg mb-4 text-sm">
            {% if s.tipo_solicitacao == 'Edicao' %}
                <div class="flex justify-between mb-1 text-xs"><span class="text-slate-400">De:</span> <span class="font-mono text-slate-600 line-through">{{ extras[s.id] }}</span></div>
                <div class="flex justify-between mb-1 text-sm font-bold"><span class="text-slate-600">Para:</span> <span class="font-mono text-blue-600">{{ s.novo_horario }} ({{ s.tipo_batida }})</span></div>
            {% elif s.tipo_solicitacao == 'Exclusao' %}
                <div class="text-red-600 font-bold text-center py-2">SOLICITA REMO√á√ÉO</div><div class="text-center text-xs text-slate-500">Alvo: {{ extras[s.id] }}</div>
            {% else %}
                <div class="text-emerald-600 font-bold text-center py-2">NOVA MARCA√á√ÉO</div><div class="text-center font-mono">{{ s.novo_horario }} ({{ s.tipo_batida }})</div>
            {% endif %}
            <div class="mt-3 text-xs text-slate-600 italic border-t pt-2">"{{ s.justificativa }}"</div>
        </div>
        <form action="/admin/solicitacoes" method="POST" class="flex flex-col gap-2">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="solic_id" value="{{ s.id }}">
            <div class="flex gap-2">
                <button type="submit" name="decisao" value="aprovar" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded text-xs transition">APROVAR</button>
                <button type="button" onclick="document.getElementById('repro-{{ s.id }}').classList.remove('hidden')" class="flex-1 bg-red-100 hover:bg-red-200 text-red-600 font-bold py-2 rounded text-xs transition">REPROVAR</button>
            </div>
            <div id="repro-{{ s.id }}" class="hidden mt-2"><input type="text" name="motivo_repro" class="w-full border border-red-200 rounded p-2 text-xs mb-2 bg-red-50" placeholder="Motivo..."><button type="submit" name="decisao" value="reprovar" class="w-full bg-red-600 text-white font-bold py-2 rounded text-xs">ENVIAR</button></div>
        </form>
    </div>
    {% else %}<div class="col-span-2 text-center py-12 text-slate-400 bg-white rounded-xl border border-slate-200 border-dashed"><p>Nenhuma solicita√ß√£o pendente.</p></div>{% endfor %}
</div>
<script>
function filtrarSolic(inputId, gridId) {
    let input = document.getElementById(inputId);
    let filter = input.value.toUpperCase();
    let grid = document.getElementById(gridId);
    let itens = grid.getElementsByClassName('item-solic');
    for (let i = 0; i < itens.length; i++) {
        let nome = itens[i].getElementsByClassName('nome-solic')[0];
        if (nome.innerHTML.toUpperCase().indexOf(filter) > -1) { itens[i].style.display = ""; } else { itens[i].style.display = "none"; }
    }
}
</script>
{% endblock %}

##################################################

FILE: app/admin/templates/admin/sucesso_usuario.html
----------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-lg mx-auto flex flex-col items-center justify-center min-h-[50vh] text-center">
    <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 mb-6 shadow-sm"><i class="fas fa-check text-3xl"></i></div>
    <h2 class="text-2xl font-bold text-slate-800 mb-2">CPF Liberado!</h2>
    <p class="text-slate-500 mb-8">O funcion√°rio <strong>{{ nome_real }}</strong> (CPF: {{ cpf }}) j√° pode se cadastrar.</p>
    <div class="bg-blue-50 text-blue-800 text-sm p-6 rounded-xl mb-8 max-w-sm">
        <p class="font-bold mb-2">Pr√≥ximo Passo:</p>
        <p>Pe√ßa para o funcion√°rio acessar o sistema, clicar em <strong>"Sou Funcion√°rio"</strong> e criar a pr√≥pria senha usando este CPF.</p>
    </div>
    <a href="/admin/usuarios" class="bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-8 rounded-full transition shadow-lg">VOLTAR</a>
</div>
{% endblock %}

##################################################

FILE: app/auth/__init__.py
--------------------------
# M√≥dulo auth

##################################################

FILE: app/auth/routes.py
------------------------
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_user, logout_user, login_required, current_user
from werkzeug.security import generate_password_hash
from app.extensions import db
from app.models import User, PreCadastro
import re
import random
import string

auth_bp = Blueprint('auth', __name__, template_folder='templates')

@auth_bp.route('/login', methods=['GET', 'POST'])
def login():
    if current_user.is_authenticated: 
        return redirect(url_for('main.dashboard'))
    
    if request.method == 'POST':
        login_input = request.form.get('username', '').replace('.', '').replace('-', '').strip()
        password = request.form.get('password')
        
        user = User.query.filter_by(username=login_input).first()
        
        if not user:
            user = User.query.filter_by(username=request.form.get('username')).first()

        if user and user.check_password(password):
            login_user(user)
            if user.is_first_access: 
                return redirect(url_for('auth.primeiro_acesso'))
            return redirect(url_for('main.dashboard'))
        
        flash('CPF ou senha inv√°lidos.', 'error')
        
    return render_template('auth/login.html')

@auth_bp.route('/logout')
@login_required
def logout():
    logout_user()
    return redirect(url_for('auth.login'))

@auth_bp.route('/primeiro-acesso', methods=['GET', 'POST'])
@login_required
def primeiro_acesso():
    if not current_user.is_first_access: 
        return redirect(url_for('main.dashboard'))
    
    if request.method == 'POST':
        nova_senha = request.form.get('nova_senha')
        confirmacao = request.form.get('confirmacao')
        
        if nova_senha == confirmacao:
            current_user.set_password(nova_senha)
            current_user.is_first_access = False
            db.session.commit()
            flash('Senha atualizada com sucesso!', 'success')
            return redirect(url_for('main.dashboard'))
        flash('As senhas n√£o coincidem.', 'error')
        
    return render_template('auth/primeiro_acesso.html')

@auth_bp.route('/cadastrar', methods=['GET', 'POST'])
def auto_cadastro():
    if request.method == 'GET': 
        return render_template('auth/auto_cadastro.html', step=1)
    
    if request.method == 'POST':
        cpf_input = request.form.get('cpf', '')
        cpf = re.sub(r'\D', '', cpf_input)
        
        pre = PreCadastro.query.filter_by(cpf=cpf).first()
        
        if not pre:
            if User.query.filter_by(cpf=cpf).first():
                flash('Este CPF j√° possui um cadastro ativo. Tente fazer login.', 'warning')
                return redirect(url_for('auth.login'))
            flash('CPF n√£o autorizado para cadastro. Entre em contato com o RH.', 'error')
            return redirect(url_for('auth.auto_cadastro'))
            
        password = request.form.get('password')
        confirm_password = request.form.get('confirm_password')
        
        if password:
            if password != confirm_password:
                flash('As senhas n√£o coincidem. Tente novamente.', 'error')
                return render_template('auth/auto_cadastro.html', step=2, cpf=cpf, nome=pre.nome_previsto)
                
            username_login = cpf 
            
            # V√≠nculo Hier√°rquico: Procura o gestor pelo CPF informado na planilha
            gestor_id_final = None
            if pre.cpf_gestor:
                gestor_encontrado = User.query.filter_by(cpf=pre.cpf_gestor).first()
                if gestor_encontrado:
                    gestor_id_final = gestor_encontrado.id
            
            # O Limite da coluna 'role' foi aumentado no models para n√£o truncar "CONTROLADOR DE ACESSO"
            novo_user = User(
                username=username_login, 
                password_hash=generate_password_hash(password), 
                real_name=pre.nome_previsto, 
                role=pre.cargo, 
                cpf=cpf, 
                salario=pre.salario, 
                razao_social_empregadora=pre.razao_social, # Suporte aos 5 CNPJs
                cnpj_empregador=pre.cnpj, # Suporte aos 5 CNPJs
                data_admissao=pre.data_admissao,
                carga_horaria=pre.carga_horaria,
                tempo_intervalo=pre.tempo_intervalo,
                inicio_jornada_ideal=pre.inicio_jornada_ideal,
                escala=pre.escala, 
                data_inicio_escala=pre.data_inicio_escala,
                departamento=pre.departamento,
                gestor_id=gestor_id_final,
                is_first_access=False,
                permissions="" 
            )
            
            db.session.add(novo_user)
            db.session.delete(pre) 
            db.session.commit()
            
            return render_template('auth/auto_cadastro_sucesso.html', username=cpf, nome=pre.nome_previsto)
        else:
            return render_template('auth/auto_cadastro.html', step=2, cpf=cpf, nome=pre.nome_previsto)

# --- RECUPERA√á√ÉO SEGURA DE SENHA ---
@auth_bp.route('/esqueci-senha', methods=['GET', 'POST'])
def esqueci_senha():
    if current_user.is_authenticated: 
        return redirect(url_for('main.dashboard'))
        
    if request.method == 'POST':
        cpf_input = request.form.get('cpf', '').replace('.', '').replace('-', '').strip()
        data_admissao_input = request.form.get('data_admissao')
        
        user = User.query.filter_by(cpf=cpf_input).first()
        
        # S√≥ permite reset se os dados baterem exatamente com o banco de dados
        if user and user.data_admissao and str(user.data_admissao) == data_admissao_input:
            senha_temporaria = ''.join(random.choices(string.ascii_uppercase + string.digits, k=6))
            user.set_password(senha_temporaria)
            user.is_first_access = True
            db.session.commit()
            
            flash(f'ACESSO RECUPERADO! Sua nova senha tempor√°ria √©: {senha_temporaria} (Copie-a agora e altere no primeiro acesso).', 'success')
            return redirect(url_for('auth.login'))
        else:
            flash('Dados divergentes. Verifique o seu CPF e Data de Admiss√£o, ou contate o RH.', 'error')
            
    return render_template('auth/esqueci_senha.html')



##################################################

FILE: app/auth/templates/auth/auto_cadastro.html
------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col items-center justify-center min-h-[60vh]">
    <div class="bg-white p-8 rounded-2xl shadow-xl border border-slate-100 w-full max-w-md">
        
        {% if step == 1 %}
        <h2 class="text-xl font-bold text-slate-800 mb-2">Primeiro Acesso</h2>
        <p class="text-sm text-slate-500 mb-6">Digite seu CPF para localizar seu cadastro.</p>
        <form action="/cadastrar" method="POST" class="space-y-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="step" value="1">
            <div>
                <label class="label-pro">CPF (Somente N√∫meros)</label>
                <input type="text" name="cpf" class="input-pro text-lg tracking-wide" placeholder="000.000.000-00" required>
            </div>
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-lg transition mt-2">CONTINUAR</button>
        </form>
        {% endif %}

        {% if step == 2 %}
        <h2 class="text-xl font-bold text-emerald-700 mb-2">Bem-vindo(a), {{ nome }}!</h2>
        <p class="text-sm text-slate-500 mb-6">Confirme seus dados e crie uma senha segura.</p>
        <form action="/cadastrar" method="POST" class="space-y-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="step" value="2">
            <input type="hidden" name="cpf" value="{{ cpf }}">
            
            <div class="bg-slate-50 p-4 rounded-lg border border-slate-100 mb-4">
                <p class="text-xs text-slate-400 font-bold uppercase">CPF</p>
                <p class="font-mono text-slate-800 font-bold">{{ cpf }}</p>
            </div>

            <div>
                <label class="label-pro">Crie sua Senha</label>
                <input type="password" name="password" class="input-pro" placeholder="M√≠nimo 6 caracteres" required minlength="6">
            </div>

            <div>
                <label class="label-pro">Confirme a Senha</label>
                <input type="password" name="confirm_password" class="input-pro" placeholder="Digite a senha novamente" required minlength="6">
            </div>
            
            <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-lg shadow-lg transition mt-4">FINALIZAR CADASTRO</button>
        </form>
        {% endif %}

        <div class="text-center mt-6">
            <a href="/login" class="text-xs text-slate-400 hover:text-slate-600 font-bold">Voltar para Login</a>
        </div>
    </div>
</div>
{% endblock %}



##################################################

FILE: app/auth/templates/auth/auto_cadastro_sucesso.html
--------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="min-h-[80vh] flex items-center justify-center p-4">
    <div class="max-w-md w-full bg-white rounded-3xl border border-slate-200 shadow-2xl p-10 text-center">
        <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-6">
            <i class="fas fa-check-circle"></i>
        </div>
        
        <h1 class="text-2xl font-bold text-slate-800 mb-2">Conta Criada!</h1>
        <p class="text-slate-500 mb-8">Ol√°, <span class="font-bold text-slate-800">{{ nome }}</span>. O teu acesso foi configurado com sucesso.</p>
        
        <div class="bg-slate-50 rounded-2xl p-6 mb-8 border border-slate-100">
            <p class="text-xs font-bold text-slate-400 uppercase mb-2">Os teus dados de acesso:</p>
            <div class="space-y-2 text-left">
                <div class="flex justify-between items-center text-sm">
                    <span class="text-slate-500">Login (CPF):</span>
                    <span class="font-mono font-bold text-slate-800">{{ username }}</span>
                </div>
                <div class="flex justify-between items-center text-sm">
                    <span class="text-slate-500">Senha:</span>
                    <span class="font-bold text-slate-800">A que criaste agora</span>
                </div>
            </div>
        </div>

        <a href="/login" class="block w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition">
            FAZER LOGIN AGORA
        </a>
    </div>
</div>
{% endblock %}




##################################################

FILE: app/auth/templates/auth/esqueci_senha.html
------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col items-center justify-center min-h-[60vh]">
    <div class="bg-white p-8 rounded-2xl shadow-xl border border-slate-100 w-full max-w-md">
        
        <h2 class="text-xl font-bold text-slate-800 mb-2 flex items-center gap-2">
            <i class="fas fa-unlock-alt text-blue-500"></i> Recuperar Acesso
        </h2>
        <p class="text-sm text-slate-500 mb-6">Para sua seguran√ßa, valide suas informa√ß√µes de contrato para gerar uma nova senha tempor√°ria.</p>
        
        <form action="/esqueci-senha" method="POST" class="space-y-5">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">CPF (Somente N√∫meros)</label>
                <input type="text" name="cpf" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 font-bold text-lg tracking-wide focus:outline-none focus:border-blue-500" placeholder="000.000.000-00" required>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Data de Admiss√£o</label>
                <input type="date" name="data_admissao" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 font-bold text-slate-700 focus:outline-none focus:border-blue-500" required>
                <p class="text-[10px] text-slate-400 mt-1">* A data em que o seu contrato foi iniciado pela empresa.</p>
            </div>

            <button type="submit" class="w-full bg-slate-900 hover:bg-blue-600 text-white font-bold py-4 rounded-lg shadow-lg transition mt-4">
                VALIDAR E GERAR SENHA
            </button>
        </form>

        <div class="text-center mt-6 pt-4 border-t border-slate-100">
            <a href="/login" class="text-xs text-slate-400 hover:text-slate-600 font-bold transition"><i class="fas fa-arrow-left mr-1"></i> Voltar ao Login</a>
        </div>
    </div>
</div>
{% endblock %}



##################################################

FILE: app/auth/templates/auth/login.html
----------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="min-h-[80vh] flex items-center justify-center p-4">
    <div class="max-w-md w-full bg-white rounded-3xl border border-slate-200 shadow-2xl overflow-hidden">
        <div class="bg-slate-900 p-10 text-center">
            
            <img src="/static/icons/icon-192x192.png" alt="Shahin" class="w-20 h-20 rounded-2xl mx-auto mb-4 shadow-lg shadow-black/50 object-cover border-2 border-slate-800">
            
            <h1 class="text-2xl font-bold text-white tracking-tight">Shahin Gest√£o</h1>
            <p class="text-slate-400 text-sm mt-2">Acesso ao Painel Operacional</p>
        </div>
        
        <form method="POST" class="p-10 space-y-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <div>
                <label class="label-pro ml-1">CPF (Apenas N√∫meros)</label>
                <div class="relative">
                    <i class="fas fa-user absolute left-4 top-4 text-slate-400"></i>
                    <input type="text" name="username" id="cpf_input" placeholder="000.000.000-00" 
                           class="input-pro pl-12 font-mono" required>
                </div>
            </div>

            <div>
                <div class="flex items-center justify-between mb-2 ml-1">
                    <label class="label-pro mb-0">Senha</label>
                    <a href="/esqueci-senha" class="text-[10px] font-bold text-blue-500 hover:text-blue-700 transition">Esqueceu a senha?</a>
                </div>
                <div class="relative">
                    <i class="fas fa-lock absolute left-4 top-4 text-slate-400"></i>
                    <input type="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                           class="input-pro pl-12" required>
                </div>
            </div>

            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 transition transform active:scale-[0.98]">
                ENTRAR NO SISTEMA
            </button>

            <div class="pt-6 border-t border-slate-100 text-center">
                <p class="text-sm text-slate-500">Novo por aqui?</p>
                <a href="/cadastrar" class="text-blue-600 font-bold hover:underline">Sou Funcion√°rio</a>
            </div>
        </form>
    </div>
</div>

<script>
    const input = document.getElementById('cpf_input');
    input.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, ''); 
        if (value.length <= 11) {
            if (value.length > 9) {
                value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
            } else if (value.length > 6) {
                value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, "$1.$2.$3");
            } else if (value.length > 3) {
                value = value.replace(/(\d{3})(\d{1,3})/, "$1.$2");
            }
            e.target.value = value;
        }
    });
</script>
{% endblock %}



##################################################

FILE: app/auth/templates/auth/primeiro_acesso.html
--------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col items-center justify-center min-h-[60vh]">
    <div class="bg-white p-8 rounded-2xl shadow-xl border-l-4 border-yellow-400 w-full max-w-sm">
        <h2 class="text-xl font-bold text-slate-800 mb-2">Primeiro Acesso</h2>
        <p class="text-sm text-slate-500 mb-6">Por seguran√ßa, voc√™ deve definir uma nova senha pessoal.</p>
        <form action="/primeiro-acesso" method="POST" class="space-y-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div>
                <label class="label-pro">Nova Senha</label>
                <input type="password" name="nova_senha" class="input-pro" required>
            </div>
            <div>
                <label class="label-pro">Confirmar Senha</label>
                <input type="password" name="confirmacao" class="input-pro" required>
            </div>
            <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 rounded-lg shadow-lg transition mt-4">SALVAR E ACESSAR</button>
        </form>
    </div>
</div>
{% endblock %}



##################################################

FILE: app/documentos/__init__.py
--------------------------------
# M√≥dulo de Documentos





##################################################

FILE: app/documentos/ai_parser.py
---------------------------------
import io
import re
import unicodedata
from pypdf import PdfReader

def limpar_texto_pdf_para_busca(texto):
    """
    Aplica a mesma limpeza usada no banco de dados para garantir
    que o texto do PDF e o nome do funcion√°rio falem a exata mesma l√≠ngua.
    """
    if not texto: return ""
    # Remove acentos
    texto = "".join(c for c in unicodedata.normalize('NFD', texto) if unicodedata.category(c) != 'Mn')
    texto = texto.upper().replace('\n', ' ').strip()
    
    # Remove preposi√ß√µes (para focar apenas nos nomes fortes)
    stopwords = [" DE ", " DA ", " DO ", " DOS ", " DAS ", " E "]
    for word in stopwords:
        texto = texto.replace(word, " ")
    
    # Remove m√∫ltiplos espa√ßos
    return " ".join(texto.split())

def extrair_dados_holerite(pdf_bytes, lista_nomes_banco=None):
    """
    Abordagem de MATCH EXATO E COMPLETO.
    Sem margem para "adivinha√ß√£o" ou envios errados.
    """
    dados_retorno = {"nome": "", "mes_referencia": "2026-02", "origem": "falha"}
    
    texto_raw = ""
    try:
        reader = PdfReader(io.BytesIO(pdf_bytes))
        if len(reader.pages) > 0:
            texto_raw = reader.pages[0].extract_text()
    except Exception as e:
        print(f"ERRO DE LEITURA PDF: {e}")
        return dados_retorno

    if not texto_raw:
        return dados_retorno

    # 1. Busca de Data
    padrao_data = r'(\d{2})[/-](\d{4})'
    match_data = re.search(padrao_data, texto_raw)
    if match_data:
        mes = match_data.group(1)
        ano = match_data.group(2)
        if 1 <= int(mes) <= 12:
            dados_retorno["mes_referencia"] = f"{ano}-{mes}"

    # 2. Busca de Nome (RIGOROSA E EXATA)
    if lista_nomes_banco:
        # Limpa o texto inteiro da p√°gina do PDF
        texto_pdf_limpo = limpar_texto_pdf_para_busca(texto_raw)
        
        # ORDENA OS NOMES POR TAMANHO (Do maior para o menor)
        # Motivo: Se tivermos "Jo√£o Marcos Silva" e "Jo√£o Marcos", 
        # o sistema testa o nome mais longo primeiro. Isso impede 
        # que nomes curtos roubem o holerite de nomes compostos.
        nomes_ordenados = sorted(lista_nomes_banco, key=len, reverse=True)
        
        for nome_banco in nomes_ordenados:
            # Adiciona espa√ßos ao redor (f" {nome} ") para garantir a busca da palavra exata.
            # Impede que o sistema ache "ANA" no meio da palavra "JULIANA".
            if f" {nome_banco} " in f" {texto_pdf_limpo} ":
                print(f"MATCH EXATO COMPLETO: '{nome_banco}' encontrado no PDF.")
                dados_retorno["nome"] = nome_banco
                dados_retorno["origem"] = "python_exato"
                break  # Para a busca no primeiro match perfeito

    return dados_retorno



##################################################

FILE: app/documentos/atestado_parser.py
---------------------------------------
from google.cloud import vision
import re
import unicodedata
import traceback

def limpar_texto(texto):
    """Padroniza o texto para an√°lise de dados."""
    if not texto: return ""
    texto = "".join(c for c in unicodedata.normalize('NFD', texto) if unicodedata.category(c) != 'Mn')
    texto = texto.upper().replace('\n', ' ')
    texto = re.sub(r'\s+', ' ', texto).strip()
    return texto

def converter_numero_extenso(texto):
    mapa = {
        "UM": 1, "DOIS": 2, "TRES": 3, "QUATRO": 4, "CINCO": 5,
        "SEIS": 6, "SETE": 7, "OITO": 8, "NOVE": 9, "DEZ": 10,
        "ONZE": 11, "DOZE": 12, "TREZE": 13, "QUATORZE": 14, "CATORZE": 14, "QUINZE": 15
    }
    return mapa.get(texto.upper(), None)

def analisar_atestado_vision(imagem_bytes, nome_funcionario):
    dados = {
        "nome_encontrado": False,
        "data_inicio": None,
        "dias_afastamento": None,
        "texto_bruto": "NENHUM TEXTO DETECTADO."
    }
    
    try:
        client = vision.ImageAnnotatorClient()
        
        # Identifica se √© PDF (assinatura de arquivo %PDF)
        is_pdf = imagem_bytes.startswith(b'%PDF')
        
        if is_pdf:
            # L√≥gica para Processar PDF
            input_config = vision.InputConfig(content=imagem_bytes, mime_type='application/pdf')
            feature = vision.Feature(type_=vision.Feature.Type.DOCUMENT_TEXT_DETECTION)
            # Solicitamos a an√°lise da primeira p√°gina do PDF
            request = vision.AnnotateFileRequest(input_config=input_config, features=[feature], pages=[1])
            
            response = client.batch_annotate_files(requests=[request])
            # O PDF retorna uma estrutura de resposta diferente da imagem
            if response.responses[0].responses:
                texto_completo = response.responses[0].responses[0].full_text_annotation.text
            else:
                dados["texto_bruto"] = "PDF LIDO, MAS NENHUM TEXTO ENCONTRADO DENTRO DELE."
                return dados
        else:
            # L√≥gica para Processar Imagem (JPG, PNG)
            image = vision.Image(content=imagem_bytes)
            response = client.text_detection(image=image)
            
            if response.error.message:
                dados["texto_bruto"] = f"ERRO NA API GOOGLE: {response.error.message}"
                return dados
                
            if not response.text_annotations:
                dados["texto_bruto"] = "NENHUM TEXTO ENCONTRADO NA IMAGEM."
                return dados
            
            texto_completo = response.text_annotations[0].description

        # Processamento Comum (Independente do formato)
        dados["texto_bruto"] = texto_completo
        texto_limpo = limpar_texto(texto_completo)
        nome_limpo = limpar_texto(nome_funcionario)

        # 1. Valida√ß√£o de Nome
        partes_nome = nome_limpo.split()
        if len(partes_nome) >= 2:
            if partes_nome[0] in texto_limpo and partes_nome[-1] in texto_limpo:
                dados["nome_encontrado"] = True

        # 2. Extra√ß√£o de Dias (Regras de Neg√≥cio)
        # Tenta: "X dias", "X (extenso) dias", "AFASTAMENTO DE X", "REPOUSO DE X"
        match_num = re.search(r'(\d{1,2})\s*(?:\([A-Z\s]+\))?\s*(?:DIAS|DIA)', texto_limpo)
        if match_num:
            dados["dias_afastamento"] = int(match_num.group(1))
        else:
            match_contexto = re.search(r'(?:AFASTAMENTO|REPOUSO|CONCEDO|NECESSITA DE)\D*?(\d{1,2})', texto_limpo)
            if match_contexto:
                dados["dias_afastamento"] = int(match_contexto.group(1))
            else:
                palavras_numero = r'(UM|DOIS|TRES|QUATRO|CINCO|SEIS|SETE|OITO|NOVE|DEZ|ONZE|DOZE|TREZE|QUATORZE|CATORZE|QUINZE)'
                match_extenso = re.search(f'{palavras_numero}\\s*(?:DIAS|DIA)', texto_limpo)
                if match_extenso:
                    dados["dias_afastamento"] = converter_numero_extenso(match_extenso.group(1))

        # 3. Extra√ß√£o de Data
        match_data = re.search(r'(\d{2})[/\-](\d{2})[/\-](\d{4})', texto_limpo)
        if match_data:
            dia, mes, ano = match_data.group(1), match_data.group(2), match_data.group(3)
            dados["data_inicio"] = f"{ano}-{mes}-{dia}"

        return dados

    except Exception as e:
        dados["texto_bruto"] = f"ERRO NO PROCESSAMENTO: {str(e)}\n{traceback.format_exc()}"
        return dados



##################################################

FILE: app/documentos/routes.py
------------------------------
from flask import Blueprint, render_template, request, redirect, url_for, flash, send_file, jsonify
from flask_login import login_required, current_user
from app.extensions import db
from app.models import User, Holerite, Recibo, AssinaturaDigital, Atestado, PontoResumo
from app.utils import get_brasil_time, permission_required, has_permission, limpar_nome, get_client_ip, calcular_hash_arquivo, enviar_notificacao, format_minutes_to_hm
from app.documentos.storage import salvar_no_storage, baixar_bytes_storage
from app.documentos.ai_parser import extrair_dados_holerite
from app.documentos.utils import gerar_pdf_recibo, gerar_pdf_espelho_mensal, gerar_certificado_entrega
from app.documentos.atestado_parser import analisar_atestado_vision
from datetime import datetime, timedelta
from pypdf import PdfReader, PdfWriter
import io
import pandas as pd 

documentos_bp = Blueprint('documentos', __name__, template_folder='templates', url_prefix='/documentos')

@documentos_bp.route('/admin')
@login_required
@permission_required('DOCUMENTOS')
def dashboard_documentos():
    f_nome = request.args.get('nome', '').strip()
    f_mes = request.args.get('mes', '')
    f_tipo = request.args.get('tipo', '')

    q_holerite = Holerite.query.filter(Holerite.status != 'Revisao')
    q_recibo = Recibo.query

    if f_nome:
        q_holerite = q_holerite.join(User).filter(User.real_name.ilike(f'%{f_nome}%'))
        q_recibo = q_recibo.join(User).filter(User.real_name.ilike(f'%{f_nome}%'))
    
    if f_mes:
        q_holerite = q_holerite.filter(Holerite.mes_referencia == f_mes)
        q_recibo = q_recibo.filter(db.extract('month', Recibo.data_pagamento) == int(f_mes.split('-')[1]),
                                   db.extract('year', Recibo.data_pagamento) == int(f_mes.split('-')[0]))

    holerites_db = q_holerite.order_by(Holerite.enviado_em.desc()).limit(50).all()
    recibos_db = q_recibo.order_by(Recibo.created_at.desc()).limit(50).all()
    total_revisao = Holerite.query.filter_by(status='Revisao').count()
    
    historico = []
    
    if not f_tipo or f_tipo in ['Holerite', 'Espelho']:
        for h in holerites_db:
            is_ponto = True if h.url_arquivo and 'espelhos' in h.url_arquivo else False
            
            tipo_label = "Espelho de Ponto" if is_ponto else "Holerite"
            historico.append({
                'id': h.id, 'doc_type': 'holerite',
                'tipo': tipo_label, 'cor': 'purple' if is_ponto else 'blue',
                'usuario': h.user.real_name if h.user else "N/A",
                'info': h.mes_referencia, 'data': h.enviado_em,
                'visualizado': h.visualizado, 'rota': 'baixar_holerite'
            })

    if not f_tipo or f_tipo == 'Recibo':
        for r in recibos_db:
            historico.append({
                'id': r.id, 'doc_type': 'recibo',
                'tipo': 'Recibo', 'cor': 'emerald',
                'usuario': r.user.real_name, 'info': f"R$ {r.valor:,.2f}",
                'data': r.created_at, 'visualizado': r.visualizado, 'rota': 'baixar_recibo'
            })

    historico.sort(key=lambda x: x['data'] if x['data'] else get_brasil_time(), reverse=True)
    return render_template('documentos/dashboard.html', historico=historico, pendentes_revisao=total_revisao, f_nome=f_nome, f_mes=f_mes, f_tipo=f_tipo)

@documentos_bp.route('/excluir/<doc_type>/<int:id>', methods=['POST'])
@login_required
@permission_required('DOCUMENTOS')
def excluir_documento(doc_type, id):
    try:
        if doc_type == 'holerite':
            item = Holerite.query.get_or_404(id)
            db.session.delete(item)
        elif doc_type == 'recibo':
            item = Recibo.query.get_or_404(id)
            db.session.delete(item)
        db.session.commit()
        flash("Documento removido com sucesso.", "success")
    except Exception as e:
        db.session.rollback()
        flash(f"Erro ao excluir: {e}", "error")
    return redirect(url_for('documentos.dashboard_documentos'))

@documentos_bp.route('/admin/holerites', methods=['GET', 'POST'])
@login_required
@permission_required('DOCUMENTOS')
def admin_holerites():
    if request.method == 'POST':
        file = request.files.get('arquivo_pdf')
        if not file: return redirect(request.url)
        try:
            reader = PdfReader(file)
            sucesso, revisao = 0, 0
            usuarios_db = User.query.filter(User.role != 'Terminal').all()
            usuarios_map = {limpar_nome(u.real_name): u.id for u in usuarios_db}
            lista_nomes_banco = list(usuarios_map.keys())

            for page in reader.pages:
                writer = PdfWriter(); writer.add_page(page); buffer = io.BytesIO(); writer.write(buffer)
                pdf_bytes = buffer.getvalue()
                
                dados = extrair_dados_holerite(pdf_bytes, lista_nomes_banco)
                nome_identificado = dados.get('nome', '')
                mes_ref = dados.get('mes_referencia', '2026-02')

                caminho_blob = salvar_no_storage(pdf_bytes, f"holerites/{mes_ref}")
                if not caminho_blob: continue

                user_id = None
                if nome_identificado and nome_identificado in usuarios_map:
                    user_id = usuarios_map[nome_identificado]

                novo_h = Holerite(user_id=user_id, mes_referencia=mes_ref, url_arquivo=caminho_blob,
                                 status='Enviado' if user_id else 'Revisao', enviado_em=get_brasil_time())
                db.session.add(novo_h)
                
                if user_id: 
                    sucesso += 1
                    enviar_notificacao(user_id, f"Novo Holerite dispon√≠vel para assinatura ({mes_ref}).", "/documentos/meus-documentos")
                else: 
                    revisao += 1

            db.session.commit()
            flash(f"Processado: {sucesso} enviados, {revisao} para revis√£o manual.", "success")
            return redirect(url_for('documentos.dashboard_documentos'))
        except Exception as e:
            db.session.rollback(); flash(f"Erro: {e}", "error")
    return render_template('documentos/admin_upload_holerite.html')

# Adicionado o m√©todo GET para permitir a abertura em nova aba no painel Master
@documentos_bp.route('/baixar/holerite/<int:id>', methods=['GET', 'POST'])
@login_required
def baixar_holerite(id):
    doc = Holerite.query.get_or_404(id)
    if not has_permission('DOCUMENTOS') and doc.user_id != current_user.id:
        return redirect(url_for('main.dashboard'))
    
    if not doc.url_arquivo:
        flash("Erro ao baixar o arquivo. Arquivo n√£o encontrado no servidor de nuvem.", "error")
        return redirect(url_for('documentos.dashboard_documentos'))

    arquivo_bytes = baixar_bytes_storage(doc.url_arquivo)
    
    if 'espelhos' in doc.url_arquivo:
        nome_download = f"ponto_{doc.mes_referencia}.pdf"
    else:
        nome_download = f"holerite_{doc.mes_referencia}.pdf"
        
    if not arquivo_bytes:
        flash("Falha ao comunicar com o Google Cloud Storage.", "error")
        return redirect(url_for('documentos.dashboard_documentos'))

    if doc.user_id == current_user.id and not doc.visualizado:
        doc.visualizado = True
        tipo_doc = "Espelho de Ponto" if 'espelhos' in doc.url_arquivo else "Holerite"
        
        user_agent_info = request.headers.get('User-Agent', 'Desconhecido')[:250]

        assinatura = AssinaturaDigital(
            user_id=current_user.id,
            documento_id=doc.id,
            tipo_documento=f"{tipo_doc} - {doc.mes_referencia}",
            hash_arquivo=calcular_hash_arquivo(arquivo_bytes),
            data_assinatura=get_brasil_time(),
            ip_address=get_client_ip(),
            user_agent=user_agent_info
        )
        db.session.add(assinatura)
        db.session.commit()

    buffer = io.BytesIO(arquivo_bytes)
    buffer.seek(0)
    return send_file(buffer, mimetype='application/pdf', as_attachment=True, download_name=nome_download)

# Adicionado o m√©todo GET para permitir a abertura em nova aba no painel Master
@documentos_bp.route('/baixar/recibo/<int:id>', methods=['GET', 'POST'])
@login_required
def baixar_recibo(id):
    doc = Recibo.query.get_or_404(id)
    if not has_permission('DOCUMENTOS') and doc.user_id != current_user.id:
        return redirect(url_for('main.dashboard'))
        
    if not doc.url_arquivo:
        flash("Erro: Recibo n√£o encontrado no servidor de nuvem.", "error")
        return redirect(url_for('documentos.dashboard_documentos'))

    arquivo_bytes = baixar_bytes_storage(doc.url_arquivo)
        
    if not arquivo_bytes:
        flash("Falha ao comunicar com o Google Cloud Storage.", "error")
        return redirect(url_for('documentos.dashboard_documentos'))
        
    if doc.user_id == current_user.id and not doc.visualizado:
        doc.visualizado = True
        user_agent_info = request.headers.get('User-Agent', 'Desconhecido')[:250]

        assinatura = AssinaturaDigital(
            user_id=current_user.id, documento_id=doc.id,
            tipo_documento=f"Recibo - R$ {doc.valor}",
            hash_arquivo=calcular_hash_arquivo(arquivo_bytes),
            data_assinatura=get_brasil_time(), ip_address=get_client_ip(), user_agent=user_agent_info
        )
        db.session.add(assinatura)
        db.session.commit()

    buffer = io.BytesIO(arquivo_bytes)
    buffer.seek(0)
    return send_file(buffer, mimetype='application/pdf', as_attachment=True, download_name=f"recibo_{id}.pdf")

@documentos_bp.route('/meus-documentos')
@login_required
def meus_documentos():
    holerites = Holerite.query.filter_by(user_id=current_user.id).order_by(Holerite.enviado_em.desc()).all()
    recibos = Recibo.query.filter_by(user_id=current_user.id).order_by(Recibo.created_at.desc()).all()
    docs = []
    for h in holerites:
        e_ponto = True if h.url_arquivo and 'espelhos' in h.url_arquivo else False
        docs.append({'id': h.id, 'tipo': 'Espelho' if e_ponto else 'Holerite', 'titulo': f"{'Ponto' if e_ponto else 'Holerite'} - {h.mes_referencia}", 'cor': 'purple' if e_ponto else 'blue', 'icone': 'fa-calendar' if e_ponto else 'fa-file', 'data': h.enviado_em, 'visto': h.visualizado, 'rota': 'baixar_holerite'})
    for r in recibos:
        docs.append({'id': r.id, 'tipo': 'Recibo', 'titulo': 'Recibo', 'cor': 'emerald', 'icone': 'fa-receipt', 'data': r.created_at, 'visto': r.visualizado, 'rota': 'baixar_recibo'})
    return render_template('documentos/meus_documentos.html', docs=docs)

@documentos_bp.route('/admin/revisao')
@login_required
@permission_required('DOCUMENTOS')
def revisao_holerites():
    pendentes = Holerite.query.filter_by(status='Revisao').all()
    funcionarios = User.query.filter(User.username != '12345678900').order_by(User.real_name).all()
    return render_template('documentos/revisao.html', pendentes=pendentes, funcionarios=funcionarios)

@documentos_bp.route('/admin/revisao/limpar', methods=['POST'])
@login_required
@permission_required('DOCUMENTOS')
def limpar_revisoes():
    try: Holerite.query.filter_by(status='Revisao').delete(); db.session.commit()
    except: db.session.rollback()
    return redirect(url_for('documentos.revisao_holerites'))

@documentos_bp.route('/admin/revisao/vincular', methods=['POST'])
@login_required
def vincular_holerite():
    h = Holerite.query.get(request.form.get('holerite_id'))
    u_id = request.form.get('user_id')
    if h and u_id: 
        h.user_id = u_id
        h.status = 'Enviado'
        db.session.commit()
        enviar_notificacao(u_id, f"Seu Holerite ({h.mes_referencia}) foi liberado. Assine agora!", "/documentos/meus-documentos")
    return redirect(url_for('documentos.revisao_holerites'))

@documentos_bp.route('/admin/auditoria')
@login_required
@permission_required('AUDITORIA')
def revisao_auditoria():
    usuarios = User.query.filter(User.username != '12345678900').order_by(User.real_name).all()
    auditores = []
    for u in usuarios:
        assinaturas = AssinaturaDigital.query.filter_by(user_id=u.id).order_by(AssinaturaDigital.data_assinatura.desc()).all()
        l = [{'id':a.id, 'tipo':a.tipo_documento, 'data':a.data_assinatura, 'ip':a.ip_address} for a in assinaturas]
        auditores.append({'user': u, 'total': len(assinaturas), 'assinaturas': l})
    return render_template('documentos/auditoria.html', auditores=auditores)

@documentos_bp.route('/admin/recibo/novo', methods=['GET', 'POST'])
@login_required
@permission_required('DOCUMENTOS')
def novo_recibo():
    if request.method == 'POST':
        u = User.query.get(request.form.get('user_id'))
        r = Recibo(user_id=u.id, valor=float(request.form.get('valor', 0)), data_pagamento=get_brasil_time().date())
        pdf_bytes = gerar_pdf_recibo(r, u)
        mes_ref = get_brasil_time().strftime('%Y-%m')
        caminho_blob = salvar_no_storage(pdf_bytes, f"recibos/{mes_ref}")
        r.url_arquivo = caminho_blob
        db.session.add(r); db.session.commit()
        
        enviar_notificacao(u.id, "Um novo Recibo foi disponibilizado para si.", "/documentos/meus-documentos")
        
        return redirect(url_for('documentos.dashboard_documentos'))
    users = User.query.filter(User.username != '12345678900').all()
    return render_template('documentos/novo_recibo.html', users=users, hoje=get_brasil_time().strftime('%Y-%m-%d'))

@documentos_bp.route('/admin/disparar-espelhos', methods=['POST'])
@login_required
@permission_required('DOCUMENTOS')
def disparar_espelhos():
    mes = request.form.get('mes_ref')
    users = User.query.filter(User.username != '12345678900').all()
    sucessos = 0
    
    for u in users:
        try:
            pdf_bytes = gerar_pdf_espelho_mensal(u, mes)
            caminho_blob = salvar_no_storage(pdf_bytes, f"espelhos/{mes}")
            db.session.add(Holerite(user_id=u.id, mes_referencia=mes, url_arquivo=caminho_blob, status='Enviado', enviado_em=get_brasil_time()))
            
            enviar_notificacao(u.id, f"Seu Espelho de Ponto ({mes}) est√° dispon√≠vel para valida√ß√£o.", "/documentos/meus-documentos")
            
            sucessos += 1
        except Exception as e:
            print(f"Erro ao gerar espelho para {u.real_name}: {e}")
            
    db.session.commit()
    flash(f'Processamento conclu√≠do. {sucessos} espelhos gerados com sucesso!', 'success')
    return redirect(url_for('documentos.dashboard_documentos'))

@documentos_bp.route('/api/user-info/<int:id>')
@login_required
def get_user_info_api(id):
    user = User.query.get_or_404(id)
    return jsonify({'razao_social': user.razao_social_empregadora, 'cnpj': user.cnpj_empregador})

# PROBLEMA 7: RESOLVIDO - Renderizar o PDF inline no navegador para evitar tela branca de nova aba
@documentos_bp.route('/admin/auditoria/certificado/<int:id>')
@login_required
@permission_required('AUDITORIA')
def baixar_certificado_auditoria(id):
    assinatura = AssinaturaDigital.query.get_or_404(id)
    usuario = User.query.get(assinatura.user_id)
    if not usuario: return redirect(url_for('documentos.revisao_auditoria'))
    usuario.nome = usuario.real_name

    try:
        pdf_bytes = gerar_certificado_entrega(assinatura, usuario)
        buffer = io.BytesIO(pdf_bytes)
        buffer.seek(0)
        
        # as_attachment=False instrui o navegador a desenhar o PDF na tela em vez de baixar √†s cegas
        return send_file(
            buffer, 
            mimetype='application/pdf', 
            as_attachment=False, 
            download_name=f"Auditoria_{usuario.real_name}_{assinatura.id}.pdf"
        )
    except Exception as e:
        print(f"Erro ao gerar certificado de auditoria: {e}")
        flash("Ocorreu um erro ao gerar o certificado. Tente novamente.", "error")
        return redirect(url_for('documentos.revisao_auditoria'))

# --- ROTAS DE ATESTADO ---
@documentos_bp.route('/atestados/meus')
@login_required
def meus_atestados():
    atestados = Atestado.query.filter_by(user_id=current_user.id).order_by(Atestado.data_envio.desc()).all()
    return render_template('documentos/meus_atestados.html', atestados=atestados)

@documentos_bp.route('/atestado/novo', methods=['GET', 'POST'])
@login_required
def enviar_atestado():
    if request.method == 'POST':
        file = request.files.get('arquivo_atestado')
        if not file or file.filename == '':
            flash('Nenhum arquivo selecionado.', 'error')
            return redirect(request.url)
        try:
            file_bytes = file.read()
            mes_ref = get_brasil_time().strftime('%Y-%m')
            caminho_blob = salvar_no_storage(file_bytes, f"atestados/{mes_ref}")
            if not caminho_blob: return redirect(request.url)

            dados_ia = analisar_atestado_vision(file_bytes, current_user.real_name)
            
            data_inicio_db = datetime.strptime(dados_ia['data_inicio'], '%Y-%m-%d').date() if dados_ia['data_inicio'] else None

            novo_atestado = Atestado(
                user_id=current_user.id, data_envio=get_brasil_time(), url_arquivo=caminho_blob,
                data_inicio_afastamento=data_inicio_db, quantidade_dias=dados_ia['dias_afastamento'],
                texto_extraido=dados_ia['texto_bruto'], status='Revisao' 
            )
            db.session.add(novo_atestado); db.session.commit()
            
            master = User.query.filter_by(username='50097952800').first()
            if master:
                enviar_notificacao(master.id, f"Novo Atestado de {current_user.real_name} aguardando an√°lise.", "/documentos/admin/atestados")
            
            flash('Atestado enviado com sucesso para o RH!', 'success')
            return redirect(url_for('documentos.meus_atestados'))
            
        except Exception as e:
            db.session.rollback(); flash('Ocorreu um erro ao processar seu atestado.', 'error')
            return redirect(request.url)
            
    return render_template('documentos/enviar_atestado.html')

@documentos_bp.route('/admin/atestados')
@login_required
@permission_required('DOCUMENTOS')
def gestao_atestados():
    atestados = Atestado.query.order_by(Atestado.data_envio.desc()).all()
    return render_template('documentos/gestao_atestados.html', atestados=atestados)

@documentos_bp.route('/atestado/baixar/<int:id>')
@login_required
def baixar_atestado(id):
    atestado = Atestado.query.get_or_404(id)
    if not has_permission('DOCUMENTOS') and atestado.user_id != current_user.id: return redirect(url_for('main.dashboard'))
    
    if atestado.url_arquivo:
        arquivo_bytes = baixar_bytes_storage(atestado.url_arquivo)
        if arquivo_bytes:
            ext = 'pdf' if 'pdf' in atestado.url_arquivo.lower() else 'jpeg'
            mimetype = 'application/pdf' if ext == 'pdf' else f'image/{ext}'
            
            buffer = io.BytesIO(arquivo_bytes)
            buffer.seek(0)
            
            return send_file(buffer, mimetype=mimetype, as_attachment=False, download_name=f"atestado_{id}.{ext}")
            
    return redirect(request.referrer or url_for('main.dashboard'))

@documentos_bp.route('/admin/atestados/<int:id>/avaliar', methods=['POST'])
@login_required
@permission_required('DOCUMENTOS')
def avaliar_atestado(id):
    atestado = Atestado.query.get_or_404(id)
    acao = request.form.get('acao')
    try:
        if acao == 'aprovar':
            data_inicio_str = request.form.get('data_inicio')
            qtd_dias_str = request.form.get('quantidade_dias')
            if not data_inicio_str or not qtd_dias_str: return redirect(url_for('documentos.gestao_atestados'))

            atestado.data_inicio_afastamento = datetime.strptime(data_inicio_str, '%Y-%m-%d').date()
            atestado.quantidade_dias = int(qtd_dias_str)
            atestado.status = 'Aprovado'
            
            for i in range(atestado.quantidade_dias):
                dia_atual = atestado.data_inicio_afastamento + timedelta(days=i)
                ponto = PontoResumo.query.filter_by(user_id=atestado.user_id, data_referencia=dia_atual).first()
                if ponto:
                    ponto.status_dia = 'Atestado'
                    ponto.minutos_esperados = 0
                    ponto.minutos_saldo = ponto.minutos_trabalhados
                else:
                    novo_ponto = PontoResumo(user_id=atestado.user_id, data_referencia=dia_atual, minutos_trabalhados=0, minutos_esperados=0, minutos_saldo=0, status_dia='Atestado')
                    db.session.add(novo_ponto)
                    
            enviar_notificacao(atestado.user_id, "O seu Atestado foi recebido e APROVADO com sucesso.", "/documentos/atestados/meus")
            
        elif acao == 'recusar':
            atestado.status = 'Recusado'
            atestado.motivo_recusa = request.form.get('motivo_recusa', 'Recusado pelo RH')
            enviar_notificacao(atestado.user_id, "O seu Atestado foi RECUSADO. Verifique o motivo.", "/documentos/atestados/meus")
            
        db.session.commit(); flash(f'Atestado avaliado com sucesso!', 'success')
    except Exception as e:
        db.session.rollback(); flash(f'Erro: {e}', 'error')
    return redirect(url_for('documentos.gestao_atestados'))

@documentos_bp.route('/admin/faxina-pdfs')
@login_required
@permission_required('DOCUMENTOS')
def migrar_pdfs_para_nuvem():
    flash("O sistema j√° est√° otimizado para a nuvem. N√£o √© necess√°rio executar a faxina.", "success")
    return redirect(url_for('documentos.dashboard_documentos'))

# --- M√ìDULO DE FECHAMENTO DE M√äS (EXCEL) ---
@documentos_bp.route('/relatorio-folha')
@login_required
@permission_required('DOCUMENTOS')
def relatorio_folha():
    return render_template('documentos/relatorio_folha.html')

@documentos_bp.route('/relatorio-folha/exportar', methods=['POST'])
@login_required
@permission_required('DOCUMENTOS')
def exportar_relatorio_folha():
    try:
        data_inicio_str = request.form.get('data_inicio')
        data_fim_str = request.form.get('data_fim')
        
        if not data_inicio_str or not data_fim_str:
            flash('Selecione as datas de in√≠cio e fim.', 'error')
            return redirect(url_for('documentos.relatorio_folha'))
            
        data_inicio = datetime.strptime(data_inicio_str, '%Y-%m-%d').date()
        data_fim = datetime.strptime(data_fim_str, '%Y-%m-%d').date()
        
        usuarios = User.query.filter(User.username != '12345678900', User.username != 'terminal').order_by(User.real_name).all()
        
        dados_relatorio = []
        
        for u in usuarios:
            pontos = PontoResumo.query.filter(
                PontoResumo.user_id == u.id,
                PontoResumo.data_referencia >= data_inicio,
                PontoResumo.data_referencia <= data_fim
            ).all()
            
            total_esperado = sum(p.minutos_esperados for p in pontos)
            total_trabalhado = sum(p.minutos_trabalhados for p in pontos)
            saldo = total_trabalhado - total_esperado
            
            faltas = sum(1 for p in pontos if p.status_dia == 'Falta')
            atestados = sum(1 for p in pontos if p.status_dia == 'Atestado')
            
            sinal = "+" if saldo >= 0 else "-"
            saldo_str = f"{sinal}{format_minutes_to_hm(abs(saldo))}"
            
            dados_relatorio.append({
                'Nome do Funcion√°rio': u.real_name,
                'CPF': u.cpf,
                'Departamento': u.departamento or 'N√£o Definido',
                'Cargo': u.role,
                'Total Horas Esperadas': format_minutes_to_hm(total_esperado),
                'Total Horas Realizadas': format_minutes_to_hm(total_trabalhado),
                'Saldo Extra / D√©bito': saldo_str,
                'Total Faltas (Dias)': faltas,
                'Atestados (Dias)': atestados
            })
            
        if not dados_relatorio:
            flash('Nenhum dado encontrado para o per√≠odo selecionado.', 'warning')
            return redirect(url_for('documentos.relatorio_folha'))
            
        df = pd.DataFrame(dados_relatorio)
        output = io.BytesIO()
        with pd.ExcelWriter(output, engine='openpyxl') as writer:
            df.to_excel(writer, index=False, sheet_name='Fechamento Folha')
            
            worksheet = writer.sheets['Fechamento Folha']
            for i, col in enumerate(df.columns):
                max_len = max(df[col].astype(str).map(len).max(), len(col)) + 2
                worksheet.column_dimensions[chr(65 + i)].width = max_len

        output.seek(0)
        nome_arquivo = f"Fechamento_Folha_{data_inicio_str}_a_{data_fim_str}.xlsx"
        
        return send_file(output, mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', as_attachment=True, download_name=nome_arquivo)

    except Exception as e:
        flash(f'Erro Cr√≠tico ao gerar relat√≥rio Excel: {str(e)}', 'error')
        return redirect(url_for('documentos.relatorio_folha'))



##################################################

FILE: app/documentos/storage.py
-------------------------------
from google.cloud import storage
import uuid
import io

# NOVO BUCKET GRATUITO NOS EUA
BUCKET_NAME = "shahin-docs-us"

def salvar_no_storage(pdf_bytes, pasta_ref):
    """Salva o PDF no bucket e retorna o caminho relativo."""
    try:
        client = storage.Client()
        bucket = client.bucket(BUCKET_NAME)
        # O arquivo ser√° salvo com a estrutura: pasta_ref/uuid.pdf
        nome_blob = f"{pasta_ref}/{uuid.uuid4()}.pdf"
        blob = bucket.blob(nome_blob)
        blob.upload_from_string(pdf_bytes, content_type='application/pdf')
        return nome_blob
    except Exception as e:
        print(f"Erro no Cloud Storage Upload: {e}")
        return None

def baixar_bytes_storage(caminho_blob):
    """
    Baixa o arquivo do Storage para a mem√≥ria do servidor.
    Isso evita problemas de Link Assinado/Chave Privada no Cloud Run.
    """
    try:
        client = storage.Client()
        bucket = client.bucket(BUCKET_NAME)
        blob = bucket.blob(caminho_blob)
        
        if not blob.exists():
            return None
            
        return blob.download_as_bytes()
    except Exception as e:
        print(f"Erro ao baixar do Storage: {e}")
        return None

# Fun√ß√£o legada mantida para compatibilidade, mas n√£o ser√° usada preferencialmente
def gerar_url_assinada(caminho_blob):
    return None



##################################################

FILE: app/documentos/utils.py
-----------------------------
from reportlab.pdfgen import canvas
from reportlab.lib.pagesizes import A4
from reportlab.lib.units import cm
from reportlab.lib import colors
from reportlab.platypus import Table, TableStyle
import io
import calendar
from datetime import date, timedelta, datetime
from app.utils import data_por_extenso, time_to_minutes, format_minutes_to_hm

def gerar_pdf_recibo(recibo, user):
    buffer = io.BytesIO()
    p = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4
    
    p.setFont("Helvetica-Bold", 14)
    p.drawString(2.5*cm, height - 3*cm, "RECIBO DE PAGAMENTO DE BENEF√çCIOS")
    p.setFont("Helvetica", 11)
    p.drawString(2.5*cm, height - 4*cm, "Recibo;")
    data_fmt = recibo.data_pagamento.strftime('%d/%m/%Y')
    p.drawString(2.5*cm, height - 4.6*cm, f"Data:  {data_fmt}")
    p.setFont("Helvetica", 11)
    
    empresa = user.razao_social_empregadora or "LA SHAHIN SERVI√áOS DE SEGURAN√áA LTDA"
    cnpj = user.cnpj_empregador or "50.537.235/0001-95"
    valor_fmt = f"{recibo.valor:,.2f}".replace(',', 'X').replace('.', ',').replace('X', '.')
    
    texto_corpo = p.beginText(2.5*cm, height - 6*cm)
    texto_corpo.setFont("Helvetica", 11)
    texto_corpo.setLeading(18)
    texto_corpo.textLines(f"Recebi de {empresa},")
    texto_corpo.textLines(f"inscrita no CNPJ n¬∫ {cnpj} a quantia de R$ {valor_fmt}")
    texto_corpo.textLines("referente ao pagamento do(s) benef√≠cio(s) abaixo assinalado(s):")
    p.drawText(texto_corpo)
    
    y_checkbox = height - 9*cm
    def draw_check(x, y, label, checked):
        mark = "(X)" if checked else "(  )"
        p.setFont("Helvetica-Bold", 11)
        p.drawString(x, y, mark)
        p.setFont("Helvetica", 11)
        p.drawString(x + 1*cm, y, label)

    draw_check(2.5*cm, y_checkbox, "Vale Alimenta√ß√£o (VA)", recibo.tipo_vale_alimentacao)
    draw_check(10.5*cm, y_checkbox, "Vale Transporte (VT)", recibo.tipo_vale_transporte)
    draw_check(2.5*cm, y_checkbox - 1*cm, "Assiduidade", recibo.tipo_assiduidade)
    draw_check(10.5*cm, y_checkbox - 1*cm, "Cesta B√°sica", recibo.tipo_cesta_basica)

    y_dados = height - 12*cm
    p.setFont("Helvetica-Bold", 12)
    p.drawString(2.5*cm, y_dados, "Dados do Funcion√°rio")
    y_dados -= 1*cm
    p.setFont("Helvetica", 11)
    p.drawString(2.5*cm, y_dados, f"Nome: {user.real_name}")
    cpf_fmt = user.cpf if user.cpf else "00000000000"
    if len(cpf_fmt) == 11: cpf_fmt = f"{cpf_fmt[:3]}.{cpf_fmt[3:6]}.{cpf_fmt[6:9]}-{cpf_fmt[9:]}"
    p.drawString(12*cm, y_dados, f"CPF: {cpf_fmt}")
    
    y_pgto = y_dados - 1.5*cm
    p.drawString(2.5*cm, y_pgto, "Forma de pagamento:")
    draw_check(7*cm, y_pgto, "Dinheiro", recibo.forma_pagamento == 'Dinheiro')
    draw_check(10.5*cm, y_pgto, "Pix", recibo.forma_pagamento == 'Pix')
    draw_check(13*cm, y_pgto, "Transfer√™ncia", recibo.forma_pagamento == 'Transfer√™ncia')

    p.drawString(2.5*cm, y_pgto - 1.5*cm, "Declaro que recebi o valor acima descrito, referente ao(s) benef√≠cio(s) assinalado(s).")
    
    y_ass = y_pgto - 4*cm
    p.line(2.5*cm, y_ass, 9*cm, y_ass)
    p.setFont("Helvetica", 10)
    p.drawString(3*cm, y_ass - 0.5*cm, "Assinatura do Empregado")
    p.line(11*cm, y_ass, 17.5*cm, y_ass)
    p.drawString(11.5*cm, y_ass - 0.5*cm, "Assinatura do Empregador")
    
    data_extenso = data_por_extenso(recibo.data_pagamento)
    p.setFont("Helvetica-Bold", 11)
    p.drawCentredString(width/2, y_ass - 2.5*cm, f"{data_extenso}.")

    p.showPage()
    p.save()
    buffer.seek(0)
    return buffer.read()

def gerar_pdf_espelho_mensal(user, mes_ano_str):
    from app.models import PontoRegistro, PontoResumo
    buffer = io.BytesIO()
    p = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4
    
    try: ano, mes = map(int, mes_ano_str.split('-'))
    except: now = datetime.now(); ano, mes = now.year, now.month

    p.setFont("Helvetica-Bold", 16)
    p.drawString(2*cm, height - 2*cm, "ESPELHO DE PONTO ELETR√îNICO")
    
    p.setFont("Helvetica", 10)
    p.drawString(2*cm, height - 3*cm, f"Colaborador: {user.real_name}")
    p.drawString(2*cm, height - 3.5*cm, f"Cargo: {user.role}")
    p.drawString(12*cm, height - 3*cm, f"Per√≠odo: {mes}/{ano}")
    
    empresa = user.razao_social_empregadora or "SHAHIN GEST√ÉO"
    cnpj = user.cnpj_empregador or ""
    p.drawString(2*cm, height - 4*cm, f"Empresa: {empresa} - CNPJ: {cnpj}")
    
    dados = [['Data', 'Dia', 'Entradas / Sa√≠das', 'Jornada', 'Saldo', 'Status']]
    last_day = calendar.monthrange(ano, mes)[1]
    total_saldo_min = 0
    dias_semana = {0:'Seg', 1:'Ter', 2:'Qua', 3:'Qui', 4:'Sex', 5:'S√°b', 6:'Dom'}
    
    for dia in range(1, last_day + 1):
        dt_atual = date(ano, mes, dia)
        pontos = PontoRegistro.query.filter_by(user_id=user.id, data_registro=dt_atual).order_by(PontoRegistro.hora_registro).all()
        horarios_str = "  ".join([pt.hora_registro.strftime('%H:%M') for pt in pontos])
        resumo_dia = PontoResumo.query.filter_by(user_id=user.id, data_referencia=dt_atual).first()
        
        meta = user.carga_horaria or 528
        if user.escala == '5x2' and dt_atual.weekday() >= 5: meta = 0
        elif user.escala == '12x36' and user.data_inicio_escala:
            if (dt_atual - user.data_inicio_escala).days % 2 != 0: meta = 0
            else: meta = 720
            
        trabalhado = 0
        for i in range(0, len(pontos), 2):
            if i+1 < len(pontos): trabalhado += (time_to_minutes(pontos[i+1].hora_registro) - time_to_minutes(pontos[i].hora_registro))
        
        saldo = trabalhado - meta
        status_abonados = ['Atestado', 'F√©rias', 'Licen√ßa', 'Folga Pr√™mio', 'Ferias', 'Licenca', 'Folga Premio']
        
        if resumo_dia and resumo_dia.status_dia in status_abonados:
            horarios_str = str(resumo_dia.status_dia).upper() 
            trabalhado = 0
            saldo = 0  
            status = "Abono"
        else:
            status = "OK"
            if not pontos: status = "Folga" if meta == 0 else "Falta"
            elif len(pontos) % 2 != 0: status = "Inc."
            elif saldo > 10: status = "+ Extra"
            elif saldo < -10: status = "D√©bito" if meta > 0 else "Extra"

        total_saldo_min += saldo
        dados.append([dt_atual.strftime('%d/%m'), dias_semana[dt_atual.weekday()], horarios_str, format_minutes_to_hm(trabalhado).replace('-', ''), format_minutes_to_hm(saldo), status])
    
    dados.append(['', '', 'TOTAL MENSAL', '', format_minutes_to_hm(total_saldo_min), ''])
    t = Table(dados, colWidths=[2*cm, 1.5*cm, 6*cm, 2*cm, 2*cm, 2.5*cm])
    t.setStyle(TableStyle([('BACKGROUND', (0,0), (-1,0), colors.navy), ('TEXTCOLOR', (0,0), (-1,0), colors.whitesmoke), ('ALIGN', (0,0), (-1,-1), 'CENTER'), ('FONTNAME', (0,0), (-1,0), 'Helvetica-Bold'), ('FONTSIZE', (0,0), (-1,0), 9), ('BOTTOMPADDING', (0,0), (-1,0), 8), ('BACKGROUND', (0,-1), (-1,-1), colors.lightgrey), ('GRID', (0,0), (-1,-1), 0.5, colors.grey), ('FONTSIZE', (0,1), (-1,-1), 8)]))
    w, h = t.wrapOn(p, width, height)
    t.drawOn(p, 2*cm, height - 6*cm - h)
    
    y_ass = 3*cm
    p.line(2*cm, y_ass, 9*cm, y_ass)
    p.setFont("Helvetica", 8)
    p.drawString(3*cm, y_ass - 0.5*cm, "Assinatura do Colaborador")
    p.line(12*cm, y_ass, 19*cm, y_ass)
    p.drawString(13*cm, y_ass - 0.5*cm, "Gestor Respons√°vel")
    p.drawString(2*cm, 1.5*cm, f"Documento gerado eletronicamente em {datetime.now().strftime('%d/%m/%Y %H:%M')}")

    p.showPage()
    p.save()
    buffer.seek(0)
    return buffer.read()

def gerar_certificado_entrega(assinatura, user):
    buffer = io.BytesIO()
    p = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4
    p.setFillColor(colors.navy)
    p.rect(0, height - 3*cm, width, 3*cm, fill=True, stroke=False)
    p.setFillColor(colors.white)
    p.setFont("Helvetica-Bold", 18)
    p.drawCentredString(width/2, height - 2*cm, "CERTIFICADO DE ENTREGA DIGITAL")
    p.setFillColor(colors.black)
    p.setFont("Helvetica", 12)
    texto = p.beginText(2.5*cm, height - 5*cm)
    texto.setLeading(20)
    texto.textLines(f"Certificamos, para os devidos fins de direito e prova, que o colaborador:")
    texto.textLines(f"Nome: {user.real_name}")
    texto.textLines(f"CPF: {user.cpf}")
    texto.textLines(f"")
    texto.textLines(f"Realizou o ACESSO e CONFIRMA√á√ÉO DE RECEBIMENTO do documento digital")
    texto.textLines(f"identificado abaixo, atrav√©s da plataforma SHAHIN GEST√ÉO.")
    p.drawText(texto)
    p.setStrokeColor(colors.grey)
    p.rect(2.5*cm, height - 16*cm, 16*cm, 7*cm)
    p.setFont("Helvetica-Bold", 12)
    p.drawString(3*cm, height - 10*cm, "DADOS DA TRANSA√á√ÉO DIGITAL")
    p.setFont("Helvetica", 10)
    y_forense = height - 11*cm
    p.drawString(3*cm, y_forense, f"Documento: {assinatura.tipo_documento} (ID: {assinatura.documento_id})")
    p.drawString(3*cm, y_forense - 1*cm, f"Data/Hora do Acesso: {assinatura.data_assinatura.strftime('%d/%m/%Y %H:%M:%S')} (UTC-3)")
    p.drawString(3*cm, y_forense - 2*cm, f"Endere√ßo IP de Origem: {assinatura.ip_address}")
    p.drawString(3*cm, y_forense - 3*cm, f"Dispositivo/Navegador: {assinatura.user_agent[:60]}...")
    p.setFont("Helvetica-Bold", 10)
    p.drawString(3*cm, y_forense - 4.5*cm, "Hash de Integridade (SHA-256):")
    p.setFont("Courier", 8)
    p.drawString(3*cm, y_forense - 5*cm, f"{assinatura.hash_arquivo}")
    p.setFont("Helvetica-Oblique", 9)
    p.drawCentredString(width/2, 3*cm, "Este registro eletr√¥nico possui validade jur√≠dica conforme MP 2.200-2/2001.")
    p.drawCentredString(width/2, 2.5*cm, "A integridade do arquivo pode ser verificada atrav√©s do Hash acima.")
    p.showPage()
    p.save()
    buffer.seek(0)
    return buffer.read()

# --- NOVO: GERADOR DE AVISO DE F√âRIAS OFICIAL (CLT) ---
def gerar_aviso_ferias_pdf(solicitacao, user):
    """Gera o documento legal de Aviso e Recibo de F√©rias."""
    buffer = io.BytesIO()
    p = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4
    
    empresa = user.razao_social_empregadora or "LA SHAHIN SERVI√áOS DE SEGURAN√áA LTDA"
    cnpj = user.cnpj_empregador or "50.537.235/0001-95"
    
    p.setFont("Helvetica-Bold", 14)
    p.drawCentredString(width/2, height - 3*cm, "AVISO DE F√âRIAS")
    
    p.setFont("Helvetica", 11)
    texto = p.beginText(2.5*cm, height - 5*cm)
    texto.setLeading(22)
    texto.textLines(f"Empregador: {empresa} - CNPJ: {cnpj}")
    texto.textLines(f"Empregado(a): {user.real_name}")
    
    cpf_fmt = user.cpf if user.cpf else "00000000000"
    if len(cpf_fmt) == 11: cpf_fmt = f"{cpf_fmt[:3]}.{cpf_fmt[3:6]}.{cpf_fmt[6:9]}-{cpf_fmt[9:]}"
    texto.textLines(f"CPF: {cpf_fmt}")
    
    texto.textLines("")
    texto.textLines("Nos termos das disposi√ß√µes legais vigentes, avisamos que lhe ser√£o concedidas")
    texto.textLines(f"f√©rias regulares de {solicitacao.quantidade_dias} dias.")
    texto.textLines("")
    texto.textLines(f"Per√≠odo de Gozo: de {solicitacao.data_inicio.strftime('%d/%m/%Y')} a {solicitacao.data_fim.strftime('%d/%m/%Y')}.")
    
    if solicitacao.abono_pecuniario:
        texto.textLines("")
        texto.textLines(f"Abono Pecuni√°rio Solicitado: SIM ({solicitacao.dias_abono} dias vendidas).")
    
    texto.textLines("")
    texto.textLines("Solicitamos a devolu√ß√£o da via anexa com sua assinatura, confirmando o")
    texto.textLines("recebimento deste aviso com a anteced√™ncia m√≠nima legal de 30 (trinta) dias.")
    p.drawText(texto)
    
    y_ass = height - 14*cm
    p.line(2.5*cm, y_ass, 9*cm, y_ass)
    p.setFont("Helvetica", 10)
    p.drawString(3*cm, y_ass - 0.5*cm, "Assinatura do Empregado")
    p.line(11*cm, y_ass, 17.5*cm, y_ass)
    p.drawString(11.5*cm, y_ass - 0.5*cm, "Assinatura do Empregador")
    
    data_extenso = data_por_extenso(datetime.now().date())
    p.setFont("Helvetica-Bold", 11)
    p.drawCentredString(width/2, y_ass - 2.5*cm, f"Data da emiss√£o do aviso: {data_extenso}.")

    p.showPage()
    p.save()
    buffer.seek(0)
    return buffer.read()



##################################################

FILE: app/documentos/templates/documentos/admin_upload_holerite.html
--------------------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-6 flex justify-between items-center">
        <div><h2 class="text-2xl font-bold text-slate-800">Importa√ß√£o de Holerites</h2><p class="text-sm text-slate-500">Envie o PDF da folha.</p></div>
        <form action="/documentos/admin/holerites" method="POST" onsubmit="return confirm('Apagar hist√≥rico?')">
            <input type="hidden" name="acao" value="limpar_tudo">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="text-xs text-red-500 hover:text-red-700 underline font-bold">Limpar Hist√≥rico</button>
        </form>
    </div>

    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-8 mb-8">
        <form action="/documentos/admin/holerites" method="POST" enctype="multipart/form-data" class="space-y-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="label-pro">M√™s de Refer√™ncia</label>
                    <input type="month" name="mes_ref" class="input-pro" required>
                </div>
                <div>
                    <label class="label-pro">Arquivo PDF</label>
                    <input type="file" name="arquivo_pdf" accept=".pdf" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" required>
                </div>
            </div>
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-md transition flex items-center justify-center gap-2" onclick="this.innerHTML='<i class=\'fas fa-spinner fa-spin\'></i> Processando...';"><i class="fas fa-cloud-upload-alt"></i> PROCESSAR E DISTRIBUIR</button>
        </form>
    </div>

    <h3 class="text-lg font-bold text-slate-700 mb-4 px-2">√öltimos Envios</h3>
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-slate-600">
                <thead class="bg-slate-50 text-xs uppercase text-slate-400 font-bold border-b border-slate-100">
                    <tr><th class="px-6 py-3">Funcion√°rio</th><th class="px-6 py-3">Refer√™ncia</th><th class="px-6 py-3 text-center">Status</th><th class="px-6 py-3 text-right">A√ß√£o</th></tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    {% for item in uploads %}
                    <tr class="hover:bg-slate-50 transition">
                        <td class="px-6 py-3 font-bold text-slate-800">{{ item.user.real_name }}</td>
                        <td class="px-6 py-3">{{ item.mes_referencia }}</td>
                        <td class="px-6 py-3 text-center">{% if item.visualizado %}<span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-[10px] font-bold uppercase">Lido</span>{% else %}<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-[10px] font-bold uppercase">Pendente</span>{% endif %}</td>
                        <td class="px-6 py-3 text-right">
                            <form action="/documentos/baixar/holerite/{{ item.id }}" method="POST" target="_blank" style="display:inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="text-blue-600 hover:underline text-xs font-bold"><i class="fas fa-download"></i> Baixar</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400">Nenhum envio recente.</td></tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}



##################################################

FILE: app/documentos/templates/documentos/auditoria.html
--------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div>
        <h2 class="text-2xl font-bold text-slate-800">Auditoria de Recebimento</h2>
        <p class="text-sm text-slate-500">Controlo de conformidade e assinaturas digitais por colaborador.</p>
    </div>
    <div class="relative w-full md:w-80">
        <input type="text" id="userSearch" onkeyup="searchUsers()" placeholder="Pesquisar funcion√°rio pelo nome..." 
               class="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 pl-11 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition shadow-sm">
        <i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i>
    </div>
</div>

<div class="space-y-3" id="usersList">
    {% for item in auditores %}
    <div class="user-item bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm transition hover:shadow-md" data-name="{{ item.user.real_name.lower() }}">
        <!-- Cabe√ßalho (Accordion Toggle) -->
        <button onclick="toggleAccordion('box-{{ item.user.id }}')" 
                class="w-full px-6 py-5 flex items-center justify-between hover:bg-slate-50/80 transition group">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 font-bold border-2 border-white shadow-inner">
                    {{ item.user.real_name[:1].upper() }}
                </div>
                <div class="text-left">
                    <div class="font-bold text-slate-800 text-base group-hover:text-blue-600 transition">{{ item.user.real_name }}</div>
                    <div class="text-[10px] text-slate-400 uppercase tracking-widest font-bold flex items-center gap-2">
                        <span>CPF: {{ item.user.cpf }}</span>
                        <span class="text-slate-200">|</span>
                        <span>{{ item.user.role }}</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <div class="hidden md:block text-right">
                    <div class="text-[10px] text-slate-400 uppercase font-bold">Total Assinado</div>
                    <div class="font-mono font-bold text-slate-700">{{ item.total }} docs</div>
                </div>
                <i class="fas fa-chevron-down text-slate-300 transition-transform duration-300 text-lg" id="icon-box-{{ item.user.id }}"></i>
            </div>
        </button>

        <!-- Painel de Detalhes -->
        <div id="box-{{ item.user.id }}" class="hidden border-t border-slate-100 bg-slate-50/30">
            {% if item.assinaturas %}
            <div class="p-2">
                <div class="overflow-x-auto rounded-lg border border-slate-100">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-100/50 text-[10px] text-slate-500 uppercase font-bold">
                            <tr>
                                <th class="px-6 py-3">Tipo</th>
                                <th class="px-6 py-3">Refer√™ncia do Documento</th>
                                <th class="px-6 py-3">Data/Hora Assinatura</th>
                                <th class="px-6 py-3 text-right">Certificado Forense</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 bg-white">
                            {% for a in item.assinaturas %}
                            <tr class="hover:bg-blue-50/50 transition">
                                <td class="px-6 py-4">
                                    <span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-tight
                                        {% if a.tipo == 'Holerite' %} bg-blue-50 text-blue-600 
                                        {% elif a.tipo == 'Recibo' %} bg-emerald-50 text-emerald-600 
                                        {% else %} bg-purple-50 text-purple-600 {% endif %}">
                                        {{ a.tipo }}
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="font-bold text-slate-700">{{ a.referencia }}</div>
                                    <div class="text-[9px] text-slate-400 font-mono">IP: {{ a.ip }}</div>
                                </td>
                                <td class="px-6 py-4 text-slate-600">
                                    <div class="font-medium">{{ a.data.strftime('%d/%m/%Y') }}</div>
                                    <div class="text-xs text-slate-400">{{ a.data.strftime('%H:%M:%S') }}</div>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <a href="/documentos/admin/auditoria/certificado/{{ a.id }}" target="_blank" 
                                       class="inline-flex items-center gap-2 bg-white border border-slate-200 text-slate-700 hover:bg-slate-900 hover:text-white hover:border-slate-900 px-4 py-2 rounded-lg font-bold text-xs transition shadow-sm">
                                        <i class="fas fa-file-signature text-blue-500"></i> Baixar Comprovante
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
            <div class="px-6 py-12 text-center text-slate-400 bg-white">
                <i class="fas fa-comment-slash text-3xl mb-3 opacity-20"></i>
                <p class="text-sm">Este colaborador ainda n√£o possui registos de assinatura digital.</p>
                <p class="text-[10px] uppercase mt-1">O sistema aguarda o primeiro download de documento.</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<script>
    function toggleAccordion(id) {
        const content = document.getElementById(id);
        const icon = document.getElementById('icon-' + id);
        content.classList.toggle('hidden');
        icon.classList.toggle('rotate-180');
    }

    function searchUsers() {
        let input = document.getElementById('userSearch').value.toLowerCase();
        let items = document.getElementsByClassName('user-item');
        for (let i = 0; i < items.length; i++) {
            let name = items[i].getAttribute('data-name');
            if (name.includes(input)) {
                items[i].style.display = "";
            } else {
                items[i].style.display = "none";
            }
        }
    }
</script>
{% endblock %}




##################################################

FILE: app/documentos/templates/documentos/dashboard.html
--------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
    <div>
        <h2 class="text-2xl font-bold text-slate-800">Central de Documentos</h2>
        <p class="text-sm text-slate-500">Gest√£o integrada de RH e Financeiro.</p>
    </div>
    
    <div class="flex flex-wrap gap-2">
        {% if pendentes_revisao > 0 %}
        <a href="/documentos/admin/revisao" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg text-xs transition flex items-center gap-2 animate-pulse">
            <i class="fas fa-exclamation-circle"></i> REVISAR PEND√äNCIAS ({{ pendentes_revisao }})
        </a>
        {% endif %}
    </div>
</div>

<div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm mb-6">
    <form method="GET" action="{{ url_for('documentos.dashboard_documentos') }}" class="flex flex-col md:flex-row gap-3 items-end">
        <div class="flex-1 w-full">
            <label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Nome do Funcion√°rio</label>
            <input type="text" name="nome" value="{{ f_nome }}" placeholder="Buscar por nome..." class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold text-slate-700 outline-none focus:border-blue-500 transition">
        </div>
        <div class="w-full md:w-48">
            <label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Tipo de Documento</label>
            <select name="tipo" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold text-slate-700 outline-none focus:border-blue-500 transition">
                <option value="">Todos</option>
                <option value="Holerite" {% if f_tipo == 'Holerite' %}selected{% endif %}>Holerite</option>
                <option value="Espelho" {% if f_tipo == 'Espelho' %}selected{% endif %}>Espelho de Ponto</option>
                <option value="Recibo" {% if f_tipo == 'Recibo' %}selected{% endif %}>Recibo</option>
            </select>
        </div>
        <div class="w-full md:w-40">
            <label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Refer√™ncia</label>
            <input type="month" name="mes" value="{{ f_mes }}" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold text-slate-700 outline-none focus:border-blue-500 transition">
        </div>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg text-sm transition shadow-md w-full md:w-auto">
            <i class="fas fa-filter mr-1"></i> FILTRAR
        </button>
        {% if f_nome or f_mes or f_tipo %}
        <a href="{{ url_for('documentos.dashboard_documentos') }}" class="bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-2 px-4 rounded-lg text-sm transition w-full md:w-auto text-center">
            LIMPAR
        </a>
        {% endif %}
    </form>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 mb-4"><i class="fas fa-file-invoice text-xl"></i></div>
        <h3 class="font-bold text-md text-slate-800 mb-2">Holerite em massa</h3>
        <a href="/documentos/admin/holerites" class="block w-full text-center bg-slate-50 hover:bg-blue-50 text-blue-600 font-bold py-2 text-xs rounded border border-slate-200 transition uppercase">Importar</a>
    </div>
    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
        <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center text-emerald-600 mb-4"><i class="fas fa-file-signature text-xl"></i></div>
        <h3 class="font-bold text-md text-slate-800 mb-2">Recibo Avulso</h3>
        <a href="/documentos/admin/recibo/novo" class="block w-full text-center bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 text-xs rounded shadow transition uppercase">Novo Recibo</a>
    </div>
    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center text-purple-600 mb-4"><i class="fas fa-calendar-check text-xl"></i></div>
        <h3 class="font-bold text-md text-slate-800 mb-2">Disparar Espelhos</h3>
        <form action="/documentos/admin/disparar-espelhos" method="POST" class="flex gap-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="month" name="mes_ref" class="w-full border rounded px-2 py-1 text-xs" required>
            <button type="submit" class="bg-purple-600 text-white px-3 py-2 rounded text-xs font-bold transition"><i class="fas fa-paper-plane"></i></button>
        </form>
    </div>
</div>

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-10">
    <div class="overflow-x-auto">
        <table class="w-full text-left text-sm text-slate-600">
            <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold border-b border-slate-100">
                <tr>
                    <th class="px-6 py-4">Tipo</th>
                    <th class="px-6 py-4">Funcion√°rio</th>
                    <th class="px-6 py-4">Ref/Valor</th>
                    <th class="px-6 py-4">Enviado em</th>
                    <th class="px-6 py-4 text-center">Status</th>
                    <th class="px-6 py-4 text-right">A√ß√µes</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
                {% for doc in historico %}
                <tr class="hover:bg-slate-50 transition group">
                    <td class="px-6 py-4"><span class="bg-{{ doc['cor'] }}-50 text-{{ doc['cor'] }}-600 px-2 py-1 rounded text-[10px] font-bold uppercase border border-{{ doc['cor'] }}-100">{{ doc['tipo'] }}</span></td>
                    <td class="px-6 py-4 font-bold text-slate-800">{{ doc['usuario'] }}</td>
                    <td class="px-6 py-4 text-xs font-medium text-slate-600">{{ doc['info'] }}</td>
                    <td class="px-6 py-4 text-xs text-slate-400">
                        {{ doc['data'].strftime('%d/%m/%Y %H:%M') if doc['data'] else '--' }}
                    </td>
                    <td class="px-6 py-4 text-center">
                        {% if doc['visualizado'] %}
                        <span class="text-emerald-600 font-bold text-[10px] uppercase flex items-center justify-center gap-1"><i class="fas fa-check-circle"></i> Lido</span>
                        {% else %}
                        <span class="text-amber-500 font-bold text-[10px] uppercase flex items-center justify-center gap-1"><i class="fas fa-clock"></i> Enviado</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-right flex items-center justify-end gap-2">
                        <form action="{{ url_for('documentos.' + doc['rota'], id=doc['id']) }}" method="POST" target="_blank">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="text-slate-400 hover:text-blue-600 p-2" title="Visualizar"><i class="fas fa-file-pdf text-lg"></i></button>
                        </form>
                        
                        <button type="button" onclick="confirmarAcao('ATEN√á√ÉO: Deseja realmente excluir este documento? O funcion√°rio perder√° o acesso.', '{{ url_for('documentos.excluir_documento', doc_type=doc['doc_type'], id=doc['id']) }}')" class="text-slate-300 hover:text-red-500 p-2 transition cursor-pointer" title="Excluir">
                            <i class="fas fa-trash-alt text-lg"></i>
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="6" class="px-6 py-20 text-center text-slate-400 font-medium">Nenhum documento encontrado.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}



##################################################

FILE: app/documentos/templates/documentos/enviar_atestado.html
--------------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-md mx-auto bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mt-8">
    <div class="bg-blue-600 p-6 text-center">
        <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3 text-white">
            <i class="fas fa-file-medical text-3xl"></i>
        </div>
        <h2 class="text-xl font-bold text-white">Enviar Atestado M√©dico</h2>
        <p class="text-blue-100 text-sm mt-1">Tire uma foto leg√≠vel do documento</p>
    </div>
    
    <div class="p-6">
        <form id="form-atestado" action="{{ url_for('documentos.enviar_atestado') }}" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <div class="mb-6">
                <label class="label-pro mb-3">Selecione a Imagem ou PDF</label>
                <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:bg-slate-50 transition cursor-pointer">
                    <i class="fas fa-camera text-slate-400 text-3xl mb-2"></i>
                    <input type="file" name="arquivo_atestado" accept=".jpg,.jpeg,.png,.pdf" required class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                </div>
                <p class="text-[10px] text-slate-500 mt-3"><i class="fas fa-info-circle text-blue-400 mr-1"></i> Certifique-se de que o seu nome, a data e a quantidade de dias est√£o bem vis√≠veis na foto.</p>
            </div>
            
            <button type="submit" id="btn-submit-atestado" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition shadow-md flex items-center justify-center gap-2">
                <i id="icon-submit" class="fas fa-paper-plane"></i> 
                <span id="text-submit">ENVIAR ATESTADO</span>
            </button>
            <a href="{{ url_for('documentos.meus_documentos') }}" class="block text-center w-full text-slate-400 hover:text-slate-600 text-xs font-bold mt-4 transition">CANCELAR</a>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('form-atestado');
        const btnSubmit = document.getElementById('btn-submit-atestado');
        const iconSubmit = document.getElementById('icon-submit');
        const textSubmit = document.getElementById('text-submit');

        form.addEventListener('submit', function() {
            // Desabilita o bot√£o para evitar m√∫ltiplos envios
            btnSubmit.disabled = true;
            btnSubmit.classList.remove('hover:bg-blue-700');
            btnSubmit.classList.add('opacity-75', 'cursor-not-allowed');

            // Troca o √≠cone para um spinner rodando
            iconSubmit.className = 'fas fa-spinner fa-spin';

            // Altera o texto exatamente como solicitado
            textSubmit.innerText = 'Enviando atestado, aguarde...';
        });
    });
</script>
{% endblock %}



##################################################

FILE: app/documentos/templates/documentos/gestao_atestados.html
---------------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-8">
    <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
        <i class="fas fa-file-medical text-teal-600"></i> Gest√£o de Atestados
    </h2>
    <p class="text-sm text-slate-500">Verifique, edite (se necess√°rio) e valide os atestados m√©dicos.</p>
</div>

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-10">
    <div class="overflow-x-auto">
        <table class="w-full text-left text-sm text-slate-600">
            <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold border-b border-slate-100">
                <tr>
                    <th class="px-6 py-4">Funcion√°rio</th>
                    <th class="px-6 py-4">Enviado em</th>
                    <th class="px-6 py-4">In√≠cio (Afastamento)</th>
                    <th class="px-6 py-4">Dias</th>
                    <th class="px-6 py-4 text-center">Status</th>
                    <th class="px-6 py-4 text-right">A√ß√µes</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
                {% for atestado in atestados %}
                <tr class="hover:bg-slate-50 transition">
                    <td class="px-6 py-4 font-bold text-slate-800">{{ atestado.user.real_name }}</td>
                    <td class="px-6 py-4 text-xs">{{ atestado.data_envio.strftime('%d/%m/%Y %H:%M') }}</td>
                    
                    {% if atestado.status == 'Revisao' or atestado.status == 'Processando' %}
                    <form action="{{ url_for('documentos.avaliar_atestado', id=atestado.id) }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        
                        <td class="px-6 py-4">
                            <input type="date" name="data_inicio" value="{{ atestado.data_inicio_afastamento.strftime('%Y-%m-%d') if atestado.data_inicio_afastamento else '' }}" required class="border border-slate-300 rounded px-2 py-1 text-xs w-full">
                        </td>
                        <td class="px-6 py-4">
                            <input type="number" name="quantidade_dias" value="{{ atestado.quantidade_dias if atestado.quantidade_dias else '' }}" min="1" max="180" required class="border border-slate-300 rounded px-2 py-1 text-xs w-20">
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="bg-amber-100 text-amber-600 px-2 py-1 rounded text-[10px] font-bold uppercase"><i class="fas fa-search"></i> Em Revis√£o</span>
                        </td>
                        <td class="px-6 py-4 text-right flex items-center justify-end gap-2">
                            <a href="{{ url_for('documentos.baixar_atestado', id=atestado.id) }}" target="_blank" class="text-slate-500 hover:text-blue-600 p-2 bg-slate-100 rounded transition" title="Ver Documento">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button type="submit" name="acao" value="aprovar" class="text-white bg-emerald-500 hover:bg-emerald-600 p-2 rounded transition" title="Aprovar e Abonar Horas">
                                <i class="fas fa-check"></i>
                            </button>
                            <button type="submit" name="acao" value="recusar" class="text-white bg-red-500 hover:bg-red-600 p-2 rounded transition" title="Recusar" onclick="return confirm('Tem a certeza que deseja recusar este atestado?');">
                                <i class="fas fa-times"></i>
                            </button>
                        </td>
                    </form>
                    
                    {% else %}
                    <td class="px-6 py-4 font-medium text-slate-700">
                        {{ atestado.data_inicio_afastamento.strftime('%d/%m/%Y') if atestado.data_inicio_afastamento else '--' }}
                    </td>
                    <td class="px-6 py-4 font-bold text-blue-600">
                        {{ atestado.quantidade_dias }} dia(s)
                    </td>
                    <td class="px-6 py-4 text-center">
                        {% if atestado.status == 'Aprovado' %}
                            <span class="bg-emerald-100 text-emerald-600 px-2 py-1 rounded text-[10px] font-bold uppercase"><i class="fas fa-check"></i> Aprovado</span>
                        {% else %}
                            <span class="bg-red-100 text-red-600 px-2 py-1 rounded text-[10px] font-bold uppercase"><i class="fas fa-times"></i> Recusado</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-right">
                        <a href="{{ url_for('documentos.baixar_atestado', id=atestado.id) }}" target="_blank" class="text-slate-500 hover:text-blue-600 p-2 bg-slate-100 rounded transition text-xs font-bold uppercase">
                            <i class="fas fa-eye mr-1"></i> Ver Anexo
                        </a>
                    </td>
                    {% endif %}
                </tr>
                {% else %}
                <tr><td colspan="6" class="px-6 py-20 text-center text-slate-400 font-medium">Nenhum atestado recebido.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}



##################################################

FILE: app/documentos/templates/documentos/meus_atestados.html
-------------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6"><h2 class="text-2xl font-bold text-slate-800">Meus Atestados M√©dicos</h2></div>

<div class="mb-8">
    <a href="{{ url_for('documentos.enviar_atestado') }}" class="w-full md:w-auto text-center inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition text-sm">
        <i class="fas fa-camera mr-2"></i> ENVIAR NOVO ATESTADO
    </a>
</div>

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-left text-sm text-slate-600">
            <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold border-b border-slate-100">
                <tr>
                    <th class="px-6 py-4">Enviado em</th>
                    <th class="px-6 py-4">In√≠cio</th>
                    <th class="px-6 py-4">Dias</th>
                    <th class="px-6 py-4 text-center">Status</th>
                    <th class="px-6 py-4 text-right">Arquivo</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
                {% for atestado in atestados %}
                <tr class="hover:bg-slate-50 transition">
                    <td class="px-6 py-4 text-xs">{{ atestado.data_envio.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td class="px-6 py-4 font-medium text-slate-700">
                        {{ atestado.data_inicio_afastamento.strftime('%d/%m/%Y') if atestado.data_inicio_afastamento else '--' }}
                    </td>
                    <td class="px-6 py-4 font-bold text-blue-600">
                        {{ atestado.quantidade_dias if atestado.quantidade_dias else '--' }}
                    </td>
                    <td class="px-6 py-4 text-center">
                        {% if atestado.status == 'Processando' or atestado.status == 'Revisao' %}
                            <span class="bg-amber-100 text-amber-600 px-2 py-1 rounded text-[10px] font-bold uppercase"><i class="fas fa-clock"></i> Em An√°lise</span>
                        {% elif atestado.status == 'Aprovado' %}
                            <span class="bg-emerald-100 text-emerald-600 px-2 py-1 rounded text-[10px] font-bold uppercase"><i class="fas fa-check"></i> Aprovado</span>
                        {% else %}
                            <span class="bg-red-100 text-red-600 px-2 py-1 rounded text-[10px] font-bold uppercase"><i class="fas fa-times"></i> Recusado</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-right">
                        <a href="{{ url_for('documentos.baixar_atestado', id=atestado.id) }}" target="_blank" class="text-slate-500 hover:text-blue-600 p-2 bg-slate-100 rounded transition" title="Ver Arquivo Enviado">
                            <i class="fas fa-eye"></i>
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="5" class="px-6 py-20 text-center text-slate-400 font-medium">Voc√™ ainda n√£o enviou nenhum atestado.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}



##################################################

FILE: app/documentos/templates/documentos/meus_documentos.html
--------------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6"><h2 class="text-2xl font-bold text-slate-800">Meus Documentos</h2></div>

<div class="mb-8 flex flex-col md:flex-row justify-between items-center bg-blue-50 p-6 rounded-xl border border-blue-100 shadow-sm">
    <div class="mb-4 md:mb-0">
        <h3 class="text-blue-800 font-bold text-lg flex items-center gap-2">
            <i class="fas fa-file-medical text-2xl"></i> Atestados M√©dicos
        </h3>
        <p class="text-blue-600 text-sm mt-1">Envie atestados m√©dicos diretamente pelo telem√≥vel para justificar faltas.</p>
    </div>
    <a href="{{ url_for('documentos.enviar_atestado') }}" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition text-sm flex items-center gap-2 whitespace-nowrap">
        <i class="fas fa-camera"></i> ENVIAR ATESTADO
    </a>
</div>

<div class="space-y-4">
    {% for doc in docs %}
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5 flex flex-col md:flex-row md:items-center justify-between gap-4 transition hover:shadow-md">
        
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-lg flex items-center justify-center text-xl bg-{{ doc.cor }}-100 text-{{ doc.cor }}-600">
                <i class="fas {{ doc.icone }}"></i>
            </div>
            
            <div>
                <div class="flex items-center gap-2">
                    <h3 class="font-bold text-slate-800">{{ doc.titulo }}</h3>
                    {% if doc.visto %}
                    <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded font-bold uppercase">Visto</span>
                    {% else %}
                    <span class="text-[10px] bg-blue-600 text-white px-2 py-0.5 rounded font-bold uppercase animate-pulse">Novo</span>
                    {% endif %}
                </div>
                <p class="text-xs text-slate-500">{{ doc.data.strftime('%d/%m/%Y') }} - {{ doc.tipo }}</p>
            </div>
        </div>

        <form action="{{ url_for('documentos.' + doc.rota, id=doc.id) }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="w-full md:w-auto px-6 py-3 rounded-lg font-bold text-sm transition border flex items-center justify-center gap-2
                {% if doc.visto %} 
                    bg-white text-slate-600 border-slate-200 hover:bg-slate-50 
                {% else %} 
                    bg-blue-600 text-white border-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-200 
                {% endif %}">
                {% if doc.visto %} 
                    <i class="fas fa-download"></i> Baixar C√≥pia 
                {% else %} 
                    <i class="fas fa-file-contract"></i> Confirmar e Baixar 
                {% endif %}
            </button>
        </form>

    </div>
    {% else %}
    <div class="text-center py-16 text-slate-400 bg-white rounded-xl border border-slate-200 border-dashed">
        <i class="fas fa-folder-open text-4xl mb-4 opacity-50"></i>
        <p>Nenhum documento dispon√≠vel no momento.</p>
    </div>
    {% endfor %}
</div>
{% endblock %}



##################################################

FILE: app/documentos/templates/documentos/novo_recibo.html
----------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<div class="max-w-2xl mx-auto">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-slate-800">Gerar Recibo de Pagamento</h2>
        <a href="/documentos/admin" class="text-xs font-bold text-slate-400 hover:text-slate-600">CANCELAR</a>
    </div>

    <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
        <div class="bg-slate-50 border-b border-slate-100 p-6 text-center">
            <h3 class="font-serif font-bold text-lg text-slate-700">RECIBO DE PAGAMENTO DE BENEF√çCIOS</h3>
        </div>

        <form action="/documentos/admin/recibo/novo" method="POST" class="p-8 space-y-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

            <div>
                <label class="label-pro">Selecione o Funcion√°rio</label>
                <select name="user_id" id="userSelect" class="w-full" onchange="carregarDadosUser(this.value)" required>
                    <option value="">Digite para pesquisar...</option>
                    {% for u in users %}
                    <option value="{{ u.id }}">{{ u.real_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100 text-sm font-serif text-slate-700 italic">
                "Recebi de <strong id="previewEmpresa" class="text-slate-900">...</strong>, inscrita no CNPJ <strong id="previewCnpj" class="text-slate-900">...</strong> a quantia abaixo..."
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label-pro text-emerald-600">Valor (R$)</label>
                    <input type="number" step="0.01" name="valor" class="input-pro text-2xl font-bold text-emerald-700" placeholder="0,00" required>
                </div>
                <div>
                    <label class="label-pro">Data do Pagamento</label>
                    <input type="date" name="data_pagamento" value="{{ hoje }}" class="input-pro" required>
                </div>
            </div>

            <div>
                <label class="label-pro">Tipo de Benef√≠cio (Marque as op√ß√µes)</label>
                <div class="grid grid-cols-2 gap-3 mt-2">
                    <label class="flex items-center p-3 border rounded-lg hover:bg-slate-50 cursor-pointer transition">
                        <input type="checkbox" name="va" checked class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2 text-sm font-bold text-slate-700">Vale Alimenta√ß√£o (VA)</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg hover:bg-slate-50 cursor-pointer transition">
                        <input type="checkbox" name="vt" checked class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2 text-sm font-bold text-slate-700">Vale Transporte (VT)</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg hover:bg-slate-50 cursor-pointer transition">
                        <input type="checkbox" name="assiduidade" class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2 text-sm font-bold text-slate-700">Assiduidade</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg hover:bg-slate-50 cursor-pointer transition">
                        <input type="checkbox" name="cesta" class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2 text-sm font-bold text-slate-700">Cesta B√°sica</span>
                    </label>
                </div>
            </div>

            <div>
                <label class="label-pro">Forma de Pagamento</label>
                <div class="flex gap-4 mt-2 text-sm text-slate-700 font-bold">
                    <label class="flex items-center cursor-pointer"><input type="radio" name="forma_pagamento" value="Pix" checked class="mr-2"> Pix</label>
                    <label class="flex items-center cursor-pointer"><input type="radio" name="forma_pagamento" value="Dinheiro" class="mr-2"> Dinheiro</label>
                    <label class="flex items-center cursor-pointer"><input type="radio" name="forma_pagamento" value="Transfer√™ncia" class="mr-2"> Transfer√™ncia</label>
                </div>
            </div>

            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition">
                <i class="fas fa-file-signature mr-2"></i> GERAR E SALVAR RECIBO
            </button>
        </form>
    </div>
</div>

<script>
    // Inicializa o TomSelect para pesquisa
    new TomSelect("#userSelect",{
        create: false,
        sortField: {
            field: "text",
            direction: "asc"
        },
        placeholder: "Digite o nome do funcion√°rio...",
        onChange: function(value) {
            carregarDadosUser(value);
        }
    });

    function carregarDadosUser(userId) {
        if(!userId) return;
        fetch(`/documentos/api/user-info/${userId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('previewEmpresa').innerText = data.razao_social || "LA SHAHIN SERVI√áOS DE SEGURAN√áA LTDA";
                document.getElementById('previewCnpj').innerText = data.cnpj || "50.537.235/0001-95";
            })
            .catch(err => console.error("Erro ao buscar dados:", err));
    }
</script>
{% endblock %}



##################################################

FILE: app/documentos/templates/documentos/relatorio_folha.html
--------------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto mt-8">
    <div class="mb-6 flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                <i class="fas fa-file-excel text-yellow-500"></i> Fechamento de M√™s
            </h2>
            <p class="text-sm text-slate-500 mt-1">Gere o relat√≥rio consolidado de ponto, horas extras, faltas e atestados para a Contabilidade.</p>
        </div>
        <a href="/documentos/admin" class="text-sm font-bold text-slate-400 hover:text-blue-600 transition">
            <i class="fas fa-arrow-left mr-1"></i> Voltar
        </a>
    </div>

    <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
        <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-xl mb-6">
            <h3 class="text-yellow-800 font-bold text-sm mb-1"><i class="fas fa-info-circle mr-1"></i> Como funciona a exporta√ß√£o?</h3>
            <p class="text-xs text-yellow-700 leading-relaxed">O sistema ir√° varrer todos os funcion√°rios ativos e calcular exatamente o que aconteceu no per√≠odo selecionado abaixo. O arquivo Excel gerado conter√° o saldo de horas, faltas injustificadas e atestados m√©dicos.</p>
        </div>

        <form action="/documentos/relatorio-folha/exportar" method="POST" class="space-y-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="label-pro">Data de In√≠cio do Ciclo</label>
                    <input type="date" name="data_inicio" required class="input-pro focus:border-yellow-500 focus:ring-yellow-500/10">
                </div>
                <div>
                    <label class="label-pro">Data de Fim do Ciclo</label>
                    <input type="date" name="data_fim" required class="input-pro focus:border-yellow-500 focus:ring-yellow-500/10">
                </div>
            </div>

            <button type="submit" class="w-full bg-slate-900 hover:bg-yellow-500 hover:text-slate-900 text-white font-bold py-4 rounded-xl transition shadow-lg flex items-center justify-center gap-2 group mt-4">
                <i class="fas fa-download group-hover:animate-bounce"></i> GERAR RELAT√ìRIO EXCEL
            </button>
        </form>
    </div>
</div>
{% endblock %}



##################################################

FILE: app/documentos/templates/documentos/revisao.html
------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-5xl mx-auto py-8">
    <div class="mb-10 flex justify-between items-center">
        <div>
            <h2 class="text-3xl font-black text-slate-800 tracking-tight">Aguardando Revis√£o</h2>
            <p class="text-slate-500 mt-2">Identifique os nomes que a IA n√£o conseguiu processar.</p>
        </div>
        <form action="{{ url_for('documentos.limpar_revisoes') }}" method="POST" onsubmit="return confirm('Apagar tudo na revis√£o?')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="bg-red-50 text-red-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-red-600 hover:text-white transition">
                <i class="fas fa-trash mr-2"></i> LIMPAR TUDO
            </button>
        </form>
    </div>

    <div class="grid gap-6">
        {% for h in pendentes %}
        <div class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm flex flex-col md:flex-row items-center gap-6">
            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 flex items-center gap-4 flex-1 w-full">
                <i class="fas fa-file-pdf text-3xl text-red-500"></i>
                <div class="overflow-hidden">
                    <p class="text-[10px] font-black text-slate-400 uppercase">Refer√™ncia</p>
                    <p class="font-bold text-slate-800">{{ h.mes_referencia }}</p>
                    <form action="{{ url_for('documentos.baixar_holerite', id=h.id) }}" method="POST" target="_blank">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="text-xs font-bold text-blue-600 hover:text-blue-800 transition">ABRIR PDF</button>
                    </form>
                </div>
            </div>

            <form action="{{ url_for('documentos.vincular_holerite') }}" method="POST" class="flex gap-3">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="holerite_id" value="{{ h.id }}">
                <select name="user_id" class="bg-slate-100 rounded-2xl px-4 py-3 text-sm font-bold md:w-72" required>
                    <option value="">Selecione o funcion√°rio...</option>
                    {% for u in funcionarios %}
                    <option value="{{ u.id }}">{{ u.real_name }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="bg-slate-900 text-white font-bold py-3 px-8 rounded-2xl hover:bg-blue-600 transition">VINCULAR</button>
            </form>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}



##################################################

FILE: app/estoque/__init__.py
-----------------------------
# M√≥dulo estoque

##################################################

FILE: app/estoque/routes.py
---------------------------
from flask import Blueprint, render_template, request, redirect, url_for, flash, jsonify
from flask_login import login_required, current_user
from app.extensions import db
from app.models import ItemEstoque, HistoricoEntrada, HistoricoSaida, SolicitacaoUniforme, User
from app.utils import get_brasil_time, permission_required, enviar_notificacao
import pandas as pd
import logging

estoque_bp = Blueprint('estoque', __name__, template_folder='templates')
logger = logging.getLogger(__name__)

@estoque_bp.route('/controle-uniforme')
@login_required
@permission_required('ESTOQUE')
def gerenciar_estoque():
    """Lista o invent√°rio atual de uniformes."""
    itens = ItemEstoque.query.order_by(ItemEstoque.nome).all()
    return render_template('estoque/controle_uniforme.html', itens=itens)

@estoque_bp.route('/entrada', methods=['GET', 'POST'])
@login_required
@permission_required('ESTOQUE')
def entrada_estoque():
    """Gerencia a chegada de novos itens ao estoque."""
    if request.method == 'POST':
        nome = request.form.get('nome_outros') if request.form.get('nome_select') == 'Outros' else request.form.get('nome_select')
        tamanho = request.form.get('tamanho')
        genero = request.form.get('genero')
        qtd = int(request.form.get('quantidade') or 0)
        
        item = ItemEstoque.query.filter_by(nome=nome, tamanho=tamanho, genero=genero).first()
        if not item:
            item = ItemEstoque(
                nome=nome, tamanho=tamanho, genero=genero, 
                quantidade=0, 
                estoque_minimo=int(request.form.get('estoque_minimo') or 5),
                estoque_ideal=int(request.form.get('estoque_ideal') or 20)
            )
            db.session.add(item)
        
        item.quantidade += qtd
        hist = HistoricoEntrada(item_nome=f"{nome} ({tamanho})", quantidade=qtd, data_hora=get_brasil_time())
        db.session.add(hist)
        db.session.commit()
        flash(f'Entrada de {qtd} unidade(s) registrada.', 'success')
        return redirect(url_for('estoque.gerenciar_estoque'))
        
    return render_template('estoque/entrada.html')

@estoque_bp.route('/saida', methods=['GET', 'POST'])
@login_required
@permission_required('ESTOQUE')
def saida_estoque():
    """Registra a entrega de uniforme para um colaborador."""
    itens = ItemEstoque.query.filter(ItemEstoque.quantidade > 0).all()
    
    if request.method == 'POST':
        item_id = request.form.get('item_id')
        qtd = int(request.form.get('quantidade') or 0)
        colaborador = request.form.get('colaborador')
        coordenador = request.form.get('coordenador')
        
        item = ItemEstoque.query.get(item_id)
        if item and item.quantidade >= qtd:
            item.quantidade -= qtd
            hist = HistoricoSaida(
                coordenador=coordenador, 
                colaborador=colaborador, 
                item_nome=item.nome, 
                tamanho=item.tamanho, 
                genero=item.genero, 
                quantidade=qtd,
                data_entrega=get_brasil_time().date()
            )
            db.session.add(hist)
            db.session.commit()
            flash('Sa√≠da registrada com sucesso.', 'success')
            return redirect(url_for('estoque.gerenciar_estoque'))
        else:
            flash('Estoque insuficiente para esta opera√ß√£o.', 'error')
            
    return render_template('estoque/saida.html', itens=itens)

@estoque_bp.route('/historico/entrada')
@login_required
@permission_required('ESTOQUE')
def ver_historico_entrada():
    logs = HistoricoEntrada.query.order_by(HistoricoEntrada.data_hora.desc()).limit(100).all()
    return render_template('estoque/historico_entrada.html', logs=logs)

@estoque_bp.route('/historico/saida')
@login_required
@permission_required('ESTOQUE')
def ver_historico_saida():
    logs = HistoricoSaida.query.order_by(HistoricoSaida.data_entrega.desc()).limit(100).all()
    return render_template('estoque/historico_saida.html', logs=logs)

@estoque_bp.route('/gerenciar/item/<int:id>', methods=['GET', 'POST'])
@login_required
@permission_required('ESTOQUE')
def editar_item(id):
    item = ItemEstoque.query.get_or_404(id)
    if request.method == 'POST':
        acao = request.form.get('acao')
        if acao == 'excluir':
            db.session.delete(item)
            db.session.commit()
            flash('Item removido do invent√°rio.', 'warning')
            return redirect(url_for('estoque.gerenciar_estoque'))
        
        item.nome = request.form.get('nome')
        item.tamanho = request.form.get('tamanho')
        item.genero = request.form.get('genero')
        item.quantidade = int(request.form.get('quantidade'))
        item.estoque_minimo = int(request.form.get('estoque_minimo'))
        item.estoque_ideal = int(request.form.get('estoque_ideal'))
        db.session.commit()
        flash('Altera√ß√µes salvas.', 'success')
        return redirect(url_for('estoque.gerenciar_estoque'))
        
    return render_template('estoque/editar_item.html', item=item)

@estoque_bp.route('/controle-uniforme/importar-excel', methods=['POST'])
@login_required
@permission_required('ESTOQUE')
def importar_excel_estoque():
    if 'arquivo_excel' not in request.files:
        flash('Nenhum arquivo enviado.', 'error')
        return redirect(url_for('estoque.gerenciar_estoque'))
    
    file = request.files['arquivo_excel']
    if file.filename == '':
        flash('Nenhum arquivo selecionado.', 'error')
        return redirect(url_for('estoque.gerenciar_estoque'))
        
    if not file.filename.endswith(('.xlsx', '.xls')):
        flash('Formato inv√°lido. Envie uma planilha do Excel (.xlsx ou .xls)', 'error')
        return redirect(url_for('estoque.gerenciar_estoque'))

    try:
        df = pd.read_excel(file)
        df = df.fillna('')
        df.columns = [str(c).strip().lower() for c in df.columns] 
        
        records = df.to_dict('records')
        sucesso_novos, sucesso_atualizados, falhas = 0, 0, 0
        
        for row in records:
            descricao = str(row.get('descricao', '')).strip()
            tamanho = str(row.get('tamanho', '')).strip()
            genero = str(row.get('genero', '')).strip()
            
            if not descricao or not tamanho:
                falhas += 1
                continue
            
            try: quantidade = int(float(row.get('quantidade', 0)))
            except: quantidade = 0
            try: minimo = int(float(row.get('minimo', 5)))
            except: minimo = 5
            try: ideal = int(float(row.get('ideal', 20)))
            except: ideal = 20

            item_existente = ItemEstoque.query.filter_by(nome=descricao, tamanho=tamanho, genero=genero).first()
            
            if item_existente:
                item_existente.quantidade = quantidade
                item_existente.estoque_minimo = minimo
                item_existente.estoque_ideal = ideal
                sucesso_atualizados += 1
            else:
                novo_item = ItemEstoque(
                    nome=descricao, tamanho=tamanho, genero=genero,
                    quantidade=quantidade, estoque_minimo=minimo, estoque_ideal=ideal
                )
                db.session.add(novo_item)
                sucesso_novos += 1

        db.session.commit()
        
        if sucesso_novos > 0 or sucesso_atualizados > 0:
            flash(f'Invent√°rio sincronizado! {sucesso_novos} novos itens. {sucesso_atualizados} atualizados. {falhas} ignorados.', 'success')
        else:
            flash('Nenhum item v√°lido encontrado na planilha. Verifique os nomes das colunas.', 'error')
            
    except Exception as e:
        db.session.rollback()
        logger.error(f"Erro no import de estoque: {e}")
        flash(f'Erro ao processar o arquivo: {str(e)}', 'error')

    return redirect(url_for('estoque.gerenciar_estoque'))

@estoque_bp.route('/api/tamanhos', methods=['GET'])
@login_required
def api_buscar_tamanhos():
    """API Din√¢mica: Retorna tamanhos e g√™neros dispon√≠veis dado um nome de item."""
    nome_item = request.args.get('nome')
    if not nome_item:
        return jsonify([])
    
    itens = ItemEstoque.query.filter(ItemEstoque.nome == nome_item, ItemEstoque.quantidade > 0).all()
    
    resultados = []
    for item in itens:
        resultados.append({
            'id': item.id,
            'tamanho': item.tamanho,
            'genero': item.genero,
            'quantidade': item.quantidade
        })
    return jsonify(resultados)

@estoque_bp.route('/solicitar', methods=['GET', 'POST'])
@login_required
def solicitar_uniforme():
    """Rota do Colaborador: Tela onde ele solicita a pe√ßa."""
    if request.method == 'POST':
        item_id = request.form.get('item_id')
        quantidade = int(request.form.get('quantidade') or 1)
        
        item = ItemEstoque.query.get(item_id)
        if not item or item.quantidade < quantidade:
            flash('Erro: O item selecionado n√£o possui stock suficiente no momento.', 'error')
            return redirect(url_for('estoque.solicitar_uniforme'))
        
        nova_solic = SolicitacaoUniforme(
            user_id=current_user.id,
            item_id=item.id,
            item_nome=item.nome,
            tamanho=item.tamanho,
            genero=item.genero,
            quantidade=quantidade,
            status='Pendente'
        )
        db.session.add(nova_solic)
        db.session.commit()
        
        # GATILHO NOTIFICA√á√ÉO MASTER
        master = User.query.filter_by(username='50097952800').first()
        if master:
            enviar_notificacao(master.id, f"{current_user.real_name} solicitou {quantidade}x {item.nome}.", url_for('estoque.gestao_solicitacoes'))

        flash('O seu pedido foi enviado ao Departamento de RH! Aguarde a aprova√ß√£o.', 'success')
        return redirect(url_for('estoque.solicitar_uniforme'))
    
    itens_query = db.session.query(ItemEstoque.nome).filter(ItemEstoque.quantidade > 0).distinct().all()
    nomes_disponiveis = [n[0] for n in itens_query]
    minhas_solicitacoes = SolicitacaoUniforme.query.filter_by(user_id=current_user.id).order_by(SolicitacaoUniforme.data_solicitacao.desc()).limit(20).all()
    
    return render_template('estoque/solicitar_uniforme.html', nomes_disponiveis=nomes_disponiveis, solicitacoes=minhas_solicitacoes)

@estoque_bp.route('/solicitacoes', methods=['GET', 'POST'])
@login_required
@permission_required('ESTOQUE')
def gestao_solicitacoes():
    """Rota do Gestor: Tela para aprovar ou recusar os pedidos da equipa."""
    if request.method == 'POST':
        solic_id = request.form.get('solicitacao_id')
        acao = request.form.get('acao')
        
        solicitacao = SolicitacaoUniforme.query.get_or_404(solic_id)
        
        if acao == 'aprovar':
            item = ItemEstoque.query.get(solicitacao.item_id)
            
            if not item or item.quantidade < solicitacao.quantidade:
                flash(f'Erro cr√≠tico: O stock atual √© insuficiente para aprovar as {solicitacao.quantidade} unidades de {solicitacao.item_nome}.', 'error')
            else:
                solicitacao.status = 'Aprovado'
                solicitacao.data_resposta = get_brasil_time()
                item.quantidade -= solicitacao.quantidade
                
                hist = HistoricoSaida(
                    coordenador=current_user.real_name, 
                    colaborador=solicitacao.user.real_name, 
                    item_nome=item.nome, 
                    tamanho=item.tamanho, 
                    genero=item.genero, 
                    quantidade=solicitacao.quantidade,
                    data_entrega=get_brasil_time().date()
                )
                db.session.add(hist)
                
                # GATILHO NOTIFICA√á√ÉO COLABORADOR
                enviar_notificacao(solicitacao.user_id, f"Seu pedido de EPI ({solicitacao.item_nome}) foi APROVADO.", url_for('estoque.solicitar_uniforme'))
                
                flash('Pedido APROVADO com sucesso! O invent√°rio foi deduzido automaticamente.', 'success')
                
        elif acao == 'recusar':
            solicitacao.status = 'Recusado'
            solicitacao.data_resposta = get_brasil_time()
            
            # GATILHO NOTIFICA√á√ÉO COLABORADOR
            enviar_notificacao(solicitacao.user_id, f"Seu pedido de EPI ({solicitacao.item_nome}) foi RECUSADO.", url_for('estoque.solicitar_uniforme'))
            
            flash('Pedido de EPI Recusado.', 'warning')
            
        db.session.commit()
        return redirect(url_for('estoque.gestao_solicitacoes'))
        
    todas_solicitacoes = SolicitacaoUniforme.query.order_by(
        db.case({ 'Pendente': 1, 'Aprovado': 2, 'Recusado': 3 }, value=SolicitacaoUniforme.status),
        SolicitacaoUniforme.data_solicitacao.desc()
    ).limit(100).all()
    
    return render_template('estoque/gestao_pedidos_uniforme.html', solicitacoes=todas_solicitacoes)



##################################################

FILE: app/estoque/templates/estoque/controle_uniforme.html
----------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col gap-4 mb-8">
    <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
        <i class="fas fa-box text-blue-600"></i> Gest√£o de Invent√°rio
    </h2>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
        <a href="{{ url_for('estoque.entrada_estoque') }}" class="bg-white border border-slate-200 hover:border-emerald-500 rounded-2xl p-4 flex items-center gap-4 transition group shadow-sm">
            <div class="w-12 h-12 bg-emerald-50 text-emerald-600 border border-emerald-100 rounded-full flex items-center justify-center text-xl group-hover:bg-emerald-500 group-hover:text-white transition shadow-inner">
                <i class="fas fa-box-open"></i>
            </div>
            <div>
                <h3 class="font-bold text-slate-800 text-sm">Registrar Entrada</h3>
                <p class="text-[10px] text-slate-500 font-medium">Recebimento de fornecedor</p>
            </div>
        </a>

        <a href="{{ url_for('estoque.saida_estoque') }}" class="bg-white border border-slate-200 hover:border-red-500 rounded-2xl p-4 flex items-center gap-4 transition group shadow-sm">
            <div class="w-12 h-12 bg-red-50 text-red-600 border border-red-100 rounded-full flex items-center justify-center text-xl group-hover:bg-red-500 group-hover:text-white transition shadow-inner">
                <i class="fas fa-hand-holding"></i>
            </div>
            <div>
                <h3 class="font-bold text-slate-800 text-sm">Sa√≠da Manual</h3>
                <p class="text-[10px] text-slate-500 font-medium">Entrega direta na base</p>
            </div>
        </a>

        <button onclick="document.getElementById('modalExcelEstoque').classList.remove('hidden')" class="bg-white border border-slate-200 hover:border-blue-500 rounded-2xl p-4 flex items-center gap-4 transition group shadow-sm text-left">
            <div class="w-12 h-12 bg-blue-50 text-blue-600 border border-blue-100 rounded-full flex items-center justify-center text-xl group-hover:bg-blue-500 group-hover:text-white transition shadow-inner">
                <i class="fas fa-file-excel"></i>
            </div>
            <div>
                <h3 class="font-bold text-slate-800 text-sm">Sincronizar Estoque</h3>
                <p class="text-[10px] text-slate-500 font-medium">Importa√ß√£o via Excel (.xlsx)</p>
            </div>
        </button>
    </div>
</div>

<div class="flex gap-2 mb-4 overflow-x-auto pb-2">
    <button onclick="aplicarFiltroSaude('ALL', this)" class="filtro-btn px-4 py-2 rounded-lg text-xs font-bold bg-slate-800 text-white transition whitespace-nowrap shadow-sm">Todos os Itens</button>
    <button onclick="aplicarFiltroSaude('IDEAL', this)" class="filtro-btn px-4 py-2 rounded-lg text-xs font-bold bg-white border border-slate-200 text-slate-600 hover:bg-emerald-50 hover:text-emerald-700 hover:border-emerald-300 transition whitespace-nowrap shadow-sm"><i class="fas fa-check-circle text-emerald-500 mr-1"></i> Estoque Ideal</button>
    <button onclick="aplicarFiltroSaude('ALERTA', this)" class="filtro-btn px-4 py-2 rounded-lg text-xs font-bold bg-white border border-slate-200 text-slate-600 hover:bg-yellow-50 hover:text-yellow-700 hover:border-yellow-300 transition whitespace-nowrap shadow-sm"><i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i> Em Alerta</button>
    <button onclick="aplicarFiltroSaude('CRITICO', this)" class="filtro-btn px-4 py-2 rounded-lg text-xs font-bold bg-white border border-slate-200 text-slate-600 hover:bg-red-50 hover:text-red-700 hover:border-red-300 transition whitespace-nowrap shadow-sm"><i class="fas fa-times-circle text-red-500 mr-1"></i> Cr√≠tico / Zerado</button>
</div>

<div class="mb-6">
    <div class="relative">
        <i class="fas fa-search absolute left-4 top-4 text-slate-400"></i>
        <input type="text" id="buscaEstoque" placeholder="Pesquisar por pe√ßa, tamanho ou g√™nero..." class="w-full pl-12 pr-4 py-3 rounded-xl border border-slate-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium text-slate-700">
    </div>
</div>

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
        <h2 class="font-semibold text-slate-800 text-sm">Invent√°rio F√≠sico</h2>
    </div>
    
    <div class="overflow-x-auto">
        <table class="w-full text-left text-sm text-slate-600" id="tabelaInventario">
            <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold border-b border-slate-100">
                <tr>
                    <th class="px-6 py-4">Item / Descri√ß√£o</th>
                    <th class="px-6 py-4">Especifica√ß√£o</th>
                    <th class="px-6 py-4 w-48">Sa√∫de do Estoque</th>
                    <th class="px-6 py-4 text-center">Quantidade</th>
                    <th class="px-6 py-4 text-right">A√ß√µes</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
                {% for item in itens %}
                
                {% set pct = (item.quantidade / item.estoque_ideal * 100) if item.estoque_ideal > 0 else 0 %}
                {% set pct_vis = pct if pct <= 100 else 100 %}
                
                {% if item.quantidade <= item.estoque_minimo %}
                    {% set status = "CRITICO" %}
                    {% set cor_barra = "bg-red-500" %}
                    {% set cor_bg = "bg-red-100" %}
                {% elif pct < 70 %}
                    {% set status = "ALERTA" %}
                    {% set cor_barra = "bg-yellow-400" %}
                    {% set cor_bg = "bg-yellow-100" %}
                {% else %}
                    {% set status = "IDEAL" %}
                    {% set cor_barra = "bg-emerald-500" %}
                    {% set cor_bg = "bg-emerald-100" %}
                {% endif %}

                <tr class="hover:bg-slate-50 transition item-linha" data-status="{{ status }}">
                    
                    <td class="px-6 py-4 font-bold text-slate-800 item-nome">
                        {{ item.nome }}
                    </td>
                    
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2 item-especificacao">
                            <span class="px-2 py-1 bg-slate-200 text-slate-700 font-bold text-xs rounded shadow-sm border border-slate-300">
                                Tam: {{ item.tamanho }}
                            </span>
                            <span class="text-xs text-slate-500 font-medium bg-slate-100 px-2 py-1 rounded border border-slate-200">
                                {{ item.genero }}
                            </span>
                        </div>
                    </td>
                    
                    <td class="px-6 py-4">
                        <div class="w-full {{ cor_bg }} rounded-full h-2.5 mb-1 overflow-hidden border border-black/5">
                            <div class="{{ cor_barra }} h-2.5 rounded-full transition-all duration-500" style="width: {{ pct_vis }}%"></div>
                        </div>
                        <div class="text-[9px] text-slate-400 font-bold uppercase mt-1 flex justify-between">
                            <span>Min: {{ item.estoque_minimo }}</span>
                            <span>Ideal: {{ item.estoque_ideal }}</span>
                        </div>
                    </td>
                    
                    <td class="px-6 py-4 text-center">
                        <div class="text-xl font-black {% if item.quantidade <= item.estoque_minimo %} text-red-600 {% elif pct >= 70 %} text-emerald-600 {% else %} text-yellow-600 {% endif %}">
                            {{ item.quantidade }}
                        </div>
                        <div class="text-[9px] text-slate-400 uppercase font-bold tracking-wider">Unidades</div>
                    </td>
                    
                    <td class="px-6 py-4 text-right">
                        <a href="{{ url_for('estoque.editar_item', id=item.id) }}" class="inline-flex w-8 h-8 items-center justify-center rounded-full text-slate-400 hover:bg-blue-50 hover:text-blue-600 transition border border-transparent hover:border-blue-200" title="Editar / Ajustar">
                            <i class="fas fa-pencil-alt text-xs"></i>
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="px-6 py-20 text-center text-slate-400">
                        <i class="fas fa-box-open text-4xl opacity-20 mb-3 block"></i>
                        <span class="text-sm font-medium">Nenhum item registrado no invent√°rio.</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div id="paginacao-container"></div>
</div>

<div id="modalExcelEstoque" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden">
        <div class="bg-blue-600 p-5 flex justify-between items-center text-white">
            <h3 class="font-bold text-lg"><i class="fas fa-file-excel mr-2"></i> Importar Invent√°rio</h3>
            <button onclick="document.getElementById('modalExcelEstoque').classList.add('hidden')" class="hover:text-blue-200 transition"><i class="fas fa-times text-xl"></i></button>
        </div>
        
        <form action="{{ url_for('estoque.importar_excel_estoque') }}" method="POST" enctype="multipart/form-data" class="p-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <div class="mb-6 bg-blue-50 p-4 rounded-xl border border-blue-100">
                <p class="text-xs text-blue-800 mb-2 font-bold uppercase">Como montar sua planilha Excel</p>
                <p class="text-[10px] text-blue-700 font-mono bg-white p-2 rounded border border-blue-200 mb-3 overflow-x-auto whitespace-nowrap">
                    Colunas exatas: descricao | tamanho | genero | quantidade | minimo | ideal
                </p>
                <ul class="text-[10px] text-blue-600 space-y-1 list-disc list-inside">
                    <li>O sistema ir√° <strong>atualizar</strong> itens j√° existentes (pelo nome e tamanho) ou <strong>criar</strong> novos.</li>
                    <li>As colunas "descricao" e "tamanho" s√£o obrigat√≥rias.</li>
                </ul>
            </div>

            <div class="mb-6">
                <label class="block w-full border-2 border-dashed border-slate-300 rounded-xl p-6 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition group">
                    <i class="fas fa-cloud-upload-alt text-3xl text-slate-400 group-hover:text-blue-500 mb-2 transition"></i>
                    <p class="text-sm font-bold text-slate-600 group-hover:text-blue-700">Clique para selecionar o arquivo (.xlsx)</p>
                    <input type="file" name="arquivo_excel" accept=".xlsx, .xls" required class="hidden" id="fileInput" onchange="document.getElementById('fileName').innerText = this.files[0].name">
                </label>
                <p id="fileName" class="text-center text-xs font-bold text-blue-600 mt-2 h-4 truncate px-4"></p>
            </div>

            <button type="submit" class="w-full bg-slate-900 hover:bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg transition flex items-center justify-center gap-2">
                <i class="fas fa-sync-alt"></i> SINCRONIZAR ESTOQUE
            </button>
        </form>
    </div>
</div>

<script>
// NOVO: SISTEMA DE PAGINA√á√ÉO E FILTROS M√ÅGICOS
let currentSaude = 'ALL';
let currentPage = 1;
const rowsPerPage = 10; // 10 itens por p√°gina fica perfeito para a tela

function aplicarFiltroSaude(status, btnElement) {
    currentSaude = status;
    currentPage = 1; // Reseta para a p√°gina 1 ao filtrar
    
    // Troca as cores dos bot√µes
    document.querySelectorAll('.filtro-btn').forEach(btn => {
        btn.classList.remove('bg-slate-800', 'text-white');
        btn.classList.add('bg-white', 'text-slate-600');
    });
    btnElement.classList.remove('bg-white', 'text-slate-600');
    btnElement.classList.add('bg-slate-800', 'text-white');

    atualizarTabela();
}

function atualizarTabela() {
    let input = document.getElementById('buscaEstoque').value.toUpperCase();
    let tabela = document.getElementById('tabelaInventario');
    let linhas = Array.from(tabela.getElementsByClassName('item-linha'));
    
    let linhasFiltradas = [];

    // Passo 1: Descobre quem passa pelos Filtros de Texto e Bot√µes
    linhas.forEach(linha => {
        let nome = linha.getElementsByClassName('item-nome')[0].innerText.toUpperCase();
        let especificacao = linha.getElementsByClassName('item-especificacao')[0].innerText.toUpperCase();
        let status = linha.getAttribute('data-status');
        
        let passaTexto = (nome.indexOf(input) > -1 || especificacao.indexOf(input) > -1);
        let passaSaude = (currentSaude === 'ALL' || status === currentSaude);

        if (passaTexto && passaSaude) {
            linhasFiltradas.push(linha);
            linha.style.display = ""; 
        } else {
            linha.style.display = "none";
        }
    });

    // Passo 2: Aplica a Pagina√ß√£o apenas nas linhas filtradas
    let totalLinhas = linhasFiltradas.length;
    let totalPages = Math.ceil(totalLinhas / rowsPerPage) || 1;
    
    if(currentPage > totalPages) currentPage = totalPages;

    let start = (currentPage - 1) * rowsPerPage;
    let end = start + rowsPerPage;

    linhasFiltradas.forEach((linha, index) => {
        if (index >= start && index < end) {
            linha.style.display = ""; // Mostra
        } else {
            linha.style.display = "none"; // Esconde da p√°gina atual
        }
    });

    renderizarPaginacao(totalPages, totalLinhas);
}

// O gatilho de busca reage instantaneamente a cada tecla digitada
document.getElementById('buscaEstoque').addEventListener('keyup', function() {
    currentPage = 1;
    atualizarTabela();
});

function renderizarPaginacao(totalPages, totalLinhas) {
    let container = document.getElementById('paginacao-container');
    
    if (totalLinhas <= rowsPerPage) {
        container.innerHTML = '';
        return;
    }

    let html = `
        <div class="flex justify-between items-center px-6 py-4 bg-slate-50/80 border-t border-slate-100">
            <span class="text-[11px] text-slate-500 font-bold uppercase tracking-wide">P√°gina ${currentPage} de ${totalPages} <span class="mx-1 opacity-50">‚Ä¢</span> ${totalLinhas} itens listados</span>
            <div class="flex gap-2">
                <button onclick="mudarPagina(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} class="px-4 py-2 rounded-lg border border-slate-200 bg-white text-slate-600 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 disabled:opacity-40 disabled:hover:bg-white disabled:hover:border-slate-200 disabled:hover:text-slate-600 text-xs font-black transition shadow-sm"><i class="fas fa-chevron-left mr-1"></i> Anterior</button>
                <button onclick="mudarPagina(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} class="px-4 py-2 rounded-lg border border-slate-200 bg-white text-slate-600 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 disabled:opacity-40 disabled:hover:bg-white disabled:hover:border-slate-200 disabled:hover:text-slate-600 text-xs font-black transition shadow-sm">Pr√≥ximo <i class="fas fa-chevron-right ml-1"></i></button>
            </div>
        </div>
    `;
    container.innerHTML = html;
}

function mudarPagina(novaPagina) {
    currentPage = novaPagina;
    atualizarTabela();
    // Faz scroll suave de volta para o topo da tabela
    document.querySelector('.overflow-x-auto').scrollIntoView({ behavior: 'smooth', block: 'end' });
}

// Quando a p√°gina termina de carregar, ele ativa a pagina√ß√£o e exibe os primeiros 10!
document.addEventListener('DOMContentLoaded', atualizarTabela);
</script>
{% endblock %}



##################################################

FILE: app/estoque/templates/estoque/editar_item.html
----------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex items-center justify-between mb-6">
    <h2 class="text-lg font-bold text-slate-800">Editar Item</h2>
    <a href="{{ url_for('estoque.gerenciar_estoque') }}" class="text-xs font-medium text-slate-500 hover:text-slate-800">Cancelar</a>
</div>

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <form action="/editar/{{ item.id }}" method="POST" class="p-6 space-y-5">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <div class="bg-yellow-50 text-yellow-800 p-3 rounded text-xs border border-yellow-200">
            <i class="fas fa-exclamation-triangle mr-1"></i> Voc√™ est√° editando manualmente o cadastro.
        </div>

        <div>
            <label class="label-pro">Nome do Item</label>
            <input type="text" name="nome" value="{{ item.nome }}" class="input-pro" required>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="label-pro">Tamanho</label>
                <select name="tamanho" class="input-pro cursor-pointer">
                    <option value="P" {% if item.tamanho == 'P' %}selected{% endif %}>P</option>
                    <option value="M" {% if item.tamanho == 'M' %}selected{% endif %}>M</option>
                    <option value="G" {% if item.tamanho == 'G' %}selected{% endif %}>G</option>
                    <option value="GG" {% if item.tamanho == 'GG' %}selected{% endif %}>GG</option>
                    <option value="XG" {% if item.tamanho == 'XG' %}selected{% endif %}>XG</option>
                </select>
            </div>
            <div>
                <label class="label-pro">G√™nero</label>
                <select name="genero" class="input-pro cursor-pointer">
                    <option value="Masculino" {% if item.genero == 'Masculino' %}selected{% endif %}>Masculino</option>
                    <option value="Feminino" {% if item.genero == 'Feminino' %}selected{% endif %}>Feminino</option>
                    <option value="Unissex" {% if item.genero == 'Unissex' %}selected{% endif %}>Unissex</option>
                </select>
            </div>
        </div>

        <div>
            <label class="label-pro">Quantidade Atual (Ajuste Manual)</label>
            <input type="number" name="quantidade" min="0" value="{{ item.quantidade }}" class="input-pro text-blue-600 font-bold text-lg" required>
        </div>

        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-md hover:shadow-lg transition-all">
            SALVAR ALTERA√á√ïES
        </button>
    </form>
</div>
{% endblock %}



##################################################

FILE: app/estoque/templates/estoque/editar_log_entrada.html
-----------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
    <h2 class="text-lg font-bold text-slate-800 mb-4">Editar Hist√≥rico (Entrada)</h2>
    <form action="/historico/entrada/editar/{{ log.id }}" method="POST" class="space-y-4">
        <div><label class="label-pro">Item (Texto)</label><input type="text" name="item_nome" value="{{ log.item_nome }}" class="input-pro"></div>
        <div><label class="label-pro">Quantidade Original</label><input type="number" name="quantidade" value="{{ log.quantidade }}" class="input-pro"></div>
        <div><label class="label-pro">Data/Hora</label><input type="datetime-local" name="data" value="{{ log.data_hora.strftime('%Y-%m-%dT%H:%M') }}" class="input-pro"></div>
        
        <div class="flex gap-3 pt-4">
            <button type="submit" name="acao" value="salvar" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg">Salvar Corre√ß√£o</button>
            <button type="submit" name="acao" value="excluir" class="flex-none bg-red-100 text-red-600 font-bold py-3 px-6 rounded-lg" onclick="return confirm('Excluir este registro? O estoque atual N√ÉO ser√° alterado.')"><i class="fas fa-trash"></i></button>
        </div>
        <p class="text-[10px] text-slate-400 mt-2 text-center">Nota: Alterar este log n√£o muda o estoque atual. Use o menu Gerenciar para ajustar quantidades atuais.</p>
    </form>
</div>
<style>.label-pro { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem; } .input-pro { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem 1rem; }</style>
{% endblock %}

##################################################

FILE: app/estoque/templates/estoque/editar_log_saida.html
---------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
    <h2 class="text-lg font-bold text-slate-800 mb-4">Editar Hist√≥rico (Sa√≠da)</h2>
    <form action="/historico/saida/editar/{{ log.id }}" method="POST" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
            <div><label class="label-pro">Coordenador</label><input type="text" name="coordenador" value="{{ log.coordenador }}" class="input-pro"></div>
            <div><label class="label-pro">Colaborador</label><input type="text" name="colaborador" value="{{ log.colaborador }}" class="input-pro"></div>
        </div>
        <div><label class="label-pro">Item (Texto)</label><input type="text" name="item_nome" value="{{ log.item_nome }}" class="input-pro"></div>
        <div><label class="label-pro">Quantidade</label><input type="number" name="quantidade" value="{{ log.quantidade }}" class="input-pro"></div>
        <div><label class="label-pro">Data</label><input type="date" name="data" value="{{ log.data_entrega.strftime('%Y-%m-%d') }}" class="input-pro"></div>
        
        <div class="flex gap-3 pt-4">
            <button type="submit" name="acao" value="salvar" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg">Salvar Corre√ß√£o</button>
            <button type="submit" name="acao" value="excluir" class="flex-none bg-red-100 text-red-600 font-bold py-3 px-6 rounded-lg" onclick="return confirm('Excluir este registro?')"><i class="fas fa-trash"></i></button>
        </div>
    </form>
</div>
<style>.label-pro { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem; } .input-pro { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem 1rem; }</style>
{% endblock %}

##################################################

FILE: app/estoque/templates/estoque/entrada.html
------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-6">
    <div class="bg-emerald-50 px-6 py-4 border-b border-emerald-100">
        <h2 class="text-lg font-bold text-emerald-800">Nova Entrada</h2>
        <p class="text-xs text-emerald-600">Adicione itens pr√©-definidos ou crie novos.</p>
    </div>
    <form action="/entrada" method="POST" class="p-6 space-y-5">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <div>
            <label class="label-pro">Item / Uniforme</label>
            <select name="nome_select" id="nome_select" class="input-pro cursor-pointer" onchange="verificarOutros(this)">
                <option value="Camisa T√°tico">Camisa T√°tico</option>
                <option value="Cal√ßa T√°tico">Cal√ßa T√°tico</option>
                <option value="Camisa Portaria">Camisa Portaria</option>
                <option value="Cal√ßa Portaria">Cal√ßa Portaria</option>
                <option value="Blazer Portaria">Blazer Portaria</option>
                <option value="Camisa Limpeza">Camisa Limpeza</option>
                <option value="Cal√ßa Limpeza">Cal√ßa Limpeza</option>
                <option value="Outros">Outros...</option>
            </select>
        </div>
        
        <div id="div_outros" class="hidden animate-fade-in">
            <label class="label-pro text-blue-600">Digite o nome do Item</label>
            <input type="text" name="nome_outros" id="nome_outros" class="input-pro border-blue-300 focus:border-blue-600 bg-blue-50 focus:bg-white" placeholder="Ex: Sapato Social">
        </div>
        
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="label-pro">Tamanho</label>
                <select name="tamanho" class="input-pro cursor-pointer">
                    <option value="P">P</option><option value="M">M</option><option value="G">G</option><option value="GG">GG</option><option value="XG">XG</option>
                </select>
            </div>
            <div>
                <label class="label-pro">G√™nero</label>
                <select name="genero" class="input-pro cursor-pointer">
                    <option value="Masculino">Masculino</option><option value="Feminino">Feminino</option><option value="Unissex">Unissex</option>
                </select>
            </div>
        </div>
        
        <div>
            <label class="label-pro text-emerald-600">Quantidade</label>
            <input type="number" name="quantidade" min="1" value="1" class="input-pro font-bold text-lg text-emerald-700 border-emerald-200 focus:border-emerald-600" required>
        </div>
        
        <div class="pt-4 border-t border-slate-100">
            <p class="text-xs font-bold text-slate-400 uppercase mb-3">Defini√ß√£o de N√≠veis (Opcional)</p>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label-pro text-red-400">M√≠nimo (Ruim)</label>
                    <input type="number" name="estoque_minimo" value="5" class="input-pro border-red-100 focus:border-red-400 text-xs">
                </div>
                <div>
                    <label class="label-pro text-emerald-400">Ideal (Bom)</label>
                    <input type="number" name="estoque_ideal" value="20" class="input-pro border-emerald-100 focus:border-emerald-400 text-xs">
                </div>
            </div>
        </div>
        
        <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-lg shadow-md hover:shadow-lg transition">ADICIONAR</button>
    </form>
</div>

<a href="/historico/entrada" class="block bg-slate-100 hover:bg-slate-200 text-slate-600 text-center py-3 rounded-lg font-bold text-xs transition mb-8">
    <i class="fas fa-history mr-1"></i> VER HIST√ìRICO DE ENTRADAS
</a>

<script>
    function verificarOutros(select) {
        const div = document.getElementById('div_outros');
        const input = document.getElementById('nome_outros');
        if (select.value === 'Outros') { 
            div.classList.remove('hidden'); 
            input.required = true; 
            input.focus(); 
        } else { 
            div.classList.add('hidden'); 
            input.required = false; 
        }
    }
</script>
{% endblock %}



##################################################

FILE: app/estoque/templates/estoque/gestao_pedidos_uniforme.html
----------------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div>
        <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
            <i class="fas fa-clipboard-list text-blue-600"></i> Pedidos de EPI e Uniforme
        </h2>
        <p class="text-sm text-slate-500 mt-1">Aprove solicita√ß√µes da equipa. A aprova√ß√£o desconta do invent√°rio automaticamente.</p>
    </div>
</div>

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-10">
    <div class="overflow-x-auto">
        <table class="w-full text-left text-sm text-slate-600">
            <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold border-b border-slate-100">
                <tr>
                    <th class="px-6 py-4">Data/Hora</th>
                    <th class="px-6 py-4">Funcion√°rio</th>
                    <th class="px-6 py-4">Pe√ßa Solicitada</th>
                    <th class="px-6 py-4">Qtd</th>
                    <th class="px-6 py-4 text-center">Status</th>
                    <th class="px-6 py-4 text-right">A√ß√£o</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
                {% for solic in solicitacoes %}
                <tr class="hover:bg-slate-50 transition {{ 'bg-blue-50/30' if solic.status == 'Pendente' else '' }}">
                    <td class="px-6 py-4 text-xs font-medium">{{ solic.data_solicitacao.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td class="px-6 py-4 font-bold text-slate-800 flex items-center gap-2">
                        <div class="w-8 h-8 bg-slate-200 text-slate-600 rounded-full flex items-center justify-center text-xs">{{ solic.user.real_name[:2].upper() }}</div>
                        {{ solic.user.real_name }}
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-700">{{ solic.item_nome }}</div>
                        <div class="text-[10px] text-slate-500 uppercase mt-0.5 bg-slate-200 px-2 py-0.5 rounded inline-block border border-slate-300">
                            {{ solic.tamanho }} | {{ solic.genero }}
                        </div>
                        {% if solic.item and solic.item.quantidade < solic.quantidade and solic.status == 'Pendente' %}
                            <div class="text-[9px] text-red-600 font-bold mt-1 uppercase"><i class="fas fa-exclamation-triangle"></i> Sem Stock na prateleira (Atual: {{ solic.item.quantidade }})</div>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 font-black text-blue-600 text-lg">{{ solic.quantidade }}</td>
                    
                    <td class="px-6 py-4 text-center">
                        {% if solic.status == 'Pendente' %}
                            <span class="bg-amber-100 text-amber-700 px-2.5 py-1 rounded text-[10px] font-black uppercase tracking-wide border border-amber-200"><i class="fas fa-clock"></i> Pendente</span>
                        {% elif solic.status == 'Aprovado' %}
                            <span class="bg-emerald-100 text-emerald-700 px-2.5 py-1 rounded text-[10px] font-black uppercase tracking-wide border border-emerald-200"><i class="fas fa-check"></i> Entregue</span>
                        {% else %}
                            <span class="bg-red-100 text-red-700 px-2.5 py-1 rounded text-[10px] font-black uppercase tracking-wide border border-red-200"><i class="fas fa-times"></i> Recusado</span>
                        {% endif %}
                    </td>
                    
                    <td class="px-6 py-4 text-right">
                        {% if solic.status == 'Pendente' %}
                            <div class="flex items-center justify-end gap-2">
                                <form action="{{ url_for('estoque.gestao_solicitacoes') }}" method="POST" class="inline" onsubmit="return confirm('Confirmar entrega? O stock ser√° deduzido e o recibo de sa√≠da ser√° gerado automaticamente.');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="solicitacao_id" value="{{ solic.id }}"/>
                                    <input type="hidden" name="acao" value="aprovar"/>
                                    <button type="submit" class="text-white bg-emerald-500 hover:bg-emerald-600 px-3 py-1.5 rounded transition text-xs font-bold shadow-sm" title="Aprovar e Deduzir Stock" {% if solic.item and solic.item.quantidade < solic.quantidade %}disabled class="opacity-50 cursor-not-allowed"{% endif %}>
                                        <i class="fas fa-check mr-1"></i> Aprovar
                                    </button>
                                </form>
                                
                                <form action="{{ url_for('estoque.gestao_solicitacoes') }}" method="POST" class="inline" onsubmit="return confirm('Deseja recusar o pedido deste colaborador?');">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="solicitacao_id" value="{{ solic.id }}"/>
                                    <input type="hidden" name="acao" value="recusar"/>
                                    <button type="submit" class="text-slate-500 hover:text-red-600 bg-slate-100 hover:bg-red-50 border border-slate-200 hover:border-red-200 px-3 py-1.5 rounded transition text-xs font-bold" title="Recusar">
                                        Recusar
                                    </button>
                                </form>
                            </div>
                        {% else %}
                            <span class="text-[10px] text-slate-400 font-bold uppercase">{{ solic.data_resposta.strftime('%d/%m/%Y') }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="px-6 py-20 text-center text-slate-400 font-medium">
                        <i class="fas fa-inbox text-4xl opacity-20 block mb-3"></i>
                        N√£o h√° solicita√ß√µes pendentes na caixa de entrada.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}



##################################################

FILE: app/estoque/templates/estoque/historico_entrada.html
----------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6"><h2 class="text-lg font-bold text-slate-800">Log de Entradas</h2></div>
<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="divide-y divide-slate-100">
        {% for log in logs %}
        <div class="p-4 flex justify-between items-center hover:bg-slate-50">
            <div>
                <div class="text-xs text-slate-400 font-bold">{{ log.data_hora.strftime('%d/%m %H:%M') }}</div>
                <div class="font-medium text-slate-800 text-sm">{{ log.item_nome }}</div>
            </div>
            <div class="flex items-center gap-4">
                <span class="font-bold text-emerald-600">+{{ log.quantidade }}</span>
                <a href="/historico/entrada/editar/{{ log.id }}" class="text-slate-300 hover:text-blue-500"><i class="fas fa-pencil-alt"></i></a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

##################################################

FILE: app/estoque/templates/estoque/historico_saida.html
--------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6"><h2 class="text-lg font-bold text-slate-800">Registro de Entregas</h2></div>
<div class="space-y-3">
    {% for log in logs %}
    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition relative group">
        <a href="/historico/saida/editar/{{ log.id }}" class="absolute top-4 right-4 text-slate-300 hover:text-blue-500 p-2"><i class="fas fa-pencil-alt"></i></a>
        <div class="flex justify-between items-start mb-2">
            <div class="text-xs font-bold text-slate-400 uppercase tracking-wide">{{ log.data_entrega.strftime('%d/%m/%Y') }}</div>
            <div class="bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded font-bold mr-8">-{{ log.quantidade }} UN</div>
        </div>
        <div class="flex items-center gap-3 mb-3">
             <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-xs">{{ log.colaborador[:1] }}</div>
             <div><div class="font-bold text-slate-800">{{ log.colaborador }}</div><div class="text-xs text-slate-500">Autorizado por: {{ log.coordenador }}</div></div>
        </div>
        <!-- Detalhes de Tamanho e Genero -->
        <div class="pt-3 border-t border-slate-100 text-sm text-slate-700 flex items-center gap-2">
            <i class="fas fa-tshirt text-slate-400"></i> 
            <span class="font-semibold">{{ log.item_nome }}</span>
            <span class="text-slate-300">|</span>
            <span class="bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded text-xs font-bold">{{ log.tamanho }}</span>
            <span class="text-slate-300">|</span>
            <span class="text-xs text-slate-500">{{ log.genero }}</span>
        </div>
    </div>
    {% else %}
    <div class="text-center py-10 text-slate-400">Nenhuma entrega registrada.</div>
    {% endfor %}
</div>
{% endblock %}

##################################################

FILE: app/estoque/templates/estoque/saida.html
----------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-6">
    <div class="bg-red-50 px-6 py-4 border-b border-red-100">
        <h2 class="text-lg font-bold text-red-800">Registrar Sa√≠da</h2>
        <p class="text-xs text-red-600">Baixa de estoque e entrega de EPI/Uniforme.</p>
    </div>
    <form action="/saida" method="POST" class="p-6 space-y-5">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <div>
            <label class="label-pro">Selecionar Item</label>
            <div class="relative">
                <select name="item_id" class="input-pro cursor-pointer appearance-none" required>
                    <option value="" disabled selected>Escolha...</option>
                    {% for item in itens %}
                    <option value="{{ item.id }}">{{ item.nome }} - {{ item.tamanho }} ({{ item.genero }}) | Disp: {{ item.quantidade }}</option>
                    {% endfor %}
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500"><i class="fas fa-chevron-down text-xs"></i></div>
            </div>
        </div>
        
        <div>
            <label class="label-pro text-red-600">Quantidade a Retirar</label>
            <input type="number" name="quantidade" min="1" value="1" class="input-pro font-bold text-lg text-red-600 border-red-200 focus:border-red-600" required>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="label-pro">Coordenador</label>
                <input type="text" name="coordenador" class="input-pro" required>
            </div>
            <div>
                <label class="label-pro">Colaborador</label>
                <input type="text" name="colaborador" class="input-pro" required>
            </div>
        </div>
        
        <div>
            <label class="label-pro">Data Entrega</label>
            <input type="date" name="data" class="input-pro" required>
        </div>
        
        <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-lg shadow-md hover:shadow-lg transition">CONFIRMAR SA√çDA</button>
    </form>
</div>

<a href="/historico/saida" class="block bg-slate-100 hover:bg-slate-200 text-slate-600 text-center py-3 rounded-lg font-bold text-xs transition mb-8">
    <i class="fas fa-history mr-1"></i> VER HIST√ìRICO DE SA√çDAS
</a>
{% endblock %}



##################################################

FILE: app/estoque/templates/estoque/selecionar_edicao.html
----------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 shadow-lg p-8 max-w-lg mx-auto">
    <h2 class="text-xl font-bold text-slate-800 mb-6 text-center">Gerenciar Item</h2>
    
    <form action="/gerenciar/selecao" method="POST" class="space-y-6">
        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Selecione o Item para Editar/Excluir</label>
            <div class="relative">
                <select name="item_id" class="w-full appearance-none bg-slate-50 border border-slate-200 rounded-lg px-4 py-4 text-slate-800 font-medium focus:outline-none focus:ring-2 focus:ring-blue-500" required onchange="this.form.submit()">
                    <option value="" disabled selected>Clique para selecionar...</option>
                    {% for item in itens %}
                    <option value="{{ item.id }}">{{ item.nome }} - {{ item.tamanho }} ({{ item.genero }})</option>
                    {% endfor %}
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
        </div>
        <div class="text-center">
            <a href="/" class="text-sm text-slate-400 hover:text-slate-600">Cancelar</a>
        </div>
    </form>
</div>
{% endblock %}

##################################################

FILE: app/estoque/templates/estoque/solicitar_uniforme.html
-----------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
        <i class="fas fa-hard-hat text-blue-600"></i> Solicita√ß√£o de Uniforme e EPI
    </h2>
    <p class="text-sm text-slate-500 mt-1">Fa√ßa o pedido de pe√ßas de fardamento ou equipamentos ao departamento de Log√≠stica/RH.</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
    
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="bg-blue-600 p-5 text-white flex justify-between items-center">
            <h3 class="font-bold text-lg"><i class="fas fa-plus-circle mr-2"></i> Novo Pedido</h3>
        </div>
        <div class="p-6">
            <form method="POST" action="{{ url_for('estoque.solicitar_uniforme') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                
                <div class="mb-4">
                    <label class="label-pro">Qual pe√ßa necessita?</label>
                    <select id="nome_item" onchange="buscarTamanhos()" required class="input-pro cursor-pointer">
                        <option value="">-- Selecione uma pe√ßa --</option>
                        {% for nome in nomes_disponiveis %}
                            <option value="{{ nome }}">{{ nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="label-pro">Tamanho</label>
                        <select id="tamanho_select" onchange="atualizarGeneros()" required class="input-pro cursor-pointer disabled:opacity-50" disabled>
                            <option value="">Aguardando pe√ßa...</option>
                        </select>
                    </div>

                    <div>
                        <label class="label-pro">G√™nero</label>
                        <select name="item_id" id="item_id" required class="input-pro cursor-pointer disabled:opacity-50" disabled>
                            <option value="">Aguardando tamanho...</option>
                        </select>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="label-pro">Quantidade</label>
                    <input type="number" name="quantidade" value="1" min="1" required class="input-pro">
                </div>

                <button type="submit" class="w-full bg-slate-900 hover:bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg transition flex items-center justify-center gap-2 group">
                    <i class="fas fa-paper-plane group-hover:-translate-y-1 group-hover:translate-x-1 transition-transform"></i> ENVIAR SOLICITA√á√ÉO
                </button>
            </form>
        </div>
    </div>

    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
        <h3 class="font-bold text-slate-800 text-lg mb-4 border-b pb-3 flex items-center gap-2">
            <i class="fas fa-history text-slate-400"></i> Meus Pedidos
        </h3>
        <div class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
            {% for solic in solicitacoes %}
            <div class="p-4 border border-slate-100 rounded-lg {{ 'bg-slate-50' if solic.status == 'Pendente' else 'bg-white' }} flex flex-col gap-2 hover:border-blue-200 transition shadow-sm">
                <div class="flex justify-between items-start">
                    <div>
                        <span class="font-bold text-sm text-slate-800 block">{{ solic.item_nome }}</span>
                        <span class="text-xs font-medium text-slate-500 mt-0.5 inline-block bg-slate-200 px-2 py-0.5 rounded">{{ solic.tamanho }} | {{ solic.genero }}</span>
                        <span class="text-xs font-black text-blue-600 ml-2">{{ solic.quantidade }} un.</span>
                    </div>
                    
                    {% if solic.status == 'Pendente' %}
                        <span class="text-[10px] bg-amber-100 text-amber-700 px-2.5 py-1 rounded font-black uppercase tracking-wide border border-amber-200"><i class="fas fa-clock mr-1"></i> Pendente</span>
                    {% elif solic.status == 'Aprovado' %}
                        <span class="text-[10px] bg-emerald-100 text-emerald-700 px-2.5 py-1 rounded font-black uppercase tracking-wide border border-emerald-200"><i class="fas fa-check mr-1"></i> Aprovado</span>
                    {% else %}
                        <span class="text-[10px] bg-red-100 text-red-700 px-2.5 py-1 rounded font-black uppercase tracking-wide border border-red-200"><i class="fas fa-times mr-1"></i> Recusado</span>
                    {% endif %}
                </div>
                <div class="text-[10px] text-slate-400 font-bold uppercase mt-2">
                    Enviado em: {{ solic.data_solicitacao.strftime('%d/%m/%Y √†s %H:%M') }}
                </div>
            </div>
            {% else %}
            <div class="text-center py-12 text-sm text-slate-400 flex flex-col items-center gap-3">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center text-2xl mb-2">
                    <i class="fas fa-box-open opacity-50"></i>
                </div>
                Voc√™ n√£o fez nenhum pedido recente.
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    let inventarioDisponivel = [];

    async function buscarTamanhos() {
        const nome = document.getElementById('nome_item').value;
        const selectTamanho = document.getElementById('tamanho_select');
        const selectGenero = document.getElementById('item_id');
        
        if (!nome) {
            selectTamanho.innerHTML = '<option value="">Aguardando pe√ßa...</option>';
            selectGenero.innerHTML = '<option value="">Aguardando tamanho...</option>';
            selectTamanho.disabled = true;
            selectGenero.disabled = true;
            inventarioDisponivel = [];
            return;
        }

        selectTamanho.innerHTML = '<option value="">Carregando...</option>';
        selectTamanho.disabled = true;
        selectGenero.innerHTML = '<option value="">Aguardando tamanho...</option>';
        selectGenero.disabled = true;

        try {
            const url = `{{ url_for('estoque.api_buscar_tamanhos') }}?nome=${encodeURIComponent(nome)}`;
            const resposta = await fetch(url);
            inventarioDisponivel = await resposta.json();
            
            selectTamanho.innerHTML = '<option value="">-- Escolha --</option>';
            
            if (inventarioDisponivel.length === 0) {
                selectTamanho.innerHTML = '<option value="">Sem stock</option>';
            } else {
                const tamanhosUnicos = [...new Set(inventarioDisponivel.map(item => item.tamanho))];
                tamanhosUnicos.forEach(tamanho => {
                    const opt = document.createElement('option');
                    opt.value = tamanho;
                    opt.textContent = tamanho;
                    selectTamanho.appendChild(opt);
                });
                selectTamanho.disabled = false;
            }
        } catch (erro) {
            selectTamanho.innerHTML = '<option value="">Erro ao buscar</option>';
        }
    }

    function atualizarGeneros() {
        const tamanhoEscolhido = document.getElementById('tamanho_select').value;
        const selectGenero = document.getElementById('item_id');

        selectGenero.innerHTML = '<option value="">-- Escolha --</option>';
        selectGenero.disabled = true;

        if (!tamanhoEscolhido) return;

        const opcoesFiltradas = inventarioDisponivel.filter(item => item.tamanho === tamanhoEscolhido);

        if (opcoesFiltradas.length === 0) {
            selectGenero.innerHTML = '<option value="">Sem stock</option>';
        } else {
            opcoesFiltradas.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.textContent = `${item.genero} (Stock: ${item.quantidade})`;
                selectGenero.appendChild(opt);
            });
            selectGenero.disabled = false;
        }
    }
</script>
{% endblock %}



##################################################

FILE: app/main/__init__.py
--------------------------
from flask import Blueprint

# O par√¢metro template_folder='templates' diz ao Flask para procurar 
# os arquivos dentro de app/main/templates/
main_bp = Blueprint('main', __name__, template_folder='templates')

# Importamos as rotas no final para evitar o erro de importa√ß√£o circular
from app.main import routes



##################################################

FILE: app/main/routes.py
------------------------
from flask import render_template, redirect, url_for, jsonify, request
from flask_login import login_required, current_user
from app.extensions import db
from app.models import User, PontoAjuste, Recibo, Holerite, PreCadastro, Notificacao, PontoResumo, PontoRegistro, HistoricoSaida, PushSubscription
from app.utils import get_brasil_time, has_permission
from datetime import timedelta
from sqlalchemy import func
import traceback
import json

# Importamos o Blueprint definido no __init__.py do m√≥dulo
from app.main import main_bp

@main_bp.route('/')
@login_required
def dashboard():
    if current_user.is_first_access:
        return redirect(url_for('auth.primeiro_acesso'))
    
    if current_user.role == 'Terminal':
        return redirect(url_for('ponto.terminal_scanner'))

    # Dados B√°sicos (Todos V√™em)
    dados = {
        'hoje': get_brasil_time().strftime('%d/%m/%Y'),
        'doc_pendentes': 0
    }

    # Contagem de documentos n√£o lidos pelo utilizador
    docs_h = Holerite.query.filter_by(user_id=current_user.id, visualizado=False).count()
    docs_r = Recibo.query.filter_by(user_id=current_user.id, visualizado=False).count()
    dados['doc_pendentes'] = docs_h + docs_r

    # Dados Administrativos (Apenas se tiver permiss√£o ou for Master)
    admin_stats = {}
    
    if has_permission('USUARIOS'):
        # FILTRO: N√£o conta o Terminal como funcion√°rio ativo
        admin_stats['total_users'] = User.query.filter(User.username != '12345678900', User.username != 'terminal').count()
        admin_stats['pendentes_cadastro'] = PreCadastro.query.count()

    if has_permission('PONTO'):
        admin_stats['ajustes_pendentes'] = PontoAjuste.query.filter_by(status='Pendente').count()

    return render_template('main/dashboard.html', dados=dados, admin=admin_stats)

# --- ROTAS AJAX DO SININHO DE NOTIFICA√á√ïES ---
@main_bp.route('/api/notificacoes', methods=['GET'])
@login_required
def buscar_notificacoes():
    """Busca as √∫ltimas 10 notifica√ß√µes do utilizador para mostrar no sino."""
    notifs = Notificacao.query.filter_by(user_id=current_user.id).order_by(Notificacao.data_criacao.desc()).limit(10).all()
    nao_lidas = Notificacao.query.filter_by(user_id=current_user.id, lida=False).count()
    
    lista = []
    for n in notifs:
        lista.append({
            'id': n.id,
            'mensagem': n.mensagem,
            'link': n.link,
            'lida': n.lida,
            'tempo': n.data_criacao.strftime('%d/%m %H:%M')
        })
        
    return jsonify({'nao_lidas': nao_lidas, 'itens': lista})

@main_bp.route('/api/notificacoes/ler/<int:notif_id>', methods=['POST'])
@login_required
def ler_notificacao(notif_id):
    """Marca uma notifica√ß√£o como lida quando o utilizador clica nela."""
    notif = Notificacao.query.filter_by(id=notif_id, user_id=current_user.id).first()
    if notif:
        notif.lida = True
        db.session.commit()
        return jsonify({'success': True})
    return jsonify({'success': False}), 404

@main_bp.route('/api/notificacoes/ler_todas', methods=['POST'])
@login_required
def ler_todas_notificacoes():
    """Limpa o contador do sino marcando todas como lidas."""
    Notificacao.query.filter_by(user_id=current_user.id, lida=False).update({'lida': True})
    db.session.commit()
    return jsonify({'success': True})

# PROBLEMA 8: Nova rota para excluir fisicamente as notifica√ß√µes do banco de dados
@main_bp.route('/api/notificacoes/limpar', methods=['POST'])
@login_required
def limpar_notificacoes():
    """Exclui todas as notifica√ß√µes do hist√≥rico do utilizador."""
    try:
        Notificacao.query.filter_by(user_id=current_user.id).delete()
        db.session.commit()
        return jsonify({'success': True})
    except Exception as e:
        db.session.rollback()
        return jsonify({'success': False, 'error': str(e)}), 500

# --- API DE INTELIG√äNCIA EXECUTIVA (CHART.JS) BLINDADA ---
@main_bp.route('/api/analytics', methods=['GET'])
@login_required
def api_analytics():
    """Fornece dados em tempo real para os 5 gr√°ficos do Dashboard Master."""
    clean_username = str(current_user.username).replace('.', '').replace('-', '')
    is_master = current_user.role == 'Master' or clean_username == '50097952800'
    
    if not is_master:
        return jsonify({'error': 'Acesso negado'}), 403
        
    try:
        hoje = get_brasil_time().date()
        sete_dias_atras = hoje - timedelta(days=6)
        primeiro_dia_mes = hoje.replace(day=1)

        # 1. Raio-X da Opera√ß√£o Hoje (Donut)
        ponto_hoje = db.session.query(PontoResumo.status_dia, func.count(PontoResumo.id)).filter(PontoResumo.data_referencia == hoje).group_by(PontoResumo.status_dia).all()
        raio_x = {status: qtd for status, qtd in ponto_hoje}
        
        # 2. Term√¥metro de Risco (Linhas: Faltas vs Horas Extras nos √∫ltimos 7 dias)
        dias_labels = [(sete_dias_atras + timedelta(days=i)).strftime('%d/%m') for i in range(7)]
        risco_faltas = []
        risco_extras = []
        for i in range(7):
            dia_alvo = sete_dias_atras + timedelta(days=i)
            faltas = PontoResumo.query.filter(PontoResumo.data_referencia == dia_alvo, PontoResumo.status_dia == 'Falta').count()
            extras_min = db.session.query(func.sum(PontoResumo.minutos_saldo)).filter(PontoResumo.data_referencia == dia_alvo, PontoResumo.minutos_saldo > 0).scalar() or 0
            risco_faltas.append(faltas)
            risco_extras.append(round(extras_min / 60, 1))

        # 3. Term√¥metro de Custos (Barras: EPI por Depto no m√™s atual)
        saidas = db.session.query(User.departamento, func.sum(HistoricoSaida.quantidade))\
            .join(User, User.real_name == HistoricoSaida.colaborador)\
            .filter(HistoricoSaida.data_entrega >= primeiro_dia_mes)\
            .group_by(User.departamento).all()
        custos_labels = [s[0] or 'Geral' for s in saidas]
        custos_data = [s[1] for s in saidas]

        # 4. Escudo Legal (Veloc√≠metro: % Documentos Lidos no M√™s)
        tot_holerites = Holerite.query.filter(Holerite.enviado_em >= primeiro_dia_mes).count()
        lid_holerites = Holerite.query.filter(Holerite.enviado_em >= primeiro_dia_mes, Holerite.visualizado == True).count()
        tot_recibos = Recibo.query.filter(Recibo.created_at >= primeiro_dia_mes).count()
        lid_recibos = Recibo.query.filter(Recibo.created_at >= primeiro_dia_mes, Recibo.visualizado == True).count()
        
        total_docs = tot_holerites + tot_recibos
        lidos_docs = lid_holerites + lid_recibos
        taxa_assinatura = round((lidos_docs / total_docs * 100) if total_docs > 0 else 100, 1)

        # 5. Radar de Pontualidade (Barras Empilhadas: Atrasos no M√™s)
        pontual = PontoResumo.query.filter(PontoResumo.data_referencia >= primeiro_dia_mes, PontoResumo.minutos_saldo >= 0).count()
        atraso_leve = PontoResumo.query.filter(PontoResumo.data_referencia >= primeiro_dia_mes, PontoResumo.minutos_saldo < 0, PontoResumo.minutos_saldo >= -15).count()
        atraso_critico = PontoResumo.query.filter(PontoResumo.data_referencia >= primeiro_dia_mes, PontoResumo.minutos_saldo < -15).count()

        return jsonify({
            'raio_x': raio_x,
            'risco': {'labels': dias_labels, 'faltas': risco_faltas, 'extras': risco_extras},
            'custos': {'labels': custos_labels, 'data': custos_data},
            'escudo': taxa_assinatura,
            'pontualidade': [pontual, atraso_leve, atraso_critico]
        })
        
    except Exception as e:
        print("====== ERRO NA API DE ANALYTICS ======")
        traceback.print_exc()
        print("======================================")
        return jsonify({'error': str(e)}), 500

# ============================================================================
# FASE 3: O APERTO DE M√ÉO (REGISTRO DA ASSINATURA PUSH DO TELEM√ìVEL)
# ============================================================================
@main_bp.route('/api/push/subscribe', methods=['POST'])
@login_required
def subscribe_push():
    try:
        sub_data = request.get_json()
        if not sub_data:
            return jsonify({'success': False, 'error': 'Nenhum dado recebido'}), 400

        endpoint = sub_data.get('endpoint')
        keys = sub_data.get('keys', {})
        p256dh = keys.get('p256dh')
        auth = keys.get('auth')

        if not endpoint or not p256dh or not auth:
            return jsonify({'success': False, 'error': 'Dados da subscri√ß√£o incompletos'}), 400

        existente = PushSubscription.query.filter_by(endpoint=endpoint, user_id=current_user.id).first()
        
        if existente:
            existente.p256dh = p256dh
            existente.auth = auth
        else:
            nova_sub = PushSubscription(
                user_id=current_user.id,
                endpoint=endpoint,
                p256dh=p256dh,
                auth=auth
            )
            db.session.add(nova_sub)

        db.session.commit()
        return jsonify({'success': True, 'message': 'Dispositivo conectado ao radar Shahin com sucesso!'})
        
    except Exception as e:
        db.session.rollback()
        print("====== ERRO NA SUBSCRI√á√ÉO PUSH ======")
        traceback.print_exc()
        return jsonify({'success': False, 'error': str(e)}), 500



##################################################

FILE: app/main/templates/main/dashboard.html
--------------------------------------------
{% extends 'base.html' %}
{% block content %}

{% set clean_username = current_user.username | string | replace('.', '') | replace('-', '') %}
{% set is_master = current_user.role == 'Master' or clean_username == '50097952800' %}

<div class="bg-gradient-to-r from-blue-900 to-slate-900 rounded-2xl p-6 text-white shadow-xl mb-8 flex justify-between items-center relative overflow-hidden transition transform hover:scale-[1.01]">
    <div class="absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
    <div>
        <p class="text-xs font-bold text-blue-300 uppercase tracking-widest mb-1">Status Hoje</p>
        <h2 class="text-2xl font-bold mb-1">{{ dados.hoje }}</h2>
        <p class="text-xs opacity-70">{{ current_user.real_name }}</p>
    </div>
    <a href="/ponto/registrar" class="bg-white text-blue-900 hover:bg-blue-50 font-bold py-3 px-6 rounded-full shadow-lg transition transform hover:scale-105 flex items-center gap-2 z-10">
        <i class="fas fa-fingerprint"></i> <span>REGISTAR</span>
    </a>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
        <h3 class="font-bold text-slate-700 mb-2"><i class="fas fa-bolt text-yellow-500 mr-2"></i>Acesso R√°pido</h3>
        <div class="flex flex-col gap-2 mt-4">
             <a href="/ponto/espelho" class="text-sm text-slate-600 hover:text-blue-600 flex items-center gap-2"><i class="fas fa-calendar-alt w-5"></i> Ver meu Espelho</a>
             <a href="/documentos/meus-documentos" class="text-sm text-slate-600 hover:text-blue-600 flex items-center gap-2"><i class="fas fa-file-invoice w-5"></i> Meus Documentos</a>
             <a href="/ponto/solicitar-ajuste" class="text-sm text-slate-600 hover:text-blue-600 flex items-center gap-2"><i class="fas fa-exclamation-circle w-5"></i> Ajustar Ponto</a>
        </div>
    </div>
    
    {% if not is_master %}
    <div class="bg-blue-50 p-6 rounded-xl border border-blue-100 shadow-sm flex items-center justify-center text-center">
        <div>
            <div class="text-blue-200 text-4xl mb-2"><i class="fas fa-quote-left"></i></div>
            <p class="text-blue-800 font-medium italic text-sm">"O sucesso √© a soma de pequenos esfor√ßos repetidos dia ap√≥s dia."</p>
        </div>
    </div>
    {% else %}
    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-purple-500 hover:shadow-md transition flex flex-col justify-center">
        <h3 class="font-bold text-slate-700 mb-2"><i class="fas fa-crown text-purple-500 mr-2"></i>Atalhos Executivos</h3>
        <div class="grid grid-cols-2 gap-3 mt-2">
            <a href="/admin/usuarios" class="bg-slate-50 hover:bg-slate-100 p-3 rounded-lg text-center text-xs font-bold text-slate-600 border border-slate-200 transition"><i class="fas fa-users block text-lg mb-1 text-blue-500"></i> Efetivo</a>
            <a href="/admin/solicitacoes" class="bg-slate-50 hover:bg-slate-100 p-3 rounded-lg text-center text-xs font-bold text-slate-600 border border-slate-200 transition relative">
                <i class="fas fa-inbox block text-lg mb-1 text-yellow-500"></i> Pedidos
                {% if admin.ajustes_pendentes > 0 %}
                <span class="absolute top-1 right-1 bg-red-500 text-white text-[9px] rounded-full w-4 h-4 flex items-center justify-center">{{ admin.ajustes_pendentes }}</span>
                {% endif %}
            </a>
        </div>
    </div>
    {% endif %}
</div>

{% if is_master %}
<div class="mt-10 mb-6 flex items-center gap-3">
    <div class="h-8 w-1 bg-blue-600 rounded-full"></div>
    <h3 class="text-xl font-black text-slate-800 tracking-tight">Business Intelligence</h3>
</div>

<div id="loading-analytics" class="flex flex-col items-center justify-center py-12 text-slate-400">
    <i class="fas fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
    <p class="text-sm font-bold animate-pulse">A carregar dados em tempo real da opera√ß√£o...</p>
</div>

<div id="painel-analytics" class="hidden">
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative">
            <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4"><i class="fas fa-chart-pie mr-1"></i> Raio-X da Opera√ß√£o (Hoje)</h4>
            <div class="h-64 relative">
                <canvas id="chartRaioX"></canvas>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4"><i class="fas fa-chart-line mr-1"></i> Term√≥metro de Risco (7 Dias)</h4>
            <div class="h-64">
                <canvas id="chartRisco"></canvas>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm text-center">
            <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2"><i class="fas fa-shield-alt mr-1"></i> Escudo Legal</h4>
            <p class="text-[10px] text-slate-400 mb-4">Leitura de Holerites no M√™s</p>
            <div class="h-32 relative flex justify-center">
                <canvas id="chartEscudo"></canvas>
                <div class="absolute bottom-0 w-full text-center pb-2">
                    <span id="escudo-valor" class="text-2xl font-black text-slate-800">0%</span>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4"><i class="fas fa-clock mr-1"></i> Radar de Pontualidade</h4>
            <div class="h-40">
                <canvas id="chartPontualidade"></canvas>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
            <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4"><i class="fas fa-tshirt mr-1"></i> Consumo de EPI / Uniforme</h4>
            <div class="h-40">
                <canvas id="chartCustos"></canvas>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            const response = await fetch('/api/analytics');
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Falha de conex√£o com a API de dados.');
            }

            document.getElementById('loading-analytics').classList.add('hidden');
            document.getElementById('painel-analytics').classList.remove('hidden');

            // GR√ÅFICO 1: RAIO-X
            const labelsRaioX = Object.keys(data.raio_x).length > 0 ? Object.keys(data.raio_x) : ['Sem dados hoje'];
            const valoresRaioX = Object.keys(data.raio_x).length > 0 ? Object.values(data.raio_x) : [1];
            const colorMap = { 'OK': '#10b981', 'Trabalhando': '#10b981', 'Falta': '#ef4444', 'Atestado': '#f59e0b', 'Folga': '#3b82f6', 'Sem dados hoje': '#e2e8f0' };
            const bgColorsRaioX = labelsRaioX.map(l => colorMap[l] || '#8b5cf6');
            new Chart(document.getElementById('chartRaioX'), { type: 'doughnut', data: { labels: labelsRaioX, datasets: [{ data: valoresRaioX, backgroundColor: bgColorsRaioX, borderWidth: 2, hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } }, cutout: '70%' } });

            // GR√ÅFICO 2: RISCO
            new Chart(document.getElementById('chartRisco'), { type: 'line', data: { labels: data.risco.labels, datasets: [{ label: 'Faltas (Dias)', data: data.risco.faltas, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', borderWidth: 3, tension: 0.4, fill: true }, { label: 'Horas Extras (h)', data: data.risco.extras, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 3, tension: 0.4, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true, grid: { borderDash: [4, 4] } }, x: { grid: { display: false } } } } });

            // GR√ÅFICO 3: CUSTOS
            new Chart(document.getElementById('chartCustos'), { type: 'bar', data: { labels: data.custos.labels.length > 0 ? data.custos.labels : ['Nenhuma sa√≠da'], datasets: [{ label: 'Pe√ßas Entregues', data: data.custos.data.length > 0 ? data.custos.data : [0], backgroundColor: '#8b5cf6', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } }, x: { grid: { display: false } } } } });

            // GR√ÅFICO 4: ESCUDO
            document.getElementById('escudo-valor').innerText = data.escudo + '%';
            let corEscudo = '#10b981'; if (data.escudo < 50) corEscudo = '#ef4444'; else if (data.escudo < 80) corEscudo = '#f59e0b';
            new Chart(document.getElementById('chartEscudo'), { type: 'doughnut', data: { labels: ['Lidos', 'Pendentes'], datasets: [{ data: [data.escudo, 100 - data.escudo], backgroundColor: [corEscudo, '#f1f5f9'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, circumference: 180, rotation: 270, cutout: '80%', plugins: { legend: { display: false }, tooltip: { enabled: false } } } });

            // GR√ÅFICO 5: PONTUALIDADE
            new Chart(document.getElementById('chartPontualidade'), { type: 'bar', data: { labels: ['No Hor√°rio', 'Atraso Leve', 'Atraso Cr√≠tico'], datasets: [{ data: data.pontualidade, backgroundColor: ['#10b981', '#f59e0b', '#ef4444'], borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } }, x: { grid: { display: false } } } } });

        } catch (error) {
            console.error("Erro ao carregar Analytics:", error);
            document.getElementById('loading-analytics').innerHTML = `<div class="text-red-500 text-center"><i class="fas fa-exclamation-triangle mb-2 text-2xl"></i><p class="text-xs font-bold">Erro do Sistema:</p><p class="text-[10px] text-slate-500 mt-1">${error.message}</p></div>`;
        }
    });
</script>
{% endif %}

{% endblock %}



##################################################

FILE: app/models/__init__.py
----------------------------
from app.extensions import db
from flask_login import UserMixin
from werkzeug.security import generate_password_hash, check_password_hash
from datetime import datetime
import pytz

def get_brasil_time():
    """Retorna o hor√°rio atual no fuso de Bras√≠lia."""
    return datetime.now(pytz.timezone('America/Sao_Paulo')).replace(tzinfo=None)

class User(UserMixin, db.Model):
    __tablename__ = 'users'
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    password_hash = db.Column(db.String(200), nullable=False)
    real_name = db.Column(db.String(120), nullable=False)
    cpf = db.Column(db.String(14), unique=True, nullable=True)
    # PROBLEMA 1: Limite aumentado de 20 para 100 caracteres
    role = db.Column(db.String(100), default='Funcionario')
    
    departamento = db.Column(db.String(100), nullable=True)
    gestor_id = db.Column(db.Integer, db.ForeignKey('users.id', ondelete='SET NULL'), nullable=True)
    gestor = db.relationship('User', remote_side=[id], backref=db.backref('subordinados', lazy=True))
    
    permissions = db.Column(db.String(500), nullable=True)
    is_first_access = db.Column(db.Boolean, default=True)
    data_admissao = db.Column(db.Date, nullable=True)
    carga_horaria = db.Column(db.Integer, default=528)
    tempo_intervalo = db.Column(db.Integer, default=60)
    inicio_jornada_ideal = db.Column(db.String(5), default="08:00")
    # PROBLEMA 1: Limite aumentado de 20 para 50 caracteres
    escala = db.Column(db.String(50), default="Livre")
    data_inicio_escala = db.Column(db.Date, nullable=True)
    salario = db.Column(db.Float, default=0.0)
    
    # PROBLEMA 3: Colunas para suportar os m√∫ltiplos CNPJs da Shahin
    razao_social_empregadora = db.Column(db.String(200))
    cnpj_empregador = db.Column(db.String(20))

    def set_password(self, password):
        self.password_hash = generate_password_hash(password)
    def check_password(self, password):
        return check_password_hash(self.password_hash, password)

class PreCadastro(db.Model):
    __tablename__ = 'pre_cadastros'
    id = db.Column(db.Integer, primary_key=True)
    cpf = db.Column(db.String(14), unique=True, nullable=False)
    nome_previsto = db.Column(db.String(120), nullable=False)
    # PROBLEMA 1: Limite aumentado de 80 para 150 caracteres
    cargo = db.Column(db.String(150))
    departamento = db.Column(db.String(100), nullable=True)
    cpf_gestor = db.Column(db.String(14), nullable=True)
    salario = db.Column(db.Float, default=0.0)
    
    # PROBLEMA 3: Colunas para suportar os m√∫ltiplos CNPJs no pr√©-cadastro
    razao_social = db.Column(db.String(200))
    cnpj = db.Column(db.String(20))
    
    data_admissao = db.Column(db.Date, nullable=True)
    carga_horaria = db.Column(db.Integer, default=528)
    tempo_intervalo = db.Column(db.Integer, default=60)
    inicio_jornada_ideal = db.Column(db.String(5), default="08:00")
    # PROBLEMA 1: Limite aumentado de 20 para 50 caracteres
    escala = db.Column(db.String(50), default="Livre")
    data_inicio_escala = db.Column(db.Date, nullable=True)
    created_at = db.Column(db.DateTime, default=get_brasil_time)

class ItemEstoque(db.Model):
    __tablename__ = 'itens_estoque'
    id = db.Column(db.Integer, primary_key=True)
    nome = db.Column(db.String(100), nullable=False)
    tamanho = db.Column(db.String(10))
    genero = db.Column(db.String(20))
    quantidade = db.Column(db.Integer, default=0)
    estoque_minimo = db.Column(db.Integer, default=5)
    estoque_ideal = db.Column(db.Integer, default=20)

class HistoricoEntrada(db.Model):
    __tablename__ = 'historico_entrada'
    id = db.Column(db.Integer, primary_key=True)
    item_nome = db.Column(db.String(100))
    quantidade = db.Column(db.Integer)
    data_hora = db.Column(db.DateTime, default=get_brasil_time)

class HistoricoSaida(db.Model):
    __tablename__ = 'historico_saida'
    id = db.Column(db.Integer, primary_key=True)
    coordenador = db.Column(db.String(100))
    colaborador = db.Column(db.String(100))
    item_nome = db.Column(db.String(100))
    tamanho = db.Column(db.String(10))
    genero = db.Column(db.String(20))
    quantidade = db.Column(db.Integer)
    data_entrega = db.Column(db.Date, default=get_brasil_time)

class Holerite(db.Model):
    __tablename__ = 'holerites'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=True)
    mes_referencia = db.Column(db.String(7), nullable=False)
    status = db.Column(db.String(20), default='Enviado')
    url_arquivo = db.Column(db.String(500), nullable=True)
    conteudo_pdf = db.Column(db.LargeBinary, nullable=True)
    visualizado = db.Column(db.Boolean, default=False)
    visualizado_em = db.Column(db.DateTime, nullable=True)
    enviado_em = db.Column(db.DateTime, default=get_brasil_time)
    user = db.relationship('User', backref=db.backref('holerites', lazy=True))

class Recibo(db.Model):
    __tablename__ = 'recibos'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    valor = db.Column(db.Float, nullable=False)
    data_pagamento = db.Column(db.Date, nullable=False)
    tipo_vale_alimentacao = db.Column(db.Boolean, default=False)
    tipo_vale_transporte = db.Column(db.Boolean, default=False)
    tipo_assiduidade = db.Column(db.Boolean, default=False)
    tipo_cesta_basica = db.Column(db.Boolean, default=False)
    forma_pagamento = db.Column(db.String(50), default="Transfer√™ncia")
    url_arquivo = db.Column(db.String(500), nullable=True) 
    conteudo_pdf = db.Column(db.LargeBinary, nullable=True) 
    visualizado = db.Column(db.Boolean, default=False)
    created_at = db.Column(db.DateTime, default=get_brasil_time)
    user = db.relationship('User', backref=db.backref('recibos', lazy=True))

class AssinaturaDigital(db.Model):
    __tablename__ = 'assinaturas_digitais'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    tipo_documento = db.Column(db.String(50), nullable=False)
    documento_id = db.Column(db.Integer, nullable=False)
    hash_arquivo = db.Column(db.String(128), nullable=False)
    ip_address = db.Column(db.String(45))
    user_agent = db.Column(db.String(255))
    data_assinatura = db.Column(db.DateTime, default=get_brasil_time)
    user = db.relationship('User', backref=db.backref('assinaturas', lazy=True))

class PontoRegistro(db.Model):
    __tablename__ = 'ponto_registros'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    data_registro = db.Column(db.Date, nullable=False)
    hora_registro = db.Column(db.Time, nullable=False)
    tipo = db.Column(db.String(20))
    latitude = db.Column(db.String(50))
    longitude = db.Column(db.String(50))

class PontoResumo(db.Model):
    __tablename__ = 'ponto_resumos'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    data_referencia = db.Column(db.Date, nullable=False)
    minutos_trabalhados = db.Column(db.Integer, default=0)
    minutos_esperados = db.Column(db.Integer, default=528)
    minutos_saldo = db.Column(db.Integer, default=0)
    status_dia = db.Column(db.String(20), default='OK')

class PontoAjuste(db.Model):
    __tablename__ = 'ponto_ajustes'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    data_referencia = db.Column(db.Date, nullable=False)
    ponto_original_id = db.Column(db.Integer, nullable=True)
    novo_horario = db.Column(db.String(5))
    tipo_batida = db.Column(db.String(20))
    tipo_solicitacao = db.Column(db.String(20))
    justificativa = db.Column(db.Text)
    status = db.Column(db.String(20), default='Pendente')
    motivo_reprovacao = db.Column(db.Text)
    created_at = db.Column(db.DateTime, default=get_brasil_time)
    user = db.relationship('User', backref=db.backref('ajustes', lazy=True))

class Atestado(db.Model):
    __tablename__ = 'atestados'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id', ondelete='CASCADE'), nullable=False)
    data_envio = db.Column(db.DateTime, nullable=False)
    url_arquivo = db.Column(db.String(500), nullable=False) 
    data_inicio_afastamento = db.Column(db.Date, nullable=True) 
    quantidade_dias = db.Column(db.Integer, nullable=True)
    texto_extraido = db.Column(db.Text, nullable=True) 
    status = db.Column(db.String(50), default='Processando')
    motivo_recusa = db.Column(db.String(500), nullable=True)
    user = db.relationship('User', backref=db.backref('atestados', lazy=True))

class PeriodoAquisitivo(db.Model):
    __tablename__ = 'periodos_aquisitivos'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id', ondelete='CASCADE'), nullable=False)
    data_inicio = db.Column(db.Date, nullable=False)
    data_fim = db.Column(db.Date, nullable=False)
    faltas_injustificadas = db.Column(db.Integer, default=0)
    dias_direito = db.Column(db.Integer, default=30)
    dias_usados = db.Column(db.Integer, default=0)
    ativo = db.Column(db.Boolean, default=True)
    user = db.relationship('User', backref=db.backref('periodos', lazy=True))

class SolicitacaoAusencia(db.Model):
    __tablename__ = 'solicitacoes_ausencia'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id', ondelete='CASCADE'), nullable=False)
    tipo_ausencia = db.Column(db.String(50), nullable=False) 
    data_inicio = db.Column(db.Date, nullable=False)
    data_fim = db.Column(db.Date, nullable=False)
    quantidade_dias = db.Column(db.Integer, nullable=False)
    abono_pecuniario = db.Column(db.Boolean, default=False)
    dias_abono = db.Column(db.Integer, default=0)
    observacao = db.Column(db.Text, nullable=True)
    status = db.Column(db.String(20), default='Pendente') 
    data_solicitacao = db.Column(db.DateTime, default=get_brasil_time)
    user = db.relationship('User', backref=db.backref('ausencias', lazy=True))

class SolicitacaoUniforme(db.Model):
    __tablename__ = 'solicitacoes_uniforme'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id', ondelete='CASCADE'), nullable=False)
    item_id = db.Column(db.Integer, db.ForeignKey('itens_estoque.id', ondelete='SET NULL'), nullable=True)
    item_nome = db.Column(db.String(100))
    tamanho = db.Column(db.String(10))
    genero = db.Column(db.String(20))
    quantidade = db.Column(db.Integer, nullable=False)
    status = db.Column(db.String(20), default='Pendente') 
    data_solicitacao = db.Column(db.DateTime, default=get_brasil_time)
    data_resposta = db.Column(db.DateTime, nullable=True)
    user = db.relationship('User', backref=db.backref('pedidos_uniforme', lazy=True))
    item = db.relationship('ItemEstoque')

class Notificacao(db.Model):
    __tablename__ = 'notificacoes'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id', ondelete='CASCADE'), nullable=False)
    mensagem = db.Column(db.String(255), nullable=False)
    link = db.Column(db.String(255), nullable=True)
    lida = db.Column(db.Boolean, default=False)
    data_criacao = db.Column(db.DateTime, default=get_brasil_time)
    user = db.relationship('User', backref=db.backref('notificacoes', lazy=True))

# --- INFRAESTRUTURA PARA NOTIFICA√á√ïES PUSH NATIVAS ---
class PushSubscription(db.Model):
    __tablename__ = 'push_subscriptions'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id', ondelete='CASCADE'), nullable=False)
    endpoint = db.Column(db.String(500), nullable=False)
    p256dh = db.Column(db.String(255), nullable=False)
    auth = db.Column(db.String(255), nullable=False)
    created_at = db.Column(db.DateTime, default=get_brasil_time)
    user = db.relationship('User', backref=db.backref('push_subs', lazy=True))



##################################################

FILE: app/ponto/__init__.py
---------------------------
# M√≥dulo ponto

##################################################

FILE: app/ponto/routes.py
-------------------------
from flask import Blueprint, render_template, request, redirect, url_for, flash, jsonify, current_app
from flask_login import login_required, current_user
from app.extensions import db, csrf
from app.models import PontoRegistro, PontoResumo, User, PontoAjuste, SolicitacaoAusencia
from app.utils import get_brasil_time, calcular_dia, format_minutes_to_hm, data_por_extenso, enviar_notificacao
from datetime import datetime, date, timedelta
from sqlalchemy import func
from itsdangerous import URLSafeTimedSerializer, SignatureExpired, BadSignature
import logging
import calendar

logger = logging.getLogger(__name__)

ponto_bp = Blueprint('ponto', __name__, template_folder='templates', url_prefix='/ponto')

@ponto_bp.route('/api/gerar-token', methods=['GET'])
@login_required
def gerar_token_qrcode():
    if current_user.role == 'Terminal': return jsonify({'error': 'Terminal n√£o gera token'}), 403
    s = URLSafeTimedSerializer(current_app.secret_key)
    token = s.dumps({'user_id': current_user.id, 'timestamp': get_brasil_time().timestamp()})
    return jsonify({'token': token})

@ponto_bp.route('/api/check-status', methods=['GET'])
@login_required
def check_status_ponto():
    if current_user.role == 'Terminal': return jsonify({'status': 'ignorar'})
    agora = get_brasil_time()
    ultimo_ponto = PontoRegistro.query.filter_by(user_id=current_user.id).order_by(PontoRegistro.id.desc()).first()
    if ultimo_ponto:
        dt_ponto = datetime.combine(ultimo_ponto.data_registro, ultimo_ponto.hora_registro)
        if (agora - dt_ponto).total_seconds() < 15:
            return jsonify({'marcado': True, 'tipo': ultimo_ponto.tipo, 'hora': ultimo_ponto.hora_registro.strftime('%H:%M')})
    return jsonify({'marcado': False})

@ponto_bp.route('/api/registrar-leitura', methods=['POST'])
@login_required
@csrf.exempt
def registrar_leitura_terminal():
    if current_user.role != 'Terminal' and current_user.role != 'Master': return jsonify({'error': 'Acesso negado.'}), 403
    token = request.json.get('token')
    if not token: return jsonify({'error': 'Token vazio'}), 400
    
    s = URLSafeTimedSerializer(current_app.secret_key)
    try:
        dados = s.loads(token, max_age=35)
        user_alvo = User.query.get(dados['user_id'])
        if not user_alvo: return jsonify({'error': 'Usu√°rio inv√°lido'}), 404
        
        tempo_agora = get_brasil_time()
        hoje = tempo_agora.date()
        
        ultimo = PontoRegistro.query.filter_by(user_id=user_alvo.id, data_registro=hoje).order_by(PontoRegistro.hora_registro.desc()).first()
        if ultimo:
            dt_ultimo = datetime.combine(hoje, ultimo.hora_registro)
            if (tempo_agora - dt_ultimo).total_seconds() < 60:
                 return jsonify({'error': f'Aguarde antes de bater o ponto novamente.'}), 400

        pontos_hoje = PontoRegistro.query.filter_by(user_id=user_alvo.id, data_registro=hoje).order_by(PontoRegistro.hora_registro).all()
        proxima = "Entrada"
        if len(pontos_hoje) == 1: proxima = "Ida Almo√ßo"
        elif len(pontos_hoje) == 2: proxima = "Volta Almo√ßo"
        elif len(pontos_hoje) == 3: proxima = "Sa√≠da"
        elif len(pontos_hoje) >= 4: proxima = "Extra"
        
        novo = PontoRegistro(
            user_id=user_alvo.id, 
            data_registro=hoje, 
            hora_registro=tempo_agora.time(), 
            tipo=proxima, 
            latitude='QR-Code', 
            longitude='Presencial'
        )
        db.session.add(novo); db.session.commit()
        calcular_dia(user_alvo.id, hoje)
        return jsonify({
            'success': True, 
            'message': f'Ponto registrado: {proxima}', 
            'funcionario': user_alvo.real_name, 
            'hora': novo.hora_registro.strftime('%H:%M'), 
            'tipo': proxima
        })
    except SignatureExpired: return jsonify({'error': 'QR Code expirado.'}), 400
    except BadSignature: return jsonify({'error': 'QR Code inv√°lido.'}), 400
    except Exception as e: return jsonify({'error': f'Erro interno: {str(e)}'}), 500

@ponto_bp.route('/scanner')
@login_required
def terminal_scanner():
    if current_user.username != '12345678900' and current_user.role != 'Master': return redirect(url_for('main.dashboard'))
    return render_template('ponto/terminal_leitura.html')

@ponto_bp.route('/registrar', methods=['GET', 'POST'])
@login_required
def registrar_ponto():
    if current_user.username == '12345678900': return redirect(url_for('ponto.terminal_scanner'))
    
    agora_br = get_brasil_time()
    hoje = agora_br.date()
    hoje_extenso = data_por_extenso(hoje)
    bloqueado, motivo = False, ""
    
    ausencia = SolicitacaoAusencia.query.filter(
        SolicitacaoAusencia.user_id == current_user.id, 
        SolicitacaoAusencia.status == 'Aprovado', 
        SolicitacaoAusencia.data_inicio <= hoje, 
        SolicitacaoAusencia.data_fim >= hoje
    ).first()
    
    if ausencia: bloqueado = True; motivo = f"Afastamento programado: {ausencia.tipo_ausencia}"
    elif current_user.escala == '5x2' and hoje.weekday() >= 5: bloqueado = True; motivo = "Fim de semana (Escala 5x2)."
    elif current_user.escala == '12x36' and current_user.data_inicio_escala:
        if (hoje - current_user.data_inicio_escala).days % 2 != 0: bloqueado = True; motivo = "Dia de folga (Escala 12x36)."

    pontos = PontoRegistro.query.filter_by(user_id=current_user.id, data_registro=hoje).order_by(PontoRegistro.hora_registro).all()
    prox = "Entrada"
    if len(pontos) == 1: prox = "Ida Almo√ßo"
    elif len(pontos) == 2: prox = "Volta Almo√ßo"
    elif len(pontos) == 3: prox = "Sa√≠da"
    elif len(pontos) >= 4: prox = "Extra"

    if request.method == 'POST':
        if bloqueado: return redirect(url_for('main.dashboard'))
        novo_registro = PontoRegistro(
            user_id=current_user.id, 
            data_registro=hoje, 
            hora_registro=agora_br.time(), 
            tipo=prox, 
            latitude=request.form.get('latitude'), 
            longitude=request.form.get('longitude')
        )
        db.session.add(novo_registro)
        db.session.commit()
        calcular_dia(current_user.id, hoje)
        return redirect(url_for('main.dashboard'))
    return render_template('ponto/registro.html', proxima_acao=prox, hoje_extenso=hoje_extenso, pontos=pontos, bloqueado=bloqueado, motivo=motivo, hoje=hoje)

@ponto_bp.route('/espelho')
@login_required
def espelho_ponto():
    target_user_id = request.args.get('user_id', type=int) or current_user.id
    if target_user_id != current_user.id and current_user.role != 'Master': return redirect(url_for('main.dashboard'))
    user = User.query.get_or_404(target_user_id)
    
    agora_br = get_brasil_time()
    mes_ref = request.args.get('mes_ref') or agora_br.strftime('%Y-%m')
    
    try: ano, mes = map(int, mes_ref.split('-'))
    except: ano, mes = agora_br.year, agora_br.month; mes_ref = agora_br.strftime('%Y-%m')
    
    resumos = PontoResumo.query.filter(
        PontoResumo.user_id == target_user_id, 
        func.extract('year', PontoResumo.data_referencia) == ano, 
        func.extract('month', PontoResumo.data_referencia) == mes
    ).order_by(PontoResumo.data_referencia).all()
    
    detalhes = {}
    for r in resumos:
        batidas = PontoRegistro.query.filter_by(user_id=target_user_id, data_registro=r.data_referencia).order_by(PontoRegistro.hora_registro).all()
        detalhes[r.id] = [b.hora_registro.strftime('%H:%M') for b in batidas]
    
    dias_semana = {0: 'Seg', 1: 'Ter', 2: 'Qua', 3: 'Qui', 4: 'Sex', 5: 'S√°b', 6: 'Dom'}
    return render_template('ponto/ponto_espelho.html', resumos=resumos, user=user, detalhes=detalhes, format_hm=format_minutes_to_hm, mes_ref=mes_ref, dias_semana=dias_semana)

@ponto_bp.route('/solicitar-ajuste', methods=['GET', 'POST'])
@login_required
def solicitar_ajuste():
    pontos_dia, data_selecionada = [], None
    meus_ajustes = PontoAjuste.query.filter_by(user_id=current_user.id).order_by(PontoAjuste.created_at.desc()).limit(20).all()
    
    if request.method == 'POST':
        if request.form.get('acao') == 'buscar':
            try: 
                data_selecionada = datetime.strptime(request.form.get('data_busca'), '%Y-%m-%d').date()
                pontos_dia = PontoRegistro.query.filter_by(user_id=current_user.id, data_registro=data_selecionada).order_by(PontoRegistro.hora_registro).all()
            except: pass
        elif request.form.get('acao') == 'enviar':
            try:
                dt_obj = datetime.strptime(request.form.get('data_ref'), '%Y-%m-%d').date()
                p_id = int(request.form.get('ponto_id')) if request.form.get('ponto_id') else None
                solic = PontoAjuste(
                    user_id=current_user.id, 
                    data_referencia=dt_obj, 
                    ponto_original_id=p_id, 
                    novo_horario=request.form.get('novo_horario'), 
                    tipo_batida=request.form.get('tipo_batida'), 
                    tipo_solicitacao=request.form.get('tipo_solicitacao'), 
                    justificativa=request.form.get('justificativa')
                )
                db.session.add(solic); db.session.commit()
                
                # GATILHO NOTIFICA√á√ÉO MASTER
                master = User.query.filter_by(username='50097952800').first()
                if master:
                    enviar_notificacao(master.id, f"{current_user.real_name} solicitou um Ajuste de Ponto.", "/admin/solicitacoes")
                
                flash('Enviado!')
                return redirect(url_for('ponto.solicitar_ajuste'))
            except: pass
            
    dados_extras = {}
    for p in meus_ajustes:
        if p.ponto_original_id:
            original = PontoRegistro.query.get(p.ponto_original_id)
            if original: dados_extras[p.id] = original.hora_registro.strftime('%H:%M')
    return render_template('ponto/solicitar_ajuste.html', pontos=pontos_dia, data_sel=data_selecionada, meus_ajustes=meus_ajustes, extras=dados_extras)

@ponto_bp.route('/escala', methods=['GET'])
@login_required
def minha_escala():
    hoje = get_brasil_time().date()
    ano = request.args.get('ano', hoje.year, type=int)
    mes = request.args.get('mes', hoje.month, type=int)
    _, num_dias = calendar.monthrange(ano, mes)
    dias_mes = []
    
    for dia in range(1, num_dias + 1):
        dt_atual = date(ano, mes, dia)
        tipo_dia = 'Trabalho'
        
        ausencia = SolicitacaoAusencia.query.filter(
            SolicitacaoAusencia.user_id == current_user.id,
            SolicitacaoAusencia.status == 'Aprovado',
            SolicitacaoAusencia.data_inicio <= dt_atual,
            SolicitacaoAusencia.data_fim >= dt_atual
        ).first()
        
        if ausencia: tipo_dia = ausencia.tipo_ausencia
        else:
            if current_user.escala == '5x2' and dt_atual.weekday() >= 5: tipo_dia = 'Folga'
            elif current_user.escala == '12x36' and current_user.data_inicio_escala:
                if (dt_atual - current_user.data_inicio_escala).days % 2 != 0: tipo_dia = 'Folga'
        
        dia_semana_layout = (dt_atual.weekday() + 1) % 7 
        dias_mes.append({'data': dt_atual, 'tipo': tipo_dia, 'dia_semana': dia_semana_layout})

    return render_template('ponto/minha_escala.html', ano=ano, mes=mes, dias_mes=dias_mes, hoje=hoje)

@ponto_bp.route('/solicitar-ferias', methods=['GET', 'POST'])
@login_required
def solicitar_ferias():
    if not current_user.data_admissao:
        flash("Sua data de admiss√£o n√£o est√° cadastrada. Solicite ao RH para regularizar.", "warning")

    dias_direito = 30
    faltas = 0
    saldo = 0
    dias_usados = 0

    if current_user.data_admissao:
        hoje = get_brasil_time().date()
        um_ano_atras = hoje - timedelta(days=365)
        faltas = PontoResumo.query.filter(
            PontoResumo.user_id == current_user.id, 
            PontoResumo.data_referencia >= um_ano_atras, 
            PontoResumo.status_dia == 'Falta'
        ).count()

        if faltas <= 5: dias_direito = 30
        elif faltas <= 14: dias_direito = 24
        elif faltas <= 23: dias_direito = 18
        elif faltas <= 32: dias_direito = 12
        else: dias_direito = 0

        ausencias_ano = SolicitacaoAusencia.query.filter(
            SolicitacaoAusencia.user_id == current_user.id, 
            SolicitacaoAusencia.tipo_ausencia == 'F√©rias', 
            SolicitacaoAusencia.status.in_(['Aprovado', 'Pendente'])
        ).all()
        dias_usados = sum(a.quantidade_dias + a.dias_abono for a in ausencias_ano)
        saldo = dias_direito - dias_usados

    if request.method == 'POST':
        tipo = request.form.get('tipo_ausencia')
        dt_inicio = datetime.strptime(request.form.get('data_inicio'), '%Y-%m-%d').date()
        dt_fim = datetime.strptime(request.form.get('data_fim'), '%Y-%m-%d').date()
        obs = request.form.get('observacao', '')
        vender_ferias = request.form.get('vender_ferias') == 'sim'
        
        if dt_inicio > dt_fim:
            flash("A data de in√≠cio n√£o pode ser maior que a data de fim.", "error")
            return redirect(url_for('ponto.solicitar_ferias'))
            
        qtd_dias = (dt_fim - dt_inicio).days + 1
        dias_abono = 0

        if tipo == 'F√©rias':
            if not current_user.data_admissao:
                flash("Data de admiss√£o ausente. O RH deve configurar seu perfil antes de solicitar f√©rias.", "error")
                return redirect(url_for('ponto.solicitar_ferias'))

            if vender_ferias:
                dias_abono = qtd_dias // 2 
                if dias_abono > (dias_direito / 3):
                    flash(f"A CLT permite vender no m√°ximo 1/3 das f√©rias (Max: {int(dias_direito/3)} dias).", "error")
                    return redirect(url_for('ponto.solicitar_ferias'))
                total_descontado = qtd_dias + dias_abono
                if total_descontado > saldo:
                    flash(f"Saldo insuficiente. Voc√™ tem {saldo} dias dispon√≠veis, mas o pedido totaliza {total_descontado} dias.", "error")
                    return redirect(url_for('ponto.solicitar_ferias'))
            else:
                if qtd_dias > saldo:
                    flash(f"Saldo insuficiente. Voc√™ possui apenas {saldo} dias.", "error")
                    return redirect(url_for('ponto.solicitar_ferias'))

            if qtd_dias < 5:
                flash("Pela CLT (Reforma 2017), o per√≠odo fracionado de f√©rias n√£o pode ser inferior a 5 dias.", "error")
                return redirect(url_for('ponto.solicitar_ferias'))

            if current_user.escala == '5x2' and dt_inicio.weekday() in [3, 4]:
                flash("Ilegal: O in√≠cio das f√©rias n√£o pode ocorrer nos 2 dias que antecedem o repouso semanal (S√°b/Dom).", "error")
                return redirect(url_for('ponto.solicitar_ferias'))

        nova_solicitacao = SolicitacaoAusencia(
            user_id=current_user.id, 
            tipo_ausencia=tipo, 
            data_inicio=dt_inicio, 
            data_fim=dt_fim, 
            quantidade_dias=qtd_dias, 
            abono_pecuniario=vender_ferias, 
            dias_abono=dias_abono, 
            observacao=obs
        )
        db.session.add(nova_solicitacao); db.session.commit()
        
        # GATILHO NOTIFICA√á√ÉO MASTER
        master = User.query.filter_by(username='50097952800').first()
        if master:
            enviar_notificacao(master.id, f"{current_user.real_name} enviou uma solicita√ß√£o de {tipo}.", "/ponto/admin/ausencias")

        flash("Solicita√ß√£o validada e enviada com sucesso ao RH!", "success")
        return redirect(url_for('ponto.solicitar_ferias'))

    minhas_solicitacoes = SolicitacaoAusencia.query.filter_by(user_id=current_user.id).order_by(SolicitacaoAusencia.data_solicitacao.desc()).all()
    return render_template('ponto/solicitar_ferias.html', minhas_solicitacoes=minhas_solicitacoes, dias_direito=dias_direito, faltas=faltas, saldo=saldo, dias_usados=dias_usados)

@ponto_bp.route('/admin/ausencias', methods=['GET', 'POST'])
@login_required
def gestao_ausencias():
    if current_user.role != 'Master' and current_user.username != '50097952800': return redirect(url_for('main.dashboard'))

    if request.method == 'POST':
        solic_id = request.form.get('solicitacao_id')
        acao = request.form.get('acao')
        solicitacao = SolicitacaoAusencia.query.get_or_404(solic_id)
        
        if acao == 'aprovar':
            solicitacao.status = 'Aprovado'
            for i in range(solicitacao.quantidade_dias):
                dia_atual = solicitacao.data_inicio + timedelta(days=i)
                ponto = PontoResumo.query.filter_by(user_id=solicitacao.user_id, data_referencia=dia_atual).first()
                if ponto:
                    ponto.status_dia = solicitacao.tipo_ausencia
                    ponto.minutos_esperados = 0
                    ponto.minutos_saldo = ponto.minutos_trabalhados
                else:
                    novo_ponto = PontoResumo(user_id=solicitacao.user_id, data_referencia=dia_atual, minutos_trabalhados=0, minutos_esperados=0, minutos_saldo=0, status_dia=solicitacao.tipo_ausencia)
                    db.session.add(novo_ponto)
            
            # GATILHO NOTIFICA√á√ÉO COLABORADOR
            enviar_notificacao(solicitacao.user_id, f"A sua solicita√ß√£o de {solicitacao.tipo_ausencia} foi APROVADA.", "/ponto/solicitar-ferias")
            flash(f"Solicita√ß√£o aprovada. O ponto foi atualizado.", "success")
            
        elif acao == 'recusar':
            solicitacao.status = 'Recusado'
            # GATILHO NOTIFICA√á√ÉO COLABORADOR
            enviar_notificacao(solicitacao.user_id, f"A sua solicita√ß√£o de {solicitacao.tipo_ausencia} foi RECUSADA pelo RH.", "/ponto/solicitar-ferias")
            flash("Solicita√ß√£o recusada.", "success")
            
        elif acao == 'remover':
            if solicitacao.status == 'Aprovado':
                user = solicitacao.user
                for i in range(solicitacao.quantidade_dias):
                    dia_atual = solicitacao.data_inicio + timedelta(days=i)
                    ponto = PontoResumo.query.filter_by(user_id=solicitacao.user_id, data_referencia=dia_atual).first()
                    if ponto and ponto.status_dia == solicitacao.tipo_ausencia:
                        meta = user.carga_horaria or 528
                        if user.escala == '5x2' and dia_atual.weekday() >= 5: meta = 0
                        elif user.escala == '12x36' and user.data_inicio_escala:
                            if (dia_atual - user.data_inicio_escala).days % 2 != 0: meta = 0
                            else: meta = 720
                        ponto.status_dia = 'OK'
                        ponto.minutos_esperados = meta
                        ponto.minutos_saldo = ponto.minutos_trabalhados - meta
            solicitacao.status = 'Cancelado'
            enviar_notificacao(solicitacao.user_id, f"O seu per√≠odo de {solicitacao.tipo_ausencia} foi CANCELADO pela empresa.", "/ponto/solicitar-ferias")
            flash("F√©rias revogadas com sucesso. O espelho de ponto foi restaurado.", "success")
            
        db.session.commit()
        return redirect(url_for('ponto.gestao_ausencias'))

    alertas_vencimento = []
    hoje = get_brasil_time().date()
    usuarios_clt = User.query.filter(User.username != '12345678900', User.data_admissao.isnot(None)).all()
    
    for u in usuarios_clt:
        dias_trabalhados = (hoje - u.data_admissao).days
        anos_completos = dias_trabalhados // 365
        
        if anos_completos >= 1:
            ausencias = SolicitacaoAusencia.query.filter_by(user_id=u.id, tipo_ausencia='F√©rias', status='Aprovado').all()
            dias_usados = sum(a.quantidade_dias + a.dias_abono for a in ausencias)
            
            saldo_teorico = (anos_completos * 30) - dias_usados
            
            if saldo_teorico > 0:
                ciclos_pendentes = saldo_teorico / 30.0
                ciclo_critico = anos_completos - int(ciclos_pendentes) + 1
                anos_para_somar = ciclo_critico + 1
                
                try:
                    data_limite = u.data_admissao.replace(year=u.data_admissao.year + anos_para_somar)
                except ValueError:
                    data_limite = u.data_admissao + timedelta(days=365 * anos_para_somar)
                    
                dias_vencimento = (data_limite - hoje).days
                
                if dias_vencimento < 0:
                    alertas_vencimento.append({'user': u, 'status': 'Vencidas', 'dias': abs(dias_vencimento), 'msg': 'Prazo concessivo estourado. Risco alto de multa/dobro!'})
                elif dias_vencimento <= 90:
                    alertas_vencimento.append({'user': u, 'status': 'A Vencer', 'dias': dias_vencimento, 'msg': f'Vence em {dias_vencimento} dias (Data limite: {data_limite.strftime("%d/%m/%Y")}).'})

    todas_solicitacoes = SolicitacaoAusencia.query.order_by(SolicitacaoAusencia.data_solicitacao.desc()).all()
    return render_template('ponto/gestao_ausencias.html', solicitacoes=todas_solicitacoes, alertas=alertas_vencimento)

@ponto_bp.route('/admin/controle-escala', methods=['GET'])
@login_required
def controle_escala():
    if current_user.role != 'Master' and current_user.username != '50097952800': return redirect(url_for('main.dashboard'))
    data_str = request.args.get('data_ref')
    if data_str: data_ref = datetime.strptime(data_str, '%Y-%m-%d').date()
    else: data_ref = get_brasil_time().date()
    
    usuarios = User.query.filter(User.username != '12345678900').order_by(User.real_name).all()
    trabalhando, folga = [], []
    
    for u in usuarios:
        ausencia = SolicitacaoAusencia.query.filter(
            SolicitacaoAusencia.user_id == u.id, 
            SolicitacaoAusencia.status == 'Aprovado', 
            SolicitacaoAusencia.data_inicio <= data_ref, 
            SolicitacaoAusencia.data_fim >= data_ref
        ).first()
        
        escala_trabalho = True
        if u.escala == '5x2' and data_ref.weekday() >= 5: escala_trabalho = False
        elif u.escala == '12x36' and u.data_inicio_escala:
            if (data_ref - u.data_inicio_escala).days % 2 != 0: escala_trabalho = False
        
        pontos = PontoRegistro.query.filter_by(user_id=u.id, data_registro=data_ref).order_by(PontoRegistro.hora_registro).all()
        status_batida = f"{len(pontos)} marca√ß√µes" if pontos else "Sem marca√ß√£o"
        info = {'user': u, 'ausencia': ausencia, 'batidas': status_batida}
        
        if ausencia: info['motivo'] = ausencia.tipo_ausencia; folga.append(info)
        elif not escala_trabalho: info['motivo'] = 'Folga Escala'; folga.append(info)
        else: trabalhando.append(info)
            
    return render_template('ponto/controle_escala.html', trabalhando=trabalhando, folga=folga, data_ref=data_ref)




##################################################

FILE: app/ponto/templates/ponto/controle_escala.html
----------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div>
        <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
            <i class="fas fa-users-cog text-blue-600"></i> Controle de Escala
        </h2>
        <p class="text-sm text-slate-500 mt-1">Vis√£o operacional: Saiba quem deve estar no posto e quem est√° de folga.</p>
    </div>
    
    <div class="bg-white p-2 rounded-lg border border-slate-200 shadow-sm flex items-center gap-3">
        <label class="label-pro !mb-0 ml-2"><i class="fas fa-calendar-day mr-1"></i> Data Base:</label>
        <form action="{{ url_for('ponto.controle_escala') }}" method="GET" class="m-0 p-0">
            <input type="date" name="data_ref" value="{{ data_ref.strftime('%Y-%m-%d') }}" onchange="this.form.submit()" 
                   class="input-pro cursor-pointer" style="width: auto; padding-top: 0.5rem; padding-bottom: 0.5rem;">
        </form>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
    
    <div class="bg-white rounded-xl border border-blue-200 shadow-sm overflow-hidden flex flex-col h-full">
        <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
            <h3 class="font-bold flex items-center gap-2"><i class="fas fa-briefcase"></i> Escala de Trabalho</h3>
            <span class="bg-white text-blue-700 font-black text-xs px-2.5 py-1 rounded-full">{{ trabalhando|length }}</span>
        </div>
        
        <div class="p-4 space-y-3 max-h-[600px] overflow-y-auto bg-slate-50/50">
            {% for item in trabalhando %}
            <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between md:items-center gap-3 hover:border-blue-300 transition relative overflow-hidden">
                <div class="absolute left-0 top-0 bottom-0 w-1 {{ 'bg-amber-400' if 'Sem' in item.batidas else 'bg-emerald-500' }}"></div>
                
                <div class="pl-2">
                    <h4 class="font-bold text-slate-800 text-sm">{{ item.user.real_name }}</h4>
                    <p class="text-[10px] text-slate-400 font-bold uppercase mt-0.5"><i class="fas fa-id-badge mr-1"></i> {{ item.user.escala }} | {{ item.user.cargo or item.user.role }}</p>
                </div>
                
                <div>
                    {% if 'Sem' in item.batidas %}
                        <span class="inline-flex items-center gap-1.5 bg-amber-50 text-amber-700 border border-amber-200 px-2.5 py-1 rounded-md text-[10px] font-black uppercase">
                            <i class="fas fa-clock"></i> Pendente Batida
                        </span>
                    {% else %}
                        <span class="inline-flex items-center gap-1.5 bg-emerald-50 text-emerald-700 border border-emerald-200 px-2.5 py-1 rounded-md text-[10px] font-black uppercase">
                            <i class="fas fa-check-double"></i> {{ item.batidas }}
                        </span>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="text-center py-10 text-slate-400">
                <i class="fas fa-bed text-4xl mb-3 opacity-30 block"></i>
                <p class="text-sm">Nenhum funcion√°rio escalado para trabalhar nesta data.</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col h-full">
        <div class="bg-slate-700 p-4 text-white flex justify-between items-center">
            <h3 class="font-bold flex items-center gap-2"><i class="fas fa-bed"></i> Folgas e Aus√™ncias</h3>
            <span class="bg-slate-900 text-white font-black text-xs px-2.5 py-1 rounded-full">{{ folga|length }}</span>
        </div>
        
        <div class="p-4 space-y-3 max-h-[600px] overflow-y-auto bg-slate-50">
            {% for item in folga %}
            <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between md:items-center gap-3 opacity-80 hover:opacity-100 transition">
                
                <div>
                    <h4 class="font-bold text-slate-700 text-sm line-through decoration-slate-300">{{ item.user.real_name }}</h4>
                    <p class="text-[10px] text-slate-400 font-bold uppercase mt-0.5">{{ item.user.escala }}</p>
                </div>
                
                <div>
                    {% if item.motivo == 'Folga Escala' %}
                        <span class="inline-flex items-center gap-1.5 bg-slate-100 text-slate-600 border border-slate-200 px-2.5 py-1 rounded-md text-[10px] font-black uppercase shadow-sm">
                            <i class="fas fa-mug-hot"></i> Folga (Escala)
                        </span>
                    {% else %}
                        <span class="inline-flex items-center gap-1.5 bg-emerald-100 text-emerald-700 border border-emerald-200 px-2.5 py-1 rounded-md text-[10px] font-black uppercase shadow-sm" title="Aus√™ncia Programada">
                            <i class="fas fa-plane-departure"></i> {{ item.motivo }}
                        </span>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="text-center py-10 text-slate-400">
                <i class="fas fa-users text-4xl mb-3 opacity-30 block"></i>
                <p class="text-sm">Nenhum funcion√°rio de folga nesta data.</p>
            </div>
            {% endfor %}
        </div>
    </div>

</div>
{% endblock %}



##################################################

FILE: app/ponto/templates/ponto/gestao_ausencias.html
-----------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div>
        <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
            <i class="fas fa-umbrella-beach text-emerald-600"></i> Gest√£o de F√©rias e Aus√™ncias
        </h2>
        <p class="text-sm text-slate-500">Aprove, recuse ou revogue solicita√ß√µes de folgas programadas.</p>
    </div>
</div>

{% if alertas %}
<div class="mb-8 bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
    <h3 class="text-sm font-bold text-slate-800 mb-4 flex items-center gap-2 uppercase tracking-wide">
        <i class="fas fa-exclamation-circle text-amber-500 text-lg"></i> Aten√ß√£o: F√©rias Pr√≥ximas ao Limite Concessivo
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for alerta in alertas %}
        <div class="p-4 rounded-xl border flex flex-col gap-2 {{ 'bg-red-50 border-red-200' if alerta.status == 'Vencidas' else 'bg-amber-50 border-amber-200' }}">
            <div class="flex justify-between items-start">
                <span class="font-bold text-slate-800 text-sm">{{ alerta.user.real_name }}</span>
                <span class="text-[10px] font-black uppercase px-2 py-1 rounded {{ 'bg-red-200 text-red-700' if alerta.status == 'Vencidas' else 'bg-amber-200 text-amber-700' }}">{{ alerta.status }}</span>
            </div>
            <p class="text-xs font-medium {{ 'text-red-600' if alerta.status == 'Vencidas' else 'text-amber-700' }}">{{ alerta.msg }}</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-10">
    <div class="overflow-x-auto">
        <table class="w-full text-left text-sm text-slate-600">
            <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold border-b border-slate-100">
                <tr>
                    <th class="px-6 py-4">Data Pedido</th>
                    <th class="px-6 py-4">Funcion√°rio</th>
                    <th class="px-6 py-4">Tipo & Regras</th>
                    <th class="px-6 py-4">Per√≠odo de Descanso</th>
                    <th class="px-6 py-4">Dias</th>
                    <th class="px-6 py-4 text-center">Status</th>
                    <th class="px-6 py-4 text-right">A√ß√µes</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
                {% for solic in solicitacoes %}
                <tr class="hover:bg-slate-50 transition">
                    <td class="px-6 py-4 text-xs">{{ solic.data_solicitacao.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td class="px-6 py-4 font-bold text-slate-800">{{ solic.user.real_name }}</td>
                    <td class="px-6 py-4">
                        <span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-[10px] font-bold uppercase border border-slate-200 block w-max mb-1">
                            {{ solic.tipo_ausencia }}
                        </span>
                        {% if solic.abono_pecuniario %}
                            <span class="text-[9px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded border border-blue-200">
                                <i class="fas fa-comment-dollar"></i> Vende {{ solic.dias_abono }} dias
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-xs font-bold text-emerald-600">
                        {{ solic.data_inicio.strftime('%d/%m') }} a {{ solic.data_fim.strftime('%d/%m') }}
                    </td>
                    <td class="px-6 py-4 font-bold text-slate-700">
                        {{ solic.quantidade_dias }}
                    </td>
                    <td class="px-6 py-4 text-center">
                        {% if solic.status == 'Pendente' %}
                            <span class="bg-amber-100 text-amber-600 px-2 py-1 rounded text-[10px] font-bold uppercase"><i class="fas fa-clock"></i> Pendente</span>
                        {% elif solic.status == 'Aprovado' %}
                            <span class="bg-emerald-100 text-emerald-600 px-2 py-1 rounded text-[10px] font-bold uppercase"><i class="fas fa-check"></i> Aprovado</span>
                        {% elif solic.status == 'Cancelado' %}
                            <span class="bg-slate-200 text-slate-600 px-2 py-1 rounded text-[10px] font-bold uppercase"><i class="fas fa-ban"></i> Cancelado</span>
                        {% else %}
                            <span class="bg-red-100 text-red-600 px-2 py-1 rounded text-[10px] font-bold uppercase"><i class="fas fa-times"></i> Recusado</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-right flex items-center justify-end gap-2">
                        
                        {% if solic.observacao %}
                        <button onclick="alert('Observa√ß√£o do Funcion√°rio:\n\n{{ solic.observacao }}')" class="text-slate-400 hover:text-blue-500 p-2 rounded transition" title="Ler Observa√ß√£o">
                            <i class="fas fa-comment-dots text-lg"></i>
                        </button>
                        {% endif %}

                        {% if solic.status == 'Pendente' %}
                            <form action="{{ url_for('ponto.gestao_ausencias') }}" method="POST" class="inline" onsubmit="return confirm('Ao aprovar, o sistema preencher√° o espelho de ponto deste funcion√°rio automaticamente. Confirmar?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="solicitacao_id" value="{{ solic.id }}"/>
                                <input type="hidden" name="acao" value="aprovar"/>
                                <button type="submit" class="text-white bg-emerald-500 hover:bg-emerald-600 px-3 py-1.5 rounded transition text-xs font-bold" title="Aprovar">Aprovar</button>
                            </form>
                            
                            <form action="{{ url_for('ponto.gestao_ausencias') }}" method="POST" class="inline" onsubmit="return confirm('Deseja recusar este pedido?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="solicitacao_id" value="{{ solic.id }}"/>
                                <input type="hidden" name="acao" value="recusar"/>
                                <button type="submit" class="text-white bg-red-500 hover:bg-red-600 px-3 py-1.5 rounded transition text-xs font-bold" title="Recusar">Recusar</button>
                            </form>
                        
                        {% elif solic.status == 'Aprovado' %}
                            <form action="{{ url_for('ponto.gestao_ausencias') }}" method="POST" class="inline" onsubmit="return confirm('PERIGO: Isso vai CANCELAR as f√©rias aprovadas e restaurar os dias devidos no espelho de ponto do funcion√°rio. Continuar?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="solicitacao_id" value="{{ solic.id }}"/>
                                <input type="hidden" name="acao" value="remover"/>
                                <button type="submit" class="text-red-500 hover:text-red-700 bg-red-50 hover:bg-red-100 border border-red-200 px-3 py-1.5 rounded transition text-xs font-bold flex items-center gap-1" title="Revogar F√©rias">
                                    <i class="fas fa-trash-alt"></i> Revogar
                                </button>
                            </form>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="7" class="px-6 py-20 text-center text-slate-400 font-medium">Nenhum pedido de aus√™ncia encontrado.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}



##################################################

FILE: app/ponto/templates/ponto/meu_calendario.html
---------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
    <div>
        <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
            <i class="fas fa-calendar-alt text-emerald-600"></i> Meu Calend√°rio e Escala
        </h2>
        <p class="text-sm text-slate-500 mt-1">Veja seus dias de trabalho e solicite aus√™ncias programadas.</p>
    </div>
    <div class="flex gap-2">
        <a href="{{ url_for('ponto.meu_calendario', ano=ano if mes > 1 else ano-1, mes=mes-1 if mes > 1 else 12) }}" class="bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 font-bold py-2 px-4 rounded shadow-sm transition">
            <i class="fas fa-chevron-left"></i>
        </a>
        <div class="bg-white border border-slate-200 text-slate-800 font-bold py-2 px-6 rounded shadow-sm flex items-center justify-center min-w-[150px]">
            {{ '%02d' % mes }} / {{ ano }}
        </div>
        <a href="{{ url_for('ponto.meu_calendario', ano=ano if mes < 12 else ano+1, mes=mes+1 if mes < 12 else 1) }}" class="bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 font-bold py-2 px-4 rounded shadow-sm transition">
            <i class="fas fa-chevron-right"></i>
        </a>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <div class="lg:col-span-2 bg-white rounded-xl border border-slate-200 shadow-sm p-6">
        <h3 class="font-bold text-slate-800 mb-4 border-b pb-2 uppercase text-sm">Escala do M√™s</h3>
        
        <div class="flex flex-wrap gap-4 mb-6 text-xs font-bold text-slate-600">
            <div class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-blue-100 border border-blue-200 inline-block"></span> Trabalho</div>
            <div class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-slate-100 border border-slate-200 inline-block"></span> Folga</div>
            <div class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-emerald-100 border border-emerald-200 inline-block"></span> F√©rias/Licen√ßa</div>
        </div>

        <div class="grid grid-cols-7 gap-2 text-center mb-2">
            <div class="text-[10px] font-bold text-slate-400 uppercase">Seg</div>
            <div class="text-[10px] font-bold text-slate-400 uppercase">Ter</div>
            <div class="text-[10px] font-bold text-slate-400 uppercase">Qua</div>
            <div class="text-[10px] font-bold text-slate-400 uppercase">Qui</div>
            <div class="text-[10px] font-bold text-slate-400 uppercase">Sex</div>
            <div class="text-[10px] font-bold text-slate-400 uppercase">S√°b</div>
            <div class="text-[10px] font-bold text-slate-400 uppercase">Dom</div>
        </div>

        <div class="grid grid-cols-7 gap-2">
            {% if dias_mes %}
                {% for _ in range(dias_mes[0].dia_semana) %}
                    <div class="p-2 rounded bg-transparent"></div>
                {% endfor %}
            {% endif %}

            {% for d in dias_mes %}
                {% set is_today = (d.data == hoje) %}
                
                {% if d.tipo == 'Trabalho' %}
                    <div class="p-2 rounded border border-blue-200 bg-blue-50 text-blue-800 flex flex-col items-center justify-center relative {{ 'ring-2 ring-blue-500 font-black' if is_today else '' }}">
                        <span class="text-lg font-bold">{{ d.data.day }}</span>
                        <span class="text-[9px] uppercase font-bold mt-1 text-blue-500 opacity-80"><i class="fas fa-briefcase"></i></span>
                    </div>
                {% elif d.tipo == 'Folga' %}
                    <div class="p-2 rounded border border-slate-200 bg-slate-50 text-slate-400 flex flex-col items-center justify-center {{ 'ring-2 ring-slate-400 font-black text-slate-600' if is_today else '' }}">
                        <span class="text-lg font-bold">{{ d.data.day }}</span>
                        <span class="text-[9px] uppercase font-bold mt-1 opacity-50"><i class="fas fa-bed"></i></span>
                    </div>
                {% else %}
                    <div class="p-2 rounded border border-emerald-200 bg-emerald-50 text-emerald-800 flex flex-col items-center justify-center {{ 'ring-2 ring-emerald-500 font-black' if is_today else '' }}" title="{{ d.tipo }}">
                        <span class="text-lg font-bold">{{ d.data.day }}</span>
                        <span class="text-[8px] uppercase font-bold mt-1 text-emerald-600 truncate w-full text-center">{{ d.tipo[:6] }}..</span>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <div class="flex flex-col gap-6">
        
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
            <div class="bg-emerald-600 p-4 text-white">
                <h3 class="font-bold flex items-center gap-2"><i class="fas fa-plane-departure"></i> Solicitar Aus√™ncia</h3>
                <p class="text-xs text-emerald-100 mt-1">F√©rias, Licen√ßas ou Folga Pr√™mio</p>
            </div>
            <div class="p-5">
                <form method="POST" action="{{ url_for('ponto.meu_calendario', ano=ano, mes=mes) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    
                    <div class="mb-3">
                        <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">Tipo de Aus√™ncia</label>
                        <select name="tipo_ausencia" required class="w-full bg-slate-50 border border-slate-200 rounded px-3 py-2 text-sm font-bold text-slate-700 outline-none focus:border-emerald-500 transition">
                            <option value="F√©rias">F√©rias</option>
                            <option value="Folga Pr√™mio">Folga Pr√™mio</option>
                            <option value="Licen√ßa Maternidade/Paternidade">Licen√ßa Maternidade/Paternidade</option>
                            <option value="Licen√ßa Casamento/√ìbito">Licen√ßa Casamento/√ìbito</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">Data In√≠cio</label>
                            <input type="date" name="data_inicio" required class="w-full bg-slate-50 border border-slate-200 rounded px-2 py-2 text-xs font-bold text-slate-700 outline-none focus:border-emerald-500 transition">
                        </div>
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">Data Fim</label>
                            <input type="date" name="data_fim" required class="w-full bg-slate-50 border border-slate-200 rounded px-2 py-2 text-xs font-bold text-slate-700 outline-none focus:border-emerald-500 transition">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">Observa√ß√µes (Opcional)</label>
                        <textarea name="observacao" rows="2" class="w-full bg-slate-50 border border-slate-200 rounded px-3 py-2 text-xs text-slate-700 outline-none focus:border-emerald-500 transition" placeholder="Detalhes adicionais..."></textarea>
                    </div>

                    <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2.5 rounded shadow transition text-sm flex items-center justify-center gap-2">
                        <i class="fas fa-paper-plane"></i> ENVIAR SOLICITA√á√ÉO
                    </button>
                </form>
            </div>
        </div>

        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
            <h3 class="font-bold text-slate-800 mb-3 border-b pb-2 text-sm">Minhas Solicita√ß√µes</h3>
            <div class="space-y-3 max-h-[250px] overflow-y-auto pr-2">
                {% for sol in minhas_solicitacoes %}
                <div class="p-3 border border-slate-100 rounded bg-slate-50 flex flex-col gap-1">
                    <div class="flex justify-between items-start">
                        <span class="font-bold text-xs text-slate-800">{{ sol.tipo_ausencia }}</span>
                        {% if sol.status == 'Pendente' %}
                            <span class="text-[9px] bg-amber-100 text-amber-600 px-2 py-0.5 rounded font-bold uppercase">Pendente</span>
                        {% elif sol.status == 'Aprovado' %}
                            <span class="text-[9px] bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded font-bold uppercase">Aprovado</span>
                        {% else %}
                            <span class="text-[9px] bg-red-100 text-red-600 px-2 py-0.5 rounded font-bold uppercase">Recusado</span>
                        {% endif %}
                    </div>
                    <div class="text-[10px] text-slate-500 font-medium">
                        De {{ sol.data_inicio.strftime('%d/%m') }} a {{ sol.data_fim.strftime('%d/%m') }} ({{ sol.quantidade_dias }} dias)
                    </div>
                </div>
                {% else %}
                <div class="text-center py-4 text-xs text-slate-400">Nenhuma solicita√ß√£o recente.</div>
                {% endfor %}
            </div>
        </div>

    </div>
</div>
{% endblock %}



##################################################

FILE: app/ponto/templates/ponto/minha_escala.html
-------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
    <div>
        <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
            <i class="fas fa-calendar-alt text-emerald-600"></i> Minha Escala
        </h2>
        <p class="text-sm text-slate-500 mt-1">Acompanhe os seus dias de trabalho e folga do m√™s.</p>
    </div>
    <div class="flex gap-2">
        <a href="{{ url_for('ponto.minha_escala', ano=ano if mes > 1 else ano-1, mes=mes-1 if mes > 1 else 12) }}" class="bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 font-bold py-2 px-4 rounded shadow-sm transition">
            <i class="fas fa-chevron-left"></i>
        </a>
        <div class="bg-white border border-slate-200 text-slate-800 font-bold py-2 px-8 rounded shadow-sm flex items-center justify-center min-w-[160px] text-lg uppercase tracking-wider">
            {{ '%02d' % mes }} / {{ ano }}
        </div>
        <a href="{{ url_for('ponto.minha_escala', ano=ano if mes < 12 else ano+1, mes=mes+1 if mes < 12 else 1) }}" class="bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 font-bold py-2 px-4 rounded shadow-sm transition">
            <i class="fas fa-chevron-right"></i>
        </a>
    </div>
</div>

<div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 lg:p-10">
    <div class="flex flex-wrap justify-center md:justify-start gap-6 mb-8 text-sm font-bold text-slate-600 border-b pb-4">
        <div class="flex items-center gap-2"><span class="w-4 h-4 rounded bg-blue-100 border border-blue-300 inline-block shadow-sm"></span> Plant√£o / Trabalho</div>
        <div class="flex items-center gap-2"><span class="w-4 h-4 rounded bg-slate-100 border border-slate-300 inline-block shadow-sm"></span> Folga</div>
        <div class="flex items-center gap-2"><span class="w-4 h-4 rounded bg-emerald-100 border border-emerald-300 inline-block shadow-sm"></span> F√©rias / Licen√ßa</div>
    </div>

    <div class="grid grid-cols-7 gap-2 text-center mb-3">
        <div class="text-xs font-black text-red-400 uppercase tracking-widest">Dom</div>
        <div class="text-xs font-black text-slate-400 uppercase tracking-widest">Seg</div>
        <div class="text-xs font-black text-slate-400 uppercase tracking-widest">Ter</div>
        <div class="text-xs font-black text-slate-400 uppercase tracking-widest">Qua</div>
        <div class="text-xs font-black text-slate-400 uppercase tracking-widest">Qui</div>
        <div class="text-xs font-black text-slate-400 uppercase tracking-widest">Sex</div>
        <div class="text-xs font-black text-slate-400 uppercase tracking-widest">S√°b</div>
    </div>

    <div class="grid grid-cols-7 gap-2 md:gap-4 auto-rows-fr">
        {% if dias_mes %}
            {% for _ in range(dias_mes[0].dia_semana) %}
                <div class="min-h-[80px] md:min-h-[100px] rounded bg-slate-50/50 border border-slate-100 border-dashed"></div>
            {% endfor %}
        {% endif %}

        {% for d in dias_mes %}
            {% set is_today = (d.data == hoje) %}
            
            {% if d.tipo == 'Trabalho' %}
                <div class="min-h-[80px] md:min-h-[100px] p-2 rounded-lg border border-blue-200 bg-blue-50 text-blue-900 flex flex-col items-center justify-center relative shadow-sm hover:shadow transition {{ 'ring-4 ring-blue-500 scale-105 z-10' if is_today else '' }}">
                    <span class="text-2xl md:text-3xl font-black">{{ d.data.day }}</span>
                    <span class="text-[10px] md:text-xs uppercase font-bold mt-2 text-blue-600 bg-blue-100 px-2 py-1 rounded w-full text-center">Trabalho</span>
                </div>
            {% elif d.tipo == 'Folga' %}
                <div class="min-h-[80px] md:min-h-[100px] p-2 rounded-lg border border-slate-200 bg-slate-50 text-slate-500 flex flex-col items-center justify-center relative shadow-sm hover:shadow transition {{ 'ring-4 ring-slate-400 scale-105 z-10' if is_today else '' }}">
                    <span class="text-2xl md:text-3xl font-black opacity-80">{{ d.data.day }}</span>
                    <span class="text-[10px] md:text-xs uppercase font-bold mt-2 text-slate-500 bg-slate-200 px-2 py-1 rounded w-full text-center">Folga</span>
                </div>
            {% else %}
                <div class="min-h-[80px] md:min-h-[100px] p-2 rounded-lg border border-emerald-200 bg-emerald-50 text-emerald-900 flex flex-col items-center justify-center relative shadow-sm hover:shadow transition {{ 'ring-4 ring-emerald-500 scale-105 z-10' if is_today else '' }}" title="{{ d.tipo }}">
                    <span class="text-2xl md:text-3xl font-black">{{ d.data.day }}</span>
                    <span class="text-[9px] md:text-xs uppercase font-bold mt-2 text-emerald-700 bg-emerald-200 px-1 py-1 rounded truncate w-full text-center">{{ d.tipo }}</span>
                </div>
            {% endif %}
        {% endfor %}
    </div>
</div>
{% endblock %}



##################################################

FILE: app/ponto/templates/ponto/ponto_espelho.html
--------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div>
        <h2 class="text-2xl font-bold text-slate-800">Espelho de Ponto</h2>
        <p class="text-sm text-slate-500">Colaborador: <span class="font-bold text-slate-700">{{ user.real_name }}</span></p>
    </div>
    
    <!-- RESUMO DA REGRA -->
    <div class="bg-blue-50 px-4 py-2 rounded-lg border border-blue-100 text-right">
        <span class="text-[10px] font-bold text-blue-400 uppercase tracking-widest block">Meta Di√°ria</span>
        <div class="font-mono font-bold text-blue-800 text-lg">
            {{ format_hm(user.carga_horaria or 528).replace('-','') }} 
            <span class="text-xs text-blue-600 font-sans font-normal">+ {{ user.tempo_intervalo }}min Almo√ßo</span>
        </div>
        <div class="text-[10px] text-slate-400 mt-1">Per√≠odo: {{ mes_ref }}</div>
    </div>
</div>

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-left text-sm">
            <thead class="bg-slate-50 text-slate-400 font-bold text-xs uppercase border-b border-slate-100">
                <tr>
                    <th class="px-4 py-4">Data</th>
                    <th class="px-4 py-4">Registros (Entradas / Sa√≠das)</th>
                    <th class="px-4 py-4 text-center">Trabalhado</th>
                    <th class="px-4 py-4 text-center">Saldo</th>
                    <th class="px-4 py-4 text-right">Status</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
                {% for r in resumos %}
                <tr class="hover:bg-slate-50 transition cursor-help group" onclick="toggleDetails('det-{{ r.id }}')">
                    <td class="px-4 py-4 font-medium text-slate-700">
                        {{ r.data_referencia.strftime('%d/%m') }} 
                        <span class="text-slate-400 text-xs uppercase ml-1">
                            ({{ dias_semana[r.data_referencia.weekday()] }})
                        </span>
                    </td>
                    <td class="px-4 py-4">
                        <div class="flex flex-wrap gap-2">
                            {% for b in detalhes[r.id] %}
                            <span class="bg-white text-slate-700 px-2 py-1 rounded-md text-xs font-mono font-bold border border-slate-200 shadow-sm group-hover:border-blue-300 transition">
                                {{ b }}
                            </span>
                            {% endfor %}
                        </div>
                    </td>
                    <td class="px-4 py-4 text-center font-mono text-slate-600">
                        {{ format_hm(r.minutos_trabalhados).replace('-','') }}
                    </td>
                    <td class="px-4 py-4 text-center font-mono font-bold {% if r.minutos_saldo >= 0 %} text-emerald-600 {% else %} text-red-500 {% endif %}">
                        {{ format_hm(r.minutos_saldo) }}
                    </td>
                    <td class="px-4 py-4 text-right">
                        <span class="text-[10px] font-bold uppercase px-2 py-1 rounded-full 
                            {% if r.status_dia == 'OK' %} bg-emerald-50 text-emerald-600 
                            {% elif r.status_dia == 'Incompleto' %} bg-amber-50 text-amber-600 
                            {% elif r.status_dia == 'Falta' %} bg-red-50 text-red-600 
                            {% elif 'Extra' in r.status_dia %} bg-blue-50 text-blue-600 
                            {% else %} bg-slate-100 text-slate-500 {% endif %}">
                            {{ r.status_dia }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<div class="mt-4 text-center text-xs text-slate-400">
    <i class="fas fa-info-circle mr-1"></i> O saldo √© calculado subtraindo sua meta di√°ria do total trabalhado.
</div>
{% endblock %}




##################################################

FILE: app/ponto/templates/ponto/registro.html
---------------------------------------------
{% extends 'base.html' %}
{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<div class="max-w-md mx-auto text-center">
    
    <div class="mb-4">
        <h2 class="text-2xl font-bold text-slate-800">Meu Ponto</h2>
        <p class="text-sm text-slate-500">Aproxime este c√≥digo do Terminal na portaria.</p>
    </div>

    {% if bloqueado %}
    <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-r-xl shadow-md text-left mb-8">
        <h3 class="text-lg font-bold text-red-700 flex items-center gap-2"><i class="fas fa-ban"></i> A√á√ÉO BLOQUEADA</h3>
        <p class="text-sm text-red-600 mt-2">{{ motivo }}</p>
    </div>
    {% else %}
    
    <div class="bg-white rounded-3xl shadow-xl border border-slate-200 p-8 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-purple-600"></div>

        <div class="mb-4">
            <h3 class="text-xl font-bold text-slate-800">{{ current_user.real_name }}</h3>
            <p class="text-xs text-slate-400 font-mono uppercase">{{ current_user.role }}</p>
        </div>

        <div class="flex justify-center mb-6">
            <div id="qrcode" class="p-2 border-4 border-slate-900 rounded-xl bg-white"></div>
        </div>

        <div class="w-full bg-slate-100 rounded-full h-2.5 mb-2">
            <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-1000 ease-linear" style="width: 100%"></div>
        </div>
        <p class="text-xs text-slate-400 font-mono" id="statusToken">Atualizando em <span id="countdown">30</span>s...</p>

        <div class="mt-6 pt-6 border-t border-slate-100 flex justify-between items-center">
            <div class="text-left">
                <span class="block text-[10px] font-bold text-slate-400 uppercase">Pr√≥ximo Ponto</span>
                <span class="text-sm font-bold text-blue-600">{{ proxima_acao }}</span>
            </div>
            <div class="text-right">
                <span class="block text-[10px] font-bold text-slate-400 uppercase">Hoje</span>
                <span class="text-sm font-mono text-slate-600">{{ hoje.strftime('%d/%m') }}</span>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="mt-8 text-left">
        <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 ml-1">Batidas de Hoje</h3>
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden divide-y divide-slate-100">
            {% for p in pontos %}
            <div class="px-4 py-3 flex justify-between items-center">
                <span class="text-sm font-bold text-slate-700 flex items-center gap-2">
                    <i class="fas fa-circle text-[6px] {% if 'Entrada' in p.tipo %}text-emerald-500{% else %}text-amber-500{% endif %}"></i>
                    {{ p.tipo }}
                </span>
                <span class="text-sm font-mono text-slate-500 font-bold bg-slate-50 px-2 py-1 rounded">{{ p.hora_registro.strftime('%H:%M') }}</span>
            </div>
            {% else %}
            <div class="p-6 text-center text-xs text-slate-400">Ainda n√£o iniciou a jornada.</div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    let timerInterval;
    const TIME_LIMIT = 30; 
    let timeLeft = TIME_LIMIT;

    function generateQRCode() {
        fetch('/ponto/api/gerar-token')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('qrcode').innerHTML = `<p class="text-red-500 text-xs">${data.error}</p>`;
                    return;
                }
                const container = document.getElementById("qrcode");
                container.innerHTML = "";
                // AUMENTADO PARA 260px (Mais facil de ler)
                new QRCode(container, {
                    text: data.token,
                    width: 260,
                    height: 260,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.L // Low correction = menos pixels = mais facil ler
                });
                resetTimer();
            })
            .catch(err => { console.error("Erro:", err); });
    }

    function resetTimer() {
        timeLeft = TIME_LIMIT;
        clearInterval(timerInterval);
        const bar = document.getElementById("progressBar");
        const text = document.getElementById("countdown");

        timerInterval = setInterval(() => {
            timeLeft--;
            text.innerText = timeLeft;
            const pct = (timeLeft / TIME_LIMIT) * 100;
            bar.style.width = pct + "%";
            if (timeLeft <= 0) generateQRCode();
        }, 1000);
    }
    
    // Polling: Verifica se o ponto foi batido a cada 2 segundos
    setInterval(() => {
        {% if not bloqueado %}
        fetch('/ponto/api/check-status')
            .then(r => r.json())
            .then(data => {
                if (data.marcado) {
                    // Feedback Visual e Redirect
                    document.body.innerHTML = `
                        <div class="flex h-screen items-center justify-center bg-emerald-600 text-white flex-col">
                            <i class="fas fa-check-circle text-6xl mb-4 animate-bounce"></i>
                            <h1 class="text-3xl font-bold">PONTO REGISTRADO!</h1>
                            <p class="text-lg mt-2">${data.tipo} √†s ${data.hora}</p>
                            <p class="text-sm mt-4 opacity-80">Redirecionando...</p>
                        </div>
                    `;
                    setTimeout(() => { window.location.href = '/'; }, 3000);
                }
            });
        {% endif %}
    }, 2000);

    document.addEventListener("DOMContentLoaded", () => {
        {% if not bloqueado %} generateQRCode(); {% endif %}
    });
</script>
{% endblock %}



##################################################

FILE: app/ponto/templates/ponto/solicitar_ajuste.html
-----------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="mb-6"><h2 class="text-xl font-bold text-slate-800">Solicitar Ajuste</h2><p class="text-sm text-slate-500">Gest√£o de ponto.</p></div>

    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 mb-6">
        <form action="/ponto/solicitar-ajuste" method="POST" class="flex gap-4 items-end">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <div class="flex-1">
                <label class="label-pro">Data do Ponto</label>
                <input type="date" name="data_busca" class="input-pro" required>
            </div>
            <button type="submit" name="acao" value="buscar" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow hover:bg-blue-700 transition"><i class="fas fa-search"></i></button>
        </form>
    </div>

    {% if data_sel %}
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 mb-8 animate-fade-in">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="font-bold text-slate-800">Registros em {{ data_sel.strftime('%d/%m/%Y') }}</h3>
            <button onclick="abrirInclusao()" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1 rounded font-bold transition"><i class="fas fa-plus mr-1"></i> ADICIONAR NOVO</button>
        </div>
        <div class="space-y-2 mb-6">
            {% for p in pontos %}
            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                <div><span class="text-xs font-bold text-slate-500 block">{{ p.tipo }}</span><span class="font-mono font-bold text-slate-800">{{ p.hora_registro.strftime('%H:%M') }}</span></div>
                <div class="flex gap-2">
                    <button onclick="abrirEdicao('{{ p.id }}', '{{ p.hora_registro.strftime('%H:%M') }}', '{{ p.tipo }}')" class="text-[10px] bg-blue-50 text-blue-600 font-bold px-2 py-1 rounded hover:bg-blue-100">EDITAR</button>
                    <button onclick="abrirExclusao('{{ p.id }}', '{{ p.hora_registro.strftime('%H:%M') }}')" class="text-[10px] bg-red-50 text-red-600 font-bold px-2 py-1 rounded hover:bg-red-100">EXCLUIR</button>
                </div>
            </div>
            {% else %}<p class="text-xs text-slate-400 italic">Sem registros neste dia.</p>{% endfor %}
        </div>

        <div id="formContainer" class="hidden bg-slate-50 p-4 rounded-xl border border-blue-200 shadow-inner">
            <h3 class="font-bold text-blue-700 mb-4 text-sm uppercase" id="formTitle">Detalhes</h3>
            <form action="/ponto/solicitar-ajuste" method="POST" class="space-y-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                
                <input type="hidden" name="acao" value="enviar">
                <input type="hidden" name="data_ref" value="{{ data_sel }}">
                <input type="hidden" name="ponto_id" id="form_ponto_id"> 
                <input type="hidden" name="tipo_solicitacao" id="form_tipo_solic"> 
                
                <div class="grid grid-cols-2 gap-4" id="divHorarioTipo">
                    <div>
                        <label class="label-pro">Hor√°rio</label>
                        <input type="time" name="novo_horario" id="form_horario" class="input-pro font-mono">
                    </div>
                    <div>
                        <label class="label-pro">Tipo</label>
                        <select name="tipo_batida" id="form_tipo" class="input-pro">
                            <option value="Entrada">Entrada</option>
                            <option value="Ida Almo√ßo">Ida Almo√ßo</option>
                            <option value="Volta Almo√ßo">Volta Almo√ßo</option>
                            <option value="Sa√≠da">Sa√≠da</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="label-pro">Justificativa</label>
                    <textarea name="justificativa" class="input-pro" rows="2" required></textarea>
                </div>
                <div class="flex gap-2">
                    <button type="button" onclick="fecharForm()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-3 rounded-lg text-xs transition">CANCELAR</button>
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow text-xs transition">ENVIAR</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="mt-8">
        <h3 class="font-bold text-slate-700 text-sm mb-4 border-b pb-2">Meus Pedidos Recentes</h3>
        <div class="space-y-3">
            {% for req in meus_ajustes %}
            <div class="bg-white border border-slate-200 rounded-lg p-4 shadow-sm relative pl-4 border-l-4 {% if req.status == 'Aprovado' %} border-l-emerald-500 {% elif req.status == 'Reprovado' %} border-l-red-500 {% else %} border-l-yellow-500 {% endif %}">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-[10px] font-bold uppercase text-slate-400">{{ req.data_referencia.strftime('%d/%m') }} - {{ req.tipo_solicitacao }}</span>
                    <span class="text-[10px] font-bold uppercase px-2 py-0.5 rounded {% if req.status == 'Pendente' %} bg-yellow-100 text-yellow-700 {% elif req.status == 'Aprovado' %} bg-emerald-100 text-emerald-700 {% else %} bg-red-100 text-red-700 {% endif %}">{{ req.status }}</span>
                </div>
                
                <div class="grid grid-cols-2 gap-2 text-xs mb-2 bg-slate-50 p-2 rounded">
                    <div><span class="block text-slate-400">Hor√°rio Antigo</span><strong class="font-mono text-slate-600">{{ extras.get(req.id, '-') }}</strong></div>
                    <div><span class="block text-slate-400">Hor√°rio Novo</span><strong class="font-mono text-blue-600">{% if req.novo_horario %}{{ req.novo_horario }} ({{ req.tipo_batida }}){% else %} - {% endif %}</strong></div>
                </div>

                <div class="text-xs text-slate-500 italic mb-2">Justificativa: "{{ req.justificativa }}"</div>
                {% if req.status == 'Reprovado' %}<div class="bg-red-50 p-2 rounded border border-red-100 text-xs text-red-700"><strong>Devolutiva:</strong> {{ req.motivo_reprovacao }}</div>{% endif %}
            </div>
            {% else %}<p class="text-center text-xs text-slate-400 py-4">Nenhum pedido recente.</p>{% endfor %}
        </div>
    </div>
</div>
<script>
    function abrirInclusao() { resetForm(); document.getElementById('formTitle').innerText = "INCLUIR"; document.getElementById('form_tipo_solic').value = "Inclusao"; document.getElementById('formContainer').classList.remove('hidden'); }
    function abrirEdicao(id, hora, tipo) { resetForm(); document.getElementById('formTitle').innerText = "EDITAR"; document.getElementById('form_ponto_id').value = id; document.getElementById('form_horario').value = hora; document.getElementById('form_tipo').value = tipo; document.getElementById('form_tipo_solic').value = "Edicao"; document.getElementById('formContainer').classList.remove('hidden'); }
    function abrirExclusao(id, hora) { resetForm(); document.getElementById('formTitle').innerText = "EXCLUIR"; document.getElementById('form_ponto_id').value = id; document.getElementById('form_tipo_solic').value = "Exclusao"; document.getElementById('divHorarioTipo').classList.add('hidden'); document.getElementById('formContainer').classList.remove('hidden'); }
    function resetForm() { document.getElementById('form_ponto_id').value = ""; document.getElementById('form_horario').value = ""; document.getElementById('divHorarioTipo').classList.remove('hidden'); }
    function fecharForm() { document.getElementById('formContainer').classList.add('hidden'); }
</script>
{% endblock %}



##################################################

FILE: app/ponto/templates/ponto/solicitar_ferias.html
-----------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
        <i class="fas fa-plane-departure text-emerald-600"></i> F√©rias e Licen√ßas
    </h2>
    <p class="text-sm text-slate-500 mt-1">Gerencie seu saldo de f√©rias e envie solicita√ß√µes ao RH.</p>
</div>

{% if current_user.data_admissao %}
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4 flex flex-col items-center justify-center text-center">
        <span class="text-[10px] uppercase font-bold text-slate-400 mb-1">Dias de Direito</span>
        <span class="text-2xl font-black text-blue-600">{{ dias_direito }}</span>
    </div>
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4 flex flex-col items-center justify-center text-center relative overflow-hidden">
        {% if faltas > 5 %}<div class="absolute top-0 left-0 w-full h-1 bg-red-500"></div>{% endif %}
        <span class="text-[10px] uppercase font-bold text-slate-400 mb-1">Faltas no Ano</span>
        <span class="text-2xl font-black {{ 'text-red-500' if faltas > 5 else 'text-slate-700' }}">{{ faltas }}</span>
    </div>
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4 flex flex-col items-center justify-center text-center">
        <span class="text-[10px] uppercase font-bold text-slate-400 mb-1">Dias Usados</span>
        <span class="text-2xl font-black text-amber-500">{{ dias_usados }}</span>
    </div>
    <div class="bg-emerald-50 rounded-xl border border-emerald-200 shadow-sm p-4 flex flex-col items-center justify-center text-center">
        <span class="text-[10px] uppercase font-black text-emerald-700 mb-1">Saldo Dispon√≠vel</span>
        <span class="text-3xl font-black text-emerald-600">{{ saldo }}</span>
    </div>
</div>
{% else %}
<div class="bg-amber-50 border border-amber-200 text-amber-800 p-4 rounded-xl mb-8 text-sm font-medium flex items-center gap-3 shadow-sm">
    <i class="fas fa-exclamation-triangle text-2xl text-amber-500"></i>
    Sua data de admiss√£o n√£o est√° configurada. O c√°lculo autom√°tico de f√©rias est√° desativado. Contate o RH.
</div>
{% endif %}

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
    
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="bg-emerald-600 p-5 text-white">
            <h3 class="font-bold text-lg"><i class="fas fa-edit mr-2"></i> Nova Solicita√ß√£o</h3>
        </div>
        <div class="p-6">
            <form method="POST" action="{{ url_for('ponto.solicitar_ferias') }}" id="formFerias">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                
                <div class="mb-4">
                    <label class="label-pro">Motivo / Tipo de Aus√™ncia</label>
                    <select name="tipo_ausencia" id="tipo_ausencia" onchange="toggleAbono()" required class="input-pro cursor-pointer">
                        <option value="F√©rias">F√©rias Anuais</option>
                        <option value="Folga Pr√™mio">Folga Pr√™mio</option>
                        <option value="Licen√ßa Maternidade/Paternidade">Licen√ßa Maternidade/Paternidade</option>
                        <option value="Licen√ßa Casamento/√ìbito">Licen√ßa (Casamento/√ìbito)</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="label-pro">Data In√≠cio</label>
                        <input type="date" name="data_inicio" required class="input-pro">
                    </div>
                    <div>
                        <label class="label-pro">Data Fim</label>
                        <input type="date" name="data_fim" required class="input-pro">
                    </div>
                </div>

                <div id="divAbono" class="mb-5 bg-blue-50 border border-blue-100 p-4 rounded-lg">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" name="vender_ferias" value="sim" class="w-5 h-5 text-blue-600 rounded">
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-blue-800">Abono Pecuni√°rio (Vender F√©rias)</span>
                            <span class="text-[10px] text-blue-600 font-medium">Desejo vender 1/3 das minhas f√©rias (M√°ximo permitido por lei).</span>
                        </div>
                    </label>
                </div>

                <div class="mb-6">
                    <label class="label-pro">Observa√ß√µes ao RH (Opcional)</label>
                    <textarea name="observacao" rows="2" class="input-pro" placeholder="Digite detalhes se necess√°rio..."></textarea>
                </div>

                <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3.5 rounded-lg shadow-lg transition flex items-center justify-center gap-2">
                    <i class="fas fa-paper-plane"></i> ENVIAR SOLICITA√á√ÉO
                </button>
            </form>
        </div>
    </div>

    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
        <h3 class="font-bold text-slate-800 text-lg mb-4 border-b pb-3"><i class="fas fa-history text-slate-400 mr-2"></i> Meu Hist√≥rico</h3>
        <div class="space-y-4 max-h-[500px] overflow-y-auto pr-2">
            {% for sol in minhas_solicitacoes %}
            <div class="p-4 border border-slate-100 rounded-lg bg-slate-50 flex flex-col gap-2 hover:bg-slate-100 transition">
                <div class="flex justify-between items-start">
                    <span class="font-bold text-sm text-slate-800">
                        {{ sol.tipo_ausencia }}
                        {% if sol.abono_pecuniario %}
                            <span class="ml-2 text-[9px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-black uppercase"><i class="fas fa-dollar-sign"></i> Abono (+{{ sol.dias_abono }}d)</span>
                        {% endif %}
                    </span>
                    
                    {% if sol.status == 'Pendente' %}
                        <span class="text-[10px] bg-amber-100 text-amber-600 px-2.5 py-1 rounded font-black uppercase tracking-wide">Pendente</span>
                    {% elif sol.status == 'Aprovado' %}
                        <span class="text-[10px] bg-emerald-100 text-emerald-600 px-2.5 py-1 rounded font-black uppercase tracking-wide">Aprovado</span>
                    {% elif sol.status == 'Cancelado' %}
                        <span class="text-[10px] bg-slate-200 text-slate-600 px-2.5 py-1 rounded font-black uppercase tracking-wide">Cancelado</span>
                    {% else %}
                        <span class="text-[10px] bg-red-100 text-red-600 px-2.5 py-1 rounded font-black uppercase tracking-wide">Recusado</span>
                    {% endif %}
                </div>
                <div class="text-xs text-slate-500 font-medium">
                    <i class="far fa-calendar-alt mr-1"></i> {{ sol.data_inicio.strftime('%d/%m/%Y') }} at√© {{ sol.data_fim.strftime('%d/%m/%Y') }} 
                    <span class="ml-2 font-bold text-blue-600">({{ sol.quantidade_dias }} dias descanso)</span>
                </div>
            </div>
            {% else %}
            <div class="text-center py-12 text-sm text-slate-400">
                <i class="fas fa-box-open text-4xl mb-3 opacity-20 block"></i>
                Voc√™ n√£o tem solicita√ß√µes de f√©rias recentes.
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    function toggleAbono() {
        const tipo = document.getElementById('tipo_ausencia').value;
        const divAbono = document.getElementById('divAbono');
        if(tipo === 'F√©rias') {
            divAbono.style.display = 'block';
        } else {
            divAbono.style.display = 'none';
        }
    }
    // Executa ao carregar a p√°gina
    document.addEventListener("DOMContentLoaded", toggleAbono);
</script>
{% endblock %}



##################################################

FILE: app/ponto/templates/ponto/terminal_leitura.html
-----------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
    .terminal-mode { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
    #reader { width: 100%; max-width: 600px; border-radius: 20px; overflow: hidden; border: 4px solid #3b82f6; background: black; }
    
    /* MODAL OVERLAY */
    #successModal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9);
        display: flex; align-items: center; justify-content: center;
        z-index: 10000;
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    #successModal.active { opacity: 1; pointer-events: all; }
    
    .modal-content {
        background: #064e3b; /* Emerald 900 */
        padding: 40px; border-radius: 20px; text-align: center;
        border: 2px solid #10b981;
        box-shadow: 0 0 50px rgba(16, 185, 129, 0.5);
        max-width: 90%;
    }
    .modal-content h2 { font-size: 2rem; font-weight: bold; color: white; margin-bottom: 10px; }
    .modal-content p { font-size: 1.5rem; color: #a7f3d0; margin-bottom: 30px; }
    .btn-next {
        background: white; color: #064e3b; font-size: 1.2rem; font-weight: bold;
        padding: 15px 40px; border-radius: 50px; border: none; cursor: pointer;
        display: inline-flex; align-items: center; gap: 10px;
    }
</style>

<div class="terminal-mode">
    <div class="mb-4 text-center"><h1 class="text-3xl font-bold tracking-widest text-blue-400">SHAHIN GEST√ÉO</h1><p class="text-sm text-slate-400">TERMINAL DE PONTO</p></div>
    <div id="reader"></div>
    <div class="mt-4"><a href="/logout" class="text-xs text-slate-600 hover:text-slate-400">Sair do Modo Terminal</a></div>
</div>

<!-- Modal de Sucesso -->
<div id="successModal">
    <div class="modal-content">
        <i class="fas fa-check-circle text-6xl text-emerald-400 mb-4"></i>
        <h2 id="modalTitle">REGISTRADO!</h2>
        <p id="modalMsg">Fulano de Tal<br>14:30</p>
        <button class="btn-next" onclick="resetScanner()">
            <i class="fas fa-redo"></i> PR√ìXIMO
        </button>
    </div>
</div>

<script>
    const html5QrCode = new Html5Qrcode("reader");
    let isScanning = true;
    
    // Configura√ß√£o para QR Code denso
    const config = { fps: 10, qrbox: { width: 300, height: 300 } };
    
    html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure);

    function onScanSuccess(decodedText, decodedResult) {
        if (!isScanning) return;
        isScanning = false;
        
        // Som de Beep
        try { new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play(); } catch(e){}

        fetch('/ponto/api/registrar-leitura', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({ token: decodedText }) 
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showModal(data.funcionario, data.hora, data.tipo);
            } else {
                alert("ERRO: " + data.error);
                setTimeout(() => { isScanning = true; }, 2000);
            }
        })
        .catch(err => {
            alert("Erro de conex√£o.");
            setTimeout(() => { isScanning = true; }, 2000);
        });
    }

    function onScanFailure(error) {}

    function showModal(nome, hora, tipo) {
        document.getElementById('modalTitle').innerText = tipo.toUpperCase() + " REGISTRADA";
        document.getElementById('modalMsg').innerHTML = `<strong>${nome}</strong><br>${hora}`;
        document.getElementById('successModal').classList.add('active');
        
        // Auto-fechar em 4s se ninguem clicar
        setTimeout(() => {
            if(document.getElementById('successModal').classList.contains('active')) resetScanner();
        }, 4000);
    }

    function resetScanner() {
        document.getElementById('successModal').classList.remove('active');
        isScanning = true;
    }
</script>
{% endblock %}

##################################################

FILE: app/static/manifest.json
------------------------------
{
  "name": "Shahin Gest√£o Operacional",
  "short_name": "Shahin App",
  "description": "Sistema Integrado de Gest√£o de Ponto e RH",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#0f172a",
  "orientation": "portrait",
  "icons": [
    {
      "src": "/static/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/static/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ]
}



##################################################

FILE: app/static/service-worker.js
----------------------------------
const CACHE_NAME = 'shahin-app-v1';

// Recursos m√≠nimos para o aplicativo iniciar mais r√°pido
const ASSETS_TO_CACHE = [
    '/',
    '/static/manifest.json'
];

// Instala√ß√£o do Motor no telem√≥vel
self.addEventListener('install', (event) => {
    event.waitUntil(
        caches.open(CACHE_NAME).then((cache) => {
            console.log('[Shahin App] Service Worker Instalado e Cache Criado.');
            return cache.addAll(ASSETS_TO_CACHE);
        })
    );
});

// Ativa√ß√£o e limpeza de vers√µes antigas do App
self.addEventListener('activate', (event) => {
    event.waitUntil(
        caches.keys().then((cacheNames) => {
            return Promise.all(
                cacheNames.map((cacheName) => {
                    if (cacheName !== CACHE_NAME) {
                        console.log('[Shahin App] Limpando vers√£o antiga do cache:', cacheName);
                        return caches.delete(cacheName);
                    }
                })
            );
        })
    );
});

// Estrat√©gia de Rede (Network First): Como √© um sistema de gest√£o ao vivo, 
// o app vai sempre tentar buscar os dados mais recentes do servidor primeiro.
self.addEventListener('fetch', (event) => {
    // Ignora requisi√ß√µes que n√£o sejam GET (como envio de atestados ou ponto)
    if (event.request.method !== 'GET') return;

    event.respondWith(
        fetch(event.request).catch(() => {
            // Se o telem√≥vel estiver sem internet (offline), tenta carregar a p√°gina do cache
            return caches.match(event.request);
        })
    );
});

// ============================================================================
// FASE 2: O CARTEIRO INVIS√çVEL (MOTOR DE NOTIFICA√á√ïES PUSH)
// ============================================================================

// 1. √Ä ESCUTA: Recebendo a notifica√ß√£o disparada pelo servidor Python
self.addEventListener('push', function(event) {
    console.log('[Shahin App] Push Message recebida!');
    
    // Dados padr√£o caso algo falhe
    let data = { 
        title: 'Shahin Gest√£o', 
        body: 'Voc√™ tem uma nova notifica√ß√£o do RH.', 
        url: '/' 
    };
    
    // Tenta extrair os dados enviados pelo servidor
    if (event.data) {
        try {
            data = event.data.json(); // Se vier formatado perfeitamente (JSON)
        } catch (e) {
            data.body = event.data.text(); // Se vier apenas como texto simples
        }
    }

    // Configura√ß√£o do visual e comportamento do aviso no telem√≥vel
    const options = {
        body: data.body,
        icon: '/static/icons/icon-192x192.png', // O √≠cone grande do app
        badge: '/static/icons/icon-192x192.png', // O √≠cone pequenino da barra de notifica√ß√µes (status bar)
        vibrate: [200, 100, 200, 100, 200, 100, 200], // Padr√£o de vibra√ß√£o chamativo
        data: {
            url: data.url || '/' // Guarda o link (ex: /documentos/meus-documentos) para quando o utilizador clicar
        },
        requireInteraction: true // For√ßa a notifica√ß√£o a ficar no ecr√£ at√© que o utilizador a veja e feche
    };

    // Diz ao telem√≥vel para mostrar o alerta final!
    event.waitUntil(
        self.registration.showNotification(data.title || 'Shahin Gest√£o', options)
    );
});

// 2. A√á√ÉO: O que acontece quando o funcion√°rio clica na notifica√ß√£o
self.addEventListener('notificationclick', function(event) {
    console.log('[Shahin App] Utilizador clicou na notifica√ß√£o.');
    
    // Fecha a notifica√ß√£o do ecr√£
    event.notification.close();

    // Recupera para qual p√°gina o RH queria enviar o funcion√°rio
    const targetUrl = event.notification.data.url;

    // A magia de navega√ß√£o:
    event.waitUntil(
        // Verifica se o Shahin Gest√£o j√° est√° aberto em alguma aba ou em segundo plano
        clients.matchAll({ type: 'window', includeUncontrolled: true }).then(function(clientList) {
            for (let i = 0; i < clientList.length; i++) {
                let client = clientList[i];
                // Se j√° estiver aberto, foca na tela existente e navega para a p√°gina correta
                if (client.url.includes(self.registration.scope) && 'focus' in client) {
                    client.navigate(targetUrl);
                    return client.focus();
                }
            }
            // Se o app estiver 100% fechado, abre-o diretamente na p√°gina correta
            if (clients.openWindow) {
                return clients.openWindow(targetUrl);
            }
        })
    );
});



##################################################

FILE: app/static/css/style.css
------------------------------
/* ========================================= */
/* Estilos Globais do Shahin Gest√£o          */
/* ========================================= */

body { 
    font-family: 'Inter', sans-serif; 
}

/* ========================================= */
/* Componentes de Formul√°rio Pro             */
/* ========================================= */

.label-pro { 
    display: block; 
    font-size: 0.75rem; /* text-xs */
    font-weight: 700; /* font-bold */
    color: #64748b; /* text-slate-500 */
    text-transform: uppercase; 
    margin-bottom: 0.5rem; 
    letter-spacing: 0.05em;
} 

.input-pro { 
    width: 100%; 
    background-color: #f8fafc; /* bg-slate-50 */
    border: 1px solid #e2e8f0; /* border-slate-200 */
    border-radius: 0.5rem; 
    padding: 0.75rem 1rem; /* py-3 px-4 */
    color: #334155; /* text-slate-700 */
    font-weight: 700; 
    outline: none; 
    transition: all 0.2s;
}

.input-pro:focus {
    background-color: #ffffff;
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

/* ========================================= */
/* Utilit√°rios de Anima√ß√£o e Transi√ß√µes      */
/* ========================================= */

.animate-fade-in { 
    animation: fadeIn 0.5s ease-out; 
}

@keyframes fadeIn { 
    from { opacity: 0; transform: translateY(10px); } 
    to { opacity: 1; transform: translateY(0); } 
}

/* Menu Lateral e Submenus */
.sidebar { transition: transform 0.3s ease-in-out; }
.submenu { transition: max-height 0.3s ease-in-out; overflow: hidden; max-height: 0; }
.submenu.open { max-height: 500px; } 

/* Sino de Notifica√ß√µes */
@keyframes ring { 
    0% { transform: rotate(0); } 
    10% { transform: rotate(15deg); } 
    20% { transform: rotate(-10deg); } 
    30% { transform: rotate(5deg); } 
    40% { transform: rotate(-5deg); } 
    50% { transform: rotate(0); } 
    100% { transform: rotate(0); } 
}
.bell-ring { 
    animation: ring 2s infinite; 
    display: inline-block; 
    transform-origin: top center; 
}



##################################################

FILE: app/templates/base.html
-----------------------------
<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shahin Gest√£o - Operacional</title>
    
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#0f172a">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Shahin App">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <script>
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('overlay');
            if (sb.classList.contains('-translate-x-full')) { 
                sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); 
            } else { 
                sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); 
            }
        }
        function toggleSubmenu(id, iconId) {
            const menu = document.getElementById(id);
            const icon = document.getElementById(iconId);
            if (menu.classList.contains('open')) {
                menu.classList.remove('open');
                setTimeout(() => menu.classList.add('hidden'), 300);
                if(icon) icon.classList.remove('rotate-180');
            } else {
                menu.classList.remove('hidden');
                setTimeout(() => menu.classList.add('open'), 10);
                if(icon) icon.classList.add('rotate-180');
            }
        }
        function toggleNotificacoes() {
            const painel = document.getElementById('painel-notificacoes');
            painel.classList.toggle('hidden');
        }
    </script>
</head>
<body class="bg-slate-100 text-slate-800">

    {% set clean_username = "" %}
    {% set is_master = false %}
    {% set perms = "" %}
    
    {% if current_user.is_authenticated %}
        {% set clean_username = current_user.username | string | replace('.', '') | replace('-', '') %}
        {% set is_master = current_user.role == 'Master' or clean_username == '50097952800' %}
        {% set perms = current_user.permissions or "" %}
    {% endif %}

    {% if current_user.is_authenticated and not current_user.is_first_access %}
    <div class="md:hidden bg-white border-b border-slate-200 p-4 flex justify-between items-center sticky top-0 z-40">
        <button onclick="toggleSidebar()" class="text-slate-600 focus:outline-none"><i class="fas fa-bars text-xl"></i></button>
        <span class="font-bold text-lg text-slate-800">Shahin</span>
        <button onclick="toggleNotificacoes()" class="relative text-slate-500 hover:text-blue-600 focus:outline-none w-8">
            <i class="fas fa-bell text-xl" id="bell-icon-mobile"></i>
            <span id="badge-notif-mobile" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[9px] font-black px-1.5 py-0.5 rounded-full border border-white">0</span>
        </button>
    </div>
    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>
    {% endif %}

    <div class="{% if current_user.is_authenticated and not current_user.is_first_access %}flex h-screen overflow-hidden{% endif %}">
        
        {% if current_user.is_authenticated and not current_user.is_first_access %}
        <aside id="sidebar" class="sidebar fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 text-slate-300 transform -translate-x-full md:translate-x-0 md:static md:flex-shrink-0 flex flex-col shadow-2xl h-full transition-transform duration-300 ease-in-out">
            <div class="h-16 flex items-center px-6 bg-slate-950 border-b border-slate-800">
                <img src="/static/icons/icon-192x192.png" alt="Shahin" class="w-8 h-8 rounded-lg mr-3 object-cover shadow-sm">
                <span class="font-bold text-xl text-white tracking-tight">Shahin</span>
            </div>
            
            <div class="p-6 border-b border-slate-800">
                {% if not is_master %}
                    <div class="text-xs font-bold text-slate-500 uppercase mb-1">Colaborador</div>
                {% endif %}
                <div class="text-sm font-bold text-white truncate">{{ current_user.real_name }}</div>
                <div class="text-[10px] text-blue-400 font-mono mt-1 uppercase">{{ current_user.role }}</div>
            </div>

            <nav class="flex-1 overflow-y-auto py-4">
                <ul class="space-y-1">
                    {% if current_user.role == 'Terminal' %}
                        <li><a href="/ponto/scanner" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-qrcode w-6 text-center mr-2 text-blue-500"></i><span class="font-medium">Abrir Leitor</span></a></li>
                    {% else %}
                        <li><a href="/" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-home w-6 text-center mr-2 text-slate-500 group-hover:text-blue-500"></i><span class="font-medium">In√≠cio</span></a></li>
                        
                        <li class="pt-4 pb-2 px-6 text-[10px] font-bold uppercase text-slate-600">√Årea Pessoal</li>
                        <li><a href="/ponto/registrar" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-fingerprint w-6 text-center mr-2 text-slate-500 group-hover:text-purple-500"></i><span class="font-medium">Registar Ponto</span></a></li>
                        <li><a href="/ponto/espelho" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-file-invoice w-6 text-center mr-2 text-slate-500 group-hover:text-blue-400"></i><span class="font-medium">Espelho de Ponto</span></a></li>
                        <li><a href="/ponto/escala" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-calendar-alt w-6 text-center mr-2 text-slate-500 group-hover:text-emerald-400"></i><span class="font-medium">Minha Escala</span></a></li>
                        
                        <li>
                            <button onclick="toggleSubmenu('submenu-solic', 'icon-solic')" class="w-full flex items-center justify-between px-6 py-3 hover:bg-slate-800 hover:text-white transition group focus:outline-none">
                                <div class="flex items-center">
                                    <i class="fas fa-paper-plane w-6 text-center mr-2 text-slate-500 group-hover:text-white"></i>
                                    <span class="font-medium">Solicita√ß√µes</span>
                                </div>
                                <i id="icon-solic" class="fas fa-chevron-down text-xs transition-transform duration-300"></i>
                            </button>
                            <ul id="submenu-solic" class="submenu hidden bg-slate-950">
                                <li><a href="/ponto/solicitar-ajuste" class="block pl-16 pr-6 py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800 transition border-l-2 border-transparent hover:border-yellow-500">Ajuste de Ponto</a></li>
                                <li><a href="/ponto/solicitar-ferias" class="block pl-16 pr-6 py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800 transition border-l-2 border-transparent hover:border-emerald-500">F√©rias e Licen√ßas</a></li>
                                <li><a href="{{ url_for('estoque.solicitar_uniforme') }}" class="block pl-16 pr-6 py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800 transition border-l-2 border-transparent hover:border-blue-400">Uniforme e EPI</a></li>
                            </ul>
                        </li>

                        <li><a href="/documentos/meus-documentos" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-folder-open w-6 text-center mr-2 text-slate-500 group-hover:text-yellow-400"></i><span class="font-medium">Meus Documentos</span></a></li>
                        <li><a href="/documentos/atestados/meus" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-file-medical w-6 text-center mr-2 text-slate-500 group-hover:text-teal-400"></i><span class="font-medium">Meus Atestados</span></a></li>

                        {% if is_master or 'DOCUMENTOS' in perms or 'PONTO' in perms or 'ESTOQUE' in perms or 'USUARIOS' in perms %}
                        <li class="pt-6 pb-2 px-6 text-[10px] font-bold uppercase text-slate-600 border-t border-slate-800/50 mt-4">Administra√ß√£o</li>
                        
                        {% if is_master or 'PONTO' in perms %}
                        <li><a href="/ponto/admin/controle-escala" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-users w-6 text-center mr-2 text-slate-500 group-hover:text-blue-400"></i><span class="font-medium">Controle de Escala</span></a></li>
                        <li>
                            <button onclick="toggleSubmenu('submenu-ponto', 'icon-ponto')" class="w-full flex items-center justify-between px-6 py-3 hover:bg-slate-800 hover:text-white transition group focus:outline-none">
                                <div class="flex items-center">
                                    <i class="fas fa-inbox w-6 text-center mr-2 text-slate-500 group-hover:text-white"></i>
                                    <span class="font-medium">Central Solicita√ß√µes</span>
                                </div>
                                <i id="icon-ponto" class="fas fa-chevron-down text-xs transition-transform duration-300"></i>
                            </button>
                            <ul id="submenu-ponto" class="submenu hidden bg-slate-950">
                                <li><a href="/admin/solicitacoes" class="block pl-16 pr-6 py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800 transition border-l-2 border-transparent hover:border-yellow-500">Aprovar Ajustes</a></li>
                                <li><a href="/ponto/admin/ausencias" class="block pl-16 pr-6 py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800 transition border-l-2 border-transparent hover:border-emerald-500">Gest√£o de F√©rias</a></li>
                            </ul>
                        </li>
                        {% endif %}

                        {% if is_master or 'DOCUMENTOS' in perms %}
                        <li>
                            <button onclick="toggleSubmenu('submenu-documentos', 'icon-documentos')" class="w-full flex items-center justify-between px-6 py-3 hover:bg-slate-800 hover:text-white transition group focus:outline-none">
                                <div class="flex items-center">
                                    <i class="fas fa-file-contract w-6 text-center mr-2 text-slate-500 group-hover:text-white"></i>
                                    <span class="font-medium">Central Documentos</span>
                                </div>
                                <i id="icon-documentos" class="fas fa-chevron-down text-xs transition-transform duration-300"></i>
                            </button>
                            <ul id="submenu-documentos" class="submenu hidden bg-slate-950">
                                <li><a href="/documentos/admin" class="block pl-16 pr-6 py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800 transition border-l-2 border-transparent hover:border-blue-600">Envio de Documentos</a></li>
                                <li><a href="/documentos/admin/atestados" class="block pl-16 pr-6 py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800 transition border-l-2 border-transparent hover:border-teal-500">Atestados M√©dicos</a></li>
                                <li><a href="/documentos/relatorio-folha" class="block pl-16 pr-6 py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800 transition border-l-2 border-transparent hover:border-yellow-400">Fechamento de Folha</a></li>
                                {% if is_master or 'AUDITORIA' in perms %}
                                <li><a href="/documentos/admin/auditoria" class="block pl-16 pr-6 py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800 transition border-l-2 border-transparent hover:border-purple-500">Auditoria (Assinaturas)</a></li>
                                {% endif %}
                            </ul>
                        </li>
                        {% endif %}

                        {% if is_master or 'ESTOQUE' in perms %}
                        <li>
                            <button onclick="toggleSubmenu('submenu-estoque', 'icon-estoque')" class="w-full flex items-center justify-between px-6 py-3 hover:bg-slate-800 hover:text-white transition group focus:outline-none">
                                <div class="flex items-center">
                                    <i class="fas fa-box w-6 text-center mr-2 text-slate-500 group-hover:text-white"></i>
                                    <span class="font-medium">Controle de Estoque</span>
                                </div>
                                <i id="icon-estoque" class="fas fa-chevron-down text-xs transition-transform duration-300"></i>
                            </button>
                            <ul id="submenu-estoque" class="submenu hidden bg-slate-950">
                                <li><a href="{{ url_for('estoque.gerenciar_estoque') }}" class="block pl-16 pr-6 py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800 transition border-l-2 border-transparent hover:border-emerald-500">Invent√°rio Geral</a></li>
                                <li><a href="{{ url_for('estoque.gestao_solicitacoes') }}" class="block pl-16 pr-6 py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800 transition border-l-2 border-transparent hover:border-blue-500">Pedidos de EPI/Uniforme</a></li>
                            </ul>
                        </li>
                        {% endif %}

                        {% if is_master or 'USUARIOS' in perms %}
                        <li><a href="/admin/usuarios" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-users-cog w-6 text-center mr-2 text-slate-500"></i><span class="font-medium">Funcion√°rios</span></a></li>
                        {% endif %}
                        {% endif %}
                    {% endif %}
                    
                    <li id="pwa-install-container" class="hidden mt-6 mx-4">
                        <button id="pwa-install-btn" class="w-full flex items-center justify-center px-4 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl shadow-lg transition-transform transform active:scale-95 group">
                            <i class="fas fa-download mr-2 group-hover:animate-bounce"></i>
                            <span class="font-bold text-xs tracking-wide uppercase">Instalar App</span>
                        </button>
                    </li>

                    <li id="push-subscribe-container" class="mt-4 mb-2 mx-4 hidden">
                        <button id="push-subscribe-btn" class="w-full flex items-center justify-center px-4 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl shadow-lg transition-transform transform active:scale-95 group border border-indigo-500/50">
                            <i class="fas fa-bell mr-2 group-hover:animate-pulse"></i>
                            <span class="font-bold text-xs tracking-wide uppercase">Ativar Alertas</span>
                        </button>
                    </li>
                    
                    <li class="{% if current_user.role != 'Terminal' %}mt-2{% endif %}"><a href="/logout" class="flex items-center px-6 py-3 hover:bg-red-900/20 hover:text-red-400 transition group"><i class="fas fa-sign-out-alt w-6 text-center mr-2 text-slate-500 group-hover:text-red-400"></i><span class="font-medium">Sair</span></a></li>
                </ul>
            </nav>
        </aside>
        {% endif %}
        
        <div class="flex-1 h-full overflow-y-auto bg-slate-50 relative w-full">
            
            {% if current_user.is_authenticated and not current_user.is_first_access %}
            <div class="hidden md:flex justify-end items-center px-8 py-4 bg-white/50 border-b border-slate-200 sticky top-0 z-30 backdrop-blur-md">
                <div class="relative">
                    <button onclick="toggleNotificacoes()" class="relative text-slate-500 hover:text-blue-600 focus:outline-none transition group bg-white p-2.5 rounded-full border border-slate-200 shadow-sm hover:shadow">
                        <i class="fas fa-bell text-lg" id="bell-icon-desktop"></i>
                        <span id="badge-notif-desktop" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-black px-1.5 py-0.5 rounded-full border border-white shadow-sm transition-transform scale-0">0</span>
                    </button>
                    
                    <div id="painel-notificacoes" class="hidden absolute right-0 mt-3 w-80 bg-white rounded-2xl shadow-2xl border border-slate-200 overflow-hidden transform origin-top-right transition-all">
                        <div class="bg-blue-600 px-5 py-3 flex justify-between items-center">
                            <h3 class="font-bold text-white text-sm flex items-center gap-2"><i class="fas fa-inbox opacity-70"></i> Notifica√ß√µes</h3>
                            <div class="flex gap-3">
                                <button onclick="lerTodasNotificacoes()" class="text-[10px] text-blue-200 hover:text-white uppercase font-bold tracking-wider transition" title="Marcar todas como lidas"><i class="fas fa-check-double mr-1"></i> Ler Tudo</button>
                                <button onclick="limparNotificacoes()" class="text-[10px] text-red-300 hover:text-red-100 uppercase font-bold tracking-wider transition" title="Excluir hist√≥rico de notifica√ß√µes"><i class="fas fa-trash-alt mr-1"></i> Limpar</button>
                            </div>
                        </div>
                        <div id="lista-notificacoes" class="max-h-[400px] overflow-y-auto divide-y divide-slate-100 bg-slate-50">
                            <div class="p-8 text-center text-slate-400 text-xs font-medium"><i class="fas fa-spinner fa-spin mr-2"></i> Carregando novidades...</div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="max-w-5xl mx-auto p-4 md:p-8 pb-20 pt-6">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="hidden" id="flask-msg-{{ loop.index }}" data-cat="{{ category }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                {% block content %}{% endblock %}
            </div>
            
            {% if current_user.is_authenticated and not current_user.is_first_access %}
            <footer class="py-6 text-center text-xs text-slate-400">&copy; 2026 Shahin Gest√£o</footer>
            {% endif %}
            
        </div>
    </div>

    <div id="modal-confirmacao" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full mx-4 overflow-hidden transform scale-95 transition-transform duration-200 ease-out" id="modal-content">
            <div class="p-8 text-center">
                <div class="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-5">
                    <i class="fas fa-exclamation-triangle text-red-500 text-4xl"></i>
                </div>
                <h3 class="text-2xl font-black text-slate-800 mb-2">Aten√ß√£o!</h3>
                <p id="modal-mensagem" class="text-sm text-slate-500 mb-8 leading-relaxed">Tem certeza que deseja continuar com esta a√ß√£o?</p>
                
                <div class="flex gap-4">
                    <button onclick="fecharModalConfirmacao()" class="flex-1 py-3.5 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold rounded-xl transition">
                        Cancelar
                    </button>
                    <form id="form-confirmacao" method="POST" class="flex-1">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="w-full h-full py-3.5 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-lg shadow-red-200 transition transform active:scale-95 flex items-center justify-center gap-2">
                            <i class="fas fa-trash-alt"></i> Excluir
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        // Fun√ß√µes do Modal Global
        function confirmarAcao(mensagem, actionUrl) {
            document.getElementById('modal-mensagem').innerText = mensagem;
            document.getElementById('form-confirmacao').action = actionUrl;
            
            const modal = document.getElementById('modal-confirmacao');
            const content = document.getElementById('modal-content');
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function fecharModalConfirmacao() {
            const modal = document.getElementById('modal-confirmacao');
            const content = document.getElementById('modal-content');
            
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        // Fun√ß√µes Originais
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('[id^="flask-msg-"]').forEach(el => {
                const msg = el.innerText;
                const cat = el.getAttribute('data-cat');
                Toastify({
                    text: msg, duration: 4000, close: true, gravity: "top", position: "right", 
                    style: { background: cat === 'error' ? "linear-gradient(to right, #ef4444, #b91c1c)" : "linear-gradient(to right, #3b82f6, #2563eb)", borderRadius: "8px", fontSize: "14px" },
                }).showToast();
            });

            {% if current_user.is_authenticated and not current_user.is_first_access %}
            buscarNotificacoes();
            setInterval(buscarNotificacoes, 120000); 
            {% endif %}
        });

        async function buscarNotificacoes() {
            try {
                const req = await fetch('/api/notificacoes');
                const data = await req.json();
                
                atualizarBadge(data.nao_lidas);
                renderizarLista(data.itens);
            } catch (e) { console.error("Falha ao buscar notifica√ß√µes", e); }
        }

        function atualizarBadge(qtd) {
            const bDesktop = document.getElementById('badge-notif-desktop');
            const iDesktop = document.getElementById('bell-icon-desktop');
            const bMobile = document.getElementById('badge-notif-mobile');
            const iMobile = document.getElementById('bell-icon-mobile');

            if (qtd > 0) {
                if(bDesktop) { bDesktop.innerText = qtd; bDesktop.classList.remove('hidden'); bDesktop.style.transform = 'scale(1)'; }
                if(bMobile) { bMobile.innerText = qtd; bMobile.classList.remove('hidden'); }
                if(iDesktop) iDesktop.classList.add('bell-ring', 'text-blue-500');
                if(iMobile) iMobile.classList.add('bell-ring', 'text-blue-500');
            } else {
                if(bDesktop) { bDesktop.classList.add('hidden'); bDesktop.style.transform = 'scale(0)'; }
                if(bMobile) bMobile.classList.add('hidden');
                if(iDesktop) iDesktop.classList.remove('bell-ring', 'text-blue-500');
                if(iMobile) iMobile.classList.remove('bell-ring', 'text-blue-500');
            }
        }

        function renderizarLista(itens) {
            const lista = document.getElementById('lista-notificacoes');
            if (itens.length === 0) {
                lista.innerHTML = '<div class="p-8 text-center text-slate-400 text-xs flex flex-col items-center gap-2"><i class="fas fa-check-circle text-2xl opacity-20"></i> Tudo lido por aqui!</div>';
                return;
            }

            lista.innerHTML = '';
            itens.forEach(n => {
                const corBg = n.lida ? 'bg-white' : 'bg-blue-50/50';
                const corBolinha = n.lida ? 'bg-transparent' : 'bg-blue-500';
                const linkAttr = n.link ? `onclick="clicarNotificacao(${n.id}, '${n.link}')" class="cursor-pointer hover:bg-slate-50 block transition"` : `class="block"`;

                lista.innerHTML += `
                    <a ${linkAttr}>
                        <div class="px-5 py-4 flex gap-3 ${corBg}">
                            <div class="mt-1 w-2 h-2 rounded-full ${corBolinha} flex-shrink-0"></div>
                            <div>
                                <p class="text-[11px] font-bold text-slate-700 leading-snug">${n.mensagem}</p>
                                <span class="text-[9px] font-bold uppercase text-slate-400 mt-1 block"><i class="far fa-clock mr-1"></i> ${n.tempo}</span>
                            </div>
                        </div>
                    </a>
                `;
            });
        }

        async function clicarNotificacao(id, link) {
            await fetch(`/api/notificacoes/ler/${id}`, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token() }}' } });
            window.location.href = link;
        }

        async function lerTodasNotificacoes() {
            await fetch(`/api/notificacoes/ler_todas`, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token() }}' } });
            buscarNotificacoes();
        }

        async function limparNotificacoes() {
            // Em vez do confirm feio, agora chamamos o nosso modal para excluir o hist√≥rico
            confirmarAcao("Tem certeza que deseja excluir todo o seu hist√≥rico de notifica√ß√µes? Esta a√ß√£o n√£o pode ser desfeita.", "/api/notificacoes/limpar");
            // Nota: Para interceptar o submit e fazer via Ajax, teremos que modificar ligeiramente, 
            // mas como √© o √∫nico local onde √© Ajax, vou deixar o script abaixo lidar com isso.
            
            // Subscreve o comportamento padr√£o do form do modal SOMENTE neste caso espec√≠fico
            document.getElementById('form-confirmacao').onsubmit = async function(e) {
                if (this.action.includes('/api/notificacoes/limpar')) {
                    e.preventDefault();
                    try {
                        const response = await fetch(`/api/notificacoes/limpar`, { 
                            method: 'POST', 
                            headers: { 'X-CSRFToken': '{{ csrf_token() }}' } 
                        });
                        const data = await response.json();
                        if(data.success) {
                            Toastify({ text: "Hist√≥rico de notifica√ß√µes limpo.", style: { background: "#10b981" } }).showToast();
                            buscarNotificacoes();
                            fecharModalConfirmacao();
                        }
                    } catch (err) {
                        console.error(err);
                    }
                    // Retira a subscri√ß√£o para n√£o afetar outros locais
                    this.onsubmit = null; 
                }
            };
        }
    </script>
    
    <script>
        const installContainer = document.getElementById('pwa-install-container');
        const installBtn = document.getElementById('pwa-install-btn');
        const pushContainer = document.getElementById('push-subscribe-container');
        const pushBtn = document.getElementById('push-subscribe-btn');

        const PUBLIC_VAPID_KEY = 'BCA3_Fa5ZC7AN78uY1Ob_Q3qqNL9GoowZcix2BskNqG6oUbWVzRc8W82T8fI2GkQNC7T3oVZZ8ANYDABJbuRWPo';

        function urlB64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if(installContainer) installContainer.classList.remove('hidden');
        });

        if(installBtn) {
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt !== null) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        installContainer.classList.add('hidden');
                    }
                    deferredPrompt = null;
                }
            });
        }

        window.addEventListener('appinstalled', () => {
            if(installContainer) installContainer.classList.add('hidden');
            console.log('Shahin App instalado com sucesso!');
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/service-worker.js').then(function(registration) {
                    console.log('Shahin App: ServiceWorker ativado com sucesso!');
                    
                    if ('PushManager' in window) {
                        registration.pushManager.getSubscription().then(function(subscription) {
                            if (subscription === null) {
                                if(pushContainer) pushContainer.classList.remove('hidden');
                            }
                        });

                        if (pushBtn) {
                            pushBtn.addEventListener('click', async () => {
                                try {
                                    const permission = await Notification.requestPermission();
                                    if (permission === 'granted') {
                                        const subscription = await registration.pushManager.subscribe({
                                            userVisibleOnly: true,
                                            applicationServerKey: urlB64ToUint8Array(PUBLIC_VAPID_KEY)
                                        });

                                        const response = await fetch('/api/push/subscribe', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'X-CSRFToken': '{{ csrf_token() }}'
                                            },
                                            body: JSON.stringify(subscription)
                                        });

                                        const data = await response.json();
                                        if (data.success) {
                                            pushContainer.classList.add('hidden');
                                            Toastify({ text: "Alertas ativados com sucesso!", duration: 5000, style: { background: "#10b981" } }).showToast();
                                        }
                                    } else {
                                        Toastify({ text: "Permiss√£o negada.", style: { background: "#ef4444" } }).showToast();
                                    }
                                } catch (error) {
                                    console.error('Erro ao ativar Push:', error);
                                    Toastify({ text: "Ocorreu um erro ao ativar.", style: { background: "#ef4444" } }).showToast();
                                }
                            });
                        }
                    }
                }).catch(function(err) {
                    console.log('Shahin App: Falha ao ativar o ServiceWorker.', err);
                });
            });
        }
    </script>
</body>
</html>



##################################################

FILE: app/templates/ponto_espelho_master.html
---------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
    <h2 class="text-2xl font-bold text-slate-800">Espelho Geral</h2>
    <form action="/ponto/espelho" method="GET" class="flex gap-2">
        <input type="date" name="data_filtro" value="{{ filtro_data }}" class="border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-600">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm"><i class="fas fa-filter"></i></button>
        {% if filtro_data %}<a href="/ponto/espelho" class="bg-slate-200 text-slate-600 px-4 py-2 rounded-lg font-bold text-sm">Limpar</a>{% endif %}
    </form>
</div>

<div class="mb-6"><input type="text" id="buscaEspelho" onkeyup="filtrarEspelho('buscaEspelho', 'listaEspelho')" placeholder="Pesquisar funcion√°rio..." class="w-full p-4 rounded-xl border border-slate-200 shadow-sm"></div>

<div class="space-y-2" id="listaEspelho">
    {% for grupo in grupos %}
    <div class="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm item-espelho">
        <button onclick="toggleDetails('detalhe-{{ loop.index }}')" class="w-full flex justify-between items-center p-4 bg-slate-50 hover:bg-slate-100 transition text-left focus:outline-none">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">{{ grupo.user.real_name[:2].upper() }}</div>
                <div>
                    <h3 class="font-bold text-slate-800 text-sm nome-func">{{ grupo.user.real_name }}</h3>
                    <p class="text-xs text-slate-500 font-mono">{{ grupo.data.strftime('%d/%m/%Y') }}</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <!-- Mostrador de Saldo no Card -->
                {% if grupo.saldo %}
                <div class="text-right">
                    <span class="block text-[10px] font-bold uppercase text-slate-400">Saldo</span>
                    <span class="text-sm font-mono font-bold 
                        {% if '-' in grupo.saldo %} text-red-600 {% else %} text-emerald-600 {% endif %}">
                        {{ grupo.saldo }}
                    </span>
                </div>
                {% endif %}
                <i class="fas fa-chevron-down text-slate-400"></i>
            </div>
        </button>
        
        <div id="detalhe-{{ loop.index }}" class="hidden border-t border-slate-100">
            <div class="p-4 bg-white grid grid-cols-2 gap-2">
                {% for p in grupo.pontos %}
                <div class="flex justify-between items-center p-2 rounded bg-slate-50 border border-slate-100">
                    <span class="text-xs font-bold text-slate-600">{{ p.tipo }}</span>
                    <span class="text-sm font-mono font-bold text-blue-600">{{ p.hora_registro.strftime('%H:%M') }}</span>
                </div>
                {% endfor %}
                <div class="col-span-2 text-center text-xs text-slate-400 mt-2 bg-slate-50 p-1 rounded">Status: {{ grupo.status }}</div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-10 text-slate-400">Nenhum registro encontrado.</div>
    {% endfor %}
</div>
<script>
function filtrarEspelho(inputId, listaId) {
    let input = document.getElementById(inputId);
    let filter = input.value.toUpperCase();
    let lista = document.getElementById(listaId);
    let itens = lista.getElementsByClassName('item-espelho');
    for (let i = 0; i < itens.length; i++) {
        let nome = itens[i].getElementsByClassName('nome-func')[0];
        if (nome.innerHTML.toUpperCase().indexOf(filter) > -1) { itens[i].style.display = ""; } else { itens[i].style.display = "none"; }
    }
}
</script>
{% endblock %}

##################################################

FILE: app/templates/errors/403.html
-----------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col items-center justify-center min-h-[60vh] text-center px-4 animate-fade-in">
    <div class="w-28 h-28 bg-red-100 text-red-500 rounded-full flex items-center justify-center text-5xl mb-6 shadow-inner ring-4 ring-red-50">
        <i class="fas fa-shield-alt"></i>
    </div>
    <h1 class="text-4xl font-black text-slate-800 mb-2">Acesso Negado</h1>
    <h2 class="text-lg font-bold text-red-600 mb-4">√Årea Restrita (Erro 403)</h2>
    <p class="text-sm text-slate-500 mb-8 max-w-md">O seu n√≠vel de acesso n√£o permite visualizar este documento ou realizar esta opera√ß√£o. Contacte a supervis√£o se acha que isto √© um erro.</p>
    
    <a href="/" class="bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 px-8 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex items-center gap-2">
        <i class="fas fa-arrow-left"></i> VOLTAR EM SEGURAN√áA
    </a>
</div>
{% endblock %}



##################################################

FILE: app/templates/errors/404.html
-----------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col items-center justify-center min-h-[60vh] text-center px-4 animate-fade-in">
    <div class="w-28 h-28 bg-slate-200 text-slate-500 rounded-full flex items-center justify-center text-5xl mb-6 shadow-inner">
        <i class="fas fa-map-signs"></i>
    </div>
    <h1 class="text-4xl font-black text-slate-800 mb-2">Erro 404</h1>
    <h2 class="text-lg font-bold text-slate-600 mb-4">Posto n√£o localizado.</h2>
    <p class="text-sm text-slate-500 mb-8 max-w-md">Ops! Parece que se perdeu na ronda. A p√°gina que tentou aceder n√£o existe ou foi movida de lugar.</p>
    
    <a href="/" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex items-center gap-2">
        <i class="fas fa-home"></i> VOLTAR √Ä BASE (IN√çCIO)
    </a>
</div>
{% endblock %}



##################################################

FILE: app/templates/errors/500.html
-----------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col items-center justify-center min-h-[60vh] text-center px-4 animate-fade-in">
    <div class="w-28 h-28 bg-amber-100 text-amber-500 rounded-full flex items-center justify-center text-5xl mb-6 shadow-inner ring-4 ring-amber-50">
        <i class="fas fa-tools"></i>
    </div>
    <h1 class="text-4xl font-black text-slate-800 mb-2">Erro 500</h1>
    <h2 class="text-lg font-bold text-amber-600 mb-4">Falha no Motor do Sistema.</h2>
    <p class="text-sm text-slate-500 mb-8 max-w-md">Problema t√©cnico! Tivemos uma falha inesperada nos bastidores da aplica√ß√£o. Por favor, tente novamente.</p>
    
    <button onclick="window.location.reload();" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-4 px-8 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex items-center gap-2 mb-4">
        <i class="fas fa-sync-alt"></i> TENTAR NOVAMENTE
    </button>
    <a href="/" class="text-xs font-bold text-slate-400 hover:text-slate-600 underline">For√ßar volta ao In√≠cio</a>
</div>
{% endblock %}



##################################################

