==================================================
SNAPSHOT DO PROJETO: Shahin Gest√£o
Gerado em: 2026-02-17 06:47:32
==================================================

--- ESTRUTURA DE ARQUIVOS ---
.
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ admin/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ admin_importar_csv.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ admin_limpeza.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ admin_relatorio_folha.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ admin_usuarios.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ editar_usuario.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ liberar_acesso.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ novo_usuario.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ solicitacoes.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ sucesso_usuario.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes.py
‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ auto_cadastro.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ auto_cadastro_sucesso.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ login.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ primeiro_acesso.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes.py
‚îÇ   ‚îú‚îÄ‚îÄ documentos/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ documentos/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ admin_upload_holerite.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ auditoria.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ dashboard.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ meus_documentos.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ novo_recibo.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ revisao.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai_parser.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ storage.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.py
‚îÇ   ‚îú‚îÄ‚îÄ estoque/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ estoque/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ controle_uniforme.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ editar_item.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ editar_log_entrada.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ editar_log_saida.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ entrada.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ historico_entrada.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ historico_saida.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ saida.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ selecionar_edicao.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes.py
‚îÇ   ‚îú‚îÄ‚îÄ main/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ dashboard.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes.py
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ ponto/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ponto/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ponto_espelho.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ registro.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ solicitar_ajuste.html
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ terminal_leitura.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes.py
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ponto.py
‚îÇ   ‚îú‚îÄ‚îÄ static/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ css/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ style.css
‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dashboard.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ editar.html
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ponto_espelho_master.html
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ extensions.py
‚îÇ   ‚îî‚îÄ‚îÄ utils.py
‚îú‚îÄ‚îÄ .env
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ PROJETOTXT.py
‚îú‚îÄ‚îÄ Procfile
‚îú‚îÄ‚îÄ backup.py
‚îú‚îÄ‚îÄ config.py
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ run.py
‚îî‚îÄ‚îÄ runtime.txt

==================================================

--- CONTE√öDO DOS ARQUIVOS ---

FILE: Dockerfile
----------------
# Usa a vers√£o do Python que voc√™ j√° definiu no runtime.txt
FROM python:3.11-slim

# Define vari√°veis para o Python n√£o gerar arquivos .pyc e logs aparecerem na hora
ENV PYTHONUNBUFFERED True
ENV APP_HOME /app

# --- AQUI EST√Å O TRUQUE DO FUSO HOR√ÅRIO ---
# For√ßa o servidor a operar no hor√°rio de Bras√≠lia, eliminando c√°lculos manuais
ENV TZ=America/Sao_Paulo

WORKDIR $APP_HOME

# Instala depend√™ncias do sistema (Linux) necess√°rias para o PostgreSQL e PDF
RUN apt-get update && apt-get install -y \
    gcc \
    libpq-dev \
    tzdata \
    && rm -rf /var/lib/apt/lists/*

# Copia e instala as bibliotecas do seu projeto
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia todo o c√≥digo do Shahin para dentro do container
COPY . .

# Comando de inicializa√ß√£o (Igual ao seu Procfile)
# O Cloud Run vai injetar a vari√°vel $PORT automaticamente
CMD exec gunicorn --bind :$PORT --workers 1 --threads 8 --timeout 0 run:app

##################################################

FILE: PROJETOTXT.py
-------------------
import os
from datetime import datetime

# --- CONFIGURA√á√ïES ---
OUTPUT_FILE = "PROJECT_FULL_CONTEXT.txt"

# Pastas para ignorar (Adicionei as solicitadas e padroes de sistema)
IGNORE_DIRS = {
    '.git', '__pycache__', '.venv', 'venv', 'env', 'node_modules', 
    'backup', 'backups', 'backups_auto', 'app_backup_20260214_220800',
    '.idea', '.vscode'
}

IGNORE_FILES = {
    '.DS_Store', 'Thumbs.db', OUTPUT_FILE, 
    'generate_project_snapshot.py', 'generate_snapshot_v2.py',
    'db.sqlite3' # Ignora banco local se houver
}

# Extens√µes que queremos ler o conte√∫do
READ_EXTENSIONS = {'.py', '.html', '.txt', '.md', '.css', '.js', '.json', '.xml'}
# Arquivos espec√≠ficos sem extens√£o que queremos ler
READ_FILES = {'Procfile', 'requirements.txt', 'runtime.txt', 'Dockerfile', '.env.example'}

def should_ignore_dir(dirname):
    """Verifica se o diretorio deve ser ignorado."""
    if dirname in IGNORE_DIRS:
        return True
    # Ignora qualquer pasta que comece com app_backup_ (para backups futuros)
    if dirname.startswith('app_backup_'):
        return True
    return False

def generate_tree(startpath, prefix=""):
    """Gera a estrutura de √°rvore visual."""
    tree_str = ""
    files = []
    dirs = []

    try:
        for item in os.listdir(startpath):
            path = os.path.join(startpath, item)
            if os.path.isdir(path):
                if not should_ignore_dir(item):
                    dirs.append(item)
            else:
                if item not in IGNORE_FILES:
                    files.append(item)
    except PermissionError:
        return ""

    dirs.sort()
    files.sort()

    entries = dirs + files
    
    for i, entry in enumerate(entries):
        is_last = (i == len(entries) - 1)
        connector = "‚îî‚îÄ‚îÄ " if is_last else "‚îú‚îÄ‚îÄ "
        
        if entry in dirs:
            tree_str += f"{prefix}{connector}{entry}/\n"
            extension = "    " if is_last else "‚îÇ   "
            tree_str += generate_tree(os.path.join(startpath, entry), prefix + extension)
        else:
            tree_str += f"{prefix}{connector}{entry}\n"

    return tree_str

def get_file_content(filepath):
    """L√™ o conte√∫do do arquivo com seguran√ßa."""
    ext = os.path.splitext(filepath)[1]
    filename = os.path.basename(filepath)
    
    if ext in READ_EXTENSIONS or filename in READ_FILES:
        try:
            with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                content = f.read()
                return content
        except Exception as e:
            return f"[Erro ao ler arquivo: {e}]"
    return "[Conte√∫do bin√°rio ou n√£o listado para leitura]"

def main():
    root_dir = os.getcwd()
    
    print(f"--- GERANDO SNAPSHOT DO PROJETO ---")
    print(f"Raiz: {root_dir}")
    print(f"Ignorando pastas de backup...")
    
    with open(OUTPUT_FILE, 'w', encoding='utf-8') as out:
        # 1. Cabe√ßalho
        out.write("="*50 + "\n")
        out.write(f"SNAPSHOT DO PROJETO: Shahin Gest√£o\n")
        out.write(f"Gerado em: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
        out.write("="*50 + "\n\n")
        
        # 2. Estrutura de Pastas (Tree)
        out.write("--- ESTRUTURA DE ARQUIVOS ---\n")
        out.write(".\n")
        out.write(generate_tree(root_dir))
        out.write("\n" + "="*50 + "\n\n")
        
        # 3. Conte√∫do dos Arquivos
        out.write("--- CONTE√öDO DOS ARQUIVOS ---\n\n")
        
        for root, dirs, files in os.walk(root_dir):
            # Modifica a lista dirs "in-place" para impedir o os.walk de entrar nas pastas ignoradas
            dirs[:] = [d for d in dirs if not should_ignore_dir(d)]
            
            # Ordena para ficar bonito
            dirs.sort()
            files.sort()
            
            for file in files:
                if file in IGNORE_FILES: continue
                
                filepath = os.path.join(root, file)
                relative_path = os.path.relpath(filepath, root_dir)
                
                # Verifica se deve ler
                ext = os.path.splitext(file)[1]
                if ext in READ_EXTENSIONS or file in READ_FILES:
                    print(f"Lendo: {relative_path}")
                    content = get_file_content(filepath)
                    
                    out.write(f"FILE: {relative_path}\n")
                    out.write("-" * len(f"FILE: {relative_path}") + "\n")
                    out.write(content + "\n")
                    out.write("\n" + "#"*50 + "\n\n")

    print(f"\nCONCLU√çDO! Arquivo gerado: {OUTPUT_FILE}")

if __name__ == "__main__":
    main()




##################################################

FILE: Procfile
--------------
web: gunicorn run:app

##################################################

FILE: backup.py
---------------
import os
import zipfile
from datetime import datetime

def create_backup():
    # 1. Configura√ß√µes
    project_root = os.getcwd()
    backup_folder = os.path.join(project_root, 'backups')
    
    # Pastas e arquivos que N√ÉO queremos no backup
    ignore_dirs = {'.git', '__pycache__', 'venv', '.venv', 'env', 'backups', 'node_modules', '.idea', '.vscode'}
    ignore_files = {'.DS_Store', 'backup.py'} # Ignora o pr√≥prio script e arquivos de sistema

    # 2. Garante que a pasta de backups existe
    if not os.path.exists(backup_folder):
        os.makedirs(backup_folder)
        print(f"üìÅ Pasta '{backup_folder}' criada com sucesso.")

    # 3. Define o nome do arquivo com Timestamp
    timestamp = datetime.now().strftime('%Y-%m-%d_%H-%M-%S')
    zip_filename = f"backup_shahin_{timestamp}.zip"
    zip_path = os.path.join(backup_folder, zip_filename)

    print(f"‚è≥ Iniciando backup: {zip_filename}...")

    # 4. Processo de Zipagem
    try:
        with zipfile.ZipFile(zip_path, 'w', zipfile.ZIP_DEFLATED) as zipf:
            for root, dirs, files in os.walk(project_root):
                # Remove pastas ignoradas da lista para n√£o entrar nelas
                dirs[:] = [d for d in dirs if d not in ignore_dirs]
                
                for file in files:
                    if file in ignore_files:
                        continue
                    
                    # Caminho completo do arquivo
                    file_path = os.path.join(root, file)
                    
                    # Caminho relativo para manter a estrutura dentro do zip
                    # Ex: Se o arquivo √© /home/user/projeto/app/routes.py, no zip fica app/routes.py
                    arcname = os.path.relpath(file_path, project_root)
                    
                    zipf.write(file_path, arcname)
        
        print(f"‚úÖ Backup conclu√≠do com sucesso!")
        print(f"üìç Local: {zip_path}")
        
    except Exception as e:
        print(f"‚ùå Erro ao criar backup: {e}")

if __name__ == "__main__":
    create_backup()




##################################################

FILE: config.py
---------------
import os
from dotenv import load_dotenv

load_dotenv()

class Config:
    # Seguran√ßa: Usa vari√°vel de ambiente ou um fallback (nunca fixo em prod)
    SECRET_KEY = os.environ.get('SECRET_KEY', 'chave_mestra_v67_fix_final')
    
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    SQLALCHEMY_ENGINE_OPTIONS = {
        "pool_pre_ping": True,
        "pool_recycle": 300,
        "pool_size": 10
    }
    
    # --- CORRE√á√ÉO DE SEGURAN√áA (FASE 1) ---
    # Ativa prote√ß√£o contra CSRF (Cross-Site Request Forgery)
    # Importante: Certifique-se que seus formul√°rios HTML tenham {{ csrf_token() }}
    WTF_CSRF_ENABLED = True 
    
    # Configura√ß√µes de Cookie
    # Mude SESSION_COOKIE_SECURE para True apenas se estiver usando HTTPS (Produ√ß√£o)
    SESSION_COOKIE_SECURE = False 
    SESSION_COOKIE_HTTPONLY = True
    SESSION_COOKIE_SAMESITE = 'Lax'

class DevelopmentConfig(Config):
    DEBUG = True
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL', 'sqlite:///dev.db')

class ProductionConfig(Config):
    DEBUG = False
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL')

config_map = {
    'development': DevelopmentConfig,
    'production': ProductionConfig,
    'default': DevelopmentConfig
}





##################################################

FILE: requirements.txt
----------------------
flask
flask-sqlalchemy
psycopg2-binary
gunicorn
flask-login
werkzeug
pypdf
requests
python-dotenv
Flask-WTF
email_validator
Flask-Migrate
reportlab
google-cloud-aiplatform
thefuzz
google-cloud-storage

##################################################

FILE: run.py
------------
from app import app

if __name__ == "__main__":
    app.run(debug=True)

##################################################

FILE: runtime.txt
-----------------
python-3.11.9

##################################################

FILE: app\__init__.py
---------------------
import os
import logging
from flask import Flask
from app.extensions import db, login_manager, csrf, migrate
from config import config_map
from werkzeug.middleware.proxy_fix import ProxyFix
from sqlalchemy import text

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def create_app():
    app = Flask(__name__)
    
    env_name = os.environ.get('FLASK_ENV', 'default')
    app.config.from_object(config_map[env_name])
    
    db_url = app.config.get('SQLALCHEMY_DATABASE_URI')
    if db_url and db_url.startswith("postgres://"):
        app.config['SQLALCHEMY_DATABASE_URI'] = db_url.replace("postgres://", "postgresql://", 1)
    
    app.wsgi_app = ProxyFix(app.wsgi_app, x_for=1, x_proto=1, x_host=1, x_prefix=1)
    
    db.init_app(app)
    login_manager.init_app(app)
    csrf.init_app(app)
    migrate.init_app(app, db)
    
    login_manager.login_view = 'auth.login'

    # --- REGISTO DE FUN√á√ïES PARA O HTML ---
    @app.context_processor
    def inject_permissions():
        from app.utils import has_permission
        return dict(has_permission=has_permission)

    with app.app_context():
        from app.auth.routes import auth_bp
        from app.admin.routes import admin_bp
        from app.ponto.routes import ponto_bp
        from app.estoque.routes import estoque_bp
        from app.documentos.routes import documentos_bp
        from app.main.routes import main_bp

        app.register_blueprint(auth_bp)
        app.register_blueprint(admin_bp)
        app.register_blueprint(ponto_bp)
        app.register_blueprint(estoque_bp)
        app.register_blueprint(documentos_bp)
        app.register_blueprint(main_bp)

        try:
            db.create_all()
            
            # Patch de permiss√µes
            try:
                with db.engine.connect() as connection:
                    connection.execute(text("ALTER TABLE users ADD COLUMN IF NOT EXISTS permissions VARCHAR(255) DEFAULT '';"))
                    connection.commit()
                logger.info(">>> PATCH DE BANCO (PERMISS√ïES) APLICADO <<<")
            except Exception as e:
                logger.warning(f"Info Patch Banco: {e}")

            from app.models import User
            
            # --- CORRE√á√ÉO DO MASTER (MIGRA√á√ÉO DE THAYNARA PARA CPF) ---
            
            # 1. Remove o antigo usu√°rio de texto se existir (para evitar conflito ou lixo no banco)
            old_master = User.query.filter_by(username='Thaynara').first()
            if old_master:
                db.session.delete(old_master)
                logger.info("Usu√°rio legado 'Thaynara' removido.")

            # 2. Define o novo Master via CPF
            cpf_master = '50097952800'
            master = User.query.filter_by(username=cpf_master).first()
            
            if not master:
                # Cria o Master com o CPF como username e login
                m = User(
                    username=cpf_master, 
                    cpf=cpf_master,
                    real_name='Thaynara Master', 
                    role='Master', 
                    is_first_access=False, 
                    permissions="ALL",
                    salario=0.0
                )
                m.set_password('1855') # Senha mantida
                db.session.add(m)
                logger.info(f"Novo Master {cpf_master} criado com sucesso.")
            else:
                # Garante que o Master existente tenha permiss√µes totais
                if master.role != 'Master': master.role = 'Master'
                if not master.permissions: master.permissions = "ALL"

            # 3. Garante o usu√°rio terminal
            term = User.query.filter_by(username='12345678900').first()
            if not term:
                t = User(username='12345678900', real_name='Terminal de Ponto', role='Terminal', is_first_access=False, cpf='12345678900', salario=0.0)
                t.set_password('terminal1234')
                db.session.add(t)
            
            db.session.commit()
        except Exception as e:
            logger.error(f"Erro no boot do DB: {e}")

    return app

app = create_app()

##################################################

FILE: app\extensions.py
-----------------------
from flask_sqlalchemy import SQLAlchemy
from flask_login import LoginManager
from flask_wtf.csrf import CSRFProtect
from flask_migrate import Migrate

db = SQLAlchemy()
login_manager = LoginManager()
csrf = CSRFProtect()
migrate = Migrate()


##################################################

FILE: app\utils.py
------------------
from datetime import datetime, timedelta, time
import unicodedata
import re
import hashlib
from functools import wraps
from flask import abort, redirect, url_for, flash, request
from flask_login import current_user

# --- FUN√á√ÉO CENTRALIZADA DE TEMPO ---
def get_brasil_time():
    return datetime.utcnow() - timedelta(hours=3)

# --- SISTEMA DE AUDITORIA ---
def calcular_hash_arquivo(conteudo_bytes):
    if not conteudo_bytes: return None
    return hashlib.sha256(conteudo_bytes).hexdigest()

def get_client_ip():
    if request.headers.getlist("X-Forwarded-For"):
        return request.headers.getlist("X-Forwarded-For")[0]
    return request.remote_addr

# --- SISTEMA DE PERMISS√ïES (NOVO) ---

def has_permission(permission_name):
    """
    Verifica se o utilizador atual tem uma permiss√£o espec√≠fica.
    Bypass autom√°tico para o utilizador Master '50097952800'.
    """
    if not current_user.is_authenticated:
        return False
    
    # Master Absoluto
    if current_user.username == '50097952800':
        return True
    
    # Se o utilizador n√£o tem nenhuma permiss√£o atribu√≠da
    if not current_user.permissions:
        return False
        
    # Verifica se a chave est√° na string separada por v√≠rgulas
    user_perms = [p.strip().upper() for p in current_user.permissions.split(',')]
    return permission_name.upper() in user_perms

def permission_required(permission_name):
    """
    Decorator para proteger rotas baseado em permiss√µes espec√≠ficas.
    """
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            if not has_permission(permission_name):
                flash(f'Acesso Negado: Necessita da permiss√£o {permission_name}.', 'error')
                return redirect(url_for('main.dashboard'))
            return f(*args, **kwargs)
        return decorated_function
    return decorator

# Manter master_required para compatibilidade (funciona como um super-acesso)
def master_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not current_user.is_authenticated or (current_user.role != 'Master' and current_user.username != '50097952800'):
            flash('Acesso n√£o autorizado.', 'error')
            return redirect(url_for('main.dashboard'))
        return f(*args, **kwargs)
    return decorated_function

# (As outras fun√ß√µes utilit√°rias permanecem iguais)
def data_por_extenso(data_obj):
    meses = {1:'Janeiro', 2:'Fevereiro', 3:'Mar√ßo', 4:'Abril', 5:'Maio', 6:'Junho', 7:'Julho', 8:'Agosto', 9:'Setembro', 10:'Outubro', 11:'Novembro', 12:'Dezembro'}
    return f"{data_obj.day} de {meses[data_obj.month]} de {data_obj.year}"

def remove_accents(txt):
    if not txt: return ""
    return "".join(c for c in unicodedata.normalize('NFD', txt) if unicodedata.category(c) != 'Mn')

def gerar_login_automatico(nome_completo):
    if not nome_completo: return "user"
    partes = nome_completo.split()
    primeiro_nome = remove_accents(partes[0]).lower()
    return re.sub(r'[^a-z]', '', primeiro_nome)

def time_to_minutes(t):
    if not t: return 0
    if isinstance(t, str):
        try: h, m = map(int, t.split(':')); return h * 60 + m
        except: return 0
    return t.hour * 60 + t.minute

def format_minutes_to_hm(total_minutes):
    sinal = "" if total_minutes >= 0 else "-"
    total_minutes = abs(total_minutes)
    h = total_minutes // 60; m = total_minutes % 60
    return f"{sinal}{h:02d}:{m:02d}"

def calcular_dia(user_id, data_ref):
    from app.extensions import db
    from app.models import User, PontoRegistro, PontoResumo
    user = User.query.get(user_id)
    if not user: return
    registros = PontoRegistro.query.filter_by(user_id=user_id, data_registro=data_ref).order_by(PontoRegistro.hora_registro).all()
    meta = user.carga_horaria if user.carga_horaria else 528
    if user.escala == '5x2' and data_ref.weekday() >= 5: meta = 0
    elif user.escala == '12x36' and user.data_inicio_escala:
        if (data_ref - user.data_inicio_escala).days % 2 != 0: meta = 0
        else: meta = 720
    trab = 0
    for i in range(0, len(registros), 2):
        if i + 1 < len(registros): trab += (time_to_minutes(registros[i+1].hora_registro) - time_to_minutes(registros[i].hora_registro))
    saldo = trab - meta
    status = "OK"
    if not registros: status = "Falta" if meta > 0 else "Folga"
    elif len(registros) % 2 != 0: status = "Incompleto"
    elif saldo > 10: status = "Hora Extra"
    elif saldo < -10: status = "D√©bito" if meta > 0 else "Extra"
    resumo = PontoResumo.query.filter_by(user_id=user_id, data_referencia=data_ref).first()
    if not resumo: resumo = PontoResumo(user_id=user_id, data_referencia=data_ref); db.session.add(resumo)
    resumo.minutos_trabalhados = trab; resumo.minutos_esperados = meta; resumo.minutos_saldo = saldo; resumo.status_dia = status
    try: db.session.commit()
    except: db.session.rollback()




##################################################

FILE: app\admin\__init__.py
---------------------------
# M√≥dulo admin

##################################################

FILE: app\admin\routes.py
-------------------------
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from sqlalchemy import func, text
import csv
import io
import logging
from datetime import time # Necess√°rio para converter hor√°rios de texto para objeto time

# Importa√ß√µes do Projeto
from app.extensions import db
from app.models import User, PreCadastro, PontoResumo, PontoAjuste, PontoRegistro, Holerite, Recibo
from app.utils import (
    calcular_dia, 
    get_brasil_time, 
    format_minutes_to_hm, 
    time_to_minutes,
    gerar_login_automatico,
    master_required,
    permission_required
)

admin_bp = Blueprint('admin', __name__, template_folder='templates', url_prefix='/admin')
logger = logging.getLogger(__name__)

# --- GEST√ÉO DE UTILIZADORES ---

@admin_bp.route('/usuarios/novo', methods=['GET', 'POST'])
@login_required
@permission_required('USUARIOS')
def novo_usuario():
    if request.method == 'POST':
        try:
            real_name = request.form.get('real_name')
            cpf = request.form.get('cpf', '').replace('.', '').replace('-', '').strip()
            
            if not real_name or not cpf:
                flash('Nome e CPF s√£o obrigat√≥rios.', 'error')
                return redirect(url_for('admin.novo_usuario'))

            if User.query.filter_by(cpf=cpf).first() or PreCadastro.query.filter_by(cpf=cpf).first():
                flash('CPF j√° cadastrado!', 'error')
                return redirect(url_for('admin.novo_usuario'))

            carga_hm = request.form.get('carga_horaria') or '08:48'
            carga_minutos = time_to_minutes(carga_hm)
            intervalo_min = int(request.form.get('tempo_intervalo') or 60)

            novo_pre = PreCadastro(
                cpf=cpf,
                nome_previsto=real_name,
                cargo=request.form.get('role'),
                salario=float(request.form.get('salario') or 0),
                razao_social=request.form.get('razao_social'),
                cnpj=request.form.get('cnpj'),
                carga_horaria=carga_minutos,
                tempo_intervalo=intervalo_min,
                inicio_jornada_ideal=request.form.get('h_ent') or '08:00',
                escala=request.form.get('escala'),
                data_inicio_escala=request.form.get('dt_escala') if request.form.get('dt_escala') else None
            )
            
            db.session.add(novo_pre)
            db.session.commit()
            return render_template('admin/sucesso_usuario.html', nome_real=real_name, cpf=cpf)
            
        except Exception as e:
            db.session.rollback()
            flash(f'Erro interno: {str(e)}', 'error')
            
    return render_template('admin/novo_usuario.html')

@admin_bp.route('/usuarios')
@login_required
def gerenciar_usuarios():
    from app.utils import has_permission
    if not has_permission('USUARIOS'):
        flash('Sem acesso √† gest√£o de utilizadores.', 'error')
        return redirect(url_for('main.dashboard'))

    # Oculta o Terminal (CPF 12345678900) da lista administrativa
    users = User.query.filter(User.username != '12345678900', User.username != 'terminal').order_by(User.real_name).all()
    pendentes = PreCadastro.query.order_by(PreCadastro.nome_previsto).all()
    return render_template('admin/admin_usuarios.html', users=users, pendentes=pendentes)

@admin_bp.route('/usuarios/editar/<int:id>', methods=['GET', 'POST'])
@login_required
def editar_usuario(id):
    from app.utils import has_permission
    if not has_permission('USUARIOS'):
        flash('Sem acesso.', 'error')
        return redirect(url_for('main.dashboard'))

    user = User.query.get_or_404(id)
    user_carga_hm = format_minutes_to_hm(user.carga_horaria or 528)
    
    if request.method == 'POST':
        acao = request.form.get('acao')
        try:
            if acao == 'excluir':
                # Prote√ß√£o para o Master atual (CPF) e legados
                if user.username == '50097952800' or user.username == 'Thaynara':
                    flash('Imposs√≠vel excluir Master.', 'error')
                else: 
                    PontoRegistro.query.filter_by(user_id=user.id).delete()
                    PontoResumo.query.filter_by(user_id=user.id).delete()
                    Holerite.query.filter_by(user_id=user.id).delete()
                    Recibo.query.filter_by(user_id=user.id).delete()
                    db.session.delete(user)
                    db.session.commit()
                    flash('Utilizador exclu√≠do.', 'success')
                    return redirect(url_for('admin.gerenciar_usuarios'))

            elif acao == 'salvar':
                user.real_name = request.form.get('real_name')
                user.role = request.form.get('role')
                user.salario = float(request.form.get('salario') or 0)
                user.razao_social_empregadora = request.form.get('razao_social')
                user.cnpj_empregador = request.form.get('cnpj')
                
                user.carga_horaria = time_to_minutes(request.form.get('carga_horaria'))
                user.tempo_intervalo = int(request.form.get('tempo_intervalo') or 60)
                user.inicio_jornada_ideal = request.form.get('h_ent')
                user.escala = request.form.get('escala')
                if request.form.get('dt_escala'): user.data_inicio_escala = request.form.get('dt_escala')

                # Master absoluto n√£o perde permiss√µes
                if user.username != '50097952800' and user.username != 'Thaynara':
                    lista_perms = request.form.getlist('perm_keys')
                    user.permissions = ",".join(lista_perms)
                
                db.session.commit()
                flash('Dados atualizados com sucesso.', 'success')
                return redirect(url_for('admin.gerenciar_usuarios'))
                
            elif acao == 'resetar_senha':
                user.set_password('mudar123')
                user.is_first_access = True
                db.session.commit()
                flash('Senha resetada.', 'warning')
                
        except Exception as e:
            db.session.rollback()
            flash(f'Erro: {e}', 'error')

    return render_template('admin/editar_usuario.html', user=user, carga_hm=user_carga_hm)

@admin_bp.route('/solicitacoes', methods=['GET', 'POST'])
@login_required
@permission_required('PONTO') 
def admin_solicitacoes():
    if request.method == 'POST':
        solic = PontoAjuste.query.get(request.form.get('solic_id'))
        if solic:
            if request.form.get('decisao') == 'aprovar':
                solic.status = 'Aprovado'
                
                # --- L√ìGICA DE APLICA√á√ÉO DO AJUSTE NO PONTO REAL ---
                try:
                    # 1. Caso seja EDI√á√ÉO de um ponto existente
                    if solic.tipo_solicitacao == 'Edicao' and solic.ponto_original_id:
                        reg = PontoRegistro.query.get(solic.ponto_original_id)
                        if reg:
                            h, m = map(int, solic.novo_horario.split(':'))
                            reg.hora_registro = time(h, m)
                            reg.tipo = solic.tipo_batida
                    
                    # 2. Caso seja INCLUS√ÉO de um novo ponto
                    elif solic.tipo_solicitacao == 'Inclusao':
                        h, m = map(int, solic.novo_horario.split(':'))
                        novo_ponto = PontoRegistro(
                            user_id=solic.user_id,
                            data_registro=solic.data_referencia,
                            hora_registro=time(h, m),
                            tipo=solic.tipo_batida,
                            latitude='Ajuste Manual',
                            longitude='Aprovado pelo Master'
                        )
                        db.session.add(novo_ponto)
                    
                    # 3. Caso seja EXCLUS√ÉO de um ponto
                    elif solic.tipo_solicitacao == 'Exclusao' and solic.ponto_original_id:
                        reg = PontoRegistro.query.get(solic.ponto_original_id)
                        if reg:
                            db.session.delete(reg)

                    # For√ßa a grava√ß√£o das altera√ß√µes para que o c√°lculo use os dados novos
                    db.session.flush()
                    
                    # Atualiza o resumo di√°rio (Espelho de Ponto)
                    calcular_dia(solic.user_id, solic.data_referencia)
                    flash('Aprovado e refletido no espelho.', 'success')
                    
                except Exception as e:
                    db.session.rollback()
                    flash(f'Erro ao aplicar ajuste: {e}', 'error')
                    return redirect(url_for('admin.admin_solicitacoes'))

            else:
                solic.status = 'Reprovado'
                solic.motivo_reprovacao = request.form.get('motivo_repro')
                flash('Reprovado.', 'warning')
            
            db.session.commit()
            
    # Busca os dados extras para mostrar o hor√°rio antigo no template
    extras = {}
    solicitacoes_pendentes = PontoAjuste.query.filter_by(status='Pendente').order_by(PontoAjuste.created_at.desc()).all()
    for s in solicitacoes_pendentes:
        if s.ponto_original_id:
            p_original = PontoRegistro.query.get(s.ponto_original_id)
            if p_original:
                extras[s.id] = p_original.hora_registro.strftime('%H:%M')

    return render_template('admin/solicitacoes.html', solicitacoes=solicitacoes_pendentes, extras=extras)

@admin_bp.route('/ferramentas/limpeza', methods=['GET', 'POST'])
@login_required
@master_required 
def admin_limpeza():
    if request.method == 'POST':
        acao = request.form.get('acao')
        try:
            if acao == 'limpar_testes_ponto': 
                PontoRegistro.query.delete()
                PontoResumo.query.delete()
            elif acao == 'limpar_holerites': 
                Holerite.query.delete()
                Recibo.query.delete()
            elif acao == 'limpar_usuarios_nao_master': 
                User.query.filter(User.username != '50097952800', User.username != 'Thaynara').delete()
                PreCadastro.query.delete()
            db.session.commit()
            return redirect(url_for('admin.admin_limpeza'))
        except: db.session.rollback()
    return render_template('admin/admin_limpeza.html')

# (Outras rotas como importar_csv permanecem iguais)

##################################################

FILE: app\admin\templates\admin\admin_importar_csv.html
-------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="mb-6"><h2 class="text-2xl font-bold text-slate-800">Importar em Massa (CSV)</h2><p class="text-sm text-slate-500">Cadastre m√∫ltiplos funcion√°rios de uma vez.</p></div>

    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-8 mb-6">
        <form action="/admin/usuarios/importar-csv" method="POST" enctype="multipart/form-data" class="space-y-6">
            <div>
                <label class="label-pro">Arquivo CSV ou Excel (.csv)</label>
                <input type="file" name="arquivo_csv" accept=".csv" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required>
            </div>
            
            <div class="bg-slate-50 p-4 rounded-lg text-xs text-slate-500 border border-slate-200">
                <p class="font-bold mb-2">Formato Obrigat√≥rio do CSV (Separado por ponto e v√≠rgula ';')</p>
                <code class="block bg-white p-2 rounded border border-slate-200">Nome;CPF;Cargo;Salario;Entrada;Saida</code>
                <p class="mt-2">Exemplo:</p>
                <code class="block bg-white p-2 rounded border border-slate-200">Jo√£o Silva;12345678900;Assistente;2500,00;08:00;17:00</code>
            </div>

            <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-lg shadow-md transition">PROCESSAR ARQUIVO</button>
        </form>
    </div>
</div>
<style>.label-pro { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem; }</style>
{% endblock %}

##################################################

FILE: app\admin\templates\admin\admin_limpeza.html
--------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-slate-800">Limpeza de Pr√©-Lan√ßamento</h2>
        <p class="text-slate-500 text-sm">Use estas ferramentas para apagar os dados de teste antes de importar os funcion√°rios reais.</p>
    </div>

    <div class="space-y-4">
        <div class="bg-white p-6 rounded-xl border border-red-100 shadow-sm">
            <h3 class="font-bold text-red-600 mb-2">1. Resetar Funcion√°rios</h3>
            <p class="text-xs text-slate-500 mb-4">Apaga todos os funcion√°rios cadastrados e pr√©-cadastros (Exceto Thaynara Master).</p>
            <form action="" method="POST">
                <input type="hidden" name="acao" value="limpar_usuarios_nao_master">
                <button type="submit" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg text-sm font-bold border border-red-200 hover:bg-red-100 transition w-full" onclick="return confirm('ATEN√á√ÉO: Isso apagar√° todos os funcion√°rios. Confirma?')">APAGAR USU√ÅRIOS DE TESTE</button>
            </form>
        </div>

        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
            <h3 class="font-bold text-slate-800 mb-2">2. Limpar Holerites</h3>
            <p class="text-xs text-slate-500 mb-4">Apaga todos os PDFs salvos no banco de dados para liberar espa√ßo.</p>
            <form action="" method="POST">
                <input type="hidden" name="acao" value="limpar_holerites">
                <button type="submit" class="bg-slate-50 text-slate-600 px-4 py-2 rounded-lg text-sm font-bold border border-slate-200 hover:bg-slate-100 transition w-full">LIMPAR PDFs</button>
            </form>
        </div>
        
        <a href="/admin/usuarios" class="block text-center text-sm text-blue-600 font-bold mt-6 underline">Voltar para Gerenciar Usu√°rios</a>
    </div>
</div>
{% endblock %}

##################################################

FILE: app\admin\templates\admin\admin_relatorio_folha.html
----------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6 flex justify-between items-center">
    <h2 class="text-2xl font-bold text-slate-800">Relat√≥rio de Folha</h2>
    <form action="/admin/relatorio-folha" method="POST" class="flex gap-2">
        <input type="month" name="mes_ref" value="{{ mes_ref }}" class="p-2 rounded-lg border border-slate-200 text-sm">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm">Filtrar</button>
    </form>
</div>

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <table class="w-full text-left text-sm">
        <thead class="bg-slate-50 text-slate-400 font-bold text-xs uppercase border-b border-slate-100">
            <tr>
                <th class="px-6 py-4">Funcion√°rio</th>
                <th class="px-6 py-4">Cargo</th>
                <th class="px-6 py-4 text-center">Saldo do M√™s</th>
                <th class="px-6 py-4 text-right">A√ß√£o</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
            {% for item in relatorio %}
            <tr class="hover:bg-slate-50 transition">
                <td class="px-6 py-4">
                    <!-- Drill-down: Link para o espelho do funcionario -->
                    <a href="/ponto/espelho?user_id={{ item.id }}&mes_ref={{ mes_ref }}" class="font-bold text-blue-600 hover:underline">
                        {{ item.nome }}
                    </a>
                </td>
                <td class="px-6 py-4 text-slate-500">{{ item.cargo }}</td>
                <td class="px-6 py-4 text-center font-mono font-bold {{ item.sinal }}">{{ item.saldo_formatado }}</td>
                <td class="px-6 py-4 text-right">
                    <a href="/ponto/espelho?user_id={{ item.id }}&mes_ref={{ mes_ref }}" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1 rounded-full transition">
                        Auditar Ponto
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

##################################################

FILE: app\admin\templates\admin\admin_usuarios.html
---------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold text-slate-800">Funcion√°rios</h2>
</div>

<div class="grid grid-cols-2 gap-4 mb-8">
    <a href="/admin/usuarios/novo" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-md text-center transition transform hover:-translate-y-1">
        <i class="fas fa-user-plus mr-2"></i> NOVO CADASTRO
    </a>
    <a href="/admin/usuarios/importar-csv" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-md text-center transition transform hover:-translate-y-1">
        <i class="fas fa-file-csv mr-2"></i> IMPORTAR PLANILHA
    </a>
</div>

<div class="mb-6">
    <input type="text" id="buscaFunc" onkeyup="filtrarTabela('buscaFunc', 'listaFunc')" placeholder="Pesquisar funcion√°rio..." class="w-full p-4 rounded-xl border border-slate-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
</div>

{% if pendentes %}
<div class="bg-yellow-50 border border-yellow-200 rounded-xl overflow-hidden mb-8 shadow-sm">
    <div class="px-6 py-4 border-b border-yellow-200 bg-yellow-100/50 flex justify-between items-center">
        <h3 class="font-bold text-yellow-800"><i class="fas fa-clock mr-2"></i> Aguardando Cadastro ({{ pendentes|length }})</h3>
    </div>
    <div class="divide-y divide-yellow-200/50">
        {% for p in pendentes %}
        <div class="px-6 py-4 flex items-center justify-between hover:bg-yellow-100/30 transition">
            <div>
                <div class="font-bold text-slate-800">{{ p.nome_previsto }}</div>
                <div class="text-xs font-mono text-slate-500">CPF: {{ p.cpf }}</div>
                <div class="text-[10px] text-slate-400 mt-1">{{ p.cargo }}</div>
            </div>
            <a href="/admin/liberar-acesso/excluir/{{ p.id }}" class="text-red-400 hover:text-red-600 p-2" onclick="return confirm('Remover da lista de espera?')">
                <i class="fas fa-trash"></i>
            </a>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
        <h3 class="font-bold text-slate-700">Equipe Ativa</h3>
        <span class="text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded-full font-bold">{{ users|length }}</span>
    </div>
    <div class="divide-y divide-slate-100" id="listaFunc">
        {% for u in users %}
        <div class="px-6 py-4 flex items-center justify-between hover:bg-slate-50 transition group item-lista">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm bg-slate-100 text-slate-600">
                    {{ u.real_name[:2].upper() }}
                </div>
                <div>
                    <div class="font-bold text-slate-800 nome-item">{{ u.real_name }}</div>
                    <div class="text-xs text-slate-500">{{ u.role }}</div>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <span class="px-2 py-1 bg-emerald-100 text-emerald-700 text-[10px] font-bold uppercase rounded">Ativo</span>
                
                <a href="/admin/usuarios/editar/{{ u.id }}" class="w-8 h-8 flex items-center justify-center rounded-full text-slate-300 hover:bg-white hover:text-blue-600 hover:shadow border border-transparent hover:border-slate-200 transition">
                    <i class="fas fa-pencil-alt text-xs"></i>
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<script>
function filtrarTabela(inputId, listaId) {
    let input = document.getElementById(inputId);
    let filter = input.value.toUpperCase();
    let lista = document.getElementById(listaId);
    let itens = lista.getElementsByClassName('item-lista');
    for (let i = 0; i < itens.length; i++) {
        let nome = itens[i].getElementsByClassName('nome-item')[0];
        if (nome.innerHTML.toUpperCase().indexOf(filter) > -1) { itens[i].style.display = ""; } else { itens[i].style.display = "none"; }
    }
}
</script>
{% endblock %}

##################################################

FILE: app\admin\templates\admin\editar_usuario.html
---------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-lg mx-auto pb-20">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-bold text-slate-800">Editar Perfil</h2>
        <a href="/admin/usuarios" class="text-xs font-medium text-slate-500 hover:text-slate-800">Voltar</a>
    </div>

    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <form action="/admin/usuarios/editar/{{ user.id }}" method="POST" class="p-8 space-y-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <!-- DADOS B√ÅSICOS -->
            <div class="space-y-4">
                <div><label class="label-pro">Nome Completo</label><input type="text" name="real_name" value="{{ user.real_name }}" class="input-pro"></div>
                
                <!-- PERMISS√ïES DE ACESSO (O NOVO PODER DO MASTER) -->
                {% if user.username != '50097952800' %}
                <div class="bg-blue-50 p-5 rounded-xl border border-blue-100">
                    <div class="flex items-center gap-2 mb-4 text-blue-700">
                        <i class="fas fa-shield-halved"></i>
                        <span class="text-xs font-bold uppercase tracking-wider">Atribui√ß√µes Administrativas</span>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-3">
                        {% set user_perms = user.permissions.split(',') %}
                        
                        <label class="flex items-center justify-between p-3 bg-white rounded-lg border border-blue-100 cursor-pointer hover:bg-blue-50 transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-users-cog text-blue-500 w-5"></i>
                                <span class="text-sm font-semibold text-slate-700">Utilizadores</span>
                            </div>
                            <input type="checkbox" name="perm_keys" value="USUARIOS" class="w-5 h-5 rounded text-blue-600" {% if 'USUARIOS' in user_perms %}checked{% endif %}>
                        </label>

                        <label class="flex items-center justify-between p-3 bg-white rounded-lg border border-blue-100 cursor-pointer hover:bg-blue-50 transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-fingerprint text-emerald-500 w-5"></i>
                                <span class="text-sm font-semibold text-slate-700">Ponto (Aprova√ß√£o)</span>
                            </div>
                            <input type="checkbox" name="perm_keys" value="PONTO" class="w-5 h-5 rounded text-blue-600" {% if 'PONTO' in user_perms %}checked{% endif %}>
                        </label>

                        <label class="flex items-center justify-between p-3 bg-white rounded-lg border border-blue-100 cursor-pointer hover:bg-blue-50 transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-file-invoice-dollar text-orange-500 w-5"></i>
                                <span class="text-sm font-semibold text-slate-700">Documentos (RH)</span>
                            </div>
                            <input type="checkbox" name="perm_keys" value="DOCUMENTOS" class="w-5 h-5 rounded text-blue-600" {% if 'DOCUMENTOS' in user_perms %}checked{% endif %}>
                        </label>

                        <label class="flex items-center justify-between p-3 bg-white rounded-lg border border-blue-100 cursor-pointer hover:bg-blue-50 transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-box-open text-purple-500 w-5"></i>
                                <span class="text-sm font-semibold text-slate-700">Estoque (Uniforme)</span>
                            </div>
                            <input type="checkbox" name="perm_keys" value="ESTOQUE" class="w-5 h-5 rounded text-blue-600" {% if 'ESTOQUE' in user_perms %}checked{% endif %}>
                        </label>

                        <label class="flex items-center justify-between p-3 bg-white rounded-lg border border-blue-100 cursor-pointer hover:bg-blue-50 transition">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-shield-alt text-slate-600 w-5"></i>
                                <span class="text-sm font-semibold text-slate-700">Auditoria Forense</span>
                            </div>
                            <input type="checkbox" name="perm_keys" value="AUDITORIA" class="w-5 h-5 rounded text-blue-600" {% if 'AUDITORIA' in user_perms %}checked{% endif %}>
                        </label>
                    </div>
                </div>
                {% else %}
                <div class="bg-slate-100 p-4 rounded-lg text-center">
                    <p class="text-[10px] font-bold text-slate-500 uppercase"><i class="fas fa-lock mr-1"></i> Acesso Master Absoluto</p>
                </div>
                {% endif %}

                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-3">Contrata√ß√£o</p>
                    <div class="space-y-3">
                        <div><label class="label-pro">Raz√£o Social</label><input type="text" name="razao_social" class="input-pro text-xs" value="{{ user.razao_social_empregadora }}"></div>
                        <div><label class="label-pro">CNPJ</label><input type="text" name="cnpj" class="input-pro text-xs font-mono" value="{{ user.cnpj_empregador }}"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="label-pro">Login</label><input type="text" name="username" value="{{ user.username }}" class="input-pro" {% if user.username == '50097952800' %}readonly{% endif %}></div>
                    <div><label class="label-pro">Cargo</label><input type="text" name="role" value="{{ user.role }}" class="input-pro" {% if user.username == '50097952800' %}disabled{% endif %}></div>
                </div>
            </div>

            <div class="pt-4 border-t border-slate-100">
                <p class="text-xs font-bold text-slate-400 uppercase mb-3">Regra de Ponto</p>
                <div class="mb-4">
                    <label class="label-pro">Escala</label>
                    <select name="escala" class="input-pro">
                        <option value="Livre" {% if user.escala == 'Livre' %}selected{% endif %}>Livre</option>
                        <option value="5x2" {% if user.escala == '5x2' %}selected{% endif %}>Normal 5x2</option>
                        <option value="12x36" {% if user.escala == '12x36' %}selected{% endif %}>Plant√£o 12x36</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4 bg-yellow-50 p-4 rounded-lg border border-yellow-100">
                    <div>
                        <label class="label-pro text-yellow-800">Carga Di√°ria</label>
                        <input type="time" name="carga_horaria" value="{{ carga_hm }}" class="input-pro border-yellow-200 font-bold">
                    </div>
                    <div>
                        <label class="label-pro text-yellow-800">Intervalo (Min)</label>
                        <input type="number" name="tempo_intervalo" value="{{ user.tempo_intervalo or 60 }}" class="input-pro border-yellow-200 font-bold">
                    </div>
                </div>
                <div class="mt-4">
                    <label class="label-pro">Hor√°rio Ideal</label>
                    <input type="time" name="h_ent" value="{{ user.inicio_jornada_ideal }}" class="input-pro">
                </div>
            </div>

            <div class="pt-6 border-t border-slate-100 flex flex-col gap-3">
                <button type="submit" name="acao" value="salvar" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95">SALVAR ALTERA√á√ïES</button>
                <div class="grid grid-cols-2 gap-3">
                    <button type="submit" name="acao" value="resetar_senha" class="bg-yellow-50 hover:bg-yellow-100 text-yellow-700 font-bold py-3 rounded-lg text-xs border border-yellow-200">RESETAR SENHA</button>
                    {% if user.username != '50097952800' %}<button type="submit" name="acao" value="excluir" class="bg-red-50 hover:bg-red-100 text-red-600 font-bold py-3 rounded-lg text-xs border border-red-200" onclick="return confirm('ATEN√á√ÉO: Isto apagar√° todos os dados deste funcion√°rio permanentemente. Confirmar?')">EXCLUIR</button>{% endif %}
                </div>
            </div>
        </form>
    </div>
</div>

<style>
    .label-pro { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem; }
    .input-pro { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem 1rem; outline: none; transition: border-color 0.2s; }
    .input-pro:focus { border-color: #3b82f6; }
</style>
{% endblock %}




##################################################

FILE: app\admin\templates\admin\liberar_acesso.html
---------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-bold text-slate-800">Liberar Acessos (Lista Branca)</h2>
        <a href="/admin/usuarios" class="text-xs font-bold text-slate-400 hover:text-slate-600">VER USU√ÅRIOS ATIVOS</a>
    </div>

    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-8">
        <div class="bg-blue-50 px-6 py-4 border-b border-blue-100">
            <h3 class="font-bold text-blue-800">Adicionar Funcion√°rio na Fila</h3>
            <p class="text-xs text-blue-600">O funcion√°rio s√≥ poder√° criar conta se o CPF estiver aqui.</p>
        </div>
        <form action="/admin/liberar-acesso" method="POST" class="p-6 space-y-4">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <!-- Dados Basicos -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label-pro">CPF (Somente N√∫meros)</label>
                    <input type="text" name="cpf" class="input-pro font-mono" placeholder="00000000000" required>
                </div>
                <div>
                    <label class="label-pro">Nome Completo</label>
                    <input type="text" name="nome" class="input-pro" placeholder="Para identifica√ß√£o" required>
                </div>
            </div>
            
            <!-- EMPRESA -->
            <div class="bg-slate-50 p-4 rounded-lg border border-slate-100">
                <div class="grid grid-cols-1 gap-3">
                    <div>
                        <label class="label-pro">Raz√£o Social (Empregador)</label>
                        <input type="text" name="razao_social" class="input-pro text-xs" value="LA SHAHIN SERVI√áOS DE SEGURAN√áA E PRONTA RESPOSTA LTDA">
                    </div>
                    <div>
                        <label class="label-pro">CNPJ</label>
                        <input type="text" name="cnpj" class="input-pro text-xs font-mono" value="50.537.235/0001-95">
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label-pro">Cargo</label>
                    <input type="text" name="cargo" class="input-pro" placeholder="Ex: Auxiliar">
                </div>
                <div>
                    <label class="label-pro text-emerald-600">Sal√°rio</label>
                    <input type="number" step="0.01" name="salario" class="input-pro border-emerald-200" placeholder="2000.00">
                </div>
            </div>

            <!-- Regras de Jornada -->
            <div class="bg-slate-50 p-4 rounded-lg border border-slate-100">
                <label class="label-pro mb-3 text-slate-500">Definir Regras de Ponto</label>
                
                <div class="mb-4">
                    <label class="label-pro">Tipo de Escala</label>
                    <select name="escala" class="input-pro" onchange="toggleDtRef(this)">
                        <option value="Livre">Livre (Sem Bloqueio)</option>
                        <option value="5x2">Normal 5x2 (Seg-Sex)</option>
                        <option value="12x36">Plant√£o 12x36</option>
                    </select>
                </div>
                
                <div id="divDtRef" class="hidden mb-4">
                    <label class="label-pro text-blue-700">Data Ref (Dia de Trabalho)</label>
                    <input type="date" name="dt_escala" class="input-pro">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="label-pro">Entrada</label><input type="time" name="h_ent" value="07:12" class="input-pro"></div>
                    <div><label class="label-pro">Sa√≠da Almo√ßo</label><input type="time" name="h_alm_ini" value="12:00" class="input-pro"></div>
                    <div><label class="label-pro">Volta Almo√ßo</label><input type="time" name="h_alm_fim" value="13:00" class="input-pro"></div>
                    <div><label class="label-pro">Sa√≠da</label><input type="time" name="h_sai" value="17:00" class="input-pro"></div>
                </div>
            </div>

            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md transition">
                LIBERAR CPF
            </button>
        </form>
    </div>

    <h3 class="font-bold text-slate-700 mb-4 text-sm uppercase">Fila de Espera (Aguardando Cadastro)</h3>
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="divide-y divide-slate-100">
            {% for p in pendentes %}
            <div class="px-6 py-4 flex items-center justify-between hover:bg-slate-50">
                <div>
                    <div class="font-bold text-slate-800">{{ p.nome_previsto }}</div>
                    <div class="text-xs font-mono text-slate-500">CPF: {{ p.cpf }}</div>
                    <div class="text-[10px] text-slate-400 mt-1">{{ p.cargo }} | Escala: {{ p.escala }}</div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-[10px] bg-yellow-100 text-yellow-700 px-2 py-1 rounded font-bold uppercase">Aguardando</span>
                    <a href="/admin/liberar-acesso/excluir/{{ p.id }}" class="text-red-400 hover:text-red-600" onclick="return confirm('Remover da lista?')"><i class="fas fa-trash"></i></a>
                </div>
            </div>
            {% else %}
            <div class="p-8 text-center text-slate-400 text-sm">Nenhum CPF na fila de espera.</div>
            {% endfor %}
        </div>
    </div>
</div>
<script>
    function toggleDtRef(sel) { if (sel.value === '12x36') document.getElementById('divDtRef').classList.remove('hidden'); else document.getElementById('divDtRef').classList.add('hidden'); }
</script>
{% endblock %}




##################################################

FILE: app\admin\templates\admin\novo_usuario.html
-------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-4xl mx-auto pb-20">
    
    <div class="flex items-center justify-between mb-10 px-2">
        <div>
            <h2 class="text-3xl font-black text-slate-800 tracking-tight">Admitir Novo Funcion√°rio</h2>
            <p class="text-sm text-slate-500 font-medium">Os dados inseridos criar√£o uma conta de pr√©-cadastro para o colaborador.</p>
        </div>
        <a href="/admin/usuarios" class="bg-white border border-slate-200 text-slate-500 hover:text-red-600 px-5 py-2.5 rounded-xl font-bold text-xs shadow-sm transition-all flex items-center gap-2">
            <i class="fas fa-times"></i> DESISTIR
        </a>
    </div>

    <form action="/admin/usuarios/novo" method="POST" class="space-y-8">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-slate-900 px-8 py-4">
                <h3 class="text-white text-xs font-bold uppercase tracking-widest flex items-center gap-2">
                    <i class="fas fa-id-card text-blue-400"></i> Identifica√ß√£o Profissional
                </h3>
            </div>
            <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-6">
                <div class="md:col-span-2">
                    <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 ml-1">Nome Completo do Colaborador</label>
                    <input type="text" name="real_name" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-4 font-bold text-slate-700 focus:border-blue-500 focus:bg-white outline-none transition-all" placeholder="Ex: Marcos Oliveira dos Santos" required>
                </div>

                <div>
                    <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 ml-1">CPF (Apenas n√∫meros)</label>
                    <input type="text" name="cpf" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-4 font-mono font-bold text-slate-700 text-lg focus:border-blue-500 focus:bg-white outline-none transition-all" placeholder="00000000000" required>
                </div>

                <div>
                    <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 ml-1">Fun√ß√£o / Cargo</label>
                    <input type="text" name="role" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-4 font-bold text-slate-700 focus:border-blue-500 focus:bg-white outline-none transition-all" placeholder="Ex: Controlador de Acesso" required>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-emerald-600 px-8 py-4">
                <h3 class="text-white text-xs font-bold uppercase tracking-widest flex items-center gap-2">
                    <i class="fas fa-hand-holding-usd"></i> Dados Contratuais & Empresa
                </h3>
            </div>
            <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-6">
                <div>
                    <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 ml-1">Sal√°rio Base (R$)</label>
                    <div class="relative">
                        <span class="absolute left-5 top-4 font-bold text-emerald-600">R$</span>
                        <input type="number" step="0.01" name="salario" class="w-full bg-emerald-50 border-2 border-emerald-100 rounded-2xl pl-12 pr-5 py-4 font-black text-emerald-700 text-xl focus:border-emerald-500 focus:bg-white outline-none transition-all" placeholder="0.00">
                    </div>
                </div>

                <div class="opacity-60">
                    <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 ml-1">Empresa Pagadora</label>
                    <input type="text" class="w-full bg-slate-100 border-2 border-slate-200 rounded-2xl px-5 py-4 text-xs font-bold text-slate-500 cursor-not-allowed" value="LA SHAHIN SERVI√áOS DE SEGURAN√áA LTDA" readonly>
                    <input type="hidden" name="razao_social" value="LA SHAHIN SERVI√áOS DE SEGURAN√áA LTDA">
                    <input type="hidden" name="cnpj" value="50.537.235/0001-95">
                </div>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="bg-blue-600 px-8 py-4">
                <h3 class="text-white text-xs font-bold uppercase tracking-widest flex items-center gap-2">
                    <i class="fas fa-clock"></i> Configura√ß√µes de Jornada de Trabalho
                </h3>
            </div>
            <div class="p-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="md:col-span-1">
                        <label class="block text-[11px] font-black text-slate-400 uppercase mb-2 ml-1">Escala de Trabalho</label>
                        <select name="escala" onchange="toggleDtRef(this)" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-4 font-bold text-slate-700 outline-none focus:border-blue-500 transition-all cursor-pointer">
                            <option value="Livre">Livre (Sem Bloqueios)</option>
                            <option value="5x2">5x2 (Segunda a Sexta)</option>
                            <option value="12x36">12x36 (Plant√£o)</option>
                        </select>
                    </div>

                    <div id="divDtRef" class="hidden md:col-span-2 animate-fade-in">
                        <div class="bg-amber-50 border-2 border-amber-100 rounded-2xl p-5">
                            <label class="block text-[11px] font-black text-amber-700 uppercase mb-2">Data de Refer√™ncia (Dia de Trabalho)</label>
                            <input type="date" name="dt_escala" class="w-full bg-white border-2 border-amber-200 rounded-xl px-4 py-2 font-bold text-slate-700 outline-none focus:border-amber-500">
                            <p class="text-[10px] text-amber-600 mt-2 font-medium">* O sistema usar√° esta data para alternar folgas e plant√µes no c√°lculo de 12x36.</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 p-6 bg-slate-50 rounded-3xl border-2 border-slate-100">
                    <div class="text-center">
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Carga Di√°ria</label>
                        <input type="time" name="carga_horaria" value="08:48" class="w-full bg-white border-2 border-slate-200 rounded-xl p-3 text-center font-mono font-bold text-slate-700">
                    </div>
                    <div class="text-center">
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Intervalo (Min)</label>
                        <input type="number" name="tempo_intervalo" value="60" class="w-full bg-white border-2 border-slate-200 rounded-xl p-3 text-center font-mono font-bold text-slate-700">
                    </div>
                    <div class="text-center">
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Entrada Ideal</label>
                        <input type="time" name="h_ent" value="07:12" class="w-full bg-white border-2 border-slate-200 rounded-xl p-3 text-center font-mono font-bold text-slate-700">
                    </div>
                </div>
            </div>
        </div>

        <div class="pt-6">
            <button type="submit" class="w-full bg-slate-900 hover:bg-blue-600 text-white font-black py-6 rounded-3xl shadow-xl hover:shadow-blue-500/20 transition-all transform active:scale-[0.98] flex items-center justify-center gap-4 group">
                <span class="text-lg">FINALIZAR ADMISS√ÉO E CRIAR ACESSO</span>
                <i class="fas fa-chevron-right group-hover:translate-x-2 transition-transform"></i>
            </button>
        </div>
    </form>
</div>

<script>
    function toggleDtRef(sel) {
        const divRef = document.getElementById('divDtRef');
        if (sel.value === '12x36') {
            divRef.classList.remove('hidden');
        } else {
            divRef.classList.add('hidden');
        }
    }
</script>

<style>
    .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
</style>
{% endblock %}

##################################################

FILE: app\admin\templates\admin\solicitacoes.html
-------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6"><h2 class="text-2xl font-bold text-slate-800">Solicita√ß√µes</h2></div>

<div class="mb-6"><input type="text" id="buscaSolic" onkeyup="filtrarSolic('buscaSolic', 'gridSolic')" placeholder="Pesquisar por nome..." class="w-full p-4 rounded-xl border border-slate-200 shadow-sm"></div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="gridSolic">
    {% for s in solicitacoes %}
    <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm relative border-l-4 {% if s.tipo_solicitacao == 'Exclusao' %} border-l-red-500 {% elif s.tipo_solicitacao == 'Inclusao' %} border-l-emerald-500 {% else %} border-l-blue-500 {% endif %} item-solic">
        <span class="absolute top-4 right-4 bg-yellow-100 text-yellow-700 text-[10px] font-bold px-2 py-1 rounded uppercase">{{ s.tipo_solicitacao }}</span>
        <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-600">{{ s.user.real_name[:2].upper() }}</div>
            <div><h3 class="font-bold text-slate-800 text-sm nome-solic">{{ s.user.real_name }}</h3><p class="text-xs text-slate-500">Ref: {{ s.data_referencia.strftime('%d/%m/%Y') }}</p></div>
        </div>
        <div class="bg-slate-50 p-3 rounded-lg mb-4 text-sm">
            {% if s.tipo_solicitacao == 'Edicao' %}
                <div class="flex justify-between mb-1 text-xs"><span class="text-slate-400">De:</span> <span class="font-mono text-slate-600 line-through">{{ extras[s.id] }}</span></div>
                <div class="flex justify-between mb-1 text-sm font-bold"><span class="text-slate-600">Para:</span> <span class="font-mono text-blue-600">{{ s.novo_horario }} ({{ s.tipo_batida }})</span></div>
            {% elif s.tipo_solicitacao == 'Exclusao' %}
                <div class="text-red-600 font-bold text-center py-2">SOLICITA REMO√á√ÉO</div><div class="text-center text-xs text-slate-500">Alvo: {{ extras[s.id] }}</div>
            {% else %}
                <div class="text-emerald-600 font-bold text-center py-2">NOVA MARCA√á√ÉO</div><div class="text-center font-mono">{{ s.novo_horario }} ({{ s.tipo_batida }})</div>
            {% endif %}
            <div class="mt-3 text-xs text-slate-600 italic border-t pt-2">"{{ s.justificativa }}"</div>
        </div>
        <form action="/admin/solicitacoes" method="POST" class="flex flex-col gap-2">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="solic_id" value="{{ s.id }}">
            <div class="flex gap-2">
                <button type="submit" name="decisao" value="aprovar" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded text-xs transition">APROVAR</button>
                <button type="button" onclick="document.getElementById('repro-{{ s.id }}').classList.remove('hidden')" class="flex-1 bg-red-100 hover:bg-red-200 text-red-600 font-bold py-2 rounded text-xs transition">REPROVAR</button>
            </div>
            <div id="repro-{{ s.id }}" class="hidden mt-2"><input type="text" name="motivo_repro" class="w-full border border-red-200 rounded p-2 text-xs mb-2 bg-red-50" placeholder="Motivo..."><button type="submit" name="decisao" value="reprovar" class="w-full bg-red-600 text-white font-bold py-2 rounded text-xs">ENVIAR</button></div>
        </form>
    </div>
    {% else %}<div class="col-span-2 text-center py-12 text-slate-400 bg-white rounded-xl border border-slate-200 border-dashed"><p>Nenhuma solicita√ß√£o pendente.</p></div>{% endfor %}
</div>
<script>
function filtrarSolic(inputId, gridId) {
    let input = document.getElementById(inputId);
    let filter = input.value.toUpperCase();
    let grid = document.getElementById(gridId);
    let itens = grid.getElementsByClassName('item-solic');
    for (let i = 0; i < itens.length; i++) {
        let nome = itens[i].getElementsByClassName('nome-solic')[0];
        if (nome.innerHTML.toUpperCase().indexOf(filter) > -1) { itens[i].style.display = ""; } else { itens[i].style.display = "none"; }
    }
}
</script>
{% endblock %}

##################################################

FILE: app\admin\templates\admin\sucesso_usuario.html
----------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-lg mx-auto flex flex-col items-center justify-center min-h-[50vh] text-center">
    <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 mb-6 shadow-sm"><i class="fas fa-check text-3xl"></i></div>
    <h2 class="text-2xl font-bold text-slate-800 mb-2">CPF Liberado!</h2>
    <p class="text-slate-500 mb-8">O funcion√°rio <strong>{{ nome_real }}</strong> (CPF: {{ cpf }}) j√° pode se cadastrar.</p>
    <div class="bg-blue-50 text-blue-800 text-sm p-6 rounded-xl mb-8 max-w-sm">
        <p class="font-bold mb-2">Pr√≥ximo Passo:</p>
        <p>Pe√ßa para o funcion√°rio acessar o sistema, clicar em <strong>"Sou Funcion√°rio"</strong> e criar a pr√≥pria senha usando este CPF.</p>
    </div>
    <a href="/admin/usuarios" class="bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-8 rounded-full transition shadow-lg">VOLTAR</a>
</div>
{% endblock %}

##################################################

FILE: app\auth\__init__.py
--------------------------
# M√≥dulo auth

##################################################

FILE: app\auth\routes.py
------------------------
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_user, logout_user, login_required, current_user
from werkzeug.security import generate_password_hash
from app.extensions import db
from app.models import User, PreCadastro
import re

auth_bp = Blueprint('auth', __name__, template_folder='templates')

@auth_bp.route('/login', methods=['GET', 'POST'])
def login():
    if current_user.is_authenticated: 
        return redirect(url_for('main.dashboard'))
    
    if request.method == 'POST':
        # O campo 'username' agora receber√° o CPF digitado pelo utilizador
        login_input = request.form.get('username', '').replace('.', '').replace('-', '').strip()
        password = request.form.get('password')
        
        # Procura pelo username (que para funcion√°rios ser√° o CPF e para Thaynara ser√° o nome)
        user = User.query.filter_by(username=login_input).first()
        
        # Caso n√£o encontre pelo CPF limpo, tenta procurar pelo input original (para casos como 'Thaynara')
        if not user:
            user = User.query.filter_by(username=request.form.get('username')).first()

        if user and user.check_password(password):
            login_user(user)
            if user.is_first_access: 
                return redirect(url_for('auth.primeiro_acesso'))
            return redirect(url_for('main.dashboard'))
        
        flash('CPF ou senha inv√°lidos.', 'error')
        
    return render_template('auth/login.html')

@auth_bp.route('/logout')
@login_required
def logout():
    logout_user()
    return redirect(url_for('auth.login'))

@auth_bp.route('/primeiro-acesso', methods=['GET', 'POST'])
@login_required
def primeiro_acesso():
    if not current_user.is_first_access: 
        return redirect(url_for('main.dashboard'))
    
    if request.method == 'POST':
        nova_senha = request.form.get('nova_senha')
        confirmacao = request.form.get('confirmacao')
        
        if nova_senha == confirmacao:
            current_user.set_password(nova_senha)
            current_user.is_first_access = False
            db.session.commit()
            flash('Senha atualizada com sucesso!', 'success')
            return redirect(url_for('main.dashboard'))
        flash('As senhas n√£o coincidem.', 'error')
        
    return render_template('auth/primeiro_acesso.html')

@auth_bp.route('/cadastrar', methods=['GET', 'POST'])
def auto_cadastro():
    if request.method == 'GET': 
        return render_template('auth/auto_cadastro.html', step=1)
    
    if request.method == 'POST':
        cpf_input = request.form.get('cpf', '')
        cpf = re.sub(r'\D', '', cpf_input) # Mant√©m apenas n√∫meros
        
        pre = PreCadastro.query.filter_by(cpf=cpf).first()
        
        if not pre:
            if User.query.filter_by(cpf=cpf).first():
                flash('Este CPF j√° possui um cadastro ativo. Tente fazer login.', 'warning')
                return redirect(url_for('auth.login'))
            flash('CPF n√£o autorizado para cadastro. Entre em contacto com o RH.', 'error')
            return redirect(url_for('auth.auto_cadastro'))
            
        password = request.form.get('password')
        if password:
            # O LOGIN AGORA √â O PR√ìPRIO CPF
            username_login = cpf 
            
            novo_user = User(
                username=username_login, 
                password_hash=generate_password_hash(password), 
                real_name=pre.nome_previsto, 
                role=pre.cargo, 
                cpf=cpf, 
                salario=pre.salario, 
                razao_social_empregadora=pre.razao_social,
                cnpj_empregador=pre.cnpj,
                carga_horaria=pre.carga_horaria,
                tempo_intervalo=pre.tempo_intervalo,
                inicio_jornada_ideal=pre.inicio_jornada_ideal,
                escala=pre.escala, 
                data_inicio_escala=pre.data_inicio_escala, 
                is_first_access=False,
                permissions="" # Cadastro inicial sempre sem permiss√µes administrativas
            )
            
            db.session.add(novo_user)
            db.session.delete(pre) # Remove da lista de pr√©-cadastro
            db.session.commit()
            
            return render_template('auth/auto_cadastro_sucesso.html', username=cpf, nome=pre.nome_previsto)
        else:
            return render_template('auth/auto_cadastro.html', step=2, cpf=cpf, nome=pre.nome_previsto)




##################################################

FILE: app\auth\templates\auth\auto_cadastro.html
------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col items-center justify-center min-h-[60vh]">
    <div class="bg-white p-8 rounded-2xl shadow-xl border border-slate-100 w-full max-w-md">
        
        <!-- ETAPA 1: DIGITAR CPF -->
        {% if step == 1 %}
        <h2 class="text-xl font-bold text-slate-800 mb-2">Primeiro Acesso</h2>
        <p class="text-sm text-slate-500 mb-6">Digite seu CPF para localizar seu cadastro.</p>
        <form action="/cadastrar" method="POST" class="space-y-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="step" value="1">
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">CPF (Somente N√∫meros)</label>
                <input type="text" name="cpf" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 font-bold text-lg tracking-wide focus:outline-none focus:border-blue-500" placeholder="000.000.000-00" required>
            </div>
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-lg transition">CONTINUAR</button>
        </form>
        {% endif %}

        <!-- ETAPA 2: CRIAR SENHA -->
        {% if step == 2 %}
        <h2 class="text-xl font-bold text-emerald-700 mb-2">Bem-vindo(a), {{ nome }}!</h2>
        <p class="text-sm text-slate-500 mb-6">Confirme seus dados e crie uma senha segura.</p>
        <form action="/cadastrar" method="POST" class="space-y-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="step" value="2">
            <input type="hidden" name="cpf" value="{{ cpf }}">
            
            <div class="bg-slate-50 p-4 rounded-lg border border-slate-100 mb-4">
                <p class="text-xs text-slate-400 font-bold uppercase">CPF</p>
                <p class="font-mono text-slate-800 font-bold">{{ cpf }}</p>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Crie sua Senha</label>
                <input type="password" name="password" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-3 focus:outline-none focus:border-emerald-500" placeholder="M√≠nimo 6 caracteres" required>
            </div>
            
            <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-lg shadow-lg transition">FINALIZAR CADASTRO</button>
        </form>
        {% endif %}

        <div class="text-center mt-4">
            <a href="/login" class="text-xs text-slate-400 hover:text-slate-600">Voltar para Login</a>
        </div>
    </div>
</div>
{% endblock %}

##################################################

FILE: app\auth\templates\auth\auto_cadastro_sucesso.html
--------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="min-h-[80vh] flex items-center justify-center p-4">
    <div class="max-w-md w-full bg-white rounded-3xl border border-slate-200 shadow-2xl p-10 text-center">
        <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-6">
            <i class="fas fa-check-circle"></i>
        </div>
        
        <h1 class="text-2xl font-bold text-slate-800 mb-2">Conta Criada!</h1>
        <p class="text-slate-500 mb-8">Ol√°, <span class="font-bold text-slate-800">{{ nome }}</span>. O teu acesso foi configurado com sucesso.</p>
        
        <div class="bg-slate-50 rounded-2xl p-6 mb-8 border border-slate-100">
            <p class="text-xs font-bold text-slate-400 uppercase mb-2">Os teus dados de acesso:</p>
            <div class="space-y-2 text-left">
                <div class="flex justify-between items-center text-sm">
                    <span class="text-slate-500">Login (CPF):</span>
                    <span class="font-mono font-bold text-slate-800">{{ username }}</span>
                </div>
                <div class="flex justify-between items-center text-sm">
                    <span class="text-slate-500">Senha:</span>
                    <span class="font-bold text-slate-800">A que criaste agora</span>
                </div>
            </div>
        </div>

        <a href="/login" class="block w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition">
            FAZER LOGIN AGORA
        </a>
    </div>
</div>
{% endblock %}




##################################################

FILE: app\auth\templates\auth\login.html
----------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="min-h-[80vh] flex items-center justify-center p-4">
    <div class="max-w-md w-full bg-white rounded-3xl border border-slate-200 shadow-2xl overflow-hidden">
        <div class="bg-slate-900 p-10 text-center">
            <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white font-bold text-3xl mx-auto mb-4 shadow-lg shadow-blue-500/30">S</div>
            <h1 class="text-2xl font-bold text-white tracking-tight">Shahin Gest√£o</h1>
            <p class="text-slate-400 text-sm mt-2">Acesso ao Painel Operacional</p>
        </div>
        
        <form method="POST" class="p-10 space-y-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">CPF (Apenas N√∫meros)</label>
                <div class="relative">
                    <i class="fas fa-user absolute left-4 top-4 text-slate-400"></i>
                    <input type="text" name="username" id="cpf_input" placeholder="000.000.000-00" 
                           class="w-full bg-slate-50 border border-slate-200 rounded-xl py-3 pl-12 pr-4 outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition font-mono font-bold text-slate-700" required>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Senha</label>
                <div class="relative">
                    <i class="fas fa-lock absolute left-4 top-4 text-slate-400"></i>
                    <input type="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                           class="w-full bg-slate-50 border border-slate-200 rounded-xl py-3 pl-12 pr-4 outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition" required>
                </div>
            </div>

            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 transition transform active:scale-[0.98]">
                ENTRAR NO SISTEMA
            </button>

            <div class="pt-6 border-t border-slate-100 text-center">
                <p class="text-sm text-slate-500">Novo por aqui?</p>
                <a href="/cadastrar" class="text-blue-600 font-bold hover:underline">Sou Funcion√°rio</a>
            </div>
        </form>
    </div>
</div>

<script>
    // M√°scara para CPF - Mantida pois agora o login √© num√©rico
    const input = document.getElementById('cpf_input');
    input.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, ''); // Remove tudo que n√£o √© n√∫mero
        if (value.length <= 11) {
            if (value.length > 9) {
                value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
            } else if (value.length > 6) {
                value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, "$1.$2.$3");
            } else if (value.length > 3) {
                value = value.replace(/(\d{3})(\d{1,3})/, "$1.$2");
            }
            e.target.value = value;
        }
    });
</script>
{% endblock %}

##################################################

FILE: app\auth\templates\auth\primeiro_acesso.html
--------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col items-center justify-center min-h-[60vh]">
    <div class="bg-white p-8 rounded-2xl shadow-xl border-l-4 border-yellow-400 w-full max-w-sm">
        <h2 class="text-xl font-bold text-slate-800 mb-2">Primeiro Acesso</h2>
        <p class="text-sm text-slate-500 mb-6">Por seguran√ßa, voc√™ deve definir uma nova senha pessoal.</p>
        <form action="/primeiro-acesso" method="POST" class="space-y-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Nova Senha</label>
                <input type="password" name="nova_senha" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-500" required>
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Confirmar Senha</label>
                <input type="password" name="confirmacao" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-500" required>
            </div>
            <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 rounded-lg shadow-lg transition">SALVAR E ACESSAR</button>
        </form>
    </div>
</div>
{% endblock %}

##################################################

FILE: app\documentos\__init__.py
--------------------------------
# M√≥dulo de Documentos





##################################################

FILE: app\documentos\ai_parser.py
---------------------------------
import vertexai
from vertexai.generative_models import GenerativeModel, Part
import json

def extrair_dados_holerite(pdf_bytes):
    """Usa IA para identificar Nome e M√™s de Refer√™ncia no PDF."""
    # Inicializa com seu ID de projeto
    vertexai.init(project="nimble-gearing-487415-u6", location="us-central1")
    model = GenerativeModel("gemini-1.5-flash-001")
    
    # Prepara o arquivo para an√°lise multimodal
    pdf_part = Part.from_data(data=pdf_bytes, mime_type="application/pdf")
    
    prompt = """
    Aja como um especialista em RH. Analise este holerite e extraia:
    1. O NOME COMPLETO do funcion√°rio.
    2. O M√äS DE REFER√äNCIA no formato AAAA-MM (Ex: 2026-02).
    
    Retorne estritamente um JSON puro:
    {
        "nome": "NOME ENCONTRADO",
        "mes_referencia": "AAAA-MM"
    }
    """
    try:
        response = model.generate_content([pdf_part, prompt])
        res_text = response.text.replace('```json', '').replace('```', '').strip()
        return json.loads(res_text)
    except Exception as e:
        print(f"Falha na IA: {e}")
        return None

##################################################

FILE: app\documentos\routes.py
------------------------------
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from app.extensions import db
from app.models import User, Holerite
from app.utils import get_brasil_time, permission_required
from app.documentos.storage import salvar_no_storage, gerar_url_assinada
from app.documentos.ai_parser import extrair_dados_holerite
from pypdf import PdfReader, PdfWriter
import io

documentos_bp = Blueprint('documentos', __name__, template_folder='templates', url_prefix='/documentos')

@documentos_bp.route('/admin/holerites', methods=['GET', 'POST'])
@login_required
@permission_required('DOCUMENTOS')
def admin_holerites():
    if request.method == 'POST':
        file = request.files.get('arquivo_pdf')
        if not file:
            flash("Selecione um arquivo PDF.", "error")
            return redirect(request.url)

        try:
            reader = PdfReader(file)
            sucesso, revisao = 0, 0
            # Mapeamento de usu√°rios ativos para busca r√°pida
            usuarios_sistema = {u.real_name.upper().strip(): u.id for u in User.query.all()}

            for page in reader.pages:
                # 1. Isola a p√°gina em bytes
                writer = PdfWriter()
                writer.add_page(page)
                buffer = io.BytesIO()
                writer.write(buffer)
                pdf_bytes = buffer.getvalue()

                # 2. IA extrai os dados
                dados = extrair_dados_holerite(pdf_bytes)
                nome_doc = dados.get('nome', '').upper().strip() if dados else ""
                mes_ref = dados.get('mes_referencia', '2026-02') if dados else "2026-02"

                # 3. Salva SEMPRE no Storage (Bucket privado)
                caminho_blob = salvar_no_storage(pdf_bytes, mes_ref)

                if not caminho_blob: continue

                # 4. Tenta vincular ao usu√°rio
                user_id = usuarios_sistema.get(nome_doc)
                status = 'Enviado' if user_id else 'Revisao'

                novo_h = Holerite(
                    user_id=user_id,
                    mes_referencia=mes_ref,
                    url_arquivo=caminho_blob, # Aqui guardamos o caminho do blob
                    status=status,
                    enviado_em=get_brasil_time()
                )
                db.session.add(novo_h)
                
                if user_id: sucesso += 1
                else: revisao += 1

            db.session.commit()
            flash(f"Processado: {sucesso} identificados e {revisao} para revis√£o manual.", "success")
            return redirect(url_for('documentos.dashboard_documentos'))
        except Exception as e:
            db.session.rollback()
            flash(f"Erro no processamento: {e}", "error")

    return render_template('documentos/admin_upload_holerite.html')

@documentos_bp.route('/admin/revisao')
@login_required
@permission_required('DOCUMENTOS')
def revisao_holerites():
    pendentes = Holerite.query.filter_by(status='Revisao').all()
    funcionarios = User.query.filter(User.role != 'Terminal').order_by(User.real_name).all()
    return render_template('documentos/revisao.html', pendentes=pendentes, funcionarios=funcionarios)

@documentos_bp.route('/admin/revisao/vincular', methods=['POST'])
@login_required
def vincular_holerite():
    h_id = request.form.get('holerite_id')
    u_id = request.form.get('user_id')
    h = Holerite.query.get(h_id)
    if h and u_id:
        h.user_id = u_id
        h.status = 'Enviado'
        db.session.commit()
        flash("Funcion√°rio vinculado com sucesso!", "success")
    return redirect(url_for('documentos.revisao_holerites'))

@documentos_bp.route('/baixar/holerite/<int:id>', methods=['POST'])
@login_required
def baixar_holerite(id):
    doc = Holerite.query.get_or_404(id)
    # Seguran√ßa: Apenas Master (50097952800) ou o dono do documento
    if current_user.username != '50097952800' and doc.user_id != current_user.id:
        return redirect(url_for('main.dashboard'))
    
    if doc.url_arquivo:
        # Gera a Signed URL (expira em 15 min)
        link = gerar_url_assinada(doc.url_arquivo)
        if link:
            return redirect(link)
    
    flash("Arquivo n√£o dispon√≠vel.", "error")
    return redirect(url_for('documentos.dashboard_documentos'))

@documentos_bp.route('/admin')
@login_required
@permission_required('DOCUMENTOS')
def dashboard_documentos():
    historico = Holerite.query.order_by(Holerite.enviado_em.desc()).limit(50).all()
    return render_template('documentos/dashboard.html', historico=historico)

##################################################

FILE: app\documentos\storage.py
-------------------------------
from google.cloud import storage
from datetime import datetime, timedelta
import uuid

# Nome do seu Bucket criado no console do GCP
BUCKET_NAME = "shahin-documentos"

def salvar_no_storage(pdf_bytes, mes_ref):
    """Envia o PDF para o bucket e retorna o NOME DO BLOB (caminho)."""
    try:
        client = storage.Client()
        bucket = client.bucket(BUCKET_NAME)
        
        # Gera um caminho √∫nico: holerites/2026-02/uuid.pdf
        nome_blob = f"holerites/{mes_ref}/{uuid.uuid4()}.pdf"
        blob = bucket.blob(nome_blob)
        
        blob.upload_from_string(pdf_bytes, content_type='application/pdf')
        return nome_blob # Retorna o caminho para salvar no banco
    except Exception as e:
        print(f"Erro no Cloud Storage: {e}")
        return None

def gerar_url_assinada(caminho_blob):
    """Gera um link privado que expira em 15 minutos."""
    try:
        client = storage.Client()
        bucket = client.bucket(BUCKET_NAME)
        blob = bucket.blob(caminho_blob)

        url = blob.generate_signed_url(
            version="v4",
            expiration=timedelta(minutes=15), 
            method="GET",
        )
        return url
    except Exception as e:
        print(f"Erro ao gerar link assinado: {e}")
        return None

##################################################

FILE: app\documentos\utils.py
-----------------------------
from reportlab.pdfgen import canvas
from reportlab.lib.pagesizes import A4
from reportlab.lib.units import cm
from reportlab.lib import colors
from reportlab.platypus import Table, TableStyle
import io
import calendar
from datetime import date, timedelta, datetime
from app.utils import data_por_extenso, time_to_minutes, format_minutes_to_hm

def gerar_pdf_recibo(recibo, user):
    """Gera o PDF do Recibo Financeiro."""
    buffer = io.BytesIO()
    p = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4
    
    p.setFont("Helvetica-Bold", 14)
    p.drawString(2.5*cm, height - 3*cm, "RECIBO DE PAGAMENTO DE BENEF√çCIOS")
    p.setFont("Helvetica", 11)
    p.drawString(2.5*cm, height - 4*cm, "Recibo;")
    data_fmt = recibo.data_pagamento.strftime('%d/%m/%Y')
    p.drawString(2.5*cm, height - 4.6*cm, f"Data:  {data_fmt}")
    p.setFont("Helvetica", 11)
    
    empresa = user.razao_social_empregadora or "LA SHAHIN SERVI√áOS DE SEGURAN√áA LTDA"
    cnpj = user.cnpj_empregador or "50.537.235/0001-95"
    valor_fmt = f"{recibo.valor:,.2f}".replace(',', 'X').replace('.', ',').replace('X', '.')
    
    texto_corpo = p.beginText(2.5*cm, height - 6*cm)
    texto_corpo.setFont("Helvetica", 11)
    texto_corpo.setLeading(18)
    texto_corpo.textLines(f"Recebi de {empresa},")
    texto_corpo.textLines(f"inscrita no CNPJ n¬∫ {cnpj} a quantia de R$ {valor_fmt}")
    texto_corpo.textLines("referente ao pagamento do(s) benef√≠cio(s) abaixo assinalado(s):")
    p.drawText(texto_corpo)
    
    y_checkbox = height - 9*cm
    def draw_check(x, y, label, checked):
        mark = "(X)" if checked else "(  )"
        p.setFont("Helvetica-Bold", 11)
        p.drawString(x, y, mark)
        p.setFont("Helvetica", 11)
        p.drawString(x + 1*cm, y, label)

    draw_check(2.5*cm, y_checkbox, "Vale Alimenta√ß√£o (VA)", recibo.tipo_vale_alimentacao)
    draw_check(10.5*cm, y_checkbox, "Vale Transporte (VT)", recibo.tipo_vale_transporte)
    draw_check(2.5*cm, y_checkbox - 1*cm, "Assiduidade", recibo.tipo_assiduidade)
    draw_check(10.5*cm, y_checkbox - 1*cm, "Cesta B√°sica", recibo.tipo_cesta_basica)

    y_dados = height - 12*cm
    p.setFont("Helvetica-Bold", 12)
    p.drawString(2.5*cm, y_dados, "Dados do Funcion√°rio")
    y_dados -= 1*cm
    p.setFont("Helvetica", 11)
    p.drawString(2.5*cm, y_dados, f"Nome: {user.real_name}")
    cpf_fmt = user.cpf if user.cpf else "00000000000"
    if len(cpf_fmt) == 11: cpf_fmt = f"{cpf_fmt[:3]}.{cpf_fmt[3:6]}.{cpf_fmt[6:9]}-{cpf_fmt[9:]}"
    p.drawString(12*cm, y_dados, f"CPF: {cpf_fmt}")
    
    y_pgto = y_dados - 1.5*cm
    p.drawString(2.5*cm, y_pgto, "Forma de pagamento:")
    draw_check(7*cm, y_pgto, "Dinheiro", recibo.forma_pagamento == 'Dinheiro')
    draw_check(10.5*cm, y_pgto, "Pix", recibo.forma_pagamento == 'Pix')
    draw_check(13*cm, y_pgto, "Transfer√™ncia", recibo.forma_pagamento == 'Transfer√™ncia')

    p.drawString(2.5*cm, y_pgto - 1.5*cm, "Declaro que recebi o valor acima descrito, referente ao(s) benef√≠cio(s) assinalado(s).")
    
    y_ass = y_pgto - 4*cm
    p.line(2.5*cm, y_ass, 9*cm, y_ass)
    p.setFont("Helvetica", 10)
    p.drawString(3*cm, y_ass - 0.5*cm, "Assinatura do Empregado")
    p.line(11*cm, y_ass, 17.5*cm, y_ass)
    p.drawString(11.5*cm, y_ass - 0.5*cm, "Assinatura do Empregador")
    
    data_extenso = data_por_extenso(recibo.data_pagamento)
    p.setFont("Helvetica-Bold", 11)
    p.drawCentredString(width/2, y_ass - 2.5*cm, f"{data_extenso}.")

    p.showPage()
    p.save()
    buffer.seek(0)
    return buffer.read()

def gerar_pdf_espelho_mensal(user, mes_ano_str):
    """Gera PDF com a tabela de pontos do m√™s."""
    from app.models import PontoRegistro
    
    buffer = io.BytesIO()
    p = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4
    
    try:
        ano, mes = map(int, mes_ano_str.split('-'))
    except:
        now = datetime.now()
        ano, mes = now.year, now.month

    p.setFont("Helvetica-Bold", 16)
    p.drawString(2*cm, height - 2*cm, "ESPELHO DE PONTO ELETR√îNICO")
    
    p.setFont("Helvetica", 10)
    p.drawString(2*cm, height - 3*cm, f"Colaborador: {user.real_name}")
    p.drawString(2*cm, height - 3.5*cm, f"Cargo: {user.role}")
    p.drawString(12*cm, height - 3*cm, f"Per√≠odo: {mes}/{ano}")
    
    empresa = user.razao_social_empregadora or "SHAHIN GEST√ÉO"
    cnpj = user.cnpj_empregador or ""
    p.drawString(2*cm, height - 4*cm, f"Empresa: {empresa} - CNPJ: {cnpj}")
    
    dados = [['Data', 'Dia', 'Entradas / Sa√≠das', 'Jornada', 'Saldo', 'Status']]
    last_day = calendar.monthrange(ano, mes)[1]
    total_saldo_min = 0
    dias_semana = {0:'Seg', 1:'Ter', 2:'Qua', 3:'Qui', 4:'Sex', 5:'S√°b', 6:'Dom'}
    
    for dia in range(1, last_day + 1):
        dt_atual = date(ano, mes, dia)
        pontos = PontoRegistro.query.filter_by(user_id=user.id, data_registro=dt_atual).order_by(PontoRegistro.hora_registro).all()
        horarios_str = "  ".join([p.hora_registro.strftime('%H:%M') for p in pontos])
        
        meta = user.carga_horaria or 528
        if user.escala == '5x2' and dt_atual.weekday() >= 5: meta = 0
        elif user.escala == '12x36' and user.data_inicio_escala:
            if (dt_atual - user.data_inicio_escala).days % 2 != 0: meta = 0
            else: meta = 720
            
        trabalhado = 0
        for i in range(0, len(pontos), 2):
            if i+1 < len(pontos):
                trabalhado += (time_to_minutes(pontos[i+1].hora_registro) - time_to_minutes(pontos[i].hora_registro))
        
        saldo = trabalhado - meta
        total_saldo_min += saldo
        status = "OK"
        if not pontos: status = "Folga" if meta == 0 else "Falta"
        elif len(pontos) % 2 != 0: status = "Inc."
        elif saldo > 10: status = "+ Extra"
        elif saldo < -10: status = "D√©bito" if meta > 0 else "Extra"
        
        dados.append([dt_atual.strftime('%d/%m'), dias_semana[dt_atual.weekday()], horarios_str, format_minutes_to_hm(trabalhado).replace('-', ''), format_minutes_to_hm(saldo), status])
    
    dados.append(['', '', 'TOTAL MENSAL', '', format_minutes_to_hm(total_saldo_min), ''])

    t = Table(dados, colWidths=[2*cm, 1.5*cm, 6*cm, 2*cm, 2*cm, 2.5*cm])
    t.setStyle(TableStyle([('BACKGROUND', (0,0), (-1,0), colors.navy), ('TEXTCOLOR', (0,0), (-1,0), colors.whitesmoke), ('ALIGN', (0,0), (-1,-1), 'CENTER'), ('FONTNAME', (0,0), (-1,0), 'Helvetica-Bold'), ('FONTSIZE', (0,0), (-1,0), 9), ('BOTTOMPADDING', (0,0), (-1,0), 8), ('BACKGROUND', (0,-1), (-1,-1), colors.lightgrey), ('GRID', (0,0), (-1,-1), 0.5, colors.grey), ('FONTSIZE', (0,1), (-1,-1), 8)]))
    w, h = t.wrapOn(p, width, height)
    t.drawOn(p, 2*cm, height - 6*cm - h)
    
    y_ass = 3*cm
    p.line(2*cm, y_ass, 9*cm, y_ass)
    p.setFont("Helvetica", 8)
    p.drawString(3*cm, y_ass - 0.5*cm, "Assinatura do Colaborador")
    p.line(12*cm, y_ass, 19*cm, y_ass)
    p.drawString(13*cm, y_ass - 0.5*cm, "Gestor Respons√°vel")
    p.drawString(2*cm, 1.5*cm, f"Documento gerado eletronicamente em {datetime.now().strftime('%d/%m/%Y %H:%M')}")

    p.showPage()
    p.save()
    buffer.seek(0)
    return buffer.read()

def gerar_certificado_entrega(assinatura, user):
    """
    Gera um PDF de auditoria (Certificado de Entrega Digital).
    """
    buffer = io.BytesIO()
    p = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4
    
    # Cabe√ßalho Oficial
    p.setFillColor(colors.navy)
    p.rect(0, height - 3*cm, width, 3*cm, fill=True, stroke=False)
    p.setFillColor(colors.white)
    p.setFont("Helvetica-Bold", 18)
    p.drawCentredString(width/2, height - 2*cm, "CERTIFICADO DE ENTREGA DIGITAL")
    
    # Corpo
    p.setFillColor(colors.black)
    p.setFont("Helvetica", 12)
    
    texto = p.beginText(2.5*cm, height - 5*cm)
    texto.setLeading(20)
    texto.textLines(f"Certificamos, para os devidos fins de direito e prova, que o colaborador:")
    texto.textLines(f"Nome: {user.real_name}")
    texto.textLines(f"CPF: {user.cpf}")
    texto.textLines(f"")
    texto.textLines(f"Realizou o ACESSO e CONFIRMA√á√ÉO DE RECEBIMENTO do documento digital")
    texto.textLines(f"identificado abaixo, atrav√©s da plataforma SHAHIN GEST√ÉO.")
    p.drawText(texto)
    
    # Caixa de Dados Forenses
    p.setStrokeColor(colors.grey)
    p.rect(2.5*cm, height - 16*cm, 16*cm, 7*cm)
    
    p.setFont("Helvetica-Bold", 12)
    p.drawString(3*cm, height - 10*cm, "DADOS DA TRANSA√á√ÉO DIGITAL")
    
    p.setFont("Helvetica", 10)
    y_forense = height - 11*cm
    p.drawString(3*cm, y_forense, f"Documento: {assinatura.tipo_documento} (ID: {assinatura.documento_id})")
    p.drawString(3*cm, y_forense - 1*cm, f"Data/Hora do Acesso: {assinatura.data_assinatura.strftime('%d/%m/%Y %H:%M:%S')} (UTC-3)")
    p.drawString(3*cm, y_forense - 2*cm, f"Endere√ßo IP de Origem: {assinatura.ip_address}")
    p.drawString(3*cm, y_forense - 3*cm, f"Dispositivo/Navegador: {assinatura.user_agent[:60]}...")
    
    p.setFont("Helvetica-Bold", 10)
    p.drawString(3*cm, y_forense - 4.5*cm, "Hash de Integridade (SHA-256):")
    p.setFont("Courier", 8)
    p.drawString(3*cm, y_forense - 5*cm, f"{assinatura.hash_arquivo}")
    
    # Rodap√© Legal
    p.setFont("Helvetica-Oblique", 9)
    p.drawCentredString(width/2, 3*cm, "Este registro eletr√¥nico possui validade jur√≠dica conforme MP 2.200-2/2001.")
    p.drawCentredString(width/2, 2.5*cm, "A integridade do arquivo pode ser verificada atrav√©s do Hash acima.")
    
    p.showPage()
    p.save()
    buffer.seek(0)
    return buffer.read()





##################################################

FILE: app\documentos\templates\documentos\admin_upload_holerite.html
--------------------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-6 flex justify-between items-center">
        <div><h2 class="text-2xl font-bold text-slate-800">Importa√ß√£o de Holerites</h2><p class="text-sm text-slate-500">Envie o PDF da folha.</p></div>
        <form action="/documentos/admin/holerites" method="POST" onsubmit="return confirm('Apagar hist√≥rico?')">
            <input type="hidden" name="acao" value="limpar_tudo">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="text-xs text-red-500 hover:text-red-700 underline font-bold">Limpar Hist√≥rico</button>
        </form>
    </div>

    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-8 mb-8">
        <form action="/documentos/admin/holerites" method="POST" enctype="multipart/form-data" class="space-y-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><label class="label-pro">M√™s de Refer√™ncia</label><input type="month" name="mes_ref" class="input-pro" required></div>
                <div><label class="label-pro">Arquivo PDF</label><input type="file" name="arquivo_pdf" accept=".pdf" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required></div>
            </div>
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-md transition flex items-center justify-center gap-2" onclick="this.innerHTML='<i class=\'fas fa-spinner fa-spin\'></i> Processando...';"><i class="fas fa-cloud-upload-alt"></i> PROCESSAR E DISTRIBUIR</button>
        </form>
    </div>

    <h3 class="text-lg font-bold text-slate-700 mb-4 px-2">√öltimos Envios</h3>
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-slate-600">
                <thead class="bg-slate-50 text-xs uppercase text-slate-400 font-bold border-b border-slate-100">
                    <tr><th class="px-6 py-3">Funcion√°rio</th><th class="px-6 py-3">Refer√™ncia</th><th class="px-6 py-3 text-center">Status</th><th class="px-6 py-3 text-right">A√ß√£o</th></tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    {% for item in uploads %}
                    <tr class="hover:bg-slate-50 transition">
                        <td class="px-6 py-3 font-bold text-slate-800">{{ item.user.real_name }}</td>
                        <td class="px-6 py-3">{{ item.mes_referencia }}</td>
                        <td class="px-6 py-3 text-center">{% if item.visualizado %}<span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-[10px] font-bold uppercase">Lido</span>{% else %}<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-[10px] font-bold uppercase">Pendente</span>{% endif %}</td>
                        <td class="px-6 py-3 text-right">
                            <form action="/documentos/baixar/holerite/{{ item.id }}" method="POST" target="_blank" style="display:inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="text-blue-600 hover:underline text-xs font-bold"><i class="fas fa-download"></i> Baixar</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400">Nenhum envio recente.</td></tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}





##################################################

FILE: app\documentos\templates\documentos\auditoria.html
--------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div>
        <h2 class="text-2xl font-bold text-slate-800">Auditoria de Recebimento</h2>
        <p class="text-sm text-slate-500">Controlo de conformidade e assinaturas digitais por colaborador.</p>
    </div>
    <div class="relative w-full md:w-80">
        <input type="text" id="userSearch" onkeyup="searchUsers()" placeholder="Pesquisar funcion√°rio pelo nome..." 
               class="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 pl-11 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition shadow-sm">
        <i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i>
    </div>
</div>

<div class="space-y-3" id="usersList">
    {% for item in auditores %}
    <div class="user-item bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm transition hover:shadow-md" data-name="{{ item.user.real_name.lower() }}">
        <!-- Cabe√ßalho (Accordion Toggle) -->
        <button onclick="toggleAccordion('box-{{ item.user.id }}')" 
                class="w-full px-6 py-5 flex items-center justify-between hover:bg-slate-50/80 transition group">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 font-bold border-2 border-white shadow-inner">
                    {{ item.user.real_name[:1].upper() }}
                </div>
                <div class="text-left">
                    <div class="font-bold text-slate-800 text-base group-hover:text-blue-600 transition">{{ item.user.real_name }}</div>
                    <div class="text-[10px] text-slate-400 uppercase tracking-widest font-bold flex items-center gap-2">
                        <span>CPF: {{ item.user.cpf }}</span>
                        <span class="text-slate-200">|</span>
                        <span>{{ item.user.role }}</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <div class="hidden md:block text-right">
                    <div class="text-[10px] text-slate-400 uppercase font-bold">Total Assinado</div>
                    <div class="font-mono font-bold text-slate-700">{{ item.total }} docs</div>
                </div>
                <i class="fas fa-chevron-down text-slate-300 transition-transform duration-300 text-lg" id="icon-box-{{ item.user.id }}"></i>
            </div>
        </button>

        <!-- Painel de Detalhes -->
        <div id="box-{{ item.user.id }}" class="hidden border-t border-slate-100 bg-slate-50/30">
            {% if item.assinaturas %}
            <div class="p-2">
                <div class="overflow-x-auto rounded-lg border border-slate-100">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-100/50 text-[10px] text-slate-500 uppercase font-bold">
                            <tr>
                                <th class="px-6 py-3">Tipo</th>
                                <th class="px-6 py-3">Refer√™ncia do Documento</th>
                                <th class="px-6 py-3">Data/Hora Assinatura</th>
                                <th class="px-6 py-3 text-right">Certificado Forense</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 bg-white">
                            {% for a in item.assinaturas %}
                            <tr class="hover:bg-blue-50/50 transition">
                                <td class="px-6 py-4">
                                    <span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-tight
                                        {% if a.tipo == 'Holerite' %} bg-blue-50 text-blue-600 
                                        {% elif a.tipo == 'Recibo' %} bg-emerald-50 text-emerald-600 
                                        {% else %} bg-purple-50 text-purple-600 {% endif %}">
                                        {{ a.tipo }}
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="font-bold text-slate-700">{{ a.referencia }}</div>
                                    <div class="text-[9px] text-slate-400 font-mono">IP: {{ a.ip }}</div>
                                </td>
                                <td class="px-6 py-4 text-slate-600">
                                    <div class="font-medium">{{ a.data.strftime('%d/%m/%Y') }}</div>
                                    <div class="text-xs text-slate-400">{{ a.data.strftime('%H:%M:%S') }}</div>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <a href="/documentos/admin/auditoria/certificado/{{ a.id }}" target="_blank" 
                                       class="inline-flex items-center gap-2 bg-white border border-slate-200 text-slate-700 hover:bg-slate-900 hover:text-white hover:border-slate-900 px-4 py-2 rounded-lg font-bold text-xs transition shadow-sm">
                                        <i class="fas fa-file-signature text-blue-500"></i> Baixar Comprovante
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
            <div class="px-6 py-12 text-center text-slate-400 bg-white">
                <i class="fas fa-comment-slash text-3xl mb-3 opacity-20"></i>
                <p class="text-sm">Este colaborador ainda n√£o possui registos de assinatura digital.</p>
                <p class="text-[10px] uppercase mt-1">O sistema aguarda o primeiro download de documento.</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<script>
    function toggleAccordion(id) {
        const content = document.getElementById(id);
        const icon = document.getElementById('icon-' + id);
        content.classList.toggle('hidden');
        icon.classList.toggle('rotate-180');
    }

    function searchUsers() {
        let input = document.getElementById('userSearch').value.toLowerCase();
        let items = document.getElementsByClassName('user-item');
        for (let i = 0; i < items.length; i++) {
            let name = items[i].getAttribute('data-name');
            if (name.includes(input)) {
                items[i].style.display = "";
            } else {
                items[i].style.display = "none";
            }
        }
    }
</script>
{% endblock %}




##################################################

FILE: app\documentos\templates\documentos\dashboard.html
--------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
    <div>
        <h2 class="text-2xl font-bold text-slate-800">Central de Documentos</h2>
        <p class="text-sm text-slate-500">Gest√£o integrada de RH e Financeiro.</p>
    </div>
    <div class="flex gap-2">
        <a href="/documentos/admin/auditoria" class="bg-slate-800 hover:bg-slate-900 text-white font-bold py-2 px-4 rounded-lg shadow-lg text-xs transition flex items-center gap-2">
            <i class="fas fa-shield-alt"></i> AUDITORIA & ASSINATURAS
        </a>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
    <!-- Cards de A√ß√£o (Mantidos os mesmos do passo anterior) -->
    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 mb-4">
            <i class="fas fa-file-invoice text-xl"></i>
        </div>
        <h3 class="font-bold text-md text-slate-800 mb-2">Holerite em massa</h3>
        <p class="text-xs text-slate-500 mb-4">Importe o PDF unificado. O sistema separa e envia.</p>
        <a href="/documentos/admin/holerites" class="block w-full text-center bg-slate-50 hover:bg-blue-50 text-blue-600 font-bold py-2 text-xs rounded border border-slate-200 transition">IMPORTAR</a>
    </div>

    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
        <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center text-emerald-600 mb-4">
            <i class="fas fa-file-signature text-xl"></i>
        </div>
        <h3 class="font-bold text-md text-slate-800 mb-2">Recibo Avulso</h3>
        <p class="text-xs text-slate-500 mb-4">Gere recibos de VA, VT ou Pix avulsos.</p>
        <a href="/documentos/admin/recibo/novo" class="block w-full text-center bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 text-xs rounded shadow transition">NOVO RECIBO</a>
    </div>

    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center text-purple-600 mb-4">
            <i class="fas fa-calendar-check text-xl"></i>
        </div>
        <h3 class="font-bold text-md text-slate-800 mb-2">Disparar Espelhos</h3>
        <p class="text-xs text-slate-500 mb-4">Envia o PDF do ponto para todos os ativos.</p>
        <form action="/documentos/admin/disparar-espelhos" method="POST" class="flex gap-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="month" name="mes_ref" class="w-full border rounded px-2 py-1 text-xs" required>
            <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded text-xs font-bold transition">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>
</div>

<!-- HIST√ìRICO UNIFICADO (REFORMULADO) -->
<h3 class="font-bold text-slate-700 mb-4 text-xs uppercase px-2 tracking-widest flex items-center gap-2">
    <i class="fas fa-stream text-slate-400"></i> Hist√≥rico de Documentos Enviados
</h3>

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-10">
    <div class="overflow-x-auto">
        <table class="w-full text-left text-sm text-slate-600">
            <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold border-b border-slate-100">
                <tr>
                    <th class="px-6 py-4">Tipo</th>
                    <th class="px-6 py-4">Funcion√°rio</th>
                    <th class="px-6 py-4">Informa√ß√£o de Refer√™ncia</th>
                    <th class="px-6 py-4">Data do Envio</th>
                    <th class="px-6 py-4 text-center">Assinatura</th>
                    <th class="px-6 py-4 text-right">Arquivo</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
                {% for h in historico %}
                <tr class="hover:bg-slate-50 transition">
                    <td class="px-6 py-4">
                        <span class="bg-{{ h.cor }}-50 text-{{ h.cor }}-600 px-2 py-1 rounded text-[10px] font-bold uppercase border border-{{ h.cor }}-100 shadow-sm">
                            {{ h.tipo }}
                        </span>
                    </td>
                    <td class="px-6 py-4 font-bold text-slate-800">{{ h.usuario }}</td>
                    <td class="px-6 py-4 text-xs font-medium text-slate-600">{{ h.info }}</td>
                    <td class="px-6 py-4 text-xs text-slate-400">{{ h.data.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td class="px-6 py-4 text-center">
                        {% if h.visto %}
                        <span class="text-emerald-600 font-bold text-[10px] uppercase flex items-center justify-center gap-1">
                            <i class="fas fa-check-circle"></i> Assinado
                        </span>
                        {% else %}
                        <span class="text-amber-500 font-bold text-[10px] uppercase flex items-center justify-center gap-1">
                            <i class="fas fa-hourglass-half"></i> Pendente
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-right">
                        <form action="{{ url_for('documentos.' + h.rota, id=h.id) }}" method="POST" target="_blank">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="text-slate-400 hover:text-blue-600 transition p-2">
                                <i class="fas fa-file-pdf text-lg"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="6" class="px-6 py-20 text-center text-slate-400">Nenhum registo de envio encontrado.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}




##################################################

FILE: app\documentos\templates\documentos\meus_documentos.html
--------------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6"><h2 class="text-2xl font-bold text-slate-800">Meus Documentos</h2></div>

<div class="space-y-4">
    {% for doc in docs %}
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5 flex flex-col md:flex-row md:items-center justify-between gap-4 transition hover:shadow-md">
        
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-lg flex items-center justify-center text-xl bg-{{ doc.cor }}-100 text-{{ doc.cor }}-600">
                <i class="fas {{ doc.icone }}"></i>
            </div>
            
            <div>
                <div class="flex items-center gap-2">
                    <h3 class="font-bold text-slate-800">{{ doc.titulo }}</h3>
                    {% if doc.visto %}
                    <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded font-bold uppercase">Visto</span>
                    {% else %}
                    <span class="text-[10px] bg-blue-600 text-white px-2 py-0.5 rounded font-bold uppercase animate-pulse">Novo</span>
                    {% endif %}
                </div>
                <p class="text-xs text-slate-500">{{ doc.data.strftime('%d/%m/%Y') }} - {{ doc.tipo }}</p>
            </div>
        </div>

        <form action="{{ url_for('documentos.' + doc.rota, id=doc.id) }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="w-full md:w-auto px-6 py-3 rounded-lg font-bold text-sm transition border flex items-center justify-center gap-2
                {% if doc.visto %} 
                    bg-white text-slate-600 border-slate-200 hover:bg-slate-50 
                {% else %} 
                    bg-blue-600 text-white border-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-200 
                {% endif %}">
                {% if doc.visto %} 
                    <i class="fas fa-download"></i> Baixar C√≥pia 
                {% else %} 
                    <i class="fas fa-file-contract"></i> Confirmar e Baixar 
                {% endif %}
            </button>
        </form>

    </div>
    {% else %}
    <div class="text-center py-16 text-slate-400 bg-white rounded-xl border border-slate-200 border-dashed">
        <i class="fas fa-folder-open text-4xl mb-4 opacity-50"></i>
        <p>Nenhum documento dispon√≠vel no momento.</p>
    </div>
    {% endfor %}
</div>
{% endblock %}





##################################################

FILE: app\documentos\templates\documentos\novo_recibo.html
----------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<!-- Plugin para Select Pesquis√°vel -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<div class="max-w-2xl mx-auto">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-slate-800">Gerar Recibo de Pagamento</h2>
        <a href="/documentos/admin" class="text-xs font-bold text-slate-400 hover:text-slate-600">CANCELAR</a>
    </div>

    <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
        <div class="bg-slate-50 border-b border-slate-100 p-6 text-center">
            <h3 class="font-serif font-bold text-lg text-slate-700">RECIBO DE PAGAMENTO DE BENEF√çCIOS</h3>
        </div>

        <form action="/documentos/admin/recibo/novo" method="POST" class="p-8 space-y-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

            <!-- 1. Sele√ß√£o do Funcion√°rio (Agora Pesquis√°vel) -->
            <div>
                <label class="label-pro mb-2">Selecione o Funcion√°rio</label>
                <select name="user_id" id="userSelect" class="w-full" onchange="carregarDadosUser(this.value)" required>
                    <option value="">Digite para pesquisar...</option>
                    {% for u in users %}
                    <option value="{{ u.id }}">{{ u.real_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Preview do Texto Legal -->
            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-100 text-sm font-serif text-slate-700 italic">
                "Recebi de <strong id="previewEmpresa" class="text-slate-900">...</strong>, inscrita no CNPJ <strong id="previewCnpj" class="text-slate-900">...</strong> a quantia abaixo..."
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label-pro text-emerald-600">Valor (R$)</label>
                    <input type="number" step="0.01" name="valor" class="input-pro text-2xl font-bold text-emerald-700" placeholder="0,00" required>
                </div>
                <div>
                    <label class="label-pro">Data do Pagamento</label>
                    <input type="date" name="data_pagamento" value="{{ hoje }}" class="input-pro" required>
                </div>
            </div>

            <div>
                <label class="label-pro mb-3">Tipo de Benef√≠cio (Marque as op√ß√µes)</label>
                <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center p-3 border rounded-lg hover:bg-slate-50 cursor-pointer transition">
                        <input type="checkbox" name="va" checked class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2 text-sm font-bold text-slate-700">Vale Alimenta√ß√£o (VA)</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg hover:bg-slate-50 cursor-pointer transition">
                        <input type="checkbox" name="vt" checked class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2 text-sm font-bold text-slate-700">Vale Transporte (VT)</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg hover:bg-slate-50 cursor-pointer transition">
                        <input type="checkbox" name="assiduidade" class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2 text-sm font-bold text-slate-700">Assiduidade</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg hover:bg-slate-50 cursor-pointer transition">
                        <input type="checkbox" name="cesta" class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2 text-sm font-bold text-slate-700">Cesta B√°sica</span>
                    </label>
                </div>
            </div>

            <div>
                <label class="label-pro mb-2">Forma de Pagamento</label>
                <div class="flex gap-4">
                    <label class="flex items-center"><input type="radio" name="forma_pagamento" value="Pix" checked class="mr-2"> Pix</label>
                    <label class="flex items-center"><input type="radio" name="forma_pagamento" value="Dinheiro" class="mr-2"> Dinheiro</label>
                    <label class="flex items-center"><input type="radio" name="forma_pagamento" value="Transfer√™ncia" class="mr-2"> Transfer√™ncia</label>
                </div>
            </div>

            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-lg transition">
                <i class="fas fa-file-signature mr-2"></i> GERAR E SALVAR RECIBO
            </button>
        </form>
    </div>
</div>

<script>
    // Inicializa o TomSelect para pesquisa
    new TomSelect("#userSelect",{
        create: false,
        sortField: {
            field: "text",
            direction: "asc"
        },
        placeholder: "Digite o nome do funcion√°rio...",
        onChange: function(value) {
            carregarDadosUser(value);
        }
    });

    function carregarDadosUser(userId) {
        if(!userId) return;
        fetch(`/documentos/api/user-info/${userId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('previewEmpresa').innerText = data.razao_social || "LA SHAHIN SERVI√áOS DE SEGURAN√áA LTDA";
                document.getElementById('previewCnpj').innerText = data.cnpj || "50.537.235/0001-95";
            })
            .catch(err => console.error("Erro ao buscar dados:", err));
    }
</script>
{% endblock %}





##################################################

FILE: app\documentos\templates\documentos\revisao.html
------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-5xl mx-auto py-8">
    <div class="mb-10">
        <h2 class="text-3xl font-black text-slate-800 tracking-tight">Aguardando Revis√£o</h2>
        <p class="text-slate-500 mt-2">Estes documentos foram salvos no Storage, mas o nome no PDF n√£o coincide exatamente com o cadastro.</p>
    </div>

    <div class="grid gap-6">
        {% for h in pendentes %}
        <div class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm flex flex-col md:flex-row items-center gap-6">
            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 flex items-center gap-4 flex-1 w-full">
                <i class="fas fa-file-pdf text-3xl text-red-500"></i>
                <div class="overflow-hidden">
                    <p class="text-[10px] font-black text-slate-400 uppercase">Refer√™ncia</p>
                    <p class="font-bold text-slate-800">{{ h.mes_referencia }}</p>
                    <form action="{{ url_for('documentos.baixar_holerite', id=h.id) }}" method="POST" target="_blank">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="text-xs font-bold text-blue-600 hover:text-blue-800 transition">VER PDF COMPLETO</button>
                    </form>
                </div>
            </div>

            <form action="{{ url_for('documentos.vincular_holerite') }}" method="POST" class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="holerite_id" value="{{ h.id }}">
                
                <select name="user_id" class="bg-slate-100 border-2 border-transparent focus:border-blue-500 rounded-2xl px-4 py-3 text-sm font-bold text-slate-700 outline-none transition-all md:w-72" required>
                    <option value="">Quem √© este funcion√°rio?</option>
                    {% for u in funcionarios %}
                    <option value="{{ u.id }}">{{ u.real_name }}</option>
                    {% endfor %}
                </select>
                
                <button type="submit" class="bg-slate-900 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-2xl transition shadow-lg shadow-slate-200">
                    VINCULAR
                </button>
            </form>
        </div>
        {% else %}
        <div class="text-center py-24 bg-slate-50 rounded-[3rem] border-4 border-dashed border-slate-200">
            <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-6">
                <i class="fas fa-check"></i>
            </div>
            <h3 class="text-xl font-black text-slate-800">Tudo em dia!</h3>
            <p class="text-slate-400 font-medium">N√£o h√° holerites pendentes de identifica√ß√£o.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

##################################################

FILE: app\estoque\__init__.py
-----------------------------
# M√≥dulo estoque

##################################################

FILE: app\estoque\routes.py
---------------------------
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from app.extensions import db
from app.models import ItemEstoque, HistoricoEntrada, HistoricoSaida
from app.utils import get_brasil_time, permission_required

estoque_bp = Blueprint('estoque', __name__, template_folder='templates')

@estoque_bp.route('/controle-uniforme')
@login_required
@permission_required('ESTOQUE') # Guardi√£o do Stock
def gerenciar_estoque():
    itens = ItemEstoque.query.order_by(ItemEstoque.nome).all()
    return render_template('estoque/admin_estoque.html', itens=itens)

@estoque_bp.route('/estoque/novo', methods=['POST'])
@login_required
@permission_required('ESTOQUE')
def novo_item():
    nome = request.form.get('nome')
    tamanho = request.form.get('tamanho')
    genero = request.form.get('genero')
    if nome:
        item = ItemEstoque(nome=nome, tamanho=tamanho, genero=genero, quantidade=0)
        db.session.add(item); db.session.commit()
        flash('Item adicionado.', 'success')
    return redirect(url_for('estoque.gerenciar_estoque'))

@estoque_bp.route('/estoque/entrada', methods=['POST'])
@login_required
@permission_required('ESTOQUE')
def entrada_estoque():
    item_id = request.form.get('item_id')
    qtd = int(request.form.get('quantidade') or 0)
    item = ItemEstoque.query.get(item_id)
    if item and qtd > 0:
        item.quantidade += qtd
        hist = HistoricoEntrada(item_nome=f"{item.nome} ({item.tamanho})", quantidade=qtd)
        db.session.add(hist); db.session.commit(); flash('Entrada registada.', 'success')
    return redirect(url_for('estoque.gerenciar_estoque'))

@estoque_bp.route('/estoque/saida', methods=['POST'])
@login_required
@permission_required('ESTOQUE')
def saida_estoque():
    item_id = request.form.get('item_id')
    qtd = int(request.form.get('quantidade') or 0)
    colaborador = request.form.get('colaborador')
    item = ItemEstoque.query.get(item_id)
    if item and qtd > 0 and item.quantidade >= qtd:
        item.quantidade -= qtd
        hist = HistoricoSaida(coordenador=current_user.real_name, colaborador=colaborador, item_nome=item.nome, tamanho=item.tamanho, genero=item.genero, quantidade=qtd)
        db.session.add(hist); db.session.commit(); flash('Sa√≠da registada.', 'success')
    else: flash('Stock insuficiente.', 'error')
    return redirect(url_for('estoque.gerenciar_estoque'))

@estoque_bp.route('/estoque/excluir/<int:id>')
@login_required
@permission_required('ESTOQUE')
def excluir_item(id):
    item = ItemEstoque.query.get(id)
    if item: db.session.delete(item); db.session.commit(); flash('Item removido.', 'warning')
    return redirect(url_for('estoque.gerenciar_estoque'))




##################################################

FILE: app\estoque\templates\estoque\controle_uniforme.html
----------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col gap-4 mb-8">
    <h2 class="text-2xl font-bold text-slate-800">Controle de Uniforme</h2>
    <div class="grid grid-cols-2 gap-4">
        <a href="/entrada" class="bg-emerald-600 hover:bg-emerald-700 text-white p-4 rounded-full shadow-lg flex items-center justify-center gap-2 text-center"><i class="fas fa-arrow-down"></i> <span class="font-bold">ENTRADA</span></a>
        <a href="/saida" class="bg-red-600 hover:bg-red-700 text-white p-4 rounded-full shadow-lg flex items-center justify-center gap-2 text-center"><i class="fas fa-arrow-up"></i> <span class="font-bold">SA√çDA</span></a>
    </div>
</div>
<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
        <h2 class="font-semibold text-slate-800">Invent√°rio</h2>
        <div class="flex gap-2 text-[10px] font-bold uppercase">
            <span class="text-emerald-600"><i class="fas fa-circle text-[6px]"></i> Bom</span>
            <span class="text-yellow-600"><i class="fas fa-circle text-[6px]"></i> M√©dio</span>
            <span class="text-red-600"><i class="fas fa-circle text-[6px]"></i> Ruim</span>
        </div>
    </div>
    <div class="divide-y divide-slate-100">
        {% for item in itens %}
        <div class="px-6 py-4 flex items-center justify-between hover:bg-slate-50 transition">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-full flex items-center justify-center text-slate-500 bg-slate-100 font-bold text-xs border border-slate-200">{{ item.tamanho }}</div>
                <div><div class="font-semibold text-slate-800 text-sm">{{ item.nome }}</div><div class="text-xs text-slate-500 flex items-center gap-1">{{ item.genero }}</div></div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <div class="text-lg font-bold {% if item.quantidade <= item.estoque_minimo %} text-red-600 {% elif item.quantidade >= item.estoque_ideal %} text-emerald-600 {% else %} text-yellow-600 {% endif %}">{{ item.quantidade }}</div>
                    <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Estoque</div>
                </div>
                <a href="/gerenciar/item/{{ item.id }}" class="text-slate-300 hover:text-blue-500 px-2"><i class="fas fa-pencil-alt"></i></a>
            </div>
        </div>
        {% else %}
        <div class="p-12 text-center text-slate-400">Nenhum item registrado.</div>
        {% endfor %}
    </div>
</div>
{% endblock %}

##################################################

FILE: app\estoque\templates\estoque\editar_item.html
----------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex items-center justify-between mb-6">
    <h2 class="text-lg font-bold text-slate-800">Editar Detalhes</h2>
    <a href="/gerenciar/selecao" class="text-xs font-medium text-slate-500 hover:text-slate-800">Voltar</a>
</div>

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <form action="/gerenciar/item/{{ item.id }}" method="POST" class="p-6 space-y-6">
        
        <!-- Dados B√°sicos -->
        <div class="space-y-4">
            <div>
                <label class="label-pro">Nome do Item</label>
                <input type="text" name="nome" value="{{ item.nome }}" class="input-pro" required>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label-pro">Tamanho</label>
                    <select name="tamanho" class="input-pro">
                        <option value="P" {% if item.tamanho == 'P' %}selected{% endif %}>P</option>
                        <option value="M" {% if item.tamanho == 'M' %}selected{% endif %}>M</option>
                        <option value="G" {% if item.tamanho == 'G' %}selected{% endif %}>G</option>
                        <option value="GG" {% if item.tamanho == 'GG' %}selected{% endif %}>GG</option>
                        <option value="XG" {% if item.tamanho == 'XG' %}selected{% endif %}>XG</option>
                    </select>
                </div>
                <div>
                    <label class="label-pro">G√™nero</label>
                    <select name="genero" class="input-pro">
                        <option value="Masculino" {% if item.genero == 'Masculino' %}selected{% endif %}>Masculino</option>
                        <option value="Feminino" {% if item.genero == 'Feminino' %}selected{% endif %}>Feminino</option>
                        <option value="Unissex" {% if item.genero == 'Unissex' %}selected{% endif %}>Unissex</option>
                    </select>
                </div>
            </div>
        </div>

        <hr class="border-slate-100">

        <!-- Quantidade e N√≠veis -->
        <div class="space-y-4">
            <div>
                <label class="label-pro text-blue-600">Quantidade Atual (Ajuste Manual)</label>
                <input type="number" name="quantidade" value="{{ item.quantidade }}" class="input-pro font-bold text-blue-700" required>
            </div>
            
            <div class="grid grid-cols-2 gap-4 bg-slate-50 p-4 rounded-lg border border-slate-100">
                <div>
                    <label class="label-pro text-red-500">Estoque Ruim (M√≠nimo)</label>
                    <input type="number" name="estoque_minimo" value="{{ item.estoque_minimo }}" class="input-pro border-red-200 text-red-600" required>
                </div>
                <div>
                    <label class="label-pro text-emerald-500">Estoque Bom (Ideal)</label>
                    <input type="number" name="estoque_ideal" value="{{ item.estoque_ideal }}" class="input-pro border-emerald-200 text-emerald-600" required>
                </div>
                <div class="col-span-2 text-[10px] text-center text-slate-400">
                    * Entre o M√≠nimo e o Ideal ser√° considerado "M√©dio" (Amarelo).
                </div>
            </div>
        </div>

        <div class="flex gap-3 pt-4">
            <button type="submit" name="acao" value="salvar" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition">
                SALVAR ALTERA√á√ïES
            </button>
            <button type="submit" name="acao" value="excluir" class="flex-none bg-red-100 hover:bg-red-200 text-red-600 font-bold py-3 px-6 rounded-lg transition" onclick="return confirm('Tem certeza? Isso apagar√° o item permanentemente.')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </form>
</div>

<style>
    .label-pro { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
    .input-pro { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem 1rem; color: #1e293b; font-weight: 500; outline: none; transition: all; }
    .input-pro:focus { background-color: #fff; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
</style>
{% endblock %}

##################################################

FILE: app\estoque\templates\estoque\editar_log_entrada.html
-----------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
    <h2 class="text-lg font-bold text-slate-800 mb-4">Editar Hist√≥rico (Entrada)</h2>
    <form action="/historico/entrada/editar/{{ log.id }}" method="POST" class="space-y-4">
        <div><label class="label-pro">Item (Texto)</label><input type="text" name="item_nome" value="{{ log.item_nome }}" class="input-pro"></div>
        <div><label class="label-pro">Quantidade Original</label><input type="number" name="quantidade" value="{{ log.quantidade }}" class="input-pro"></div>
        <div><label class="label-pro">Data/Hora</label><input type="datetime-local" name="data" value="{{ log.data_hora.strftime('%Y-%m-%dT%H:%M') }}" class="input-pro"></div>
        
        <div class="flex gap-3 pt-4">
            <button type="submit" name="acao" value="salvar" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg">Salvar Corre√ß√£o</button>
            <button type="submit" name="acao" value="excluir" class="flex-none bg-red-100 text-red-600 font-bold py-3 px-6 rounded-lg" onclick="return confirm('Excluir este registro? O estoque atual N√ÉO ser√° alterado.')"><i class="fas fa-trash"></i></button>
        </div>
        <p class="text-[10px] text-slate-400 mt-2 text-center">Nota: Alterar este log n√£o muda o estoque atual. Use o menu Gerenciar para ajustar quantidades atuais.</p>
    </form>
</div>
<style>.label-pro { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem; } .input-pro { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem 1rem; }</style>
{% endblock %}

##################################################

FILE: app\estoque\templates\estoque\editar_log_saida.html
---------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
    <h2 class="text-lg font-bold text-slate-800 mb-4">Editar Hist√≥rico (Sa√≠da)</h2>
    <form action="/historico/saida/editar/{{ log.id }}" method="POST" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
            <div><label class="label-pro">Coordenador</label><input type="text" name="coordenador" value="{{ log.coordenador }}" class="input-pro"></div>
            <div><label class="label-pro">Colaborador</label><input type="text" name="colaborador" value="{{ log.colaborador }}" class="input-pro"></div>
        </div>
        <div><label class="label-pro">Item (Texto)</label><input type="text" name="item_nome" value="{{ log.item_nome }}" class="input-pro"></div>
        <div><label class="label-pro">Quantidade</label><input type="number" name="quantidade" value="{{ log.quantidade }}" class="input-pro"></div>
        <div><label class="label-pro">Data</label><input type="date" name="data" value="{{ log.data_entrega.strftime('%Y-%m-%d') }}" class="input-pro"></div>
        
        <div class="flex gap-3 pt-4">
            <button type="submit" name="acao" value="salvar" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg">Salvar Corre√ß√£o</button>
            <button type="submit" name="acao" value="excluir" class="flex-none bg-red-100 text-red-600 font-bold py-3 px-6 rounded-lg" onclick="return confirm('Excluir este registro?')"><i class="fas fa-trash"></i></button>
        </div>
    </form>
</div>
<style>.label-pro { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem; } .input-pro { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem 1rem; }</style>
{% endblock %}

##################################################

FILE: app\estoque\templates\estoque\entrada.html
------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-6">
    <div class="bg-emerald-50 px-6 py-4 border-b border-emerald-100">
        <h2 class="text-lg font-bold text-emerald-800">Nova Entrada</h2>
        <p class="text-xs text-emerald-600">Adicione itens pr√©-definidos ou crie novos.</p>
    </div>
    <form action="/entrada" method="POST" class="p-6 space-y-5">
        <div>
            <label class="label-pro">Item / Uniforme</label>
            <select name="nome_select" id="nome_select" class="input-pro" onchange="verificarOutros(this)">
                <option value="Camisa T√°tico">Camisa T√°tico</option>
                <option value="Cal√ßa T√°tico">Cal√ßa T√°tico</option>
                <option value="Camisa Portaria">Camisa Portaria</option>
                <option value="Cal√ßa Portaria">Cal√ßa Portaria</option>
                <option value="Blazer Portaria">Blazer Portaria</option>
                <option value="Camisa Limpeza">Camisa Limpeza</option>
                <option value="Cal√ßa Limpeza">Cal√ßa Limpeza</option>
                <option value="Outros">Outros...</option>
            </select>
        </div>
        <div id="div_outros" class="hidden animate-fade-in">
            <label class="label-pro text-blue-600">Digite o nome do Item</label>
            <input type="text" name="nome_outros" id="nome_outros" class="input-pro border-blue-300 bg-blue-50" placeholder="Ex: Sapato Social">
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div><label class="label-pro">Tamanho</label><select name="tamanho" class="input-pro"><option value="P">P</option><option value="M">M</option><option value="G">G</option><option value="GG">GG</option><option value="XG">XG</option></select></div>
            <div><label class="label-pro">G√™nero</label><select name="genero" class="input-pro"><option value="Masculino">Masculino</option><option value="Feminino">Feminino</option><option value="Unissex">Unissex</option></select></div>
        </div>
        <div><label class="label-pro text-emerald-600">Quantidade</label><input type="number" name="quantidade" min="1" value="1" class="input-pro font-bold text-lg text-emerald-700" required></div>
        <div class="pt-4 border-t border-slate-100">
            <p class="text-xs font-bold text-slate-400 uppercase mb-3">Defini√ß√£o de N√≠veis (Opcional)</p>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="label-pro text-red-400">M√≠nimo (Ruim)</label><input type="number" name="estoque_minimo" value="5" class="input-pro text-xs"></div>
                <div><label class="label-pro text-emerald-400">Ideal (Bom)</label><input type="number" name="estoque_ideal" value="20" class="input-pro text-xs"></div>
            </div>
        </div>
        <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-lg shadow-md hover:shadow-lg transition">ADICIONAR</button>
    </form>
</div>

<!-- Bot√£o de Hist√≥rico Restaurado -->
<a href="/historico/entrada" class="block bg-slate-100 hover:bg-slate-200 text-slate-600 text-center py-3 rounded-lg font-bold text-xs transition">
    <i class="fas fa-history mr-1"></i> VER HIST√ìRICO DE ENTRADAS
</a>

<script>
    function verificarOutros(select) {
        const div = document.getElementById('div_outros');
        const input = document.getElementById('nome_outros');
        if (select.value === 'Outros') { div.classList.remove('hidden'); input.required = true; input.focus(); } 
        else { div.classList.add('hidden'); input.required = false; }
    }
</script>
<style>.label-pro { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; } .input-pro { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem 1rem; color: #1e293b; font-weight: 500; outline: none; }</style>
{% endblock %}

##################################################

FILE: app\estoque\templates\estoque\historico_entrada.html
----------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6"><h2 class="text-lg font-bold text-slate-800">Log de Entradas</h2></div>
<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="divide-y divide-slate-100">
        {% for log in logs %}
        <div class="p-4 flex justify-between items-center hover:bg-slate-50">
            <div>
                <div class="text-xs text-slate-400 font-bold">{{ log.data_hora.strftime('%d/%m %H:%M') }}</div>
                <div class="font-medium text-slate-800 text-sm">{{ log.item_nome }}</div>
            </div>
            <div class="flex items-center gap-4">
                <span class="font-bold text-emerald-600">+{{ log.quantidade }}</span>
                <a href="/historico/entrada/editar/{{ log.id }}" class="text-slate-300 hover:text-blue-500"><i class="fas fa-pencil-alt"></i></a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

##################################################

FILE: app\estoque\templates\estoque\historico_saida.html
--------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6"><h2 class="text-lg font-bold text-slate-800">Registro de Entregas</h2></div>
<div class="space-y-3">
    {% for log in logs %}
    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition relative group">
        <a href="/historico/saida/editar/{{ log.id }}" class="absolute top-4 right-4 text-slate-300 hover:text-blue-500 p-2"><i class="fas fa-pencil-alt"></i></a>
        <div class="flex justify-between items-start mb-2">
            <div class="text-xs font-bold text-slate-400 uppercase tracking-wide">{{ log.data_entrega.strftime('%d/%m/%Y') }}</div>
            <div class="bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded font-bold mr-8">-{{ log.quantidade }} UN</div>
        </div>
        <div class="flex items-center gap-3 mb-3">
             <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-xs">{{ log.colaborador[:1] }}</div>
             <div><div class="font-bold text-slate-800">{{ log.colaborador }}</div><div class="text-xs text-slate-500">Autorizado por: {{ log.coordenador }}</div></div>
        </div>
        <!-- Detalhes de Tamanho e Genero -->
        <div class="pt-3 border-t border-slate-100 text-sm text-slate-700 flex items-center gap-2">
            <i class="fas fa-tshirt text-slate-400"></i> 
            <span class="font-semibold">{{ log.item_nome }}</span>
            <span class="text-slate-300">|</span>
            <span class="bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded text-xs font-bold">{{ log.tamanho }}</span>
            <span class="text-slate-300">|</span>
            <span class="text-xs text-slate-500">{{ log.genero }}</span>
        </div>
    </div>
    {% else %}
    <div class="text-center py-10 text-slate-400">Nenhuma entrega registrada.</div>
    {% endfor %}
</div>
{% endblock %}

##################################################

FILE: app\estoque\templates\estoque\saida.html
----------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="bg-red-50 px-6 py-4 border-b border-red-100">
        <h2 class="text-lg font-bold text-red-800">Registrar Sa√≠da</h2>
        <p class="text-xs text-red-600">Baixa de estoque e entrega de EPI/Uniforme.</p>
    </div>
    <form action="/saida" method="POST" class="p-6 space-y-5">
        <div>
            <label class="label-pro">Selecionar Item</label>
            <div class="relative">
                <select name="item_id" class="input-pro appearance-none" required>
                    <option value="" disabled selected>Escolha...</option>
                    {% for item in itens %}
                    <option value="{{ item.id }}">{{ item.nome }} - {{ item.tamanho }} ({{ item.genero }}) | Disp: {{ item.quantidade }}</option>
                    {% endfor %}
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500"><i class="fas fa-chevron-down text-xs"></i></div>
            </div>
        </div>
        <div><label class="label-pro text-red-600">Quantidade a Retirar</label><input type="number" name="quantidade" min="1" value="1" class="input-pro font-bold text-lg text-red-600" required></div>
        <div class="grid grid-cols-2 gap-4">
            <div><label class="label-pro">Coordenador</label><input type="text" name="coordenador" class="input-pro" required></div>
            <div><label class="label-pro">Colaborador</label><input type="text" name="colaborador" class="input-pro" required></div>
        </div>
        <div><label class="label-pro">Data Entrega</label><input type="date" name="data" class="input-pro" required></div>
        <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-lg shadow-md hover:shadow-lg transition">CONFIRMAR SA√çDA</button>
    </form>
</div>
<div class="text-center mt-4"><a href="/historico/saida" class="text-xs font-bold text-red-600 hover:underline">VER HIST√ìRICO DE SA√çDAS</a></div>
<style>.label-pro { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; } .input-pro { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem 1rem; color: #1e293b; font-weight: 500; outline: none; }</style>
{% endblock %}

##################################################

FILE: app\estoque\templates\estoque\selecionar_edicao.html
----------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 shadow-lg p-8 max-w-lg mx-auto">
    <h2 class="text-xl font-bold text-slate-800 mb-6 text-center">Gerenciar Item</h2>
    
    <form action="/gerenciar/selecao" method="POST" class="space-y-6">
        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Selecione o Item para Editar/Excluir</label>
            <div class="relative">
                <select name="item_id" class="w-full appearance-none bg-slate-50 border border-slate-200 rounded-lg px-4 py-4 text-slate-800 font-medium focus:outline-none focus:ring-2 focus:ring-blue-500" required onchange="this.form.submit()">
                    <option value="" disabled selected>Clique para selecionar...</option>
                    {% for item in itens %}
                    <option value="{{ item.id }}">{{ item.nome }} - {{ item.tamanho }} ({{ item.genero }})</option>
                    {% endfor %}
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
        </div>
        <div class="text-center">
            <a href="/" class="text-sm text-slate-400 hover:text-slate-600">Cancelar</a>
        </div>
    </form>
</div>
{% endblock %}

##################################################

FILE: app\main\__init__.py
--------------------------
# M√≥dulo main

##################################################

FILE: app\main\routes.py
------------------------
from flask import Blueprint, render_template, redirect, url_for
from flask_login import login_required, current_user
from app.models import User, PontoAjuste, Recibo, Holerite, PreCadastro
from app.utils import get_brasil_time, has_permission

main_bp = Blueprint('main', __name__)

@main_bp.route('/')
@login_required
def dashboard():
    if current_user.is_first_access:
        return redirect(url_for('auth.primeiro_acesso'))
    
    # CORRE√á√ÉO: Nome correto da rota do scanner
    if current_user.role == 'Terminal':
        return redirect(url_for('ponto.terminal_scanner'))

    # Dados B√°sicos (Todos V√™em)
    dados = {
        'hoje': get_brasil_time().strftime('%d/%m/%Y'),
        'doc_pendentes': 0
    }

    # Contagem de documentos n√£o lidos pelo utilizador
    docs_h = Holerite.query.filter_by(user_id=current_user.id, visualizado=False).count()
    docs_r = Recibo.query.filter_by(user_id=current_user.id, visualizado=False).count()
    dados['doc_pendentes'] = docs_h + docs_r

    # Dados Administrativos (Apenas se tiver permiss√£o ou for Master)
    admin_stats = {}
    
    if has_permission('USUARIOS'):
        # FILTRO: N√£o conta o Terminal como funcion√°rio ativo
        admin_stats['total_users'] = User.query.filter(User.username != '12345678900', User.username != 'terminal').count()
        admin_stats['pendentes_cadastro'] = PreCadastro.query.count()

    if has_permission('PONTO'):
        admin_stats['ajustes_pendentes'] = PontoAjuste.query.filter_by(status='Pendente').count()

    return render_template('main/dashboard.html', dados=dados, admin=admin_stats)

##################################################

FILE: app\main\templates\main\dashboard.html
--------------------------------------------
{% extends 'base.html' %}
{% block content %}

<!-- Widget de Ponto -->
<div class="bg-gradient-to-r from-blue-900 to-slate-900 rounded-2xl p-6 text-white shadow-xl mb-8 flex justify-between items-center relative overflow-hidden transition transform hover:scale-[1.01]">
    <div class="absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
    <div>
        <p class="text-xs font-bold text-blue-300 uppercase tracking-widest mb-1">Status Hoje</p>
        <h2 class="text-2xl font-bold mb-1">{{ status_ponto }}</h2>
        <p class="text-xs opacity-70">{{ current_user.real_name }}</p>
    </div>
    <a href="/ponto/registrar" class="bg-white text-blue-900 hover:bg-blue-50 font-bold py-3 px-6 rounded-full shadow-lg transition transform hover:scale-105 flex items-center gap-2 z-10">
        <i class="fas fa-fingerprint"></i> <span>REGISTRAR</span>
    </a>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
        <h3 class="font-bold text-slate-700 mb-2"><i class="fas fa-bolt text-yellow-500 mr-2"></i>Acesso R√°pido</h3>
        <div class="flex flex-col gap-2 mt-4">
             <a href="/ponto/espelho" class="text-sm text-slate-600 hover:text-blue-600 flex items-center gap-2"><i class="fas fa-calendar-alt w-5"></i> Ver meu Espelho</a>
             <a href="/holerites/meus-documentos" class="text-sm text-slate-600 hover:text-blue-600 flex items-center gap-2"><i class="fas fa-file-invoice w-5"></i> Meus Holerites</a>
             <a href="/ponto/solicitar-ajuste" class="text-sm text-slate-600 hover:text-blue-600 flex items-center gap-2"><i class="fas fa-exclamation-circle w-5"></i> Ajustar Ponto</a>
        </div>
    </div>
    
    {% if current_user.role != 'Master' %}
    <div class="bg-blue-50 p-6 rounded-xl border border-blue-100 shadow-sm flex items-center justify-center text-center">
        <div>
            <div class="text-blue-200 text-4xl mb-2"><i class="fas fa-quote-left"></i></div>
            <p class="text-blue-800 font-medium italic text-sm">"O sucesso √© a soma de pequenos esfor√ßos repetidos dia ap√≥s dia."</p>
        </div>
    </div>
    {% endif %}

    {% if current_user.role == 'Master' %}
    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-purple-500 hover:shadow-md transition">
        <h3 class="font-bold text-slate-700 mb-2"><i class="fas fa-crown text-purple-500 mr-2"></i>√Årea Master</h3>
        <div class="grid grid-cols-2 gap-2 mt-4">
            <a href="/admin/usuarios" class="bg-slate-50 hover:bg-slate-100 p-2 rounded text-center text-xs font-bold text-slate-600 border border-slate-200">Funcion√°rios</a>
            <a href="/admin/solicitacoes" class="bg-slate-50 hover:bg-slate-100 p-2 rounded text-center text-xs font-bold text-slate-600 border border-slate-200">Solicita√ß√µes</a>
        </div>
    </div>
    {% endif %}
</div>

<!-- GR√ÅFICOS MASTER -->
{% if current_user.role == 'Master' and dados_graficos %}
<h3 class="text-lg font-bold text-slate-800 mb-4 px-2">Vis√£o Geral</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
    <!-- Gr√°fico 1 -->
    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
        <h4 class="text-xs font-bold text-red-500 uppercase mb-4">Estoque Cr√≠tico</h4>
        {% if dados_graficos.estoque_labels %}
            <canvas id="chartEstoque"></canvas>
        {% else %}
            <div class="h-40 flex items-center justify-center text-slate-400 text-sm">Estoque saud√°vel.</div>
        {% endif %}
    </div>

    <!-- Gr√°fico 2 -->
    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
        <h4 class="text-xs font-bold text-blue-500 uppercase mb-4">Pontualidade (M√™s)</h4>
        <div class="h-48">
            <canvas id="chartPonto"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    {% if dados_graficos.estoque_labels %}
    const ctxEstoque = document.getElementById('chartEstoque');
    new Chart(ctxEstoque, {
        type: 'bar',
        data: {
            labels: {{ dados_graficos.estoque_labels | tojson }},
            datasets: [{
                label: 'Qtd Atual',
                data: {{ dados_graficos.estoque_data | tojson }},
                backgroundColor: '#ef4444',
                borderRadius: 4
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
    {% endif %}

    const ctxPonto = document.getElementById('chartPonto');
    const dadosPonto = {{ dados_graficos.ponto_status | tojson }};
    new Chart(ctxPonto, {
        type: 'doughnut',
        data: {
            labels: ['OK', 'Falta', 'Hora Extra', 'D√©bito'],
            datasets: [{
                data: [dadosPonto['OK'], dadosPonto['Falta'], dadosPonto['Hora Extra'], dadosPonto['D√©bito']],
                backgroundColor: ['#10b981', '#ef4444', '#3b82f6', '#f59e0b'],
                borderWidth: 0
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } } }
    });
</script>
{% endif %}

{% endblock %}


##################################################

FILE: app\models\__init__.py
----------------------------
from app.extensions import db
from flask_login import UserMixin
from werkzeug.security import generate_password_hash, check_password_hash
from datetime import datetime
import pytz

def get_brasil_time():
    return datetime.now(pytz.timezone('America/Sao_Paulo'))

class User(UserMixin, db.Model):
    __tablename__ = 'users'
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    password_hash = db.Column(db.String(200), nullable=False)
    real_name = db.Column(db.String(120), nullable=False)
    cpf = db.Column(db.String(14), unique=True, nullable=True)
    role = db.Column(db.String(20), default='Funcionario') # Master, Admin, Funcionario, Terminal
    permissions = db.Column(db.String(500), nullable=True) # Ex: "DOCUMENTOS,PONTO,ESTOQUE"
    is_first_access = db.Column(db.Boolean, default=True)
    
    # Dados de Ponto
    carga_horaria = db.Column(db.Integer, default=528)
    tempo_intervalo = db.Column(db.Integer, default=60)
    inicio_jornada_ideal = db.Column(db.String(5), default="08:00")
    escala = db.Column(db.String(20), default="Livre")
    data_inicio_escala = db.Column(db.Date, nullable=True)
    
    # Dados Financeiros
    salario = db.Column(db.Float, default=0.0)
    razao_social_empregadora = db.Column(db.String(200))
    cnpj_empregador = db.Column(db.String(20))

    def set_password(self, password):
        self.password_hash = generate_password_hash(password)

    def check_password(self, password):
        return check_password_hash(self.password_hash, password)

class Holerite(db.Model):
    __tablename__ = 'holerites'
    id = db.Column(db.Integer, primary_key=True)
    # user_id agora aceita NULL (None) para quando a IA n√£o identifica o nome de primeira
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=True)
    mes_referencia = db.Column(db.String(7), nullable=False) 
    
    # Colunas novas para GCS e Revis√£o
    status = db.Column(db.String(20), default='Enviado') # 'Enviado' ou 'Revisao'
    url_arquivo = db.Column(db.String(500), nullable=True) 
    
    conteudo_pdf = db.Column(db.LargeBinary, nullable=True) 
    visualizado = db.Column(db.Boolean, default=False)
    visualizado_em = db.Column(db.DateTime, nullable=True)
    enviado_em = db.Column(db.DateTime, default=get_brasil_time)

    user = db.relationship('User', backref=db.backref('holerites', lazy=True))

class Recibo(db.Model):
    __tablename__ = 'recibos'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    valor = db.Column(db.Float, nullable=False)
    data_pagamento = db.Column(db.Date, nullable=False)
    
    tipo_vale_alimentacao = db.Column(db.Boolean, default=False)
    tipo_vale_transporte = db.Column(db.Boolean, default=False)
    tipo_assiduidade = db.Column(db.Boolean, default=False)
    tipo_cesta_basica = db.Column(db.Boolean, default=False)
    
    forma_pagamento = db.Column(db.String(50), default="Transfer√™ncia")
    conteudo_pdf = db.Column(db.LargeBinary, nullable=True)
    visualizado = db.Column(db.Boolean, default=False)
    created_at = db.Column(db.DateTime, default=get_brasil_time)

    user = db.relationship('User', backref=db.backref('recibos', lazy=True))

class AssinaturaDigital(db.Model):
    __tablename__ = 'assinaturas_digitais'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    tipo_documento = db.Column(db.String(50), nullable=False) 
    documento_id = db.Column(db.Integer, nullable=False)
    hash_arquivo = db.Column(db.String(128), nullable=False)
    ip_address = db.Column(db.String(45))
    user_agent = db.Column(db.String(255))
    data_assinatura = db.Column(db.DateTime, default=get_brasil_time)

    user = db.relationship('User', backref=db.backref('assinaturas', lazy=True))

# Registros de Ponto
class PontoRegistro(db.Model):
    __tablename__ = 'ponto_registros'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    data_registro = db.Column(db.Date, nullable=False)
    hora_registro = db.Column(db.Time, nullable=False)
    tipo = db.Column(db.String(20)) # Entrada, Sa√≠da, etc
    latitude = db.Column(db.String(50))
    longitude = db.Column(db.String(50))

class PontoResumo(db.Model):
    __tablename__ = 'ponto_resumos'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    data_referencia = db.Column(db.Date, nullable=False)
    minutos_trabalhados = db.Column(db.Integer, default=0)
    minutos_extras = db.Column(db.Integer, default=0)
    minutos_falta = db.Column(db.Integer, default=0)
    saldo_dia = db.Column(db.Integer, default=0)

class PontoAjuste(db.Model):
    __tablename__ = 'ponto_ajustes'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    data_referencia = db.Column(db.Date, nullable=False)
    ponto_original_id = db.Column(db.Integer, nullable=True)
    novo_horario = db.Column(db.String(5))
    tipo_batida = db.Column(db.String(20))
    tipo_solicitacao = db.Column(db.String(20)) # Inclusao, Edicao, Exclusao
    justificativa = db.Column(db.Text)
    status = db.Column(db.String(20), default='Pendente')
    motivo_reprovacao = db.Column(db.Text)
    created_at = db.Column(db.DateTime, default=get_brasil_time)

##################################################

FILE: app\ponto\__init__.py
---------------------------
# M√≥dulo ponto

##################################################

FILE: app\ponto\routes.py
-------------------------
from flask import Blueprint, render_template, request, redirect, url_for, flash, jsonify, current_app
from flask_login import login_required, current_user
# ADICIONADO: Importa√ß√£o do 'csrf' para permitir a isen√ß√£o na rota da API
from app.extensions import db, csrf
from app.models import PontoRegistro, PontoResumo, User, PontoAjuste
from app.utils import get_brasil_time, calcular_dia, format_minutes_to_hm, data_por_extenso
from datetime import datetime, date
from sqlalchemy import func
from itsdangerous import URLSafeTimedSerializer, SignatureExpired, BadSignature
import logging

# Configura√ß√£o de Log
logger = logging.getLogger(__name__)

ponto_bp = Blueprint('ponto', __name__, template_folder='templates', url_prefix='/ponto')

# --- APIS DO SISTEMA DE PONTO ---

@ponto_bp.route('/api/gerar-token', methods=['GET'])
@login_required
def gerar_token_qrcode():
    if current_user.role == 'Terminal': 
        return jsonify({'error': 'Terminal n√£o gera token'}), 403
    
    s = URLSafeTimedSerializer(current_app.secret_key)
    token = s.dumps({'user_id': current_user.id, 'timestamp': get_brasil_time().timestamp()})
    return jsonify({'token': token})

@ponto_bp.route('/api/check-status', methods=['GET'])
@login_required
def check_status_ponto():
    """Verifica se o usu√°rio acabou de bater o ponto no terminal."""
    if current_user.role == 'Terminal': 
        return jsonify({'status': 'ignorar'})
    
    agora = get_brasil_time()
    # Busca o √∫ltimo ponto registrado deste usu√°rio
    ultimo_ponto = PontoRegistro.query.filter_by(user_id=current_user.id).order_by(PontoRegistro.id.desc()).first()
    
    if ultimo_ponto:
        # Combina data e hora para ter o timestamp completo
        dt_ponto = datetime.combine(ultimo_ponto.data_registro, ultimo_ponto.hora_registro)
        
        # Calcula a diferen√ßa em segundos
        diferenca = (agora - dt_ponto).total_seconds()
        
        # Se o ponto foi batido nos √∫ltimos 15 segundos, avisa o front-end
        if diferenca < 15:
            return jsonify({
                'marcado': True, 
                'tipo': ultimo_ponto.tipo, 
                'hora': ultimo_ponto.hora_registro.strftime('%H:%M')
            })
            
    return jsonify({'marcado': False})

@ponto_bp.route('/api/registrar-leitura', methods=['POST'])
@login_required
@csrf.exempt # --- CORRE√á√ÉO: Permite POST via API sem token de formul√°rio ---
def registrar_leitura_terminal():
    if current_user.role != 'Terminal' and current_user.role != 'Master': 
        return jsonify({'error': 'Acesso negado.'}), 403
    
    data = request.json
    token = data.get('token')
    
    if not token: 
        return jsonify({'error': 'Token vazio'}), 400
    
    s = URLSafeTimedSerializer(current_app.secret_key)
    try:
        dados = s.loads(token, max_age=35) # Token expira em 35s
        user_alvo = User.query.get(dados['user_id'])
        
        if not user_alvo: 
            return jsonify({'error': 'Usu√°rio inv√°lido'}), 404
        
        hoje = get_brasil_time().date()
        
        # Evita duplicidade (mesmo usu√°rio batendo 2x em menos de 1 min)
        ultimo = PontoRegistro.query.filter_by(user_id=user_alvo.id, data_registro=hoje).order_by(PontoRegistro.hora_registro.desc()).first()
        if ultimo:
            agora_time = get_brasil_time()
            dt_ultimo = datetime.combine(hoje, ultimo.hora_registro)
            if (agora_time - dt_ultimo).total_seconds() < 60:
                 return jsonify({'error': f'Ponto j√° registrado h√° instantes ({ultimo.hora_registro.strftime("%H:%M")}). Aguarde.'}), 400

        pontos_hoje = PontoRegistro.query.filter_by(user_id=user_alvo.id, data_registro=hoje).order_by(PontoRegistro.hora_registro).all()
        
        proxima = "Entrada"
        if len(pontos_hoje) == 1: proxima = "Ida Almo√ßo"
        elif len(pontos_hoje) == 2: proxima = "Volta Almo√ßo"
        elif len(pontos_hoje) == 3: proxima = "Sa√≠da"
        elif len(pontos_hoje) >= 4: proxima = "Extra"
        
        novo = PontoRegistro(
            user_id=user_alvo.id, 
            data_registro=hoje, 
            hora_registro=get_brasil_time().time(), 
            tipo=proxima, 
            latitude='QR-Code', 
            longitude='Presencial'
        )
        db.session.add(novo)
        db.session.commit()
        
        calcular_dia(user_alvo.id, hoje)
        
        return jsonify({
            'success': True, 
            'message': f'Ponto registrado: {proxima}', 
            'funcionario': user_alvo.real_name, 
            'hora': novo.hora_registro.strftime('%H:%M'), 
            'tipo': proxima
        })

    except SignatureExpired: return jsonify({'error': 'QR Code expirado.'}), 400
    except BadSignature: return jsonify({'error': 'QR Code inv√°lido.'}), 400
    except Exception as e: return jsonify({'error': f'Erro interno: {str(e)}'}), 500

# --- ROTAS DE INTERFACE ---

@ponto_bp.route('/scanner')
@login_required
def terminal_scanner():
    # Permite apenas Terminal (CPF) ou Master
    if current_user.username != '12345678900' and current_user.role != 'Master':
        flash('Acesso restrito.')
        return redirect(url_for('main.dashboard'))
    return render_template('ponto/terminal_leitura.html')

@ponto_bp.route('/registrar', methods=['GET', 'POST'])
@login_required
def registrar_ponto():
    # Se for Terminal, redireciona para o scanner
    if current_user.username == '12345678900': 
        return redirect(url_for('ponto.terminal_scanner'))

    hoje = get_brasil_time().date()
    hoje_extenso = data_por_extenso(hoje)
    
    bloqueado = False
    motivo = ""
    
    if current_user.escala == '5x2' and hoje.weekday() >= 5: 
        bloqueado = True
        motivo = "Fim de semana (Escala 5x2)."
    elif current_user.escala == '12x36' and current_user.data_inicio_escala:
        if (hoje - current_user.data_inicio_escala).days % 2 != 0: 
            bloqueado = True
            motivo = "Dia de folga (Escala 12x36)."

    pontos = PontoRegistro.query.filter_by(user_id=current_user.id, data_registro=hoje).order_by(PontoRegistro.hora_registro).all()
    
    prox = "Entrada"
    if len(pontos) == 1: prox = "Ida Almo√ßo"
    elif len(pontos) == 2: prox = "Volta Almo√ßo"
    elif len(pontos) == 3: prox = "Sa√≠da"
    elif len(pontos) >= 4: prox = "Extra"

    if request.method == 'POST':
        if bloqueado: 
            flash('Bloqueado')
            return redirect(url_for('main.dashboard'))
        
        db.session.add(PontoRegistro(
            user_id=current_user.id, 
            data_registro=hoje, 
            hora_registro=get_brasil_time().time(), 
            tipo=prox, 
            latitude=request.form.get('latitude'), 
            longitude=request.form.get('longitude')
        ))
        db.session.commit()
        calcular_dia(current_user.id, hoje)
        return redirect(url_for('main.dashboard'))
    
    return render_template('ponto/registro.html', 
                         proxima_acao=prox, 
                         hoje_extenso=hoje_extenso, 
                         pontos=pontos, 
                         bloqueado=bloqueado, 
                         motivo=motivo, 
                         hoje=hoje)

@ponto_bp.route('/espelho')
@login_required
def espelho_ponto():
    target_user_id = request.args.get('user_id', type=int) or current_user.id
    
    if target_user_id != current_user.id and current_user.role != 'Master':
        return redirect(url_for('main.dashboard'))
    
    user = User.query.get_or_404(target_user_id)
    mes_ref = request.args.get('mes_ref') or get_brasil_time().strftime('%Y-%m')
    
    try: 
        ano, mes = map(int, mes_ref.split('-'))
    except: 
        hoje = get_brasil_time()
        ano, mes = hoje.year, hoje.month
        mes_ref = hoje.strftime('%Y-%m')
    
    resumos = PontoResumo.query.filter(
        PontoResumo.user_id == target_user_id,
        func.extract('year', PontoResumo.data_referencia) == ano,
        func.extract('month', PontoResumo.data_referencia) == mes
    ).order_by(PontoResumo.data_referencia).all()
    
    detalhes = {}
    for r in resumos:
        batidas = PontoRegistro.query.filter_by(user_id=target_user_id, data_registro=r.data_referencia).order_by(PontoRegistro.hora_registro).all()
        detalhes[r.id] = [b.hora_registro.strftime('%H:%M') for b in batidas]

    dias_semana = {0: 'Seg', 1: 'Ter', 2: 'Qua', 3: 'Qui', 4: 'Sex', 5: 'S√°b', 6: 'Dom'}

    return render_template('ponto/ponto_espelho.html', 
                         resumos=resumos, 
                         user=user, 
                         detalhes=detalhes, 
                         format_hm=format_minutes_to_hm, 
                         mes_ref=mes_ref,
                         dias_semana=dias_semana)

@ponto_bp.route('/solicitar-ajuste', methods=['GET', 'POST'])
@login_required
def solicitar_ajuste():
    pontos_dia = []
    data_selecionada = None
    meus_ajustes = PontoAjuste.query.filter_by(user_id=current_user.id).order_by(PontoAjuste.created_at.desc()).limit(20).all()
    
    if request.method == 'POST':
        if request.form.get('acao') == 'buscar':
            try: 
                data_selecionada = datetime.strptime(request.form.get('data_busca'), '%Y-%m-%d').date()
                pontos_dia = PontoRegistro.query.filter_by(user_id=current_user.id, data_registro=data_selecionada).order_by(PontoRegistro.hora_registro).all()
            except: 
                flash('Data inv√°lida')
        
        elif request.form.get('acao') == 'enviar':
            try:
                dt_obj = datetime.strptime(request.form.get('data_ref'), '%Y-%m-%d').date()
                p_id = int(request.form.get('ponto_id')) if request.form.get('ponto_id') else None
                
                solic = PontoAjuste(
                    user_id=current_user.id, 
                    data_referencia=dt_obj, 
                    ponto_original_id=p_id, 
                    novo_horario=request.form.get('novo_horario'), 
                    tipo_batida=request.form.get('tipo_batida'), 
                    tipo_solicitacao=request.form.get('tipo_solicitacao'), 
                    justificativa=request.form.get('justificativa')
                )
                db.session.add(solic)
                db.session.commit()
                flash('Enviado!')
                return redirect(url_for('ponto.solicitar_ajuste'))
            except: pass
            
    dados_extras = {}
    for p in meus_ajustes:
        if p.ponto_original_id:
            original = PontoRegistro.query.get(p.ponto_original_id)
            if original: dados_extras[p.id] = original.hora_registro.strftime('%H:%M')
            
    return render_template('ponto/solicitar_ajuste.html', 
                         pontos=pontos_dia, 
                         data_sel=data_selecionada, 
                         meus_ajustes=meus_ajustes, 
                         extras=dados_extras)

##################################################

FILE: app\ponto\templates\ponto\ponto_espelho.html
--------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div>
        <h2 class="text-2xl font-bold text-slate-800">Espelho de Ponto</h2>
        <p class="text-sm text-slate-500">Colaborador: <span class="font-bold text-slate-700">{{ user.real_name }}</span></p>
    </div>
    
    <!-- RESUMO DA REGRA -->
    <div class="bg-blue-50 px-4 py-2 rounded-lg border border-blue-100 text-right">
        <span class="text-[10px] font-bold text-blue-400 uppercase tracking-widest block">Meta Di√°ria</span>
        <div class="font-mono font-bold text-blue-800 text-lg">
            {{ format_hm(user.carga_horaria or 528).replace('-','') }} 
            <span class="text-xs text-blue-600 font-sans font-normal">+ {{ user.tempo_intervalo }}min Almo√ßo</span>
        </div>
        <div class="text-[10px] text-slate-400 mt-1">Per√≠odo: {{ mes_ref }}</div>
    </div>
</div>

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-left text-sm">
            <thead class="bg-slate-50 text-slate-400 font-bold text-xs uppercase border-b border-slate-100">
                <tr>
                    <th class="px-4 py-4">Data</th>
                    <th class="px-4 py-4">Registros (Entradas / Sa√≠das)</th>
                    <th class="px-4 py-4 text-center">Trabalhado</th>
                    <th class="px-4 py-4 text-center">Saldo</th>
                    <th class="px-4 py-4 text-right">Status</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
                {% for r in resumos %}
                <tr class="hover:bg-slate-50 transition cursor-help group" onclick="toggleDetails('det-{{ r.id }}')">
                    <td class="px-4 py-4 font-medium text-slate-700">
                        {{ r.data_referencia.strftime('%d/%m') }} 
                        <span class="text-slate-400 text-xs uppercase ml-1">
                            ({{ dias_semana[r.data_referencia.weekday()] }})
                        </span>
                    </td>
                    <td class="px-4 py-4">
                        <div class="flex flex-wrap gap-2">
                            {% for b in detalhes[r.id] %}
                            <span class="bg-white text-slate-700 px-2 py-1 rounded-md text-xs font-mono font-bold border border-slate-200 shadow-sm group-hover:border-blue-300 transition">
                                {{ b }}
                            </span>
                            {% endfor %}
                        </div>
                    </td>
                    <td class="px-4 py-4 text-center font-mono text-slate-600">
                        {{ format_hm(r.minutos_trabalhados).replace('-','') }}
                    </td>
                    <td class="px-4 py-4 text-center font-mono font-bold {% if r.minutos_saldo >= 0 %} text-emerald-600 {% else %} text-red-500 {% endif %}">
                        {{ format_hm(r.minutos_saldo) }}
                    </td>
                    <td class="px-4 py-4 text-right">
                        <span class="text-[10px] font-bold uppercase px-2 py-1 rounded-full 
                            {% if r.status_dia == 'OK' %} bg-emerald-50 text-emerald-600 
                            {% elif r.status_dia == 'Incompleto' %} bg-amber-50 text-amber-600 
                            {% elif r.status_dia == 'Falta' %} bg-red-50 text-red-600 
                            {% elif 'Extra' in r.status_dia %} bg-blue-50 text-blue-600 
                            {% else %} bg-slate-100 text-slate-500 {% endif %}">
                            {{ r.status_dia }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<div class="mt-4 text-center text-xs text-slate-400">
    <i class="fas fa-info-circle mr-1"></i> O saldo √© calculado subtraindo sua meta di√°ria do total trabalhado.
</div>
{% endblock %}




##################################################

FILE: app\ponto\templates\ponto\registro.html
---------------------------------------------
{% extends 'base.html' %}
{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<div class="max-w-md mx-auto text-center">
    
    <div class="mb-4">
        <h2 class="text-2xl font-bold text-slate-800">Meu Ponto</h2>
        <p class="text-sm text-slate-500">Aproxime este c√≥digo do Terminal na portaria.</p>
    </div>

    {% if bloqueado %}
    <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-r-xl shadow-md text-left mb-8">
        <h3 class="text-lg font-bold text-red-700 flex items-center gap-2"><i class="fas fa-ban"></i> A√á√ÉO BLOQUEADA</h3>
        <p class="text-sm text-red-600 mt-2">{{ motivo }}</p>
    </div>
    {% else %}
    
    <div class="bg-white rounded-3xl shadow-xl border border-slate-200 p-8 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-purple-600"></div>

        <div class="mb-4">
            <h3 class="text-xl font-bold text-slate-800">{{ current_user.real_name }}</h3>
            <p class="text-xs text-slate-400 font-mono uppercase">{{ current_user.role }}</p>
        </div>

        <!-- QR Code Gigante -->
        <div class="flex justify-center mb-6">
            <div id="qrcode" class="p-2 border-4 border-slate-900 rounded-xl bg-white"></div>
        </div>

        <div class="w-full bg-slate-100 rounded-full h-2.5 mb-2">
            <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-1000 ease-linear" style="width: 100%"></div>
        </div>
        <p class="text-xs text-slate-400 font-mono" id="statusToken">Atualizando em <span id="countdown">30</span>s...</p>

        <div class="mt-6 pt-6 border-t border-slate-100 flex justify-between items-center">
            <div class="text-left">
                <span class="block text-[10px] font-bold text-slate-400 uppercase">Pr√≥ximo Ponto</span>
                <span class="text-sm font-bold text-blue-600">{{ proxima_acao }}</span>
            </div>
            <div class="text-right">
                <span class="block text-[10px] font-bold text-slate-400 uppercase">Hoje</span>
                <span class="text-sm font-mono text-slate-600">{{ hoje.strftime('%d/%m') }}</span>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="mt-8 text-left">
        <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 ml-1">Batidas de Hoje</h3>
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden divide-y divide-slate-100">
            {% for p in pontos %}
            <div class="px-4 py-3 flex justify-between items-center">
                <span class="text-sm font-bold text-slate-700 flex items-center gap-2">
                    <i class="fas fa-circle text-[6px] {% if 'Entrada' in p.tipo %}text-emerald-500{% else %}text-amber-500{% endif %}"></i>
                    {{ p.tipo }}
                </span>
                <span class="text-sm font-mono text-slate-500 font-bold bg-slate-50 px-2 py-1 rounded">{{ p.hora_registro.strftime('%H:%M') }}</span>
            </div>
            {% else %}
            <div class="p-6 text-center text-xs text-slate-400">Ainda n√£o iniciou a jornada.</div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    let timerInterval;
    const TIME_LIMIT = 30; 
    let timeLeft = TIME_LIMIT;

    function generateQRCode() {
        fetch('/ponto/api/gerar-token')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('qrcode').innerHTML = `<p class="text-red-500 text-xs">${data.error}</p>`;
                    return;
                }
                const container = document.getElementById("qrcode");
                container.innerHTML = "";
                // AUMENTADO PARA 260px (Mais facil de ler)
                new QRCode(container, {
                    text: data.token,
                    width: 260,
                    height: 260,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.L // Low correction = menos pixels = mais facil ler
                });
                resetTimer();
            })
            .catch(err => { console.error("Erro:", err); });
    }

    function resetTimer() {
        timeLeft = TIME_LIMIT;
        clearInterval(timerInterval);
        const bar = document.getElementById("progressBar");
        const text = document.getElementById("countdown");

        timerInterval = setInterval(() => {
            timeLeft--;
            text.innerText = timeLeft;
            const pct = (timeLeft / TIME_LIMIT) * 100;
            bar.style.width = pct + "%";
            if (timeLeft <= 0) generateQRCode();
        }, 1000);
    }
    
    // Polling: Verifica se o ponto foi batido a cada 2 segundos
    setInterval(() => {
        {% if not bloqueado %}
        fetch('/ponto/api/check-status')
            .then(r => r.json())
            .then(data => {
                if (data.marcado) {
                    // Feedback Visual e Redirect
                    document.body.innerHTML = `
                        <div class="flex h-screen items-center justify-center bg-emerald-600 text-white flex-col">
                            <i class="fas fa-check-circle text-6xl mb-4 animate-bounce"></i>
                            <h1 class="text-3xl font-bold">PONTO REGISTRADO!</h1>
                            <p class="text-lg mt-2">${data.tipo} √†s ${data.hora}</p>
                            <p class="text-sm mt-4 opacity-80">Redirecionando...</p>
                        </div>
                    `;
                    setTimeout(() => { window.location.href = '/'; }, 3000);
                }
            });
        {% endif %}
    }, 2000);

    document.addEventListener("DOMContentLoaded", () => {
        {% if not bloqueado %} generateQRCode(); {% endif %}
    });
</script>
{% endblock %}

##################################################

FILE: app\ponto\templates\ponto\solicitar_ajuste.html
-----------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="mb-6"><h2 class="text-xl font-bold text-slate-800">Solicitar Ajuste</h2><p class="text-sm text-slate-500">Gest√£o de ponto.</p></div>

    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 mb-6">
        <form action="/ponto/solicitar-ajuste" method="POST" class="flex gap-4 items-end">
            <!-- TOKEN CSRF INJETADO -->
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <div class="flex-1">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Data do Ponto</label>
                <input type="date" name="data_busca" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3" required>
            </div>
            <button type="submit" name="acao" value="buscar" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow hover:bg-blue-700 transition"><i class="fas fa-search"></i></button>
        </form>
    </div>

    {% if data_sel %}
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 mb-8 animate-fade-in">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="font-bold text-slate-800">Registros em {{ data_sel.strftime('%d/%m/%Y') }}</h3>
            <button onclick="abrirInclusao()" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1 rounded font-bold transition"><i class="fas fa-plus mr-1"></i> ADICIONAR NOVO</button>
        </div>
        <div class="space-y-2 mb-6">
            {% for p in pontos %}
            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                <div><span class="text-xs font-bold text-slate-500 block">{{ p.tipo }}</span><span class="font-mono font-bold text-slate-800">{{ p.hora_registro.strftime('%H:%M') }}</span></div>
                <div class="flex gap-2">
                    <button onclick="abrirEdicao('{{ p.id }}', '{{ p.hora_registro.strftime('%H:%M') }}', '{{ p.tipo }}')" class="text-[10px] bg-blue-50 text-blue-600 font-bold px-2 py-1 rounded hover:bg-blue-100">EDITAR</button>
                    <button onclick="abrirExclusao('{{ p.id }}', '{{ p.hora_registro.strftime('%H:%M') }}')" class="text-[10px] bg-red-50 text-red-600 font-bold px-2 py-1 rounded hover:bg-red-100">EXCLUIR</button>
                </div>
            </div>
            {% else %}<p class="text-xs text-slate-400 italic">Sem registros neste dia.</p>{% endfor %}
        </div>

        <div id="formContainer" class="hidden bg-slate-50 p-4 rounded-xl border border-blue-200 shadow-inner">
            <h3 class="font-bold text-blue-700 mb-4 text-sm uppercase" id="formTitle">Detalhes</h3>
            <form action="/ponto/solicitar-ajuste" method="POST" class="space-y-4">
                <!-- TOKEN CSRF INJETADO -->
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                
                <input type="hidden" name="acao" value="enviar">
                <input type="hidden" name="data_ref" value="{{ data_sel }}">
                <input type="hidden" name="ponto_id" id="form_ponto_id"> 
                <input type="hidden" name="tipo_solicitacao" id="form_tipo_solic"> 
                <div class="grid grid-cols-2 gap-4" id="divHorarioTipo">
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Hor√°rio</label><input type="time" name="novo_horario" id="form_horario" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-2 font-mono"></div>
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Tipo</label><select name="tipo_batida" id="form_tipo" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-2 text-sm"><option value="Entrada">Entrada</option><option value="Ida Almo√ßo">Ida Almo√ßo</option><option value="Volta Almo√ßo">Volta Almo√ßo</option><option value="Sa√≠da">Sa√≠da</option></select></div>
                </div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Justificativa</label><textarea name="justificativa" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-2 text-sm" rows="2" required></textarea></div>
                <div class="flex gap-2"><button type="button" onclick="fecharForm()" class="flex-1 bg-slate-200 text-slate-600 font-bold py-2 rounded-lg text-xs">CANCELAR</button><button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg shadow text-xs">ENVIAR</button></div>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="mt-8">
        <h3 class="font-bold text-slate-700 text-sm mb-4 border-b pb-2">Meus Pedidos Recentes</h3>
        <div class="space-y-3">
            {% for req in meus_ajustes %}
            <div class="bg-white border border-slate-200 rounded-lg p-4 shadow-sm relative pl-4 border-l-4 {% if req.status == 'Aprovado' %} border-l-emerald-500 {% elif req.status == 'Reprovado' %} border-l-red-500 {% else %} border-l-yellow-500 {% endif %}">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-[10px] font-bold uppercase text-slate-400">{{ req.data_referencia.strftime('%d/%m') }} - {{ req.tipo_solicitacao }}</span>
                    <span class="text-[10px] font-bold uppercase px-2 py-0.5 rounded {% if req.status == 'Pendente' %} bg-yellow-100 text-yellow-700 {% elif req.status == 'Aprovado' %} bg-emerald-100 text-emerald-700 {% else %} bg-red-100 text-red-700 {% endif %}">{{ req.status }}</span>
                </div>
                
                <div class="grid grid-cols-2 gap-2 text-xs mb-2 bg-slate-50 p-2 rounded">
                    <div><span class="block text-slate-400">Hor√°rio Antigo</span><strong class="font-mono text-slate-600">{{ extras.get(req.id, '-') }}</strong></div>
                    <div><span class="block text-slate-400">Hor√°rio Novo</span><strong class="font-mono text-blue-600">{% if req.novo_horario %}{{ req.novo_horario }} ({{ req.tipo_batida }}){% else %} - {% endif %}</strong></div>
                </div>

                <div class="text-xs text-slate-500 italic mb-2">Justificativa: "{{ req.justificativa }}"</div>
                {% if req.status == 'Reprovado' %}<div class="bg-red-50 p-2 rounded border border-red-100 text-xs text-red-700"><strong>Devolutiva:</strong> {{ req.motivo_reprovacao }}</div>{% endif %}
            </div>
            {% else %}<p class="text-center text-xs text-slate-400 py-4">Nenhum pedido recente.</p>{% endfor %}
        </div>
    </div>
</div>
<script>
    function abrirInclusao() { resetForm(); document.getElementById('formTitle').innerText = "INCLUIR"; document.getElementById('form_tipo_solic').value = "Inclusao"; document.getElementById('formContainer').classList.remove('hidden'); }
    function abrirEdicao(id, hora, tipo) { resetForm(); document.getElementById('formTitle').innerText = "EDITAR"; document.getElementById('form_ponto_id').value = id; document.getElementById('form_horario').value = hora; document.getElementById('form_tipo').value = tipo; document.getElementById('form_tipo_solic').value = "Edicao"; document.getElementById('formContainer').classList.remove('hidden'); }
    function abrirExclusao(id, hora) { resetForm(); document.getElementById('formTitle').innerText = "EXCLUIR"; document.getElementById('form_ponto_id').value = id; document.getElementById('form_tipo_solic').value = "Exclusao"; document.getElementById('divHorarioTipo').classList.add('hidden'); document.getElementById('formContainer').classList.remove('hidden'); }
    function resetForm() { document.getElementById('form_ponto_id').value = ""; document.getElementById('form_horario').value = ""; document.getElementById('divHorarioTipo').classList.remove('hidden'); }
    function fecharForm() { document.getElementById('formContainer').classList.add('hidden'); }
</script>
{% endblock %}


##################################################

FILE: app\ponto\templates\ponto\terminal_leitura.html
-----------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
    .terminal-mode { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
    #reader { width: 100%; max-width: 600px; border-radius: 20px; overflow: hidden; border: 4px solid #3b82f6; background: black; }
    
    /* MODAL OVERLAY */
    #successModal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9);
        display: flex; align-items: center; justify-content: center;
        z-index: 10000;
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    #successModal.active { opacity: 1; pointer-events: all; }
    
    .modal-content {
        background: #064e3b; /* Emerald 900 */
        padding: 40px; border-radius: 20px; text-align: center;
        border: 2px solid #10b981;
        box-shadow: 0 0 50px rgba(16, 185, 129, 0.5);
        max-width: 90%;
    }
    .modal-content h2 { font-size: 2rem; font-weight: bold; color: white; margin-bottom: 10px; }
    .modal-content p { font-size: 1.5rem; color: #a7f3d0; margin-bottom: 30px; }
    .btn-next {
        background: white; color: #064e3b; font-size: 1.2rem; font-weight: bold;
        padding: 15px 40px; border-radius: 50px; border: none; cursor: pointer;
        display: inline-flex; align-items: center; gap: 10px;
    }
</style>

<div class="terminal-mode">
    <div class="mb-4 text-center"><h1 class="text-3xl font-bold tracking-widest text-blue-400">SHAHIN GEST√ÉO</h1><p class="text-sm text-slate-400">TERMINAL DE PONTO</p></div>
    <div id="reader"></div>
    <div class="mt-4"><a href="/logout" class="text-xs text-slate-600 hover:text-slate-400">Sair do Modo Terminal</a></div>
</div>

<!-- Modal de Sucesso -->
<div id="successModal">
    <div class="modal-content">
        <i class="fas fa-check-circle text-6xl text-emerald-400 mb-4"></i>
        <h2 id="modalTitle">REGISTRADO!</h2>
        <p id="modalMsg">Fulano de Tal<br>14:30</p>
        <button class="btn-next" onclick="resetScanner()">
            <i class="fas fa-redo"></i> PR√ìXIMO
        </button>
    </div>
</div>

<script>
    const html5QrCode = new Html5Qrcode("reader");
    let isScanning = true;
    
    // Configura√ß√£o para QR Code denso
    const config = { fps: 10, qrbox: { width: 300, height: 300 } };
    
    html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure);

    function onScanSuccess(decodedText, decodedResult) {
        if (!isScanning) return;
        isScanning = false;
        
        // Som de Beep
        try { new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg").play(); } catch(e){}

        fetch('/ponto/api/registrar-leitura', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({ token: decodedText }) 
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showModal(data.funcionario, data.hora, data.tipo);
            } else {
                alert("ERRO: " + data.error);
                setTimeout(() => { isScanning = true; }, 2000);
            }
        })
        .catch(err => {
            alert("Erro de conex√£o.");
            setTimeout(() => { isScanning = true; }, 2000);
        });
    }

    function onScanFailure(error) {}

    function showModal(nome, hora, tipo) {
        document.getElementById('modalTitle').innerText = tipo.toUpperCase() + " REGISTRADA";
        document.getElementById('modalMsg').innerHTML = `<strong>${nome}</strong><br>${hora}`;
        document.getElementById('successModal').classList.add('active');
        
        // Auto-fechar em 4s se ninguem clicar
        setTimeout(() => {
            if(document.getElementById('successModal').classList.contains('active')) resetScanner();
        }, 4000);
    }

    function resetScanner() {
        document.getElementById('successModal').classList.remove('active');
        isScanning = true;
    }
</script>
{% endblock %}

##################################################

FILE: app\routes\__init__.py
----------------------------


##################################################

FILE: app\routes\ponto.py
-------------------------
from flask import Blueprint, render_template, request, redirect, url_for, flash, jsonify, current_app
from flask_login import login_required, current_user
from app import db
from app.models import PontoRegistro, PontoResumo, User, PontoAjuste
from app.utils import get_brasil_time, calcular_dia, format_minutes_to_hm, data_por_extenso
from datetime import datetime, date, timedelta
from sqlalchemy import func
from itsdangerous import URLSafeTimedSerializer, SignatureExpired, BadSignature

ponto_bp = Blueprint('ponto', __name__, template_folder='templates', url_prefix='/ponto')

# --- APIS DO SISTEMA DE PONTO ---

@ponto_bp.route('/api/gerar-token', methods=['GET'])
@login_required
def gerar_token_qrcode():
    if current_user.role == 'Terminal': return jsonify({'error': 'Terminal n√£o gera token'}), 403
    s = URLSafeTimedSerializer(current_app.secret_key)
    token = s.dumps({'user_id': current_user.id, 'timestamp': get_brasil_time().timestamp()})
    return jsonify({'token': token})

@ponto_bp.route('/api/check-status', methods=['GET'])
@login_required
def check_status_ponto():
    # Verifica se houve um ponto registrado nos ultimos 10 segundos
    # Isso permite que o celular do funcionario saiba que o terminal leu o codigo
    if current_user.role == 'Terminal': return jsonify({'status': 'ignorar'})
    
    agora = get_brasil_time()
    # Busca ultimo ponto do usuario
    ultimo_ponto = PontoRegistro.query.filter_by(user_id=current_user.id).order_by(PontoRegistro.id.desc()).first()
    
    if ultimo_ponto:
        # Pega data/hora do ponto
        dt_ponto = datetime.combine(ultimo_ponto.data_registro, ultimo_ponto.hora_registro)
        # Se foi registrado ha menos de 10 segundos
        diferenca = (agora - dt_ponto).total_seconds()
        
        if diferenca < 15: # Janela de tempo para notificar
            return jsonify({
                'marcado': True, 
                'tipo': ultimo_ponto.tipo, 
                'hora': ultimo_ponto.hora_registro.strftime('%H:%M')
            })
            
    return jsonify({'marcado': False})

@ponto_bp.route('/api/registrar-leitura', methods=['POST'])
@login_required
def registrar_leitura_terminal():
    if current_user.role != 'Terminal' and current_user.role != 'Master': return jsonify({'error': 'Acesso negado.'}), 403
    data = request.json
    token = data.get('token')
    if not token: return jsonify({'error': 'Token vazio'}), 400
    s = URLSafeTimedSerializer(current_app.secret_key)
    try:
        dados = s.loads(token, max_age=35)
        user_alvo = User.query.get(dados['user_id'])
        if not user_alvo: return jsonify({'error': 'Usu√°rio inv√°lido'}), 404
        
        hoje = get_brasil_time().date()
        
        # Verifica duplicidade imediata (evita leitura dupla em 1 min)
        ultimo = PontoRegistro.query.filter_by(user_id=user_alvo.id, data_registro=hoje).order_by(PontoRegistro.hora_registro.desc()).first()
        if ultimo:
            agora_time = get_brasil_time()
            dt_ultimo = datetime.combine(hoje, ultimo.hora_registro)
            if (agora_time - dt_ultimo).total_seconds() < 60:
                 return jsonify({'error': f'Ponto j√° registrado h√° instantes ({ultimo.hora_registro.strftime("%H:%M")}). Aguarde.'}), 400

        pontos_hoje = PontoRegistro.query.filter_by(user_id=user_alvo.id, data_registro=hoje).order_by(PontoRegistro.hora_registro).all()
        
        proxima = "Entrada"
        if len(pontos_hoje) == 1: proxima = "Ida Almo√ßo"
        elif len(pontos_hoje) == 2: proxima = "Volta Almo√ßo"
        elif len(pontos_hoje) == 3: proxima = "Sa√≠da"
        elif len(pontos_hoje) >= 4: proxima = "Extra"
        
        novo = PontoRegistro(user_id=user_alvo.id, data_registro=hoje, hora_registro=get_brasil_time().time(), tipo=proxima, latitude='QR-Code', longitude='Presencial')
        db.session.add(novo); db.session.commit(); calcular_dia(user_alvo.id, hoje)
        
        return jsonify({'success': True, 'message': f'Ponto registrado: {proxima}', 'funcionario': user_alvo.real_name, 'hora': novo.hora_registro.strftime('%H:%M'), 'tipo': proxima})
    except SignatureExpired: return jsonify({'error': 'QR Code expirado.'}), 400
    except BadSignature: return jsonify({'error': 'QR Code inv√°lido.'}), 400
    except Exception as e: return jsonify({'error': f'Erro interno: {str(e)}'}), 500

# --- ROTAS DE INTERFACE ---

@ponto_bp.route('/scanner')
@login_required
def terminal_scanner():
    if current_user.role != 'Terminal' and current_user.role != 'Master':
        flash('Acesso restrito.')
        return redirect(url_for('main.dashboard'))
    return render_template('ponto/terminal_leitura.html')

@ponto_bp.route('/registrar', methods=['GET', 'POST'])
@login_required
def registrar_ponto():
    if current_user.role == 'Terminal': return redirect(url_for('ponto.terminal_scanner'))

    hoje = get_brasil_time().date()
    hoje_extenso = data_por_extenso(hoje)
    
    bloqueado = False; motivo = ""
    if current_user.escala == '5x2' and hoje.weekday() >= 5: bloqueado = True; motivo = "N√£o √© poss√≠vel realizar a marca√ß√£o de ponto."
    elif current_user.escala == '12x36' and current_user.data_inicio_escala:
        if (hoje - current_user.data_inicio_escala).days % 2 != 0: bloqueado = True; motivo = "N√£o √© poss√≠vel realizar a marca√ß√£o de ponto."

    pontos = PontoRegistro.query.filter_by(user_id=current_user.id, data_registro=hoje).order_by(PontoRegistro.hora_registro).all()
    prox = "Entrada"
    if len(pontos) == 1: prox = "Ida Almo√ßo"
    elif len(pontos) == 2: prox = "Volta Almo√ßo"
    elif len(pontos) == 3: prox = "Sa√≠da"
    elif len(pontos) >= 4: prox = "Extra"

    if request.method == 'POST':
        if bloqueado: flash('Bloqueado'); return redirect(url_for('main.dashboard'))
        db.session.add(PontoRegistro(user_id=current_user.id, data_registro=hoje, hora_registro=get_brasil_time().time(), tipo=prox, latitude=request.form.get('latitude'), longitude=request.form.get('longitude')))
        db.session.commit(); calcular_dia(current_user.id, hoje)
        return redirect(url_for('main.dashboard'))
    
    return render_template('ponto/registro.html', proxima_acao=prox, hoje_extenso=hoje_extenso, pontos=pontos, bloqueado=bloqueado, motivo=motivo, hoje=hoje)

@ponto_bp.route('/espelho')
@login_required
def espelho_ponto():
    target_user_id = request.args.get('user_id', type=int) or current_user.id
    if target_user_id != current_user.id and current_user.role != 'Master':
        return redirect(url_for('main.dashboard'))
    
    user = User.query.get_or_404(target_user_id)
    mes_ref = request.args.get('mes_ref') or get_brasil_time().strftime('%Y-%m')
    try: ano, mes = map(int, mes_ref.split('-'))
    except: hoje = get_brasil_time(); ano, mes = hoje.year, hoje.month; mes_ref = hoje.strftime('%Y-%m')
    
    resumos = PontoResumo.query.filter(
        PontoResumo.user_id == target_user_id,
        func.extract('year', PontoResumo.data_referencia) == ano,
        func.extract('month', PontoResumo.data_referencia) == mes
    ).order_by(PontoResumo.data_referencia).all()
    
    detalhes = {}
    for r in resumos:
        batidas = PontoRegistro.query.filter_by(user_id=target_user_id, data_registro=r.data_referencia).order_by(PontoRegistro.hora_registro).all()
        detalhes[r.id] = [b.hora_registro.strftime('%H:%M') for b in batidas]

    dias_semana = {0: 'Seg', 1: 'Ter', 2: 'Qua', 3: 'Qui', 4: 'Sex', 5: 'S√°b', 6: 'Dom'}

    return render_template('ponto/ponto_espelho.html', 
                         resumos=resumos, 
                         user=user, 
                         detalhes=detalhes, 
                         format_hm=format_minutes_to_hm, 
                         mes_ref=mes_ref,
                         dias_semana=dias_semana)

@ponto_bp.route('/solicitar-ajuste', methods=['GET', 'POST'])
@login_required
def solicitar_ajuste():
    pontos_dia = []; data_selecionada = None
    meus_ajustes = PontoAjuste.query.filter_by(user_id=current_user.id).order_by(PontoAjuste.created_at.desc()).limit(20).all()
    if request.method == 'POST':
        if request.form.get('acao') == 'buscar':
            try: data_selecionada = datetime.strptime(request.form.get('data_busca'), '%Y-%m-%d').date(); pontos_dia = PontoRegistro.query.filter_by(user_id=current_user.id, data_registro=data_selecionada).order_by(PontoRegistro.hora_registro).all()
            except: flash('Data inv√°lida')
        elif request.form.get('acao') == 'enviar':
            try:
                dt_obj = datetime.strptime(request.form.get('data_ref'), '%Y-%m-%d').date()
                p_id = int(request.form.get('ponto_id')) if request.form.get('ponto_id') else None
                solic = PontoAjuste(user_id=current_user.id, data_referencia=dt_obj, ponto_original_id=p_id, novo_horario=request.form.get('novo_horario'), tipo_batida=request.form.get('tipo_batida'), tipo_solicitacao=request.form.get('tipo_solicitacao'), justificativa=request.form.get('justificativa'))
                db.session.add(solic); db.session.commit(); flash('Enviado!')
                return redirect(url_for('ponto.solicitar_ajuste'))
            except: pass
    dados_extras = {}
    for p in meus_ajustes:
        if p.ponto_original_id:
            original = PontoRegistro.query.get(p.ponto_original_id)
            if original: dados_extras[p.id] = original.hora_registro.strftime('%H:%M')
    return render_template('ponto/solicitar_ajuste.html', pontos=pontos_dia, data_sel=data_selecionada, meus_ajustes=meus_ajustes, extras=dados_extras)

##################################################

FILE: app\static\css\style.css
------------------------------
/* Estilos Globais do Thay-RH */

/* Componentes de Formul√°rio (Extra√≠dos dos templates) */
.label-pro { 
    display: block; 
    font-size: 0.7rem; 
    font-weight: 700; 
    color: #64748b; 
    text-transform: uppercase; 
    margin-bottom: 0.5rem; 
    letter-spacing: 0.05em;
} 

.input-pro { 
    width: 100%; 
    background-color: #f8fafc; 
    border: 1px solid #e2e8f0; 
    border-radius: 0.5rem; 
    padding: 0.75rem 1rem; 
    color: #1e293b; 
    font-weight: 500; 
    outline: none; 
    transition: all 0.2s;
}

.input-pro:focus {
    background-color: #ffffff;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Utilit√°rios de Anima√ß√£o */
.animate-fade-in { 
    animation: fadeIn 0.5s ease-out; 
}

@keyframes fadeIn { 
    from { opacity: 0; transform: translateY(10px); } 
    to { opacity: 1; transform: translateY(0); } 
}


##################################################

FILE: app\templates\base.html
-----------------------------
<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shahin Gest√£o - Operacional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; } 
        .sidebar { transition: transform 0.3s ease-in-out; }
        .submenu { transition: max-height 0.3s ease-in-out; overflow: hidden; max-height: 0; }
        .submenu.open { max-height: 200px; }
    </style>
    <script>
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('overlay');
            if (sb.classList.contains('-translate-x-full')) { 
                sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); 
            } else { 
                sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); 
            }
        }
        function toggleSubmenu(id, iconId) {
            const menu = document.getElementById(id);
            const icon = document.getElementById(iconId);
            if (menu.classList.contains('open')) {
                menu.classList.remove('open');
                setTimeout(() => menu.classList.add('hidden'), 300);
                if(icon) icon.classList.remove('rotate-180');
            } else {
                menu.classList.remove('hidden');
                setTimeout(() => menu.classList.add('open'), 10);
                if(icon) icon.classList.add('rotate-180');
            }
        }
    </script>
</head>
<body class="bg-slate-100 text-slate-800">
    {% if current_user.is_authenticated and not current_user.is_first_access %}
    <div class="md:hidden bg-white border-b border-slate-200 p-4 flex justify-between items-center sticky top-0 z-40">
        <button onclick="toggleSidebar()" class="text-slate-600 focus:outline-none"><i class="fas fa-bars text-xl"></i></button>
        <span class="font-bold text-lg text-slate-800">Shahin</span>
        <div class="w-8"></div>
    </div>
    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>
    {% endif %}

    <div class="{% if current_user.is_authenticated and not current_user.is_first_access %}flex h-screen overflow-hidden{% endif %}">
        {% if current_user.is_authenticated and not current_user.is_first_access %}
        <aside id="sidebar" class="sidebar fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 text-slate-300 transform -translate-x-full md:translate-x-0 md:static md:flex-shrink-0 flex flex-col shadow-2xl h-full">
            <div class="h-16 flex items-center px-6 bg-slate-950 border-b border-slate-800">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-lg mr-3">S</div>
                <span class="font-bold text-xl text-white tracking-tight">Shahin</span>
            </div>
            
            <div class="p-6 border-b border-slate-800">
                <div class="text-xs font-bold text-slate-500 uppercase mb-1">Utilizador</div>
                <div class="text-sm font-bold text-white truncate">{{ current_user.real_name }}</div>
                <div class="text-[10px] text-blue-400 font-mono mt-1 uppercase">{{ current_user.role }}</div>
            </div>

            <nav class="flex-1 overflow-y-auto py-4">
                <ul class="space-y-1">
                    {% if current_user.role == 'Terminal' %}
                        <li><a href="/ponto/scanner" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-qrcode w-6 text-center mr-2 text-blue-500"></i><span class="font-medium">Abrir Leitor</span></a></li>
                    {% else %}
                        <li><a href="/" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-home w-6 text-center mr-2 text-slate-500 group-hover:text-blue-500"></i><span class="font-medium">In√≠cio</span></a></li>
                        
                        <li class="pt-4 pb-2 px-6 text-[10px] font-bold uppercase text-slate-600">√Årea Pessoal</li>
                        <li><a href="/ponto/registrar" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-fingerprint w-6 text-center mr-2 text-slate-500 group-hover:text-purple-500"></i><span class="font-medium">Registar Ponto</span></a></li>
                        
                        <li>
                            <button onclick="toggleSubmenu('submenu-espelho', 'icon-espelho')" class="w-full flex items-center justify-between px-6 py-3 hover:bg-slate-800 hover:text-white transition group focus:outline-none">
                                <div class="flex items-center">
                                    <i class="fas fa-calendar-alt w-6 text-center mr-2 text-slate-500 group-hover:text-white"></i>
                                    <span class="font-medium">Espelho de Ponto</span>
                                </div>
                                <i id="icon-espelho" class="fas fa-chevron-down text-xs transition-transform duration-300"></i>
                            </button>
                            <ul id="submenu-espelho" class="submenu hidden bg-slate-950">
                                <li><a href="/ponto/espelho" class="block pl-16 pr-6 py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800 transition border-l-2 border-transparent hover:border-blue-600">Visualizar</a></li>
                                <li><a href="/ponto/solicitar-ajuste" class="block pl-16 pr-6 py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800 transition border-l-2 border-transparent hover:border-yellow-500">Solicitar Ajuste</a></li>
                            </ul>
                        </li>

                        <li><a href="/documentos/meus-documentos" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-folder-open w-6 text-center mr-2 text-slate-500 group-hover:text-yellow-400"></i><span class="font-medium">Meus Documentos</span></a></li>
                        
                        {% set perms = current_user.permissions or "" %}
                        {% set is_master = current_user.username == '50097952800' %}

                        {% if is_master or 'DOCUMENTOS' in perms or 'PONTO' in perms or 'ESTOQUE' in perms or 'USUARIOS' in perms %}
                        <li class="pt-6 pb-2 px-6 text-[10px] font-bold uppercase text-slate-600 border-t border-slate-800/50 mt-4">Administra√ß√£o</li>
                        
                        {% if is_master or 'DOCUMENTOS' in perms %}
                        <li class="relative group">
                            <a href="/documentos/admin" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition"><i class="fas fa-file-contract w-6 text-center mr-2 text-slate-500"></i><span class="font-medium">Central Documentos</span></a>
                            {% if is_master or 'AUDITORIA' in perms %}
                            <a href="/documentos/admin/auditoria" class="flex items-center pl-14 pr-6 py-2 text-xs text-slate-400 hover:text-white hover:bg-slate-800 transition"><i class="fas fa-shield-alt mr-2 text-[10px]"></i>Assinaturas Digitais</a>
                            {% endif %}
                        </li>
                        {% endif %}

                        {% if is_master or 'ESTOQUE' in perms %}
                        <li><a href="/controle-uniforme" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-tshirt w-6 text-center mr-2 text-slate-500"></i><span class="font-medium">Uniformes/Estoque</span></a></li>
                        {% endif %}

                        {% if is_master or 'PONTO' in perms %}
                        <li><a href="/admin/solicitacoes" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-check-double w-6 text-center mr-2 text-slate-500"></i><span class="font-medium">Gest√£o de Ponto</span></a></li>
                        {% endif %}

                        {% if is_master or 'USUARIOS' in perms %}
                        <li><a href="/admin/usuarios" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-users-cog w-6 text-center mr-2 text-slate-500"></i><span class="font-medium">Funcion√°rios</span></a></li>
                        {% endif %}
                        {% endif %}
                    {% endif %}
                    <li><a href="/logout" class="flex items-center px-6 py-3 hover:bg-red-900/20 hover:text-red-400 transition group mt-8"><i class="fas fa-sign-out-alt w-6 text-center mr-2 text-slate-500 group-hover:text-red-400"></i><span class="font-medium">Sair</span></a></li>
                </ul>
            </nav>
        </aside>
        {% endif %}
        
        <div class="flex-1 h-full overflow-y-auto bg-slate-50 relative w-full">
            <div class="max-w-5xl mx-auto p-4 md:p-8 pb-20">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="hidden" id="flask-msg-{{ loop.index }}" data-cat="{{ category }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                {% block content %}{% endblock %}
            </div>
            {% if current_user.is_authenticated and not current_user.is_first_access %}
            <footer class="py-6 text-center text-xs text-slate-400">&copy; 2026 Shahin Gest√£o</footer>
            {% endif %}
        </div>
    </div>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('[id^="flask-msg-"]').forEach(el => {
                const msg = el.innerText;
                const cat = el.getAttribute('data-cat');
                Toastify({
                    text: msg, duration: 4000, close: true, gravity: "top", position: "right", 
                    style: { background: cat === 'error' ? "linear-gradient(to right, #ef4444, #b91c1c)" : "linear-gradient(to right, #3b82f6, #2563eb)", borderRadius: "8px", fontSize: "14px" },
                }).showToast();
            });
        });
    </script>
</body>
</html>

##################################################

FILE: app\templates\editar.html
-------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex items-center justify-between mb-6">
    <h2 class="text-lg font-bold text-slate-800">Editar Item</h2>
    <a href="/" class="text-xs font-medium text-slate-500 hover:text-slate-800">Cancelar</a>
</div>

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <form action="/editar/{{ item.id }}" method="POST" class="p-6 space-y-5">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <!-- Alerta -->
        <div class="bg-yellow-50 text-yellow-800 p-3 rounded text-xs border border-yellow-200">
            <i class="fas fa-exclamation-triangle mr-1"></i> Voc√™ est√° editando manualmente o cadastro.
        </div>

        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Nome do Item</label>
            <input type="text" name="nome" value="{{ item.nome }}" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 text-slate-800 font-bold focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Tamanho</label>
                <select name="tamanho" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="P" {% if item.tamanho == 'P' %}selected{% endif %}>P</option>
                    <option value="M" {% if item.tamanho == 'M' %}selected{% endif %}>M</option>
                    <option value="G" {% if item.tamanho == 'G' %}selected{% endif %}>G</option>
                    <option value="GG" {% if item.tamanho == 'GG' %}selected{% endif %}>GG</option>
                    <option value="XG" {% if item.tamanho == 'XG' %}selected{% endif %}>XG</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">G√™nero</label>
                <select name="genero" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="Masculino" {% if item.genero == 'Masculino' %}selected{% endif %}>Masculino</option>
                    <option value="Feminino" {% if item.genero == 'Feminino' %}selected{% endif %}>Feminino</option>
                    <option value="Unissex" {% if item.genero == 'Unissex' %}selected{% endif %}>Unissex</option>
                </select>
            </div>
        </div>

        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Quantidade Atual (Ajuste Manual)</label>
            <input type="number" name="quantidade" min="0" value="{{ item.quantidade }}" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 text-blue-600 font-bold text-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>

        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-md hover:shadow-lg transition-all">
            SALVAR ALTERA√á√ïES
        </button>
    </form>
</div>
{% endblock %}

##################################################

FILE: app\templates\ponto_espelho_master.html
---------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
    <h2 class="text-2xl font-bold text-slate-800">Espelho Geral</h2>
    <form action="/ponto/espelho" method="GET" class="flex gap-2">
        <input type="date" name="data_filtro" value="{{ filtro_data }}" class="border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-600">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm"><i class="fas fa-filter"></i></button>
        {% if filtro_data %}<a href="/ponto/espelho" class="bg-slate-200 text-slate-600 px-4 py-2 rounded-lg font-bold text-sm">Limpar</a>{% endif %}
    </form>
</div>

<div class="mb-6"><input type="text" id="buscaEspelho" onkeyup="filtrarEspelho('buscaEspelho', 'listaEspelho')" placeholder="Pesquisar funcion√°rio..." class="w-full p-4 rounded-xl border border-slate-200 shadow-sm"></div>

<div class="space-y-2" id="listaEspelho">
    {% for grupo in grupos %}
    <div class="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm item-espelho">
        <button onclick="toggleDetails('detalhe-{{ loop.index }}')" class="w-full flex justify-between items-center p-4 bg-slate-50 hover:bg-slate-100 transition text-left focus:outline-none">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">{{ grupo.user.real_name[:2].upper() }}</div>
                <div>
                    <h3 class="font-bold text-slate-800 text-sm nome-func">{{ grupo.user.real_name }}</h3>
                    <p class="text-xs text-slate-500 font-mono">{{ grupo.data.strftime('%d/%m/%Y') }}</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <!-- Mostrador de Saldo no Card -->
                {% if grupo.saldo %}
                <div class="text-right">
                    <span class="block text-[10px] font-bold uppercase text-slate-400">Saldo</span>
                    <span class="text-sm font-mono font-bold 
                        {% if '-' in grupo.saldo %} text-red-600 {% else %} text-emerald-600 {% endif %}">
                        {{ grupo.saldo }}
                    </span>
                </div>
                {% endif %}
                <i class="fas fa-chevron-down text-slate-400"></i>
            </div>
        </button>
        
        <div id="detalhe-{{ loop.index }}" class="hidden border-t border-slate-100">
            <div class="p-4 bg-white grid grid-cols-2 gap-2">
                {% for p in grupo.pontos %}
                <div class="flex justify-between items-center p-2 rounded bg-slate-50 border border-slate-100">
                    <span class="text-xs font-bold text-slate-600">{{ p.tipo }}</span>
                    <span class="text-sm font-mono font-bold text-blue-600">{{ p.hora_registro.strftime('%H:%M') }}</span>
                </div>
                {% endfor %}
                <div class="col-span-2 text-center text-xs text-slate-400 mt-2 bg-slate-50 p-1 rounded">Status: {{ grupo.status }}</div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-10 text-slate-400">Nenhum registro encontrado.</div>
    {% endfor %}
</div>
<script>
function filtrarEspelho(inputId, listaId) {
    let input = document.getElementById(inputId);
    let filter = input.value.toUpperCase();
    let lista = document.getElementById(listaId);
    let itens = lista.getElementsByClassName('item-espelho');
    for (let i = 0; i < itens.length; i++) {
        let nome = itens[i].getElementsByClassName('nome-func')[0];
        if (nome.innerHTML.toUpperCase().indexOf(filter) > -1) { itens[i].style.display = ""; } else { itens[i].style.display = "none"; }
    }
}
</script>
{% endblock %}

##################################################

FILE: app\templates\main\dashboard.html
---------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-8">
    <h2 class="text-3xl font-bold text-slate-800">In√≠cio</h2>
    <p class="text-slate-500">Bem-vindo ao painel operacional, {{ current_user.real_name.split()[0] }}.</p>
</div>

<!-- GRID DE AC√á√ïES R√ÅPIDAS (√ÅREA DO FUNCION√ÅRIO) -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <a href="/ponto/registrar" class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition group">
        <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center text-purple-600 mb-4 group-hover:bg-purple-600 group-hover:text-white transition-colors">
            <i class="fas fa-fingerprint text-xl"></i>
        </div>
        <h3 class="font-bold text-slate-800">Bater Ponto</h3>
        <p class="text-xs text-slate-400 mt-1">Registe a sua entrada ou sa√≠da agora.</p>
    </a>

    <a href="/documentos/meus-documentos" class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition group relative">
        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-blue-600 mb-4 group-hover:bg-blue-600 group-hover:text-white transition-colors">
            <i class="fas fa-file-contract text-xl"></i>
        </div>
        {% if dados.doc_pendentes > 0 %}
        <span class="absolute top-6 right-6 bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded-full">{{ dados.doc_pendentes }}</span>
        {% endif %}
        <h3 class="font-bold text-slate-800">Documentos</h3>
        <p class="text-xs text-slate-400 mt-1">Holerites, recibos e espelhos assinados.</p>
    </a>

    <a href="/ponto/espelho" class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition group">
        <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center text-emerald-600 mb-4 group-hover:bg-emerald-600 group-hover:text-white transition-colors">
            <i class="fas fa-calendar-check text-xl"></i>
        </div>
        <h3 class="font-bold text-slate-800">Meu Espelho</h3>
        <p class="text-xs text-slate-400 mt-1">Consulte o seu hist√≥rico de horas.</p>
    </a>

    <div class="bg-slate-900 p-6 rounded-2xl shadow-lg flex flex-col justify-between">
        <div class="text-slate-400 text-xs font-bold uppercase tracking-wider">Data de Hoje</div>
        <div class="text-white text-2xl font-bold mt-2">{{ dados.hoje }}</div>
        <div class="text-blue-400 text-[10px] mt-2 font-mono uppercase">Sincronizado via GPS</div>
    </div>
</div>

<!-- SEC√á√ÉO ADMINISTRATIVA (S√ì APARECE SE TIVER PERMISS√ïES) -->
{% if admin.total_users is defined or admin.ajustes_pendentes is defined %}
<div class="pt-6 border-t border-slate-200 mt-10">
    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-6">Gest√£o Administrativa</h3>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        
        {% if has_permission('USUARIOS') %}
        <div class="bg-white p-6 rounded-xl border-l-4 border-blue-500 shadow-sm">
            <div class="text-xs font-bold text-slate-400 uppercase">Funcion√°rios Ativos</div>
            <div class="text-3xl font-black text-slate-800 mt-1">{{ admin.total_users }}</div>
            {% if admin.pendentes_cadastro > 0 %}
            <div class="mt-2 text-[10px] bg-blue-50 text-blue-600 py-1 px-2 rounded inline-block font-bold">
                {{ admin.pendentes_cadastro }} AGUARDANDO PRIMEIRO ACESSO
            </div>
            {% endif %}
        </div>
        {% endif %}

        {% if has_permission('PONTO') %}
        <div class="bg-white p-6 rounded-xl border-l-4 border-emerald-500 shadow-sm">
            <div class="text-xs font-bold text-slate-400 uppercase">Solicita√ß√µes de Ajuste</div>
            <div class="text-3xl font-black text-slate-800 mt-1">{{ admin.ajustes_pendentes }}</div>
            <a href="/admin/solicitacoes" class="text-[10px] text-emerald-600 font-bold hover:underline mt-2 block uppercase">Revisar Agora ‚Üí</a>
        </div>
        {% endif %}

        {% if has_permission('DOCUMENTOS') %}
        <div class="bg-white p-6 rounded-xl border-l-4 border-orange-500 shadow-sm">
            <div class="text-xs font-bold text-slate-400 uppercase">Central de RH</div>
            <div class="text-sm font-bold text-slate-700 mt-2 italic">Acesso R√°pido Dispon√≠vel</div>
            <a href="/documentos/admin" class="text-[10px] text-orange-600 font-bold hover:underline mt-2 block uppercase">Abrir M√≥dulo de Documentos ‚Üí</a>
        </div>
        {% endif %}

    </div>
</div>
{% endif %}

{% endblock %}




##################################################

