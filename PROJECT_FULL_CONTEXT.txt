==================================================
SNAPSHOT DO PROJETO: Shahin Gestão
Gerado em: 2026-02-15 08:39:04
==================================================

--- ESTRUTURA DE ARQUIVOS ---
.
├── app/
│   ├── admin/
│   │   ├── templates/
│   │   │   └── admin/
│   │   │       ├── admin_importar_csv.html
│   │   │       ├── admin_limpeza.html
│   │   │       ├── admin_relatorio_folha.html
│   │   │       ├── admin_usuarios.html
│   │   │       ├── editar_usuario.html
│   │   │       ├── liberar_acesso.html
│   │   │       ├── novo_usuario.html
│   │   │       ├── solicitacoes.html
│   │   │       └── sucesso_usuario.html
│   │   ├── __init__.py
│   │   └── routes.py
│   ├── auth/
│   │   ├── templates/
│   │   │   └── auth/
│   │   │       ├── auto_cadastro.html
│   │   │       ├── auto_cadastro_sucesso.html
│   │   │       ├── login.html
│   │   │       └── primeiro_acesso.html
│   │   ├── __init__.py
│   │   └── routes.py
│   ├── estoque/
│   │   ├── templates/
│   │   │   └── estoque/
│   │   │       ├── controle_uniforme.html
│   │   │       ├── editar_item.html
│   │   │       ├── editar_log_entrada.html
│   │   │       ├── editar_log_saida.html
│   │   │       ├── entrada.html
│   │   │       ├── historico_entrada.html
│   │   │       ├── historico_saida.html
│   │   │       ├── saida.html
│   │   │       └── selecionar_edicao.html
│   │   ├── __init__.py
│   │   └── routes.py
│   ├── holerites/
│   │   ├── templates/
│   │   │   └── holerites/
│   │   │       ├── admin_upload_holerite.html
│   │   │       └── meus_holerites.html
│   │   ├── __init__.py
│   │   └── routes.py
│   ├── main/
│   │   ├── templates/
│   │   │   └── main/
│   │   │       └── dashboard.html
│   │   ├── __init__.py
│   │   └── routes.py
│   ├── models/
│   │   └── __init__.py
│   ├── ponto/
│   │   ├── templates/
│   │   │   └── ponto/
│   │   │       ├── ponto_espelho.html
│   │   │       ├── registro.html
│   │   │       └── solicitar_ajuste.html
│   │   ├── __init__.py
│   │   └── routes.py
│   ├── routes/
│   │   └── __init__.py
│   ├── static/
│   │   └── css/
│   │       └── style.css
│   ├── templates/
│   │   ├── base.html
│   │   ├── editar.html
│   │   └── ponto_espelho_master.html
│   ├── __init__.py
│   ├── extensions.py
│   └── utils.py
├── .env
├── .gitignore
├── Procfile
├── config.py
├── requirements.txt
├── run.py
└── runtime.txt

==================================================

--- CONTEÚDO DOS ARQUIVOS ---

FILE: Procfile
--------------
web: gunicorn run:app

##################################################

FILE: config.py
---------------
import os
from dotenv import load_dotenv

load_dotenv()

class Config:
    SECRET_KEY = os.environ.get('SECRET_KEY', 'chave_padrao_desenvolvimento')
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    SQLALCHEMY_ENGINE_OPTIONS = {
        "pool_pre_ping": True,
        "pool_recycle": 300,
    }

class DevelopmentConfig(Config):
    DEBUG = True
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL', 'sqlite:///dev.db')

class ProductionConfig(Config):
    DEBUG = False
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL')

# Dicionário para facilitar a seleção
config_map = {
    'development': DevelopmentConfig,
    'production': ProductionConfig,
    'default': DevelopmentConfig
}


##################################################

FILE: requirements.txt
----------------------
flask
flask-sqlalchemy
psycopg2-binary
gunicorn
flask-login
werkzeug
cloudinary
pypdf
requests
python-dotenv
Flask-WTF
email_validator
Flask-Migrate

##################################################

FILE: run.py
------------
from app import app

if __name__ == "__main__":
    app.run(debug=True)

##################################################

FILE: runtime.txt
-----------------
python-3.11.9

##################################################

FILE: app/__init__.py
---------------------
import os
from flask import Flask
from app.extensions import db, login_manager, csrf, migrate
from config import config_map

def create_app():
    app = Flask(__name__)
    
    # Determina o ambiente (padrão: development)
    env_name = os.environ.get('FLASK_ENV', 'default')
    app.config.from_object(config_map[env_name])
    
    # Correção para URLs Postgres do Render/Neon
    db_url = app.config.get('SQLALCHEMY_DATABASE_URI')
    if db_url and db_url.startswith("postgres://"):
        app.config['SQLALCHEMY_DATABASE_URI'] = db_url.replace("postgres://", "postgresql://", 1)
    
    # Inicializa Extensões
    db.init_app(app)
    login_manager.init_app(app)
    csrf.init_app(app)
    migrate.init_app(app, db)
    
    login_manager.login_view = 'auth.login'

    # Registra Blueprints
    with app.app_context():
        from app.auth.routes import auth_bp
        from app.admin.routes import admin_bp
        from app.ponto.routes import ponto_bp
        from app.estoque.routes import estoque_bp
        from app.holerites.routes import holerite_bp
        from app.main.routes import main_bp

        app.register_blueprint(auth_bp)
        app.register_blueprint(admin_bp)
        app.register_blueprint(ponto_bp)
        app.register_blueprint(estoque_bp)
        app.register_blueprint(holerite_bp)
        app.register_blueprint(main_bp)

        try:
            db.create_all()
        except:
            pass

    return app

app = create_app()


##################################################

FILE: app/extensions.py
-----------------------
from flask_sqlalchemy import SQLAlchemy
from flask_login import LoginManager
from flask_wtf.csrf import CSRFProtect
from flask_migrate import Migrate

db = SQLAlchemy()
login_manager = LoginManager()
csrf = CSRFProtect()
migrate = Migrate()


##################################################

FILE: app/utils.py
------------------
from datetime import datetime, timedelta, time
import unicodedata
import re

def get_brasil_time():
    return datetime.utcnow() - timedelta(hours=3)

def remove_accents(txt):
    if not txt: return ""
    return "".join(c for c in unicodedata.normalize('NFD', txt) if unicodedata.category(c) != 'Mn')

def gerar_login_automatico(nome_completo):
    if not nome_completo: return "user"
    partes = nome_completo.split()
    primeiro_nome = remove_accents(partes[0]).lower()
    return re.sub(r'[^a-z]', '', primeiro_nome)

def time_to_minutes(t):
    if not t: return 0
    if isinstance(t, str):
        try:
            h, m = map(int, t.split(':'))
            return h * 60 + m
        except: return 0
    return t.hour * 60 + t.minute

def format_minutes_to_hm(total_minutes):
    sinal = "" if total_minutes >= 0 else "-"
    total_minutes = abs(total_minutes)
    h = total_minutes // 60
    m = total_minutes % 60
    return f"{sinal}{h:02d}:{m:02d}"

def calcular_dia(user_id, data_ref):
    from app import db
    from app.models import User, PontoRegistro, PontoResumo
    user = User.query.get(user_id)
    if not user: return

    registros = PontoRegistro.query.filter_by(user_id=user_id, data_registro=data_ref).order_by(PontoRegistro.hora_registro).all()
    
    ent_prev = time_to_minutes(user.horario_entrada)
    sai_prev = time_to_minutes(user.horario_saida)
    alm_ini_prev = time_to_minutes(user.horario_almoco_inicio)
    alm_fim_prev = time_to_minutes(user.horario_almoco_fim)
    
    minutos_esperados = (sai_prev - ent_prev) - (alm_fim_prev - alm_ini_prev)
    if minutos_esperados < 0: minutos_esperados = 0
    
    if data_ref.weekday() >= 5 and user.escala != 'Livre':
        minutos_esperados = 0

    trabalhado_total = 0
    for i in range(0, len(registros), 2):
        if i + 1 < len(registros):
            inicio = time_to_minutes(registros[i].hora_registro)
            fim = time_to_minutes(registros[i+1].hora_registro)
            trabalhado_total += (fim - inicio)

    saldo = trabalhado_total - minutos_esperados
    
    status = "OK"
    if len(registros) == 0 and minutos_esperados > 0: status = "Falta"
    elif len(registros) % 2 != 0: status = "Incompleto"
    elif saldo > 0: status = "Hora Extra"
    elif saldo < 0: status = "Débito"

    resumo = PontoResumo.query.filter_by(user_id=user_id, data_referencia=data_ref).first()
    if not resumo:
        resumo = PontoResumo(user_id=user_id, data_referencia=data_ref)
        db.session.add(resumo)
    
    resumo.minutos_trabalhados = trabalhado_total
    resumo.minutos_esperados = minutos_esperados
    resumo.minutos_saldo = saldo
    resumo.status_dia = status
    try:
        db.session.commit()
    except:
        db.session.rollback()

##################################################

FILE: app/admin/__init__.py
---------------------------
# Módulo admin

##################################################

FILE: app/admin/routes.py
-------------------------
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from app.extensions import db
from app.models import User, PreCadastro, PontoResumo, PontoAjuste, PontoRegistro, Holerite
from app.utils import calcular_dia, get_brasil_time, format_minutes_to_hm, gerar_login_automatico
from werkzeug.security import generate_password_hash
import csv
import io
from sqlalchemy import func

admin_bp = Blueprint('admin', __name__, template_folder='templates', url_prefix='/admin')

# --- ROTAS CORRIGIDAS/ADICIONADAS ---

@admin_bp.route('/usuarios/novo', methods=['GET', 'POST'])
@login_required
def novo_usuario():
    if current_user.role != 'Master': return redirect(url_for('main.dashboard'))
    
    if request.method == 'POST':
        try:
            # Criação manual de usuário ou pré-cadastro
            real_name = request.form.get('real_name')
            cpf = request.form.get('cpf').replace('.', '').replace('-', '').strip()
            
            # Verifica duplicidade
            if User.query.filter_by(cpf=cpf).first() or PreCadastro.query.filter_by(cpf=cpf).first():
                flash('CPF já cadastrado!', 'error')
                return redirect(url_for('admin.novo_usuario'))

            # Criação direta de PreCadastro para o fluxo "Sou Funcionário"
            novo_pre = PreCadastro(
                cpf=cpf,
                nome_previsto=real_name,
                cargo=request.form.get('role'),
                salario=float(request.form.get('salario') or 0),
                horario_entrada=request.form.get('h_ent'),
                horario_almoco_inicio=request.form.get('h_alm_ini'),
                horario_almoco_fim=request.form.get('h_alm_fim'),
                horario_saida=request.form.get('h_sai'),
                escala=request.form.get('escala'),
                data_inicio_escala=request.form.get('dt_escala') if request.form.get('dt_escala') else None
            )
            db.session.add(novo_pre)
            db.session.commit()
            return render_template('admin/sucesso_usuario.html', nome_real=real_name, cpf=cpf)
            
        except Exception as e:
            db.session.rollback()
            flash(f'Erro ao criar: {str(e)}', 'error')
            
    return render_template('admin/novo_usuario.html')

@admin_bp.route('/solicitacoes', methods=['GET', 'POST'])
@login_required
def admin_solicitacoes():
    if current_user.role != 'Master': return redirect(url_for('main.dashboard'))
    
    if request.method == 'POST':
        solic_id = request.form.get('solic_id')
        decisao = request.form.get('decisao')
        motivo = request.form.get('motivo_repro')
        
        solic = PontoAjuste.query.get(solic_id)
        if solic:
            if decisao == 'aprovar':
                solic.status = 'Aprovado'
                # Lógica para aplicar a alteração no ponto (se for edição/inclusão)
                # ... (Implementar lógica de aplicar no PontoRegistro se necessário)
                flash('Solicitação Aprovada.')
            else:
                solic.status = 'Reprovado'
                solic.motivo_reprovacao = motivo
                flash('Solicitação Reprovada.')
            db.session.commit()
            
    solicitacoes = PontoAjuste.query.filter_by(status='Pendente').order_by(PontoAjuste.created_at.desc()).all()
    extras = {} # Dicionário para dados auxiliares se necessário
    return render_template('admin/solicitacoes.html', solicitacoes=solicitacoes, extras=extras)

@admin_bp.route('/liberar-acesso', methods=['POST'])
@login_required
def liberar_acesso():
    # Rota auxiliar para processar o formulário da página 'admin/liberar_acesso.html'
    if current_user.role != 'Master': return redirect(url_for('main.dashboard'))
    
    try:
        cpf = request.form.get('cpf').replace('.', '').replace('-', '').strip()
        if User.query.filter_by(cpf=cpf).first() or PreCadastro.query.filter_by(cpf=cpf).first():
            flash('CPF já existe.', 'error')
        else:
            novo = PreCadastro(
                cpf=cpf,
                nome_previsto=request.form.get('nome'),
                cargo=request.form.get('cargo'),
                salario=float(request.form.get('salario') or 0),
                horario_entrada=request.form.get('h_ent'),
                horario_almoco_inicio=request.form.get('h_alm_ini'),
                horario_almoco_fim=request.form.get('h_alm_fim'),
                horario_saida=request.form.get('h_sai'),
                escala=request.form.get('escala'),
                data_inicio_escala=request.form.get('dt_escala') if request.form.get('dt_escala') else None
            )
            db.session.add(novo)
            db.session.commit()
            flash('Acesso liberado com sucesso!', 'success')
    except Exception as e:
        flash(f'Erro: {e}', 'error')
        
    return redirect(url_for('admin.gerenciar_usuarios')) # Ou redirecionar para liberar_acesso page se houver

@admin_bp.route('/liberar-acesso/excluir/<int:id>')
@login_required
def excluir_liberacao(id):
    if current_user.role != 'Master': return redirect(url_for('main.dashboard'))
    pre = PreCadastro.query.get(id)
    if pre:
        db.session.delete(pre)
        db.session.commit()
        flash('Removido da fila.')
    return redirect(url_for('admin.gerenciar_usuarios'))

# --- ROTAS EXISTENTES MANTIDAS ---

@admin_bp.route('/ferramentas/limpeza', methods=['GET', 'POST'])
@login_required
def admin_limpeza():
    if current_user.role != 'Master': return redirect(url_for('main.dashboard'))
    
    if request.method == 'POST':
        acao = request.form.get('acao')
        try:
            if acao == 'limpar_testes_ponto':
                PontoRegistro.query.delete()
                PontoResumo.query.delete()
                flash('Registros de ponto limpos.')
            elif acao == 'limpar_holerites':
                Holerite.query.delete()
                flash('Holerites removidos do banco.')
            elif acao == 'limpar_usuarios_nao_master':
                User.query.filter(User.username != 'Thaynara').delete()
                PreCadastro.query.delete()
                flash('Usuários de teste removidos.')
            
            db.session.commit()
            return redirect(url_for('admin.admin_limpeza'))
        except Exception as e:
            db.session.rollback()
            flash(f'Erro na limpeza: {e}')
            
    return render_template('admin/admin_limpeza.html')

@admin_bp.route('/relatorio-folha', methods=['GET', 'POST'])
@login_required
def admin_relatorio_folha():
    if current_user.role != 'Master': return redirect(url_for('main.dashboard'))
    mes_ref = request.form.get('mes_ref') or get_brasil_time().strftime('%Y-%m')
    try: ano, mes = map(int, mes_ref.split('-'))
    except: hoje = get_brasil_time(); ano, mes = hoje.year, hoje.month; mes_ref = hoje.strftime('%Y-%m')
    
    users = User.query.order_by(User.real_name).all()
    relatorio = []
    for u in users:
        resumos = PontoResumo.query.filter(
            PontoResumo.user_id == u.id, 
            func.extract('year', PontoResumo.data_referencia) == ano, 
            func.extract('month', PontoResumo.data_referencia) == mes
        ).all()
        total_saldo = sum(r.minutos_saldo for r in resumos)
        relatorio.append({
            'id': u.id,
            'nome': u.real_name,
            'cargo': u.role,
            'saldo_formatado': format_minutes_to_hm(total_saldo),
            'sinal': 'text-emerald-600' if total_saldo >= 0 else 'text-red-600'
        })
    return render_template('admin/admin_relatorio_folha.html', relatorio=relatorio, mes_ref=mes_ref)

@admin_bp.route('/usuarios/importar-csv', methods=['GET', 'POST'])
@login_required
def importar_csv():
    if current_user.role != 'Master': return redirect(url_for('main.dashboard'))
    if request.method == 'POST':
        file = request.files.get('arquivo_csv')
        if not file: return redirect(url_for('admin.importar_csv'))
        try:
            stream = io.StringIO(file.stream.read().decode("UTF8"), newline=None)
            csv_reader = csv.DictReader(stream, delimiter=';')
            count = 0
            for row in csv_reader:
                cpf_limpo = row.get('CPF', '').replace('.', '').replace('-', '').strip()
                if not cpf_limpo: continue
                if PreCadastro.query.filter_by(cpf=cpf_limpo).first() or User.query.filter_by(cpf=cpf_limpo).first(): continue
                pre = PreCadastro(
                    cpf=cpf_limpo,
                    nome_previsto=row.get('Nome', 'Funcionario'),
                    cargo=row.get('Cargo', 'Colaborador'),
                    salario=float(row.get('Salario', 0).replace(',', '.') or 0),
                    horario_entrada=row.get('Entrada', '07:12'),
                    horario_saida=row.get('Saida', '17:00'),
                    horario_almoco_inicio='12:00', horario_almoco_fim='13:00', escala='5x2'
                )
                db.session.add(pre); count += 1
            db.session.commit()
            flash(f'Importados {count} CPFs.')
        except Exception as e: flash(f'Erro: {e}')
    return render_template('admin/admin_importar_csv.html')

@admin_bp.route('/usuarios')
@login_required
def gerenciar_usuarios():
    if current_user.role != 'Master': return redirect(url_for('main.dashboard'))
    users = User.query.all(); pendentes = PreCadastro.query.all()
    return render_template('admin/admin_usuarios.html', users=users, pendentes=pendentes)

@admin_bp.route('/usuarios/editar/<int:id>', methods=['GET', 'POST'])
@login_required
def editar_usuario(id):
    if current_user.role != 'Master': return redirect(url_for('main.dashboard'))
    user = User.query.get_or_404(id)
    if request.method == 'POST':
        try:
            acao = request.form.get('acao')
            if acao == 'excluir':
                if user.username == 'Thaynara': flash('Não é possível excluir o Master.')
                else: 
                    PontoRegistro.query.filter_by(user_id=user.id).delete()
                    PontoResumo.query.filter_by(user_id=user.id).delete()
                    Holerite.query.filter_by(user_id=user.id).delete()
                    db.session.delete(user); db.session.commit()
                return redirect(url_for('admin.gerenciar_usuarios'))
            user.real_name = request.form.get('real_name'); user.role = request.form.get('role')
            user.salario = float(request.form.get('salario') or 0); user.horario_entrada = request.form.get('h_ent')
            user.horario_almoco_inicio = request.form.get('h_alm_ini'); user.horario_almoco_fim = request.form.get('h_alm_fim')
            user.horario_saida = request.form.get('h_sai'); user.escala = request.form.get('escala')
            db.session.commit(); flash('Salvo.'); return redirect(url_for('admin.gerenciar_usuarios'))
        except Exception as e: flash(f'Erro: {e}')
    return render_template('admin/editar_usuario.html', user=user)


##################################################

FILE: app/admin/templates/admin/admin_importar_csv.html
-------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="mb-6"><h2 class="text-2xl font-bold text-slate-800">Importar em Massa (CSV)</h2><p class="text-sm text-slate-500">Cadastre múltiplos funcionários de uma vez.</p></div>

    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-8 mb-6">
        <form action="/admin/usuarios/importar-csv" method="POST" enctype="multipart/form-data" class="space-y-6">
            <div>
                <label class="label-pro">Arquivo CSV ou Excel (.csv)</label>
                <input type="file" name="arquivo_csv" accept=".csv" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required>
            </div>
            
            <div class="bg-slate-50 p-4 rounded-lg text-xs text-slate-500 border border-slate-200">
                <p class="font-bold mb-2">Formato Obrigatório do CSV (Separado por ponto e vírgula ';')</p>
                <code class="block bg-white p-2 rounded border border-slate-200">Nome;CPF;Cargo;Salario;Entrada;Saida</code>
                <p class="mt-2">Exemplo:</p>
                <code class="block bg-white p-2 rounded border border-slate-200">João Silva;12345678900;Assistente;2500,00;08:00;17:00</code>
            </div>

            <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-lg shadow-md transition">PROCESSAR ARQUIVO</button>
        </form>
    </div>
</div>
<style>.label-pro { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem; }</style>
{% endblock %}

##################################################

FILE: app/admin/templates/admin/admin_limpeza.html
--------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-slate-800">Limpeza de Pré-Lançamento</h2>
        <p class="text-slate-500 text-sm">Use estas ferramentas para apagar os dados de teste antes de importar os funcionários reais.</p>
    </div>

    <div class="space-y-4">
        <div class="bg-white p-6 rounded-xl border border-red-100 shadow-sm">
            <h3 class="font-bold text-red-600 mb-2">1. Resetar Funcionários</h3>
            <p class="text-xs text-slate-500 mb-4">Apaga todos os funcionários cadastrados e pré-cadastros (Exceto Thaynara Master).</p>
            <form action="" method="POST">
                <input type="hidden" name="acao" value="limpar_usuarios_nao_master">
                <button type="submit" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg text-sm font-bold border border-red-200 hover:bg-red-100 transition w-full" onclick="return confirm('ATENÇÃO: Isso apagará todos os funcionários. Confirma?')">APAGAR USUÁRIOS DE TESTE</button>
            </form>
        </div>

        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
            <h3 class="font-bold text-slate-800 mb-2">2. Limpar Holerites</h3>
            <p class="text-xs text-slate-500 mb-4">Apaga todos os PDFs salvos no banco de dados para liberar espaço.</p>
            <form action="" method="POST">
                <input type="hidden" name="acao" value="limpar_holerites">
                <button type="submit" class="bg-slate-50 text-slate-600 px-4 py-2 rounded-lg text-sm font-bold border border-slate-200 hover:bg-slate-100 transition w-full">LIMPAR PDFs</button>
            </form>
        </div>
        
        <a href="/admin/usuarios" class="block text-center text-sm text-blue-600 font-bold mt-6 underline">Voltar para Gerenciar Usuários</a>
    </div>
</div>
{% endblock %}

##################################################

FILE: app/admin/templates/admin/admin_relatorio_folha.html
----------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6 flex justify-between items-center">
    <h2 class="text-2xl font-bold text-slate-800">Relatório de Folha</h2>
    <form action="/admin/relatorio-folha" method="POST" class="flex gap-2">
        <input type="month" name="mes_ref" value="{{ mes_ref }}" class="p-2 rounded-lg border border-slate-200 text-sm">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm">Filtrar</button>
    </form>
</div>

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <table class="w-full text-left text-sm">
        <thead class="bg-slate-50 text-slate-400 font-bold text-xs uppercase border-b border-slate-100">
            <tr>
                <th class="px-6 py-4">Funcionário</th>
                <th class="px-6 py-4">Cargo</th>
                <th class="px-6 py-4 text-center">Saldo do Mês</th>
                <th class="px-6 py-4 text-right">Ação</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
            {% for item in relatorio %}
            <tr class="hover:bg-slate-50 transition">
                <td class="px-6 py-4">
                    <!-- Drill-down: Link para o espelho do funcionario -->
                    <a href="/ponto/espelho?user_id={{ item.id }}&mes_ref={{ mes_ref }}" class="font-bold text-blue-600 hover:underline">
                        {{ item.nome }}
                    </a>
                </td>
                <td class="px-6 py-4 text-slate-500">{{ item.cargo }}</td>
                <td class="px-6 py-4 text-center font-mono font-bold {{ item.sinal }}">{{ item.saldo_formatado }}</td>
                <td class="px-6 py-4 text-right">
                    <a href="/ponto/espelho?user_id={{ item.id }}&mes_ref={{ mes_ref }}" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1 rounded-full transition">
                        Auditar Ponto
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

##################################################

FILE: app/admin/templates/admin/admin_usuarios.html
---------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold text-slate-800">Funcionários</h2>
</div>

<div class="grid grid-cols-2 gap-4 mb-8">
    <a href="/admin/usuarios/novo" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-md text-center transition transform hover:-translate-y-1">
        <i class="fas fa-user-plus mr-2"></i> NOVO CADASTRO
    </a>
    <a href="/admin/usuarios/importar-csv" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-md text-center transition transform hover:-translate-y-1">
        <i class="fas fa-file-csv mr-2"></i> IMPORTAR PLANILHA
    </a>
</div>

<div class="mb-6">
    <input type="text" id="buscaFunc" onkeyup="filtrarTabela('buscaFunc', 'listaFunc')" placeholder="Pesquisar funcionário..." class="w-full p-4 rounded-xl border border-slate-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
</div>

{% if pendentes %}
<div class="bg-yellow-50 border border-yellow-200 rounded-xl overflow-hidden mb-8 shadow-sm">
    <div class="px-6 py-4 border-b border-yellow-200 bg-yellow-100/50 flex justify-between items-center">
        <h3 class="font-bold text-yellow-800"><i class="fas fa-clock mr-2"></i> Aguardando Cadastro ({{ pendentes|length }})</h3>
    </div>
    <div class="divide-y divide-yellow-200/50">
        {% for p in pendentes %}
        <div class="px-6 py-4 flex items-center justify-between hover:bg-yellow-100/30 transition">
            <div>
                <div class="font-bold text-slate-800">{{ p.nome_previsto }}</div>
                <div class="text-xs font-mono text-slate-500">CPF: {{ p.cpf }}</div>
                <div class="text-[10px] text-slate-400 mt-1">{{ p.cargo }}</div>
            </div>
            <a href="/admin/liberar-acesso/excluir/{{ p.id }}" class="text-red-400 hover:text-red-600 p-2" onclick="return confirm('Remover da lista de espera?')">
                <i class="fas fa-trash"></i>
            </a>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
        <h3 class="font-bold text-slate-700">Equipe Ativa</h3>
        <span class="text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded-full font-bold">{{ users|length }}</span>
    </div>
    <div class="divide-y divide-slate-100" id="listaFunc">
        {% for u in users %}
        <div class="px-6 py-4 flex items-center justify-between hover:bg-slate-50 transition group item-lista">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm bg-slate-100 text-slate-600">
                    {{ u.real_name[:2].upper() }}
                </div>
                <div>
                    <div class="font-bold text-slate-800 nome-item">{{ u.real_name }}</div>
                    <div class="text-xs text-slate-500">{{ u.role }}</div>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <span class="px-2 py-1 bg-emerald-100 text-emerald-700 text-[10px] font-bold uppercase rounded">Ativo</span>
                
                <a href="/admin/usuarios/editar/{{ u.id }}" class="w-8 h-8 flex items-center justify-center rounded-full text-slate-300 hover:bg-white hover:text-blue-600 hover:shadow border border-transparent hover:border-slate-200 transition">
                    <i class="fas fa-pencil-alt text-xs"></i>
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<script>
function filtrarTabela(inputId, listaId) {
    let input = document.getElementById(inputId);
    let filter = input.value.toUpperCase();
    let lista = document.getElementById(listaId);
    let itens = lista.getElementsByClassName('item-lista');
    for (let i = 0; i < itens.length; i++) {
        let nome = itens[i].getElementsByClassName('nome-item')[0];
        if (nome.innerHTML.toUpperCase().indexOf(filter) > -1) { itens[i].style.display = ""; } else { itens[i].style.display = "none"; }
    }
}
</script>
{% endblock %}

##################################################

FILE: app/admin/templates/admin/editar_usuario.html
---------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-lg mx-auto">
    <div class="flex items-center justify-between mb-6"><h2 class="text-lg font-bold text-slate-800">Editar</h2><a href="/admin/usuarios" class="text-xs font-medium text-slate-500 hover:text-slate-800">Cancelar</a></div>
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <form action="/admin/usuarios/editar/{{ user.id }}" method="POST" class="p-8 space-y-6">
            <div class="space-y-4">
                <div><label class="label-pro">Nome</label><input type="text" name="real_name" value="{{ user.real_name }}" class="input-pro"></div>
                <div><label class="label-pro">Login</label><input type="text" name="username" value="{{ user.username }}" class="input-pro" {% if user.username == 'Thaynara' %}readonly{% endif %}></div>
                <div><label class="label-pro">Cargo</label><input type="text" name="role" value="{{ user.role }}" class="input-pro" {% if user.username == 'Thaynara' %}disabled{% endif %}></div>
                <div><label class="label-pro">Salário</label><input type="number" step="0.01" name="salario" value="{{ user.salario }}" class="input-pro"></div>
            </div>
            <div class="pt-4 border-t border-slate-100">
                <p class="text-xs font-bold text-slate-400 uppercase mb-3">Escala e Jornada</p>
                <div class="mb-4">
                    <label class="label-pro">Tipo de Escala</label>
                    <select name="escala" class="input-pro" onchange="toggleDtRef(this)">
                        <option value="Livre" {% if user.escala == 'Livre' %}selected{% endif %}>Livre</option>
                        <option value="5x2" {% if user.escala == '5x2' %}selected{% endif %}>Normal 5x2</option>
                        <option value="12x36" {% if user.escala == '12x36' %}selected{% endif %}>Plantão 12x36</option>
                    </select>
                </div>
                <div id="divDtRef" class="{% if user.escala != '12x36' %}hidden{% endif %} mb-4 bg-blue-50 p-3 rounded border border-blue-100">
                    <label class="label-pro text-blue-700">Data Ref (Trabalho)</label>
                    <input type="date" name="dt_escala" value="{{ user.data_inicio_escala }}" class="input-pro">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="label-pro">Entrada</label><input type="time" name="h_ent" value="{{ user.horario_entrada }}" class="input-pro"></div>
                    <div><label class="label-pro">Saída Almoço</label><input type="time" name="h_alm_ini" value="{{ user.horario_almoco_inicio }}" class="input-pro"></div>
                    <div><label class="label-pro">Volta Almoço</label><input type="time" name="h_alm_fim" value="{{ user.horario_almoco_fim }}" class="input-pro"></div>
                    <div><label class="label-pro">Saída</label><input type="time" name="h_sai" value="{{ user.horario_saida }}" class="input-pro"></div>
                </div>
            </div>
            <div class="pt-6 border-t border-slate-100 flex flex-col gap-3">
                <button type="submit" name="acao" value="salvar" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition">SALVAR</button>
                <div class="grid grid-cols-2 gap-3">
                    <button type="submit" name="acao" value="resetar_senha" class="bg-yellow-50 hover:bg-yellow-100 text-yellow-700 font-bold py-3 rounded-lg text-xs border border-yellow-200">RESETAR SENHA</button>
                    {% if user.username != 'Thaynara' %}<button type="submit" name="acao" value="excluir" class="bg-red-50 hover:bg-red-100 text-red-600 font-bold py-3 rounded-lg text-xs border border-red-200" onclick="return confirm('Excluir?')">EXCLUIR</button>{% endif %}
                </div>
            </div>
        </form>
    </div>
</div>
<script>function toggleDtRef(s){if(s.value==='12x36')document.getElementById('divDtRef').classList.remove('hidden');else document.getElementById('divDtRef').classList.add('hidden');}</script>
<style>.label-pro { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem; } .input-pro { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem 1rem; outline: none; }</style>
{% endblock %}

##################################################

FILE: app/admin/templates/admin/liberar_acesso.html
---------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-bold text-slate-800">Liberar Acessos (Lista Branca)</h2>
        <a href="/admin/usuarios" class="text-xs font-bold text-slate-400 hover:text-slate-600">VER USUÁRIOS ATIVOS</a>
    </div>

    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-8">
        <div class="bg-blue-50 px-6 py-4 border-b border-blue-100">
            <h3 class="font-bold text-blue-800">Adicionar Funcionário na Fila</h3>
            <p class="text-xs text-blue-600">O funcionário só poderá criar conta se o CPF estiver aqui.</p>
        </div>
        <form action="/admin/liberar-acesso" method="POST" class="p-6 space-y-4">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <!-- Dados Basicos -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label-pro">CPF (Somente Números)</label>
                    <input type="text" name="cpf" class="input-pro font-mono" placeholder="00000000000" required>
                </div>
                <div>
                    <label class="label-pro">Nome Completo</label>
                    <input type="text" name="nome" class="input-pro" placeholder="Para identificação" required>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label-pro">Cargo</label>
                    <input type="text" name="cargo" class="input-pro" placeholder="Ex: Auxiliar">
                </div>
                <div>
                    <label class="label-pro text-emerald-600">Salário</label>
                    <input type="number" step="0.01" name="salario" class="input-pro border-emerald-200" placeholder="2000.00">
                </div>
            </div>

            <!-- Regras de Jornada -->
            <div class="bg-slate-50 p-4 rounded-lg border border-slate-100">
                <label class="label-pro mb-3 text-slate-500">Definir Regras de Ponto</label>
                
                <div class="mb-4">
                    <label class="label-pro">Tipo de Escala</label>
                    <select name="escala" class="input-pro" onchange="toggleDtRef(this)">
                        <option value="Livre">Livre (Sem Bloqueio)</option>
                        <option value="5x2">Normal 5x2 (Seg-Sex)</option>
                        <option value="12x36">Plantão 12x36</option>
                    </select>
                </div>
                
                <div id="divDtRef" class="hidden mb-4">
                    <label class="label-pro text-blue-700">Data Ref (Dia de Trabalho)</label>
                    <input type="date" name="dt_escala" class="input-pro">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="label-pro">Entrada</label><input type="time" name="h_ent" value="07:12" class="input-pro"></div>
                    <div><label class="label-pro">Saída Almoço</label><input type="time" name="h_alm_ini" value="12:00" class="input-pro"></div>
                    <div><label class="label-pro">Volta Almoço</label><input type="time" name="h_alm_fim" value="13:00" class="input-pro"></div>
                    <div><label class="label-pro">Saída</label><input type="time" name="h_sai" value="17:00" class="input-pro"></div>
                </div>
            </div>

            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md transition">
                LIBERAR CPF
            </button>
        </form>
    </div>

    <h3 class="font-bold text-slate-700 mb-4 text-sm uppercase">Fila de Espera (Aguardando Cadastro)</h3>
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="divide-y divide-slate-100">
            {% for p in pendentes %}
            <div class="px-6 py-4 flex items-center justify-between hover:bg-slate-50">
                <div>
                    <div class="font-bold text-slate-800">{{ p.nome_previsto }}</div>
                    <div class="text-xs font-mono text-slate-500">CPF: {{ p.cpf }}</div>
                    <div class="text-[10px] text-slate-400 mt-1">{{ p.cargo }} | Escala: {{ p.escala }}</div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-[10px] bg-yellow-100 text-yellow-700 px-2 py-1 rounded font-bold uppercase">Aguardando</span>
                    <a href="/admin/liberar-acesso/excluir/{{ p.id }}" class="text-red-400 hover:text-red-600" onclick="return confirm('Remover da lista?')"><i class="fas fa-trash"></i></a>
                </div>
            </div>
            {% else %}
            <div class="p-8 text-center text-slate-400 text-sm">Nenhum CPF na fila de espera.</div>
            {% endfor %}
        </div>
    </div>
</div>
<script>
    function toggleDtRef(sel) { if (sel.value === '12x36') document.getElementById('divDtRef').classList.remove('hidden'); else document.getElementById('divDtRef').classList.add('hidden'); }
</script>

{% endblock %}

##################################################

FILE: app/admin/templates/admin/novo_usuario.html
-------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-lg mx-auto">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-bold text-slate-800">Novo Cadastro Manual</h2>
        <a href="/admin/usuarios" class="text-xs font-medium text-slate-500 hover:text-slate-800">Cancelar</a>
    </div>

    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <form action="/admin/usuarios/novo" method="POST" class="p-8 space-y-6">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <div class="space-y-4">
                <div>
                    <label class="label-pro">Nome Completo</label>
                    <input type="text" name="real_name" class="input-pro" placeholder="Ex: Maria da Silva" required>
                </div>
                <div>
                    <label class="label-pro text-blue-600">CPF (Somente Números)</label>
                    <input type="text" name="cpf" class="input-pro font-mono bg-blue-50 border-blue-200" placeholder="00000000000" required>
                </div>
                <div>
                    <label class="label-pro">Cargo / Função</label>
                    <input type="text" name="role" class="input-pro" placeholder="Ex: Assistente" required>
                </div>
                <div>
                    <label class="label-pro text-emerald-600">Salário Base (R$)</label>
                    <input type="number" step="0.01" name="salario" class="input-pro border-emerald-200 text-emerald-700 font-bold" placeholder="2000.00">
                </div>
            </div>

            <!-- JORNADA DE TRABALHO -->
            <div class="pt-4 border-t border-slate-100">
                <p class="text-xs font-bold text-slate-400 uppercase mb-3">Escala e Jornada</p>
                <div class="mb-4">
                    <label class="label-pro">Tipo de Escala</label>
                    <select name="escala" class="input-pro" onchange="toggleDtRef(this)">
                        <option value="Livre">Livre (Sem Bloqueio)</option>
                        <option value="5x2">Normal 5x2 (Seg-Sex)</option>
                        <option value="12x36">Plantão 12x36</option>
                    </select>
                </div>
                <div id="divDtRef" class="hidden mb-4 bg-blue-50 p-3 rounded border border-blue-100">
                    <label class="label-pro text-blue-700">Data de Referência (Dia Trabalhado)</label>
                    <input type="date" name="dt_escala" class="input-pro">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="label-pro">Entrada</label><input type="time" name="h_ent" value="07:12" class="input-pro"></div>
                    <div><label class="label-pro">Saída Almoço</label><input type="time" name="h_alm_ini" value="12:00" class="input-pro"></div>
                    <div><label class="label-pro">Volta Almoço</label><input type="time" name="h_alm_fim" value="13:00" class="input-pro"></div>
                    <div><label class="label-pro">Saída</label><input type="time" name="h_sai" value="17:00" class="input-pro"></div>
                </div>
            </div>

            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-md transition transform active:scale-95">
                GERAR ACESSO AUTOMÁTICO
            </button>
        </form>
    </div>
</div>
<script>
    function toggleDtRef(sel) {
        if (sel.value === '12x36') document.getElementById('divDtRef').classList.remove('hidden');
        else document.getElementById('divDtRef').classList.add('hidden');
    }
</script>

{% endblock %}

##################################################

FILE: app/admin/templates/admin/solicitacoes.html
-------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6"><h2 class="text-2xl font-bold text-slate-800">Solicitações</h2></div>

<div class="mb-6"><input type="text" id="buscaSolic" onkeyup="filtrarSolic('buscaSolic', 'gridSolic')" placeholder="Pesquisar por nome..." class="w-full p-4 rounded-xl border border-slate-200 shadow-sm"></div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="gridSolic">
    {% for s in solicitacoes %}
    <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm relative border-l-4 {% if s.tipo_solicitacao == 'Exclusao' %} border-l-red-500 {% elif s.tipo_solicitacao == 'Inclusao' %} border-l-emerald-500 {% else %} border-l-blue-500 {% endif %} item-solic">
        <span class="absolute top-4 right-4 bg-yellow-100 text-yellow-700 text-[10px] font-bold px-2 py-1 rounded uppercase">{{ s.tipo_solicitacao }}</span>
        <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-600">{{ s.user.real_name[:2].upper() }}</div>
            <div><h3 class="font-bold text-slate-800 text-sm nome-solic">{{ s.user.real_name }}</h3><p class="text-xs text-slate-500">Ref: {{ s.data_referencia.strftime('%d/%m/%Y') }}</p></div>
        </div>
        <div class="bg-slate-50 p-3 rounded-lg mb-4 text-sm">
            {% if s.tipo_solicitacao == 'Edicao' %}
                <div class="flex justify-between mb-1 text-xs"><span class="text-slate-400">De:</span> <span class="font-mono text-slate-600 line-through">{{ extras[s.id] }}</span></div>
                <div class="flex justify-between mb-1 text-sm font-bold"><span class="text-slate-600">Para:</span> <span class="font-mono text-blue-600">{{ s.novo_horario }} ({{ s.tipo_batida }})</span></div>
            {% elif s.tipo_solicitacao == 'Exclusao' %}
                <div class="text-red-600 font-bold text-center py-2">SOLICITA REMOÇÃO</div><div class="text-center text-xs text-slate-500">Alvo: {{ extras[s.id] }}</div>
            {% else %}
                <div class="text-emerald-600 font-bold text-center py-2">NOVA MARCAÇÃO</div><div class="text-center font-mono">{{ s.novo_horario }} ({{ s.tipo_batida }})</div>
            {% endif %}
            <div class="mt-3 text-xs text-slate-600 italic border-t pt-2">"{{ s.justificativa }}"</div>
        </div>
        <form action="/admin/solicitacoes" method="POST" class="flex flex-col gap-2">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="solic_id" value="{{ s.id }}">
            <div class="flex gap-2">
                <button type="submit" name="decisao" value="aprovar" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded text-xs transition">APROVAR</button>
                <button type="button" onclick="document.getElementById('repro-{{ s.id }}').classList.remove('hidden')" class="flex-1 bg-red-100 hover:bg-red-200 text-red-600 font-bold py-2 rounded text-xs transition">REPROVAR</button>
            </div>
            <div id="repro-{{ s.id }}" class="hidden mt-2"><input type="text" name="motivo_repro" class="w-full border border-red-200 rounded p-2 text-xs mb-2 bg-red-50" placeholder="Motivo..."><button type="submit" name="decisao" value="reprovar" class="w-full bg-red-600 text-white font-bold py-2 rounded text-xs">ENVIAR</button></div>
        </form>
    </div>
    {% else %}<div class="col-span-2 text-center py-12 text-slate-400 bg-white rounded-xl border border-slate-200 border-dashed"><p>Nenhuma solicitação pendente.</p></div>{% endfor %}
</div>
<script>
function filtrarSolic(inputId, gridId) {
    let input = document.getElementById(inputId);
    let filter = input.value.toUpperCase();
    let grid = document.getElementById(gridId);
    let itens = grid.getElementsByClassName('item-solic');
    for (let i = 0; i < itens.length; i++) {
        let nome = itens[i].getElementsByClassName('nome-solic')[0];
        if (nome.innerHTML.toUpperCase().indexOf(filter) > -1) { itens[i].style.display = ""; } else { itens[i].style.display = "none"; }
    }
}
</script>
{% endblock %}

##################################################

FILE: app/admin/templates/admin/sucesso_usuario.html
----------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-lg mx-auto flex flex-col items-center justify-center min-h-[50vh] text-center">
    <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 mb-6 shadow-sm"><i class="fas fa-check text-3xl"></i></div>
    <h2 class="text-2xl font-bold text-slate-800 mb-2">CPF Liberado!</h2>
    <p class="text-slate-500 mb-8">O funcionário <strong>{{ nome_real }}</strong> (CPF: {{ cpf }}) já pode se cadastrar.</p>
    <div class="bg-blue-50 text-blue-800 text-sm p-6 rounded-xl mb-8 max-w-sm">
        <p class="font-bold mb-2">Próximo Passo:</p>
        <p>Peça para o funcionário acessar o sistema, clicar em <strong>"Sou Funcionário"</strong> e criar a própria senha usando este CPF.</p>
    </div>
    <a href="/admin/usuarios" class="bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-8 rounded-full transition shadow-lg">VOLTAR</a>
</div>
{% endblock %}

##################################################

FILE: app/auth/__init__.py
--------------------------
# Módulo auth

##################################################

FILE: app/auth/routes.py
------------------------
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_user, logout_user, login_required, current_user
from werkzeug.security import generate_password_hash
from app.extensions import db
from app.models import User, PreCadastro
from app.utils import gerar_login_automatico

auth_bp = Blueprint('auth', __name__, template_folder='templates')

@auth_bp.route('/login', methods=['GET', 'POST'])
def login():
    if current_user.is_authenticated: return redirect(url_for('main.dashboard'))
    if request.method == 'POST':
        user = User.query.filter_by(username=request.form.get('username')).first()
        if user and user.check_password(request.form.get('password')):
            login_user(user)
            if user.is_first_access: return redirect(url_for('auth.primeiro_acesso'))
            return redirect(url_for('main.dashboard'))
        flash('Credenciais inválidas.')
    return render_template('auth/login.html')

@auth_bp.route('/logout')
@login_required
def logout():
    logout_user()
    return redirect(url_for('auth.login'))

@auth_bp.route('/primeiro-acesso', methods=['GET', 'POST'])
@login_required
def primeiro_acesso():
    if not current_user.is_first_access: return redirect(url_for('main.dashboard'))
    if request.method == 'POST':
        if request.form.get('nova_senha') == request.form.get('confirmacao'):
            current_user.set_password(request.form.get('nova_senha'))
            current_user.is_first_access = False
            db.session.commit()
            return redirect(url_for('main.dashboard'))
        flash('Senhas não conferem.')
    return render_template('auth/primeiro_acesso.html')

@auth_bp.route('/cadastrar', methods=['GET', 'POST'])
def auto_cadastro():
    if request.method == 'GET': return render_template('auth/auto_cadastro.html', step=1)
    if request.method == 'POST':
        cpf = request.form.get('cpf').replace('.', '').replace('-', '').strip()
        pre = PreCadastro.query.filter_by(cpf=cpf).first()
        if not pre:
            if User.query.filter_by(cpf=cpf).first():
                flash('Você já tem cadastro. Faça login.')
                return redirect(url_for('auth.login'))
            flash('CPF não encontrado na lista de liberação.')
            return redirect(url_for('auth.auto_cadastro'))
            
        password = request.form.get('password')
        if password:
            username = gerar_login_automatico(pre.nome_previsto)
            while User.query.filter_by(username=username).first(): username = gerar_login_automatico(pre.nome_previsto)
            novo_user = User(username=username, password_hash=generate_password_hash(password), real_name=pre.nome_previsto, role=pre.cargo, cpf=cpf, salario=pre.salario, horario_entrada=pre.horario_entrada, horario_almoco_inicio=pre.horario_almoco_inicio, horario_almoco_fim=pre.horario_almoco_fim, horario_saida=pre.horario_saida, escala=pre.escala, data_inicio_escala=pre.data_inicio_escala, is_first_access=False)
            db.session.add(novo_user); db.session.delete(pre); db.session.commit()
            return render_template('auth/auto_cadastro_sucesso.html', username=username, nome=pre.nome_previsto)
        else:
            return render_template('auth/auto_cadastro.html', step=2, cpf=cpf, nome=pre.nome_previsto)

##################################################

FILE: app/auth/templates/auth/auto_cadastro.html
------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col items-center justify-center min-h-[60vh]">
    <div class="bg-white p-8 rounded-2xl shadow-xl border border-slate-100 w-full max-w-md">
        
        <!-- ETAPA 1: DIGITAR CPF -->
        {% if step == 1 %}
        <h2 class="text-xl font-bold text-slate-800 mb-2">Primeiro Acesso</h2>
        <p class="text-sm text-slate-500 mb-6">Digite seu CPF para localizar seu cadastro.</p>
        <form action="/cadastrar" method="POST" class="space-y-4">
            <input type="hidden" name="step" value="1">
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">CPF (Somente Números)</label>
                <input type="text" name="cpf" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 font-bold text-lg tracking-wide focus:outline-none focus:border-blue-500" placeholder="000.000.000-00" required>
            </div>
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-lg transition">CONTINUAR</button>
        </form>
        {% endif %}

        <!-- ETAPA 2: CRIAR SENHA -->
        {% if step == 2 %}
        <h2 class="text-xl font-bold text-emerald-700 mb-2">Bem-vindo(a), {{ nome }}!</h2>
        <p class="text-sm text-slate-500 mb-6">Confirme seus dados e crie uma senha segura.</p>
        <form action="/cadastrar" method="POST" class="space-y-4">
            <input type="hidden" name="step" value="2">
            <input type="hidden" name="cpf" value="{{ cpf }}">
            
            <div class="bg-slate-50 p-4 rounded-lg border border-slate-100 mb-4">
                <p class="text-xs text-slate-400 font-bold uppercase">CPF</p>
                <p class="font-mono text-slate-800 font-bold">{{ cpf }}</p>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Crie sua Senha</label>
                <input type="password" name="password" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-3 focus:outline-none focus:border-emerald-500" placeholder="Mínimo 6 caracteres" required>
            </div>
            
            <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-lg shadow-lg transition">FINALIZAR CADASTRO</button>
        </form>
        {% endif %}

        <div class="text-center mt-4">
            <a href="/login" class="text-xs text-slate-400 hover:text-slate-600">Voltar para Login</a>
        </div>
    </div>
</div>
{% endblock %}

##################################################

FILE: app/auth/templates/auth/auto_cadastro_sucesso.html
--------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-lg mx-auto flex flex-col items-center justify-center min-h-[50vh] text-center">
    <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 mb-6 shadow-sm animate-bounce"><i class="fas fa-check text-3xl"></i></div>
    <h2 class="text-2xl font-bold text-slate-800 mb-2">Tudo Pronto!</h2>
    <p class="text-slate-500 mb-8">Seu usuário de acesso foi gerado automaticamente.</p>
    
    <div class="bg-white border-2 border-dashed border-emerald-300 p-8 rounded-xl w-full mb-8 shadow-lg relative overflow-hidden">
        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">SEU USUÁRIO É</p>
        <div class="text-4xl font-mono font-bold text-slate-800 select-all">{{ username }}</div>
        <p class="text-xs text-emerald-600 mt-2 font-bold">Memorize este usuário para entrar.</p>
    </div>
    
    <a href="/login" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full transition shadow-lg">FAZER LOGIN AGORA</a>
</div>
{% endblock %}

##################################################

FILE: app/auth/templates/auth/login.html
----------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col items-center justify-center min-h-[60vh]">
    <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white font-bold text-3xl mb-6 shadow-lg shadow-blue-200">S</div>
    <div class="bg-white p-8 rounded-2xl shadow-xl border border-slate-100 w-full max-w-sm">
        <h2 class="text-xl font-bold text-center text-slate-800 mb-6">Acesso Shahin</h2>
        <form action="/login" method="POST" class="space-y-4">
            <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">Usuário</label><input type="text" name="username" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500" placeholder="ex: joao.silva" required></div>
            <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">Senha</label><input type="password" name="password" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500" placeholder="••••••" required></div>
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-lg transition">ENTRAR</button>
        </form>
    </div>
    
    <a href="/cadastrar" class="mt-6 text-sm text-blue-600 font-bold hover:underline">
        Sou Funcionário e quero criar minha senha
    </a>
    
    <p class="text-xs text-slate-400 mt-6">&copy; 2026 Vortice Company</p>
</div>
{% endblock %}

##################################################

FILE: app/auth/templates/auth/primeiro_acesso.html
--------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col items-center justify-center min-h-[60vh]">
    <div class="bg-white p-8 rounded-2xl shadow-xl border-l-4 border-yellow-400 w-full max-w-sm">
        <h2 class="text-xl font-bold text-slate-800 mb-2">Primeiro Acesso</h2>
        <p class="text-sm text-slate-500 mb-6">Por segurança, você deve definir uma nova senha pessoal.</p>
        <form action="/primeiro-acesso" method="POST" class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Nova Senha</label>
                <input type="password" name="nova_senha" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-500" required>
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Confirmar Senha</label>
                <input type="password" name="confirmacao" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-500" required>
            </div>
            <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 rounded-lg shadow-lg transition">SALVAR E ACESSAR</button>
        </form>
    </div>
</div>
{% endblock %}

##################################################

FILE: app/estoque/__init__.py
-----------------------------
# Módulo estoque

##################################################

FILE: app/estoque/routes.py
---------------------------
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from app.extensions import db
from app.models import ItemEstoque, HistoricoEntrada, HistoricoSaida
from app.utils import get_brasil_time
from datetime import datetime

estoque_bp = Blueprint('estoque', __name__, template_folder='templates')

@estoque_bp.route('/controle-uniforme')
@login_required
def controle_uniforme(): return render_template('estoque/controle_uniforme.html', itens=ItemEstoque.query.all()) if current_user.role == 'Master' else redirect(url_for('main.dashboard'))

@estoque_bp.route('/entrada', methods=['GET', 'POST'])
@login_required
def entrada(): 
    if request.method == 'POST':
        try:
            nome = request.form.get('nome_outros') if request.form.get('nome_select') == 'Outros' else request.form.get('nome_select')
            item = ItemEstoque.query.filter_by(nome=nome, tamanho=request.form.get('tamanho'), genero=request.form.get('genero')).first()
            qtd = int(request.form.get('quantidade') or 1)
            if item:
                item.quantidade += qtd
                item.estoque_minimo = int(request.form.get('estoque_minimo') or 5)
                item.estoque_ideal = int(request.form.get('estoque_ideal') or 20)
                item.data_atualizacao = get_brasil_time()
            else:
                novo = ItemEstoque(nome=nome, tamanho=request.form.get('tamanho'), genero=request.form.get('genero'), quantidade=qtd, estoque_minimo=int(request.form.get('estoque_minimo') or 5), estoque_ideal=int(request.form.get('estoque_ideal') or 20))
                novo.data_atualizacao = get_brasil_time()
                db.session.add(novo)
            db.session.add(HistoricoEntrada(item_nome=f"{nome} ({request.form.get('genero')}-{request.form.get('tamanho')})", quantidade=qtd, data_hora=get_brasil_time()))
            db.session.commit(); return redirect(url_for('estoque.controle_uniforme'))
        except: db.session.rollback()
    return render_template('estoque/entrada.html')

@estoque_bp.route('/saida', methods=['GET', 'POST'])
@login_required
def saida(): 
    if request.method == 'POST': 
        item = ItemEstoque.query.get(request.form.get('item_id'))
        qtd = int(request.form.get('quantidade') or 1)
        if item and item.quantidade >= qtd:
            item.quantidade -= qtd
            item.data_atualizacao = get_brasil_time()
            try: dt = datetime.strptime(request.form.get('data'), '%Y-%m-%d')
            except: dt = get_brasil_time()
            db.session.add(HistoricoSaida(coordenador=request.form.get('coordenador'), colaborador=request.form.get('colaborador'), item_nome=item.nome, tamanho=item.tamanho, genero=item.genero, quantidade=qtd, data_entrega=dt))
            db.session.commit()
            return redirect(url_for('estoque.controle_uniforme'))
        flash('Erro estoque.')
    return render_template('estoque/saida.html', itens=ItemEstoque.query.all())

@estoque_bp.route('/gerenciar/selecao', methods=['GET', 'POST'])
@login_required
def selecionar_edicao():
    if request.method == 'POST': return redirect(url_for('estoque.editar_item', id=request.form.get('item_id')))
    return render_template('estoque/selecionar_edicao.html', itens=ItemEstoque.query.order_by(ItemEstoque.nome).all())

@estoque_bp.route('/gerenciar/item/<int:id>', methods=['GET', 'POST'])
@login_required
def editar_item(id):
    item = ItemEstoque.query.get_or_404(id)
    if request.method == 'POST':
        if request.form.get('acao') == 'excluir': db.session.delete(item); db.session.commit()
        else: item.nome = request.form.get('nome'); item.quantidade = int(request.form.get('quantidade')); db.session.commit()
        return redirect(url_for('estoque.controle_uniforme'))
    return render_template('estoque/editar_item.html', item=item)

@estoque_bp.route('/historico/entrada')
@login_required
def view_historico_entrada(): return render_template('estoque/historico_entrada.html', logs=HistoricoEntrada.query.all())

@estoque_bp.route('/historico/saida')
@login_required
def view_historico_saida(): return render_template('estoque/historico_saida.html', logs=HistoricoSaida.query.all())

@estoque_bp.route('/historico/entrada/editar/<int:id>', methods=['GET', 'POST'])
@login_required
def editar_historico_entrada(id):
    log = HistoricoEntrada.query.get_or_404(id)
    if request.method == 'POST':
        if request.form.get('acao') == 'excluir': db.session.delete(log); db.session.commit(); return redirect(url_for('estoque.view_historico_entrada'))
        log.item_nome = request.form.get('item_nome'); log.quantidade = int(request.form.get('quantidade')); db.session.commit(); return redirect(url_for('estoque.view_historico_entrada'))
    return render_template('estoque/editar_log_entrada.html', log=log)

@estoque_bp.route('/historico/saida/editar/<int:id>', methods=['GET', 'POST'])
@login_required
def editar_historico_saida(id):
    log = HistoricoSaida.query.get_or_404(id)
    if request.method == 'POST':
        if request.form.get('acao') == 'excluir': db.session.delete(log); db.session.commit(); return redirect(url_for('estoque.view_historico_saida'))
        log.colaborador = request.form.get('colaborador'); log.quantidade = int(request.form.get('quantidade')); db.session.commit(); return redirect(url_for('estoque.view_historico_saida'))
    return render_template('estoque/editar_log_saida.html', log=log)

##################################################

FILE: app/estoque/templates/estoque/controle_uniforme.html
----------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col gap-4 mb-8">
    <h2 class="text-2xl font-bold text-slate-800">Controle de Uniforme</h2>
    <div class="grid grid-cols-2 gap-4">
        <a href="/entrada" class="bg-emerald-600 hover:bg-emerald-700 text-white p-4 rounded-full shadow-lg flex items-center justify-center gap-2 text-center"><i class="fas fa-arrow-down"></i> <span class="font-bold">ENTRADA</span></a>
        <a href="/saida" class="bg-red-600 hover:bg-red-700 text-white p-4 rounded-full shadow-lg flex items-center justify-center gap-2 text-center"><i class="fas fa-arrow-up"></i> <span class="font-bold">SAÍDA</span></a>
    </div>
</div>
<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
        <h2 class="font-semibold text-slate-800">Inventário</h2>
        <div class="flex gap-2 text-[10px] font-bold uppercase">
            <span class="text-emerald-600"><i class="fas fa-circle text-[6px]"></i> Bom</span>
            <span class="text-yellow-600"><i class="fas fa-circle text-[6px]"></i> Médio</span>
            <span class="text-red-600"><i class="fas fa-circle text-[6px]"></i> Ruim</span>
        </div>
    </div>
    <div class="divide-y divide-slate-100">
        {% for item in itens %}
        <div class="px-6 py-4 flex items-center justify-between hover:bg-slate-50 transition">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-full flex items-center justify-center text-slate-500 bg-slate-100 font-bold text-xs border border-slate-200">{{ item.tamanho }}</div>
                <div><div class="font-semibold text-slate-800 text-sm">{{ item.nome }}</div><div class="text-xs text-slate-500 flex items-center gap-1">{{ item.genero }}</div></div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <div class="text-lg font-bold {% if item.quantidade <= item.estoque_minimo %} text-red-600 {% elif item.quantidade >= item.estoque_ideal %} text-emerald-600 {% else %} text-yellow-600 {% endif %}">{{ item.quantidade }}</div>
                    <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Estoque</div>
                </div>
                <a href="/gerenciar/item/{{ item.id }}" class="text-slate-300 hover:text-blue-500 px-2"><i class="fas fa-pencil-alt"></i></a>
            </div>
        </div>
        {% else %}
        <div class="p-12 text-center text-slate-400">Nenhum item registrado.</div>
        {% endfor %}
    </div>
</div>
{% endblock %}

##################################################

FILE: app/estoque/templates/estoque/editar_item.html
----------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex items-center justify-between mb-6">
    <h2 class="text-lg font-bold text-slate-800">Editar Detalhes</h2>
    <a href="/gerenciar/selecao" class="text-xs font-medium text-slate-500 hover:text-slate-800">Voltar</a>
</div>

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <form action="/gerenciar/item/{{ item.id }}" method="POST" class="p-6 space-y-6">
        
        <!-- Dados Básicos -->
        <div class="space-y-4">
            <div>
                <label class="label-pro">Nome do Item</label>
                <input type="text" name="nome" value="{{ item.nome }}" class="input-pro" required>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label-pro">Tamanho</label>
                    <select name="tamanho" class="input-pro">
                        <option value="P" {% if item.tamanho == 'P' %}selected{% endif %}>P</option>
                        <option value="M" {% if item.tamanho == 'M' %}selected{% endif %}>M</option>
                        <option value="G" {% if item.tamanho == 'G' %}selected{% endif %}>G</option>
                        <option value="GG" {% if item.tamanho == 'GG' %}selected{% endif %}>GG</option>
                        <option value="XG" {% if item.tamanho == 'XG' %}selected{% endif %}>XG</option>
                    </select>
                </div>
                <div>
                    <label class="label-pro">Gênero</label>
                    <select name="genero" class="input-pro">
                        <option value="Masculino" {% if item.genero == 'Masculino' %}selected{% endif %}>Masculino</option>
                        <option value="Feminino" {% if item.genero == 'Feminino' %}selected{% endif %}>Feminino</option>
                        <option value="Unissex" {% if item.genero == 'Unissex' %}selected{% endif %}>Unissex</option>
                    </select>
                </div>
            </div>
        </div>

        <hr class="border-slate-100">

        <!-- Quantidade e Níveis -->
        <div class="space-y-4">
            <div>
                <label class="label-pro text-blue-600">Quantidade Atual (Ajuste Manual)</label>
                <input type="number" name="quantidade" value="{{ item.quantidade }}" class="input-pro font-bold text-blue-700" required>
            </div>
            
            <div class="grid grid-cols-2 gap-4 bg-slate-50 p-4 rounded-lg border border-slate-100">
                <div>
                    <label class="label-pro text-red-500">Estoque Ruim (Mínimo)</label>
                    <input type="number" name="estoque_minimo" value="{{ item.estoque_minimo }}" class="input-pro border-red-200 text-red-600" required>
                </div>
                <div>
                    <label class="label-pro text-emerald-500">Estoque Bom (Ideal)</label>
                    <input type="number" name="estoque_ideal" value="{{ item.estoque_ideal }}" class="input-pro border-emerald-200 text-emerald-600" required>
                </div>
                <div class="col-span-2 text-[10px] text-center text-slate-400">
                    * Entre o Mínimo e o Ideal será considerado "Médio" (Amarelo).
                </div>
            </div>
        </div>

        <div class="flex gap-3 pt-4">
            <button type="submit" name="acao" value="salvar" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition">
                SALVAR ALTERAÇÕES
            </button>
            <button type="submit" name="acao" value="excluir" class="flex-none bg-red-100 hover:bg-red-200 text-red-600 font-bold py-3 px-6 rounded-lg transition" onclick="return confirm('Tem certeza? Isso apagará o item permanentemente.')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </form>
</div>

<style>
    .label-pro { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
    .input-pro { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem 1rem; color: #1e293b; font-weight: 500; outline: none; transition: all; }
    .input-pro:focus { background-color: #fff; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
</style>
{% endblock %}

##################################################

FILE: app/estoque/templates/estoque/editar_log_entrada.html
-----------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
    <h2 class="text-lg font-bold text-slate-800 mb-4">Editar Histórico (Entrada)</h2>
    <form action="/historico/entrada/editar/{{ log.id }}" method="POST" class="space-y-4">
        <div><label class="label-pro">Item (Texto)</label><input type="text" name="item_nome" value="{{ log.item_nome }}" class="input-pro"></div>
        <div><label class="label-pro">Quantidade Original</label><input type="number" name="quantidade" value="{{ log.quantidade }}" class="input-pro"></div>
        <div><label class="label-pro">Data/Hora</label><input type="datetime-local" name="data" value="{{ log.data_hora.strftime('%Y-%m-%dT%H:%M') }}" class="input-pro"></div>
        
        <div class="flex gap-3 pt-4">
            <button type="submit" name="acao" value="salvar" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg">Salvar Correção</button>
            <button type="submit" name="acao" value="excluir" class="flex-none bg-red-100 text-red-600 font-bold py-3 px-6 rounded-lg" onclick="return confirm('Excluir este registro? O estoque atual NÃO será alterado.')"><i class="fas fa-trash"></i></button>
        </div>
        <p class="text-[10px] text-slate-400 mt-2 text-center">Nota: Alterar este log não muda o estoque atual. Use o menu Gerenciar para ajustar quantidades atuais.</p>
    </form>
</div>
<style>.label-pro { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem; } .input-pro { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem 1rem; }</style>
{% endblock %}

##################################################

FILE: app/estoque/templates/estoque/editar_log_saida.html
---------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
    <h2 class="text-lg font-bold text-slate-800 mb-4">Editar Histórico (Saída)</h2>
    <form action="/historico/saida/editar/{{ log.id }}" method="POST" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
            <div><label class="label-pro">Coordenador</label><input type="text" name="coordenador" value="{{ log.coordenador }}" class="input-pro"></div>
            <div><label class="label-pro">Colaborador</label><input type="text" name="colaborador" value="{{ log.colaborador }}" class="input-pro"></div>
        </div>
        <div><label class="label-pro">Item (Texto)</label><input type="text" name="item_nome" value="{{ log.item_nome }}" class="input-pro"></div>
        <div><label class="label-pro">Quantidade</label><input type="number" name="quantidade" value="{{ log.quantidade }}" class="input-pro"></div>
        <div><label class="label-pro">Data</label><input type="date" name="data" value="{{ log.data_entrega.strftime('%Y-%m-%d') }}" class="input-pro"></div>
        
        <div class="flex gap-3 pt-4">
            <button type="submit" name="acao" value="salvar" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg">Salvar Correção</button>
            <button type="submit" name="acao" value="excluir" class="flex-none bg-red-100 text-red-600 font-bold py-3 px-6 rounded-lg" onclick="return confirm('Excluir este registro?')"><i class="fas fa-trash"></i></button>
        </div>
    </form>
</div>
<style>.label-pro { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem; } .input-pro { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem 1rem; }</style>
{% endblock %}

##################################################

FILE: app/estoque/templates/estoque/entrada.html
------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-6">
    <div class="bg-emerald-50 px-6 py-4 border-b border-emerald-100">
        <h2 class="text-lg font-bold text-emerald-800">Nova Entrada</h2>
        <p class="text-xs text-emerald-600">Adicione itens pré-definidos ou crie novos.</p>
    </div>
    <form action="/entrada" method="POST" class="p-6 space-y-5">
        <div>
            <label class="label-pro">Item / Uniforme</label>
            <select name="nome_select" id="nome_select" class="input-pro" onchange="verificarOutros(this)">
                <option value="Camisa Tático">Camisa Tático</option>
                <option value="Calça Tático">Calça Tático</option>
                <option value="Camisa Portaria">Camisa Portaria</option>
                <option value="Calça Portaria">Calça Portaria</option>
                <option value="Blazer Portaria">Blazer Portaria</option>
                <option value="Camisa Limpeza">Camisa Limpeza</option>
                <option value="Calça Limpeza">Calça Limpeza</option>
                <option value="Outros">Outros...</option>
            </select>
        </div>
        <div id="div_outros" class="hidden animate-fade-in">
            <label class="label-pro text-blue-600">Digite o nome do Item</label>
            <input type="text" name="nome_outros" id="nome_outros" class="input-pro border-blue-300 bg-blue-50" placeholder="Ex: Sapato Social">
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div><label class="label-pro">Tamanho</label><select name="tamanho" class="input-pro"><option value="P">P</option><option value="M">M</option><option value="G">G</option><option value="GG">GG</option><option value="XG">XG</option></select></div>
            <div><label class="label-pro">Gênero</label><select name="genero" class="input-pro"><option value="Masculino">Masculino</option><option value="Feminino">Feminino</option><option value="Unissex">Unissex</option></select></div>
        </div>
        <div><label class="label-pro text-emerald-600">Quantidade</label><input type="number" name="quantidade" min="1" value="1" class="input-pro font-bold text-lg text-emerald-700" required></div>
        <div class="pt-4 border-t border-slate-100">
            <p class="text-xs font-bold text-slate-400 uppercase mb-3">Definição de Níveis (Opcional)</p>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="label-pro text-red-400">Mínimo (Ruim)</label><input type="number" name="estoque_minimo" value="5" class="input-pro text-xs"></div>
                <div><label class="label-pro text-emerald-400">Ideal (Bom)</label><input type="number" name="estoque_ideal" value="20" class="input-pro text-xs"></div>
            </div>
        </div>
        <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-lg shadow-md hover:shadow-lg transition">ADICIONAR</button>
    </form>
</div>

<!-- Botão de Histórico Restaurado -->
<a href="/historico/entrada" class="block bg-slate-100 hover:bg-slate-200 text-slate-600 text-center py-3 rounded-lg font-bold text-xs transition">
    <i class="fas fa-history mr-1"></i> VER HISTÓRICO DE ENTRADAS
</a>

<script>
    function verificarOutros(select) {
        const div = document.getElementById('div_outros');
        const input = document.getElementById('nome_outros');
        if (select.value === 'Outros') { div.classList.remove('hidden'); input.required = true; input.focus(); } 
        else { div.classList.add('hidden'); input.required = false; }
    }
</script>
<style>.label-pro { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; } .input-pro { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem 1rem; color: #1e293b; font-weight: 500; outline: none; }</style>
{% endblock %}

##################################################

FILE: app/estoque/templates/estoque/historico_entrada.html
----------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6"><h2 class="text-lg font-bold text-slate-800">Log de Entradas</h2></div>
<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="divide-y divide-slate-100">
        {% for log in logs %}
        <div class="p-4 flex justify-between items-center hover:bg-slate-50">
            <div>
                <div class="text-xs text-slate-400 font-bold">{{ log.data_hora.strftime('%d/%m %H:%M') }}</div>
                <div class="font-medium text-slate-800 text-sm">{{ log.item_nome }}</div>
            </div>
            <div class="flex items-center gap-4">
                <span class="font-bold text-emerald-600">+{{ log.quantidade }}</span>
                <a href="/historico/entrada/editar/{{ log.id }}" class="text-slate-300 hover:text-blue-500"><i class="fas fa-pencil-alt"></i></a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

##################################################

FILE: app/estoque/templates/estoque/historico_saida.html
--------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6"><h2 class="text-lg font-bold text-slate-800">Registro de Entregas</h2></div>
<div class="space-y-3">
    {% for log in logs %}
    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition relative group">
        <a href="/historico/saida/editar/{{ log.id }}" class="absolute top-4 right-4 text-slate-300 hover:text-blue-500 p-2"><i class="fas fa-pencil-alt"></i></a>
        <div class="flex justify-between items-start mb-2">
            <div class="text-xs font-bold text-slate-400 uppercase tracking-wide">{{ log.data_entrega.strftime('%d/%m/%Y') }}</div>
            <div class="bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded font-bold mr-8">-{{ log.quantidade }} UN</div>
        </div>
        <div class="flex items-center gap-3 mb-3">
             <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-xs">{{ log.colaborador[:1] }}</div>
             <div><div class="font-bold text-slate-800">{{ log.colaborador }}</div><div class="text-xs text-slate-500">Autorizado por: {{ log.coordenador }}</div></div>
        </div>
        <!-- Detalhes de Tamanho e Genero -->
        <div class="pt-3 border-t border-slate-100 text-sm text-slate-700 flex items-center gap-2">
            <i class="fas fa-tshirt text-slate-400"></i> 
            <span class="font-semibold">{{ log.item_nome }}</span>
            <span class="text-slate-300">|</span>
            <span class="bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded text-xs font-bold">{{ log.tamanho }}</span>
            <span class="text-slate-300">|</span>
            <span class="text-xs text-slate-500">{{ log.genero }}</span>
        </div>
    </div>
    {% else %}
    <div class="text-center py-10 text-slate-400">Nenhuma entrega registrada.</div>
    {% endfor %}
</div>
{% endblock %}

##################################################

FILE: app/estoque/templates/estoque/saida.html
----------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="bg-red-50 px-6 py-4 border-b border-red-100">
        <h2 class="text-lg font-bold text-red-800">Registrar Saída</h2>
        <p class="text-xs text-red-600">Baixa de estoque e entrega de EPI/Uniforme.</p>
    </div>
    <form action="/saida" method="POST" class="p-6 space-y-5">
        <div>
            <label class="label-pro">Selecionar Item</label>
            <div class="relative">
                <select name="item_id" class="input-pro appearance-none" required>
                    <option value="" disabled selected>Escolha...</option>
                    {% for item in itens %}
                    <option value="{{ item.id }}">{{ item.nome }} - {{ item.tamanho }} ({{ item.genero }}) | Disp: {{ item.quantidade }}</option>
                    {% endfor %}
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500"><i class="fas fa-chevron-down text-xs"></i></div>
            </div>
        </div>
        <div><label class="label-pro text-red-600">Quantidade a Retirar</label><input type="number" name="quantidade" min="1" value="1" class="input-pro font-bold text-lg text-red-600" required></div>
        <div class="grid grid-cols-2 gap-4">
            <div><label class="label-pro">Coordenador</label><input type="text" name="coordenador" class="input-pro" required></div>
            <div><label class="label-pro">Colaborador</label><input type="text" name="colaborador" class="input-pro" required></div>
        </div>
        <div><label class="label-pro">Data Entrega</label><input type="date" name="data" class="input-pro" required></div>
        <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-lg shadow-md hover:shadow-lg transition">CONFIRMAR SAÍDA</button>
    </form>
</div>
<div class="text-center mt-4"><a href="/historico/saida" class="text-xs font-bold text-red-600 hover:underline">VER HISTÓRICO DE SAÍDAS</a></div>
<style>.label-pro { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; } .input-pro { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem 1rem; color: #1e293b; font-weight: 500; outline: none; }</style>
{% endblock %}

##################################################

FILE: app/estoque/templates/estoque/selecionar_edicao.html
----------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="bg-white rounded-xl border border-slate-200 shadow-lg p-8 max-w-lg mx-auto">
    <h2 class="text-xl font-bold text-slate-800 mb-6 text-center">Gerenciar Item</h2>
    
    <form action="/gerenciar/selecao" method="POST" class="space-y-6">
        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Selecione o Item para Editar/Excluir</label>
            <div class="relative">
                <select name="item_id" class="w-full appearance-none bg-slate-50 border border-slate-200 rounded-lg px-4 py-4 text-slate-800 font-medium focus:outline-none focus:ring-2 focus:ring-blue-500" required onchange="this.form.submit()">
                    <option value="" disabled selected>Clique para selecionar...</option>
                    {% for item in itens %}
                    <option value="{{ item.id }}">{{ item.nome }} - {{ item.tamanho }} ({{ item.genero }})</option>
                    {% endfor %}
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
        </div>
        <div class="text-center">
            <a href="/" class="text-sm text-slate-400 hover:text-slate-600">Cancelar</a>
        </div>
    </form>
</div>
{% endblock %}

##################################################

FILE: app/holerites/__init__.py
-------------------------------
# Módulo holerites

##################################################

FILE: app/holerites/routes.py
-----------------------------
from flask import Blueprint, render_template, request, redirect, url_for, flash, send_file
from flask_login import login_required, current_user
from app.extensions import db
from app.models import User, Holerite
from app.utils import get_brasil_time, remove_accents
import io
from pypdf import PdfReader, PdfWriter
from sqlalchemy import text

holerite_bp = Blueprint('holerite', __name__, template_folder='templates', url_prefix='/holerites')

def encontrar_usuario_por_nome(texto_pagina):
    texto_limpo = remove_accents(texto_pagina).upper()
    users = User.query.all()
    for u in users:
        nome_limpo = remove_accents(u.real_name).upper().strip()
        if len(nome_limpo.split()) > 1 and nome_limpo in texto_limpo:
            return u
    return None

@holerite_bp.route('/admin/importar', methods=['GET', 'POST'])
@login_required
def admin_importar():
    if current_user.role != 'Master': return redirect(url_for('main.dashboard'))
    
    if request.method == 'POST':
        if request.form.get('acao') == 'limpar_tudo':
            Holerite.query.delete()
            db.session.commit()
            flash('Histórico removido.')
            return redirect(url_for('holerite.admin_importar'))

        file = request.files.get('arquivo_pdf')
        mes_ref = request.form.get('mes_ref')
        if not file or not mes_ref: return redirect(url_for('holerite.admin_importar'))
            
        try:
            reader = PdfReader(file)
            sucesso = 0
            for page in reader.pages:
                user = encontrar_usuario_por_nome(page.extract_text())
                if user:
                    writer = PdfWriter(); writer.add_page(page)
                    out = io.BytesIO(); writer.write(out)
                    
                    existente = Holerite.query.filter_by(user_id=user.id, mes_referencia=mes_ref).first()
                    if existente:
                        existente.conteudo_pdf = out.getvalue()
                        existente.enviado_em = get_brasil_time()
                        existente.visualizado = False
                    else:
                        novo = Holerite(user_id=user.id, mes_referencia=mes_ref, conteudo_pdf=out.getvalue())
                        db.session.add(novo)
                    sucesso += 1
            db.session.commit()
            flash(f'Sucesso: {sucesso} holerites processados.')
        except Exception as e:
            db.session.rollback(); flash(f'Erro: {e}')

    ultimos = Holerite.query.order_by(Holerite.enviado_em.desc()).limit(20).all()
    return render_template('holerites/admin_upload_holerite.html', uploads=ultimos)

@holerite_bp.route('/meus-documentos')
@login_required
def meus_holerites():
    docs = Holerite.query.filter_by(user_id=current_user.id).order_by(Holerite.mes_referencia.desc()).all()
    return render_template('holerites/meus_holerites.html', holerites=docs)

@holerite_bp.route('/baixar/<int:id>', methods=['GET', 'POST'])
@login_required
def baixar_holerite(id):
    doc = Holerite.query.get_or_404(id)
    if current_user.role != 'Master' and doc.user_id != current_user.id: 
        return redirect(url_for('main.dashboard'))
    
    if not doc.visualizado and current_user.id == doc.user_id:
        doc.visualizado = True
        doc.visualizado_em = get_brasil_time()
        db.session.commit()
        
    return send_file(
        io.BytesIO(doc.conteudo_pdf),
        mimetype='application/pdf',
        as_attachment=True,
        download_name=f"Holerite_{doc.mes_referencia}.pdf"
    )

##################################################

FILE: app/holerites/templates/holerites/admin_upload_holerite.html
------------------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-6 flex justify-between items-center">
        <div><h2 class="text-2xl font-bold text-slate-800">Importação de Holerites</h2><p class="text-sm text-slate-500">Envie o PDF da folha.</p></div>
        <form action="/holerites/admin/importar" method="POST" onsubmit="return confirm('Apagar histórico?')"><input type="hidden" name="acao" value="limpar_tudo"><button type="submit" class="text-xs text-red-500 hover:text-red-700 underline font-bold">Limpar Histórico</button></form>
    </div>

    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-8 mb-8">
        <form action="/holerites/admin/importar" method="POST" enctype="multipart/form-data" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><label class="label-pro">Mês de Referência</label><input type="month" name="mes_ref" class="input-pro" required></div>
                <div><label class="label-pro">Arquivo PDF</label><input type="file" name="arquivo_pdf" accept=".pdf" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required></div>
            </div>
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-md transition flex items-center justify-center gap-2" onclick="this.innerHTML='<i class=\'fas fa-spinner fa-spin\'></i> Processando...';"><i class="fas fa-cloud-upload-alt"></i> PROCESSAR E DISTRIBUIR</button>
        </form>
    </div>

    <h3 class="text-lg font-bold text-slate-700 mb-4 px-2">Últimos Envios</h3>
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-slate-600">
                <thead class="bg-slate-50 text-xs uppercase text-slate-400 font-bold border-b border-slate-100">
                    <tr><th class="px-6 py-3">Funcionário</th><th class="px-6 py-3">Referência</th><th class="px-6 py-3 text-center">Status</th><th class="px-6 py-3 text-right">Ação</th></tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    {% for item in uploads %}
                    <tr class="hover:bg-slate-50 transition">
                        <td class="px-6 py-3 font-bold text-slate-800">{{ item.user.real_name }}</td>
                        <td class="px-6 py-3">{{ item.mes_referencia }}</td>
                        <td class="px-6 py-3 text-center">{% if item.visualizado %}<span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-[10px] font-bold uppercase">Lido</span>{% else %}<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-[10px] font-bold uppercase">Pendente</span>{% endif %}</td>
                        <td class="px-6 py-3 text-right">
                            <a href="/holerites/baixar/{{ item.id }}" target="_blank" class="text-blue-600 hover:underline text-xs font-bold"><i class="fas fa-download"></i> Baixar</a>
                        </td>
                    </tr>
                    {% else %}<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400">Nenhum envio recente.</td></tr>{% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<style>.label-pro { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem; } .input-pro { width: 100%; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem 1rem; outline: none; }</style>
{% endblock %}

##################################################

FILE: app/holerites/templates/holerites/meus_holerites.html
-----------------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6"><h2 class="text-2xl font-bold text-slate-800">Meus Holerites</h2></div>
<div class="grid gap-4">
    {% for h in holerites %}
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-lg flex items-center justify-center text-2xl {% if h.visualizado %} bg-emerald-100 text-emerald-600 {% else %} bg-blue-100 text-blue-600 {% endif %}"><i class="fas fa-file-invoice-dollar"></i></div>
            <div>
                <div class="font-bold text-slate-800 text-lg">{{ h.mes_referencia }}</div>
                <div class="text-xs text-slate-500">{% if h.visualizado %}<span class="text-emerald-600 font-bold"><i class="fas fa-check"></i> Recebido: {{ h.visualizado_em.strftime('%d/%m/%Y %H:%M') }}</span>{% else %}<span class="text-blue-600 font-bold">Pendente de Assinatura</span>{% endif %}</div>
            </div>
        </div>
        <!-- Form aponta para a rota de download direta -->
        <form action="/holerites/baixar/{{ h.id }}" method="POST">
            <button type="submit" class="px-4 py-2 rounded-lg font-bold text-sm transition shadow-sm border {% if h.visualizado %} bg-white text-slate-600 border-slate-200 hover:bg-slate-50 {% else %} bg-blue-600 text-white border-blue-600 hover:bg-blue-700 animate-pulse {% endif %}">
                {% if h.visualizado %} <i class="fas fa-download mr-1"></i> Baixar PDF {% else %} <i class="fas fa-pen-nib mr-1"></i> Confirmar e Baixar {% endif %}
            </button>
        </form>
    </div>
    {% else %}
    <div class="text-center py-12 text-slate-400"><i class="fas fa-folder-open text-4xl mb-4 opacity-50"></i><p>Nenhum documento disponível.</p></div>
    {% endfor %}
</div>
{% endblock %}

##################################################

FILE: app/main/__init__.py
--------------------------
# Módulo main

##################################################

FILE: app/main/routes.py
------------------------
from flask import Blueprint, render_template
from flask_login import login_required, current_user
from app.models import PontoRegistro, ItemEstoque, PontoResumo
from app.utils import get_brasil_time
from sqlalchemy import func, extract

main_bp = Blueprint('main', __name__, template_folder='templates')

@main_bp.route('/')
@login_required
def dashboard():
    hoje = get_brasil_time()
    hoje_date = hoje.date()
    
    # Lógica Padrão
    pontos = PontoRegistro.query.filter_by(user_id=current_user.id, data_registro=hoje_date).count()
    status = "Não Iniciado"
    if pontos == 1: status = "Trabalhando"
    elif pontos == 2: status = "Almoço"
    elif pontos == 3: status = "Trabalhando (Tarde)"
    elif pontos >= 4: status = "Dia Finalizado"

    # Lógica Master (Gráficos)
    dados_graficos = None
    
    if current_user.role == 'Master':
        estoque_critico = ItemEstoque.query.filter(
            ItemEstoque.quantidade <= ItemEstoque.estoque_minimo
        ).order_by(ItemEstoque.quantidade).limit(5).all()
        
        resumos_mes = db_resumos_mes(hoje.year, hoje.month)
        
        dados_graficos = {
            'estoque_labels': [i.nome for i in estoque_critico],
            'estoque_data': [i.quantidade for i in estoque_critico],
            'ponto_status': resumos_mes
        }

    return render_template('main/dashboard.html', status_ponto=status, dados_graficos=dados_graficos)

def db_resumos_mes(ano, mes):
    stats = PontoResumo.query.with_entities(
        PontoResumo.status_dia, func.count(PontoResumo.id)
    ).filter(
        extract('year', PontoResumo.data_referencia) == ano,
        extract('month', PontoResumo.data_referencia) == mes
    ).group_by(PontoResumo.status_dia).all()
    
    resultado = {'OK': 0, 'Falta': 0, 'Incompleto': 0, 'Hora Extra': 0, 'Débito': 0}
    for s, qtd in stats:
        if s in resultado:
            resultado[s] = qtd
        else:
            resultado['Incompleto'] += qtd
            
    return resultado


##################################################

FILE: app/main/templates/main/dashboard.html
--------------------------------------------
{% extends 'base.html' %}
{% block content %}

<!-- Widget de Ponto -->
<div class="bg-gradient-to-r from-blue-900 to-slate-900 rounded-2xl p-6 text-white shadow-xl mb-8 flex justify-between items-center relative overflow-hidden transition transform hover:scale-[1.01]">
    <div class="absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
    <div>
        <p class="text-xs font-bold text-blue-300 uppercase tracking-widest mb-1">Status Hoje</p>
        <h2 class="text-2xl font-bold mb-1">{{ status_ponto }}</h2>
        <p class="text-xs opacity-70">{{ current_user.real_name }}</p>
    </div>
    <a href="/ponto/registrar" class="bg-white text-blue-900 hover:bg-blue-50 font-bold py-3 px-6 rounded-full shadow-lg transition transform hover:scale-105 flex items-center gap-2 z-10">
        <i class="fas fa-fingerprint"></i> <span>REGISTRAR</span>
    </a>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition">
        <h3 class="font-bold text-slate-700 mb-2"><i class="fas fa-bolt text-yellow-500 mr-2"></i>Acesso Rápido</h3>
        <div class="flex flex-col gap-2 mt-4">
             <a href="/ponto/espelho" class="text-sm text-slate-600 hover:text-blue-600 flex items-center gap-2"><i class="fas fa-calendar-alt w-5"></i> Ver meu Espelho</a>
             <a href="/holerites/meus-documentos" class="text-sm text-slate-600 hover:text-blue-600 flex items-center gap-2"><i class="fas fa-file-invoice w-5"></i> Meus Holerites</a>
             <a href="/ponto/solicitar-ajuste" class="text-sm text-slate-600 hover:text-blue-600 flex items-center gap-2"><i class="fas fa-exclamation-circle w-5"></i> Ajustar Ponto</a>
        </div>
    </div>
    
    {% if current_user.role != 'Master' %}
    <div class="bg-blue-50 p-6 rounded-xl border border-blue-100 shadow-sm flex items-center justify-center text-center">
        <div>
            <div class="text-blue-200 text-4xl mb-2"><i class="fas fa-quote-left"></i></div>
            <p class="text-blue-800 font-medium italic text-sm">"O sucesso é a soma de pequenos esforços repetidos dia após dia."</p>
        </div>
    </div>
    {% endif %}

    {% if current_user.role == 'Master' %}
    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-purple-500 hover:shadow-md transition">
        <h3 class="font-bold text-slate-700 mb-2"><i class="fas fa-crown text-purple-500 mr-2"></i>Área Master</h3>
        <div class="grid grid-cols-2 gap-2 mt-4">
            <a href="/admin/usuarios" class="bg-slate-50 hover:bg-slate-100 p-2 rounded text-center text-xs font-bold text-slate-600 border border-slate-200">Funcionários</a>
            <a href="/admin/solicitacoes" class="bg-slate-50 hover:bg-slate-100 p-2 rounded text-center text-xs font-bold text-slate-600 border border-slate-200">Solicitações</a>
        </div>
    </div>
    {% endif %}
</div>

<!-- GRÁFICOS MASTER -->
{% if current_user.role == 'Master' and dados_graficos %}
<h3 class="text-lg font-bold text-slate-800 mb-4 px-2">Visão Geral</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
    <!-- Gráfico 1 -->
    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
        <h4 class="text-xs font-bold text-red-500 uppercase mb-4">Estoque Crítico</h4>
        {% if dados_graficos.estoque_labels %}
            <canvas id="chartEstoque"></canvas>
        {% else %}
            <div class="h-40 flex items-center justify-center text-slate-400 text-sm">Estoque saudável.</div>
        {% endif %}
    </div>

    <!-- Gráfico 2 -->
    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
        <h4 class="text-xs font-bold text-blue-500 uppercase mb-4">Pontualidade (Mês)</h4>
        <div class="h-48">
            <canvas id="chartPonto"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    {% if dados_graficos.estoque_labels %}
    const ctxEstoque = document.getElementById('chartEstoque');
    new Chart(ctxEstoque, {
        type: 'bar',
        data: {
            labels: {{ dados_graficos.estoque_labels | tojson }},
            datasets: [{
                label: 'Qtd Atual',
                data: {{ dados_graficos.estoque_data | tojson }},
                backgroundColor: '#ef4444',
                borderRadius: 4
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
    {% endif %}

    const ctxPonto = document.getElementById('chartPonto');
    const dadosPonto = {{ dados_graficos.ponto_status | tojson }};
    new Chart(ctxPonto, {
        type: 'doughnut',
        data: {
            labels: ['OK', 'Falta', 'Hora Extra', 'Débito'],
            datasets: [{
                data: [dadosPonto['OK'], dadosPonto['Falta'], dadosPonto['Hora Extra'], dadosPonto['Débito']],
                backgroundColor: ['#10b981', '#ef4444', '#3b82f6', '#f59e0b'],
                borderWidth: 0
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } } }
    });
</script>
{% endif %}

{% endblock %}


##################################################

FILE: app/models/__init__.py
----------------------------
from app.extensions import db, login_manager
# O conteúdo original de models.py será anexado aqui

from app.extensions import db, login_manager
from flask_login import UserMixin
from werkzeug.security import generate_password_hash, check_password_hash
from datetime import datetime, timedelta

def get_brasil_time():
    return datetime.utcnow() - timedelta(hours=3)

@login_manager.user_loader
def load_user(user_id):
    return User.query.get(int(user_id))

class User(UserMixin, db.Model):
    __tablename__ = 'users'
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(50), unique=True, nullable=False)
    password_hash = db.Column(db.String(256), nullable=False)
    real_name = db.Column(db.String(100))
    role = db.Column(db.String(50)) 
    cpf = db.Column(db.String(14), unique=True, nullable=True)
    is_first_access = db.Column(db.Boolean, default=True)
    created_at = db.Column(db.DateTime, default=get_brasil_time)
    
    horario_entrada = db.Column(db.String(5), default='07:12')
    horario_almoco_inicio = db.Column(db.String(5), default='12:00')
    horario_almoco_fim = db.Column(db.String(5), default='13:00')
    horario_saida = db.Column(db.String(5), default='17:00')
    salario = db.Column(db.Float, default=2000.00)
    escala = db.Column(db.String(20), default='Livre')
    data_inicio_escala = db.Column(db.Date, nullable=True)

    def set_password(self, password): self.password_hash = generate_password_hash(password)
    def check_password(self, password): return check_password_hash(self.password_hash, password)

class PreCadastro(db.Model):
    __tablename__ = 'pre_cadastros'
    id = db.Column(db.Integer, primary_key=True)
    cpf = db.Column(db.String(14), unique=True, nullable=False)
    nome_previsto = db.Column(db.String(100))
    cargo = db.Column(db.String(50), default='Colaborador')
    salario = db.Column(db.Float, default=2000.00)
    horario_entrada = db.Column(db.String(5), default='07:12')
    horario_almoco_inicio = db.Column(db.String(5), default='12:00')
    horario_almoco_fim = db.Column(db.String(5), default='13:00')
    horario_saida = db.Column(db.String(5), default='17:00')
    escala = db.Column(db.String(20), default='Livre')
    data_inicio_escala = db.Column(db.Date, nullable=True)
    criado_em = db.Column(db.DateTime, default=get_brasil_time)

class PontoRegistro(db.Model):
    __tablename__ = 'ponto_registros'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    data_registro = db.Column(db.Date, default=get_brasil_time)
    hora_registro = db.Column(db.Time, default=lambda: get_brasil_time().time())
    tipo = db.Column(db.String(20))
    latitude = db.Column(db.String(50)); longitude = db.Column(db.String(50))
    user = db.relationship('User', backref=db.backref('pontos', lazy=True))

class PontoResumo(db.Model):
    __tablename__ = 'ponto_resumos'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    data_referencia = db.Column(db.Date, nullable=False)
    minutos_trabalhados = db.Column(db.Integer, default=0)
    minutos_esperados = db.Column(db.Integer, default=0)
    minutos_saldo = db.Column(db.Integer, default=0)
    status_dia = db.Column(db.String(50))
    user = db.relationship('User', backref=db.backref('resumos', lazy=True))

class PontoAjuste(db.Model):
    __tablename__ = 'ponto_ajustes'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    data_referencia = db.Column(db.Date, nullable=False)
    ponto_original_id = db.Column(db.Integer, nullable=True)
    novo_horario = db.Column(db.String(5), nullable=True)
    tipo_batida = db.Column(db.String(20), nullable=False)
    tipo_solicitacao = db.Column(db.String(20), default='Edicao')
    justificativa = db.Column(db.String(255))
    status = db.Column(db.String(20), default='Pendente')
    motivo_reprovacao = db.Column(db.String(255))
    created_at = db.Column(db.DateTime, default=get_brasil_time)
    user = db.relationship('User', backref=db.backref('ajustes', lazy=True))

class ItemEstoque(db.Model):
    __tablename__ = 'itens_estoque'
    id = db.Column(db.Integer, primary_key=True)
    nome = db.Column(db.String(100), nullable=False)
    categoria = db.Column(db.String(50), default='Uniforme')
    tamanho = db.Column(db.String(10)); genero = db.Column(db.String(20)) 
    quantidade = db.Column(db.Integer, default=0)
    estoque_minimo = db.Column(db.Integer, default=5); estoque_ideal = db.Column(db.Integer, default=20)
    data_atualizacao = db.Column(db.DateTime, default=get_brasil_time)

class HistoricoEntrada(db.Model):
    __tablename__ = 'historico_entrada'
    id = db.Column(db.Integer, primary_key=True)
    item_nome = db.Column(db.String(150)); quantidade = db.Column(db.Integer)
    data_hora = db.Column(db.DateTime, default=get_brasil_time)

class HistoricoSaida(db.Model):
    __tablename__ = 'historico_saida'
    id = db.Column(db.Integer, primary_key=True)
    coordenador = db.Column(db.String(100)); colaborador = db.Column(db.String(100))
    item_nome = db.Column(db.String(100)); tamanho = db.Column(db.String(10))
    genero = db.Column(db.String(20)); quantidade = db.Column(db.Integer)
    data_entrega = db.Column(db.DateTime, default=get_brasil_time)

class Holerite(db.Model):
    __tablename__ = 'holerites'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    mes_referencia = db.Column(db.String(7), nullable=False) 
    url_arquivo = db.Column(db.String(500), nullable=True) # Agora aceita nulo no Python
    conteudo_pdf = db.Column(db.LargeBinary, nullable=True) 
    visualizado = db.Column(db.Boolean, default=False)
    visualizado_em = db.Column(db.DateTime, nullable=True)
    enviado_em = db.Column(db.DateTime, default=get_brasil_time)
    user = db.relationship('User', backref=db.backref('holerites', lazy=True))

##################################################

FILE: app/ponto/__init__.py
---------------------------
# Módulo ponto

##################################################

FILE: app/ponto/routes.py
-------------------------
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required, current_user
from app.extensions import db
from app.models import PontoRegistro, PontoResumo, User, PontoAjuste
from app.utils import get_brasil_time, calcular_dia, format_minutes_to_hm
from datetime import datetime, date
from sqlalchemy import func

ponto_bp = Blueprint('ponto', __name__, template_folder='templates', url_prefix='/ponto')

@ponto_bp.route('/registrar', methods=['GET', 'POST'])
@login_required
def registrar_ponto():
    hoje = get_brasil_time().date()
    if request.method == 'POST':
        tipo = request.form.get('tipo')
        lat = request.form.get('lat')
        lon = request.form.get('lon')
        
        # Validação simples
        if not tipo:
            flash('Selecione um tipo de registro.', 'error')
            return redirect(url_for('ponto.registrar_ponto'))

        novo = PontoRegistro(
            user_id=current_user.id, 
            data_registro=hoje, 
            tipo=tipo, 
            latitude=lat, 
            longitude=lon
        )
        db.session.add(novo)
        try:
            db.session.commit()
            calcular_dia(current_user.id, hoje)
            flash(f'Ponto de {tipo} registrado com sucesso!', 'success')
        except Exception as e:
            db.session.rollback()
            flash(f'Erro ao registrar: {str(e)}', 'error')
            
        return redirect(url_for('main.dashboard'))
    
    # Busca histórico do dia para exibir
    registros = PontoRegistro.query.filter_by(user_id=current_user.id, data_registro=hoje).order_by(PontoRegistro.hora_registro).all()
    return render_template('ponto/registro.html', registros=registros)

@ponto_bp.route('/espelho')
@login_required
def espelho_ponto():
    target_user_id = request.args.get('user_id', type=int) or current_user.id
    if target_user_id != current_user.id and current_user.role != 'Master':
        return redirect(url_for('main.dashboard'))
    
    user = User.query.get_or_404(target_user_id)
    mes_ref = request.args.get('mes_ref') or get_brasil_time().strftime('%Y-%m')
    try:
        ano, mes = map(int, mes_ref.split('-'))
    except:
        hoje = get_brasil_time()
        ano, mes = hoje.year, hoje.month
        mes_ref = hoje.strftime('%Y-%m')
    
    resumos = PontoResumo.query.filter(
        PontoResumo.user_id == target_user_id,
        func.extract('year', PontoResumo.data_referencia) == ano,
        func.extract('month', PontoResumo.data_referencia) == mes
    ).order_by(PontoResumo.data_referencia).all()
    
    detalhes = {}
    for r in resumos:
        batidas = PontoRegistro.query.filter_by(user_id=target_user_id, data_registro=r.data_referencia).order_by(PontoRegistro.hora_registro).all()
        detalhes[r.id] = [b.hora_registro.strftime('%H:%M') for b in batidas]

    # Dicionário de Tradução dos Dias (Fix para idioma Inglês no Server)
    dias_semana = {0: 'Seg', 1: 'Ter', 2: 'Qua', 3: 'Qui', 4: 'Sex', 5: 'Sáb', 6: 'Dom'}

    return render_template('ponto/ponto_espelho.html', 
                         resumos=resumos, 
                         user=user, 
                         detalhes=detalhes, 
                         format_hm=format_minutes_to_hm, 
                         mes_ref=mes_ref,
                         dias_semana=dias_semana)

@ponto_bp.route('/solicitar-ajuste', methods=['GET', 'POST'])
@login_required
def solicitar_ajuste():
    data_sel = None
    pontos = []
    
    if request.method == 'POST':
        acao = request.form.get('acao')
        
        if acao == 'buscar':
            data_busca = request.form.get('data_busca')
            if data_busca:
                try:
                    data_sel = datetime.strptime(data_busca, '%Y-%m-%d').date()
                    pontos = PontoRegistro.query.filter_by(user_id=current_user.id, data_registro=data_sel).order_by(PontoRegistro.hora_registro).all()
                except:
                    flash('Data inválida.', 'error')
        
        elif acao == 'enviar':
            try:
                # Logica simplificada de ajuste (expansível)
                ajuste = PontoAjuste(
                    user_id=current_user.id,
                    data_referencia=request.form.get('data_ref'),
                    ponto_original_id=request.form.get('ponto_id') or None,
                    novo_horario=request.form.get('novo_horario'),
                    tipo_batida=request.form.get('tipo_batida'),
                    tipo_solicitacao=request.form.get('tipo_solicitacao'),
                    justificativa=request.form.get('justificativa')
                )
                db.session.add(ajuste)
                db.session.commit()
                flash('Solicitação enviada!', 'success')
                return redirect(url_for('ponto.solicitar_ajuste'))
            except Exception as e:
                db.session.rollback()
                flash(f'Erro: {e}', 'error')

    # Histórico de Ajustes
    meus_ajustes = PontoAjuste.query.filter_by(user_id=current_user.id).order_by(PontoAjuste.created_at.desc()).limit(10).all()
    extras = {}
    for a in meus_ajustes:
        if a.ponto_original_id:
            p = PontoRegistro.query.get(a.ponto_original_id)
            if p: extras[a.id] = f"{p.hora_registro.strftime('%H:%M')} ({p.tipo})"
    
    return render_template('ponto/solicitar_ajuste.html', 
                         data_sel=data_sel, 
                         pontos=pontos, 
                         meus_ajustes=meus_ajustes, 
                         extras=extras)


##################################################

FILE: app/ponto/templates/ponto/ponto_espelho.html
--------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6 flex justify-between items-center">
    <div>
        <h2 class="text-2xl font-bold text-slate-800">Espelho de Ponto</h2>
        <p class="text-sm text-slate-500">Colaborador: <span class="font-bold text-slate-700">{{ user.real_name }}</span></p>
    </div>
    <div class="text-right">
        <span class="text-xs font-bold text-slate-400 uppercase">Período</span>
        <div class="font-bold text-slate-700">{{ mes_ref }}</div>
    </div>
</div>

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-left text-sm">
            <thead class="bg-slate-50 text-slate-400 font-bold text-xs uppercase border-b border-slate-100">
                <tr>
                    <th class="px-4 py-4">Data</th>
                    <th class="px-4 py-4">Batidas Realizadas</th>
                    <th class="px-4 py-4 text-center">Trabalhado</th>
                    <th class="px-4 py-4 text-center">Saldo</th>
                    <th class="px-4 py-4 text-right">Status</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
                {% for r in resumos %}
                <tr class="hover:bg-slate-50 transition cursor-help" onclick="toggleDetails('det-{{ r.id }}')">
                    <!-- DATA TRADUZIDA AQUI -->
                    <td class="px-4 py-4 font-medium text-slate-700">
                        {{ r.data_referencia.strftime('%d/%m') }} 
                        <span class="text-slate-400 text-xs uppercase ml-1">
                            ({{ dias_semana[r.data_referencia.weekday()] }})
                        </span>
                    </td>
                    <td class="px-4 py-4">
                        <div class="flex flex-wrap gap-1">
                            {% for b in detalhes[r.id] %}
                            <span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded text-[10px] font-bold border border-slate-200">{{ b }}</span>
                            {% endfor %}
                        </div>
                    </td>
                    <td class="px-4 py-4 text-center font-mono">{{ format_hm(r.minutos_trabalhados) }}</td>
                    <td class="px-4 py-4 text-center font-mono font-bold {% if r.minutos_saldo >= 0 %} text-emerald-600 {% else %} text-red-500 {% endif %}">
                        {{ format_hm(r.minutos_saldo) }}
                    </td>
                    <td class="px-4 py-4 text-right">
                        <span class="text-[10px] font-bold uppercase px-2 py-1 rounded-full 
                            {% if r.status_dia == 'OK' %} bg-emerald-50 text-emerald-600 
                            {% elif r.status_dia == 'Incompleto' %} bg-amber-50 text-amber-600 
                            {% elif r.status_dia == 'Falta' %} bg-red-50 text-red-600 
                            {% else %} bg-blue-50 text-blue-600 {% endif %}">
                            {{ r.status_dia }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<div class="mt-4 text-center text-xs text-slate-400">
    <i class="fas fa-info-circle mr-1"></i> Batidas ímpares são marcadas como "Incompleto" e não somam horas.
</div>
{% endblock %}


##################################################

FILE: app/ponto/templates/ponto/registro.html
---------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-md mx-auto text-center">
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-slate-800">Registrar Ponto</h2>
        <p class="text-sm text-slate-500">Confirme sua localização.</p>
    </div>

    {% if bloqueado %}
    <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-r-xl shadow-md text-left mb-8">
        <h3 class="text-lg font-bold text-red-700 flex items-center gap-2"><i class="fas fa-ban"></i> AÇÃO BLOQUEADA</h3>
        <p class="text-sm text-red-600 mt-2">{{ motivo }}</p>
    </div>
    {% else %}
    <div class="bg-slate-900 text-white rounded-2xl p-8 shadow-2xl mb-8 border border-slate-700 relative overflow-hidden">
        <div class="text-5xl font-mono font-bold tracking-widest mb-2" id="relogio">--:--:--</div>
        <div class="text-sm text-slate-400 uppercase tracking-widest" id="data-hoje">...</div>
        <div class="mt-6 inline-block bg-blue-600 text-xs font-bold px-4 py-1 rounded-full uppercase tracking-wide shadow-lg animate-pulse">
            Localizando...
        </div>
    </div>
    
    <form action="/ponto/registrar" method="POST" id="formPonto">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <input type="hidden" name="tipo" id="inputTipo">
        <input type="hidden" name="lat" id="lat">
        <input type="hidden" name="lon" id="lon">
        
        <div class="grid grid-cols-2 gap-4 mb-4">
            <button type="button" onclick="submitPonto('Entrada')" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95">
                <i class="fas fa-sign-in-alt mb-1 block text-2xl"></i> ENTRADA
            </button>
            <button type="button" onclick="submitPonto('Saída')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95">
                <i class="fas fa-sign-out-alt mb-1 block text-2xl"></i> SAÍDA
            </button>
            <button type="button" onclick="submitPonto('Ida Almoço')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95">
                <i class="fas fa-utensils mb-1 block text-2xl"></i> IDA ALMOÇO
            </button>
            <button type="button" onclick="submitPonto('Volta Almoço')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95">
                <i class="fas fa-undo mb-1 block text-2xl"></i> VOLTA ALMOÇO
            </button>
        </div>
        <p id="geoStatus" class="text-xs text-slate-400 mt-2 h-4"></p>
    </form>
    {% endif %}

    <div class="mt-8 text-left">
        <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 ml-1">Histórico de Hoje</h3>
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden divide-y divide-slate-100">
            {% for p in registros %}
            <div class="px-4 py-3 flex justify-between items-center hover:bg-slate-50 transition">
                <span class="text-sm font-bold text-slate-700 flex items-center gap-2">
                    <!-- FIX: Verifica se p.tipo existe antes de verificar 'in' -->
                    <i class="fas fa-circle text-[8px] {% if p.tipo and ('Entrada' in p.tipo or 'Volta' in p.tipo) %}text-emerald-500{% else %}text-red-500{% endif %}"></i>
                    {{ p.tipo or 'N/A' }}
                </span>
                <span class="text-sm font-mono text-slate-500 font-bold bg-slate-100 px-2 py-1 rounded">
                    {% if p.hora_registro %}{{ p.hora_registro.strftime('%H:%M') }}{% else %}--:--{% endif %}
                </span>
            </div>
            {% else %}
            <div class="p-6 text-center text-xs text-slate-400 flex flex-col items-center">
                <i class="fas fa-clock text-2xl mb-2 opacity-30"></i>
                Nenhum registro hoje.
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    function updateTime() { 
        const now = new Date();
        document.getElementById('relogio').innerText = now.toLocaleTimeString('pt-BR'); 
        document.getElementById('data-hoje').innerText = now.toLocaleDateString('pt-BR', {weekday: 'long', day: 'numeric', month: 'long'});
    }
    setInterval(updateTime, 1000); updateTime();

    function submitPonto(tipo) {
        const btn = event.currentTarget;
        const st = document.getElementById('geoStatus');
        const form = document.getElementById('formPonto');
        document.getElementById('inputTipo').value = tipo;
        
        const btns = document.querySelectorAll('button');
        btns.forEach(b => b.disabled = true);
        st.innerText = "Obtendo localização GPS...";
        st.className = "text-xs text-blue-500 mt-2 h-4 animate-pulse font-bold";

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (p) => { 
                    document.getElementById('lat').value = p.coords.latitude; 
                    document.getElementById('lon').value = p.coords.longitude; 
                    st.innerText = "Localização obtida! Enviando...";
                    st.className = "text-xs text-emerald-600 mt-2 h-4 font-bold";
                    form.submit(); 
                },
                (e) => { 
                    alert("Erro GPS: " + e.message); 
                    st.innerText = "Erro no GPS.";
                    st.className = "text-xs text-red-500 mt-2 h-4";
                    btns.forEach(b => b.disabled = false);
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        } else {
            alert("Sem suporte GPS.");
            btns.forEach(b => b.disabled = false);
        }
    }
</script>
{% endblock %}


##################################################

FILE: app/ponto/templates/ponto/solicitar_ajuste.html
-----------------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="mb-6"><h2 class="text-xl font-bold text-slate-800">Solicitar Ajuste</h2><p class="text-sm text-slate-500">Gestão de ponto.</p></div>

    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 mb-6">
        <form action="/ponto/solicitar-ajuste" method="POST" class="flex gap-4 items-end">
            <!-- TOKEN CSRF INJETADO -->
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <div class="flex-1">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Data do Ponto</label>
                <input type="date" name="data_busca" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3" required>
            </div>
            <button type="submit" name="acao" value="buscar" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow hover:bg-blue-700 transition"><i class="fas fa-search"></i></button>
        </form>
    </div>

    {% if data_sel %}
    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 mb-8 animate-fade-in">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="font-bold text-slate-800">Registros em {{ data_sel.strftime('%d/%m/%Y') }}</h3>
            <button onclick="abrirInclusao()" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1 rounded font-bold transition"><i class="fas fa-plus mr-1"></i> ADICIONAR NOVO</button>
        </div>
        <div class="space-y-2 mb-6">
            {% for p in pontos %}
            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                <div><span class="text-xs font-bold text-slate-500 block">{{ p.tipo }}</span><span class="font-mono font-bold text-slate-800">{{ p.hora_registro.strftime('%H:%M') }}</span></div>
                <div class="flex gap-2">
                    <button onclick="abrirEdicao('{{ p.id }}', '{{ p.hora_registro.strftime('%H:%M') }}', '{{ p.tipo }}')" class="text-[10px] bg-blue-50 text-blue-600 font-bold px-2 py-1 rounded hover:bg-blue-100">EDITAR</button>
                    <button onclick="abrirExclusao('{{ p.id }}', '{{ p.hora_registro.strftime('%H:%M') }}')" class="text-[10px] bg-red-50 text-red-600 font-bold px-2 py-1 rounded hover:bg-red-100">EXCLUIR</button>
                </div>
            </div>
            {% else %}<p class="text-xs text-slate-400 italic">Sem registros neste dia.</p>{% endfor %}
        </div>

        <div id="formContainer" class="hidden bg-slate-50 p-4 rounded-xl border border-blue-200 shadow-inner">
            <h3 class="font-bold text-blue-700 mb-4 text-sm uppercase" id="formTitle">Detalhes</h3>
            <form action="/ponto/solicitar-ajuste" method="POST" class="space-y-4">
                <!-- TOKEN CSRF INJETADO -->
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                
                <input type="hidden" name="acao" value="enviar">
                <input type="hidden" name="data_ref" value="{{ data_sel }}">
                <input type="hidden" name="ponto_id" id="form_ponto_id"> 
                <input type="hidden" name="tipo_solicitacao" id="form_tipo_solic"> 
                <div class="grid grid-cols-2 gap-4" id="divHorarioTipo">
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Horário</label><input type="time" name="novo_horario" id="form_horario" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-2 font-mono"></div>
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Tipo</label><select name="tipo_batida" id="form_tipo" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-2 text-sm"><option value="Entrada">Entrada</option><option value="Ida Almoço">Ida Almoço</option><option value="Volta Almoço">Volta Almoço</option><option value="Saída">Saída</option></select></div>
                </div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Justificativa</label><textarea name="justificativa" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-2 text-sm" rows="2" required></textarea></div>
                <div class="flex gap-2"><button type="button" onclick="fecharForm()" class="flex-1 bg-slate-200 text-slate-600 font-bold py-2 rounded-lg text-xs">CANCELAR</button><button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg shadow text-xs">ENVIAR</button></div>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="mt-8">
        <h3 class="font-bold text-slate-700 text-sm mb-4 border-b pb-2">Meus Pedidos Recentes</h3>
        <div class="space-y-3">
            {% for req in meus_ajustes %}
            <div class="bg-white border border-slate-200 rounded-lg p-4 shadow-sm relative pl-4 border-l-4 {% if req.status == 'Aprovado' %} border-l-emerald-500 {% elif req.status == 'Reprovado' %} border-l-red-500 {% else %} border-l-yellow-500 {% endif %}">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-[10px] font-bold uppercase text-slate-400">{{ req.data_referencia.strftime('%d/%m') }} - {{ req.tipo_solicitacao }}</span>
                    <span class="text-[10px] font-bold uppercase px-2 py-0.5 rounded {% if req.status == 'Pendente' %} bg-yellow-100 text-yellow-700 {% elif req.status == 'Aprovado' %} bg-emerald-100 text-emerald-700 {% else %} bg-red-100 text-red-700 {% endif %}">{{ req.status }}</span>
                </div>
                
                <div class="grid grid-cols-2 gap-2 text-xs mb-2 bg-slate-50 p-2 rounded">
                    <div><span class="block text-slate-400">Horário Antigo</span><strong class="font-mono text-slate-600">{{ extras.get(req.id, '-') }}</strong></div>
                    <div><span class="block text-slate-400">Horário Novo</span><strong class="font-mono text-blue-600">{% if req.novo_horario %}{{ req.novo_horario }} ({{ req.tipo_batida }}){% else %} - {% endif %}</strong></div>
                </div>

                <div class="text-xs text-slate-500 italic mb-2">Justificativa: "{{ req.justificativa }}"</div>
                {% if req.status == 'Reprovado' %}<div class="bg-red-50 p-2 rounded border border-red-100 text-xs text-red-700"><strong>Devolutiva:</strong> {{ req.motivo_reprovacao }}</div>{% endif %}
            </div>
            {% else %}<p class="text-center text-xs text-slate-400 py-4">Nenhum pedido recente.</p>{% endfor %}
        </div>
    </div>
</div>
<script>
    function abrirInclusao() { resetForm(); document.getElementById('formTitle').innerText = "INCLUIR"; document.getElementById('form_tipo_solic').value = "Inclusao"; document.getElementById('formContainer').classList.remove('hidden'); }
    function abrirEdicao(id, hora, tipo) { resetForm(); document.getElementById('formTitle').innerText = "EDITAR"; document.getElementById('form_ponto_id').value = id; document.getElementById('form_horario').value = hora; document.getElementById('form_tipo').value = tipo; document.getElementById('form_tipo_solic').value = "Edicao"; document.getElementById('formContainer').classList.remove('hidden'); }
    function abrirExclusao(id, hora) { resetForm(); document.getElementById('formTitle').innerText = "EXCLUIR"; document.getElementById('form_ponto_id').value = id; document.getElementById('form_tipo_solic').value = "Exclusao"; document.getElementById('divHorarioTipo').classList.add('hidden'); document.getElementById('formContainer').classList.remove('hidden'); }
    function resetForm() { document.getElementById('form_ponto_id').value = ""; document.getElementById('form_horario').value = ""; document.getElementById('divHorarioTipo').classList.remove('hidden'); }
    function fecharForm() { document.getElementById('formContainer').classList.add('hidden'); }
</script>
{% endblock %}


##################################################

FILE: app/routes/__init__.py
----------------------------


##################################################

FILE: app/static/css/style.css
------------------------------
/* Estilos Globais do Thay-RH */

/* Componentes de Formulário (Extraídos dos templates) */
.label-pro { 
    display: block; 
    font-size: 0.7rem; 
    font-weight: 700; 
    color: #64748b; 
    text-transform: uppercase; 
    margin-bottom: 0.5rem; 
    letter-spacing: 0.05em;
} 

.input-pro { 
    width: 100%; 
    background-color: #f8fafc; 
    border: 1px solid #e2e8f0; 
    border-radius: 0.5rem; 
    padding: 0.75rem 1rem; 
    color: #1e293b; 
    font-weight: 500; 
    outline: none; 
    transition: all 0.2s;
}

.input-pro:focus {
    background-color: #ffffff;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Utilitários de Animação */
.animate-fade-in { 
    animation: fadeIn 0.5s ease-out; 
}

@keyframes fadeIn { 
    from { opacity: 0; transform: translateY(10px); } 
    to { opacity: 1; transform: translateY(0); } 
}


##################################################

FILE: app/templates/base.html
-----------------------------
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shahin Gestão</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Toastify CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    
    
    <script>
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('overlay');
            if (sb.classList.contains('-translate-x-full')) { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); }
            else { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }
        }
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg-slate-50 text-slate-800">
    {% if current_user.is_authenticated and not current_user.is_first_access %}
    <div class="md:hidden bg-white border-b border-slate-200 p-4 flex justify-between items-center sticky top-0 z-40">
        <button onclick="toggleSidebar()" class="text-slate-600 focus:outline-none"><i class="fas fa-bars text-xl"></i></button>
        <span class="font-bold text-lg text-slate-800">Shahin</span>
        <div class="w-8"></div>
    </div>
    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>
    {% endif %}
    
    <div class="{% if current_user.is_authenticated and not current_user.is_first_access %}flex h-screen overflow-hidden{% endif %}">
        {% if current_user.is_authenticated and not current_user.is_first_access %}
        <aside id="sidebar" class="sidebar fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 text-slate-300 transform -translate-x-full md:translate-x-0 md:static md:flex-shrink-0 flex flex-col shadow-2xl h-full">
            <div class="h-16 flex items-center px-6 bg-slate-950 border-b border-slate-800">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-lg mr-3">S</div>
                <span class="font-bold text-xl text-white tracking-tight">Shahin</span>
            </div>
            <div class="p-6 border-b border-slate-800">
                <div class="text-xs font-bold text-slate-500 uppercase mb-1">Olá,</div>
                <div class="text-sm font-bold text-white truncate">{{ current_user.real_name }}</div>
            </div>
            <nav class="flex-1 overflow-y-auto py-4">
                <ul class="space-y-1">
                    <li><a href="/" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-home w-6 text-center mr-2 text-slate-500 group-hover:text-blue-500"></i><span class="font-medium">Início</span></a></li>
                    
                    <li class="pt-4 pb-2 px-6 text-[10px] font-bold uppercase text-slate-600">Funcionário</li>
                    <li><a href="/ponto/registrar" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-fingerprint w-6 text-center mr-2 text-slate-500 group-hover:text-purple-500"></i><span class="font-medium">Registrar Ponto</span></a></li>
                    <li><a href="/ponto/espelho" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-calendar-alt w-6 text-center mr-2 text-slate-500"></i><span class="font-medium">Espelho de Ponto</span></a></li>
                    <li><a href="/holerites/meus-documentos" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-folder w-6 text-center mr-2 text-slate-500 group-hover:text-yellow-400"></i><span class="font-medium">Meus Holerites</span></a></li>
                    <li><a href="/ponto/solicitar-ajuste" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-edit w-6 text-center mr-2 text-slate-500"></i><span class="font-medium">Solicitar Ajuste</span></a></li>
                    
                    {% if current_user.role == 'Master' %}
                    <li class="pt-4 pb-2 px-6 text-[10px] font-bold uppercase text-slate-600">Administração</li>
                    <li><a href="/holerites/admin/importar" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-file-upload w-6 text-center mr-2 text-slate-500 group-hover:text-blue-400"></i><span class="font-medium">Importar Holerites</span></a></li>
                    <li><a href="/admin/relatorio-folha" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-file-invoice-dollar w-6 text-center mr-2 text-slate-500 group-hover:text-emerald-400"></i><span class="font-medium">Relatório de Folha</span></a></li>
                    <li><a href="/controle-uniforme" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-tshirt w-6 text-center mr-2 text-slate-500 group-hover:text-yellow-500"></i><span class="font-medium">Controle de Uniforme</span></a></li>
                    <li><a href="/admin/solicitacoes" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-check-double w-6 text-center mr-2 text-slate-500 group-hover:text-emerald-500"></i><span class="font-medium">Solicitações de Ponto</span></a></li>
                    <li><a href="/admin/usuarios" class="flex items-center px-6 py-3 hover:bg-slate-800 hover:text-white transition group"><i class="fas fa-users-cog w-6 text-center mr-2 text-blue-400"></i><span class="font-medium">Funcionários</span></a></li>
                    {% endif %}
                    
                    <li><a href="/logout" class="flex items-center px-6 py-3 hover:bg-red-900/20 hover:text-red-400 transition group mt-8"><i class="fas fa-sign-out-alt w-6 text-center mr-2 text-slate-500 group-hover:text-red-400"></i><span class="font-medium">Sair</span></a></li>
                </ul>
            </nav>
        </aside>
        {% endif %}
        
        <div class="flex-1 h-full overflow-y-auto bg-slate-50 relative w-full">
            <div class="max-w-5xl mx-auto p-4 md:p-8 pb-20">
                {% block content %}{% endblock %}
            </div>
            {% if current_user.is_authenticated and not current_user.is_first_access %}
            <footer class="py-6 text-center text-xs text-slate-400">&copy; 2026 Vortice Company</footer>
            {% endif %}
        </div>
    </div>

    <!-- Toastify JS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        Toastify({
                            text: "{{ message }}",
                            duration: 4000,
                            close: true,
                            gravity: "top", 
                            position: "right", 
                            stopOnFocus: true, 
                            style: {
                                background: "{% if category == 'error' %}linear-gradient(to right, #ef4444, #b91c1c){% else %}linear-gradient(to right, #059669, #047857){% endif %}",
                                borderRadius: "8px",
                                boxShadow: "0 4px 6px -1px rgba(0, 0, 0, 0.1)",
                                fontWeight: "bold",
                                fontSize: "14px"
                            },
                        }).showToast();
                    {% endfor %}
                {% endif %}
            {% endwith %}
        });
    </script>
</body>
</html>


##################################################

FILE: app/templates/editar.html
-------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="flex items-center justify-between mb-6">
    <h2 class="text-lg font-bold text-slate-800">Editar Item</h2>
    <a href="/" class="text-xs font-medium text-slate-500 hover:text-slate-800">Cancelar</a>
</div>

<div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
    <form action="/editar/{{ item.id }}" method="POST" class="p-6 space-y-5">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <!-- Alerta -->
        <div class="bg-yellow-50 text-yellow-800 p-3 rounded text-xs border border-yellow-200">
            <i class="fas fa-exclamation-triangle mr-1"></i> Você está editando manualmente o cadastro.
        </div>

        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Nome do Item</label>
            <input type="text" name="nome" value="{{ item.nome }}" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 text-slate-800 font-bold focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Tamanho</label>
                <select name="tamanho" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="P" {% if item.tamanho == 'P' %}selected{% endif %}>P</option>
                    <option value="M" {% if item.tamanho == 'M' %}selected{% endif %}>M</option>
                    <option value="G" {% if item.tamanho == 'G' %}selected{% endif %}>G</option>
                    <option value="GG" {% if item.tamanho == 'GG' %}selected{% endif %}>GG</option>
                    <option value="XG" {% if item.tamanho == 'XG' %}selected{% endif %}>XG</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Gênero</label>
                <select name="genero" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 text-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="Masculino" {% if item.genero == 'Masculino' %}selected{% endif %}>Masculino</option>
                    <option value="Feminino" {% if item.genero == 'Feminino' %}selected{% endif %}>Feminino</option>
                    <option value="Unissex" {% if item.genero == 'Unissex' %}selected{% endif %}>Unissex</option>
                </select>
            </div>
        </div>

        <div>
            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Quantidade Atual (Ajuste Manual)</label>
            <input type="number" name="quantidade" min="0" value="{{ item.quantidade }}" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 text-blue-600 font-bold text-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>

        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-md hover:shadow-lg transition-all">
            SALVAR ALTERAÇÕES
        </button>
    </form>
</div>
{% endblock %}

##################################################

FILE: app/templates/ponto_espelho_master.html
---------------------------------------------
{% extends 'base.html' %}
{% block content %}
<div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
    <h2 class="text-2xl font-bold text-slate-800">Espelho Geral</h2>
    <form action="/ponto/espelho" method="GET" class="flex gap-2">
        <input type="date" name="data_filtro" value="{{ filtro_data }}" class="border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-600">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm"><i class="fas fa-filter"></i></button>
        {% if filtro_data %}<a href="/ponto/espelho" class="bg-slate-200 text-slate-600 px-4 py-2 rounded-lg font-bold text-sm">Limpar</a>{% endif %}
    </form>
</div>

<div class="mb-6"><input type="text" id="buscaEspelho" onkeyup="filtrarEspelho('buscaEspelho', 'listaEspelho')" placeholder="Pesquisar funcionário..." class="w-full p-4 rounded-xl border border-slate-200 shadow-sm"></div>

<div class="space-y-2" id="listaEspelho">
    {% for grupo in grupos %}
    <div class="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm item-espelho">
        <button onclick="toggleDetails('detalhe-{{ loop.index }}')" class="w-full flex justify-between items-center p-4 bg-slate-50 hover:bg-slate-100 transition text-left focus:outline-none">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">{{ grupo.user.real_name[:2].upper() }}</div>
                <div>
                    <h3 class="font-bold text-slate-800 text-sm nome-func">{{ grupo.user.real_name }}</h3>
                    <p class="text-xs text-slate-500 font-mono">{{ grupo.data.strftime('%d/%m/%Y') }}</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <!-- Mostrador de Saldo no Card -->
                {% if grupo.saldo %}
                <div class="text-right">
                    <span class="block text-[10px] font-bold uppercase text-slate-400">Saldo</span>
                    <span class="text-sm font-mono font-bold 
                        {% if '-' in grupo.saldo %} text-red-600 {% else %} text-emerald-600 {% endif %}">
                        {{ grupo.saldo }}
                    </span>
                </div>
                {% endif %}
                <i class="fas fa-chevron-down text-slate-400"></i>
            </div>
        </button>
        
        <div id="detalhe-{{ loop.index }}" class="hidden border-t border-slate-100">
            <div class="p-4 bg-white grid grid-cols-2 gap-2">
                {% for p in grupo.pontos %}
                <div class="flex justify-between items-center p-2 rounded bg-slate-50 border border-slate-100">
                    <span class="text-xs font-bold text-slate-600">{{ p.tipo }}</span>
                    <span class="text-sm font-mono font-bold text-blue-600">{{ p.hora_registro.strftime('%H:%M') }}</span>
                </div>
                {% endfor %}
                <div class="col-span-2 text-center text-xs text-slate-400 mt-2 bg-slate-50 p-1 rounded">Status: {{ grupo.status }}</div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-10 text-slate-400">Nenhum registro encontrado.</div>
    {% endfor %}
</div>
<script>
function filtrarEspelho(inputId, listaId) {
    let input = document.getElementById(inputId);
    let filter = input.value.toUpperCase();
    let lista = document.getElementById(listaId);
    let itens = lista.getElementsByClassName('item-espelho');
    for (let i = 0; i < itens.length; i++) {
        let nome = itens[i].getElementsByClassName('nome-func')[0];
        if (nome.innerHTML.toUpperCase().indexOf(filter) > -1) { itens[i].style.display = ""; } else { itens[i].style.display = "none"; }
    }
}
</script>
{% endblock %}

##################################################

